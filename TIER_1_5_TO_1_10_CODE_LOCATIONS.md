# TIER 1.5-1.10 Code Location Reference
**Quick lookup**: Exact files and line numbers for each item

---

## üó∫Ô∏è Item 1.10: Anonymization Salt

**Primary File**: `training_data_manager.py`

| Action | Location |
|--------|----------|
| Add imports | Top of file (after existing imports) |
| Add function | `get_anonymization_salt()` - add before current ANONYMIZATION_SALT line |
| Replace | Line ~20-30: `ANONYMIZATION_SALT = "default_salt_12345"` |
| Update | `.env.example` - add `ANONYMIZATION_SALT=<auto-generated-on-startup>` |

**Affected Endpoints**: None (config-only)  
**DB Changes**: None  
**Breaking Changes**: No (same behavior, different source)

---

## üó∫Ô∏è Item 1.7: Access Control

**Primary File**: `api.py`

| Action | Location | Search |
|--------|----------|--------|
| Find endpoint | Line 10189-10221 | `/api/professional/ai-summary` |
| Fix | Change `clinician_username = request.json.get(...)` | Use `session.get('username')` instead |
| Add checks | Same endpoint | Add role verification from DB |
| Audit all | Throughout file | Grep: `request.json.get.*username` |
| Add logging | All professional endpoints | `log_event(username, 'professional', action, details)` |

**Affected Endpoints**: `/api/professional/*` (all professional routes)  
**DB Changes**: None  
**Breaking Changes**: No (fixing security bypass)

---

## üó∫Ô∏è Item 1.5: Session Management

**Primary File**: `api.py`

| Action | Location | Current ‚Üí New |
|--------|----------|---|
| Reduce lifetime | Line ~165 | `timedelta(days=30)` ‚Üí `timedelta(days=7)` |
| Add fields | Login endpoint (~line 3600?) | Add `session['login_time']`, `session['last_activity']` |
| Add middleware | Before @app.before_request (top-ish) | New `check_session_timeout()` function |
| Add invalidation | Password change endpoint | Clear old sessions, `session.clear()` |

**Find login endpoint**:
```bash
grep -n "'/api/auth/login'" api.py
grep -n "def login" api.py
```

**Find password change endpoint**:
```bash
grep -n "change-password\|change_password" api.py
```

**Affected Endpoints**: 
- `/api/auth/login` (add session rotation)
- `/api/auth/change-password` (add session invalidation)
- All endpoints (add inactivity check via middleware)

**DB Changes**: None required (uses Flask session)  
**Breaking Changes**: No (users re-login after 30‚Üí7 days, only applies to new sessions)

---

## üó∫Ô∏è Item 1.9: Database Pooling

**Primary File**: `api.py`

| Action | Location | What |
|--------|----------|------|
| Add pool class | Top of file (after imports, ~line 50?) | `ThreadedConnectionPool` setup |
| Add helpers | After pool class | `get_db_connection_pooled()`, `return_db_connection()`, context manager |
| Replace calls | Throughout file (100+ places) | Gradual: `get_db_connection()` ‚Üí context manager |

**Find all `get_db_connection()` calls**:
```bash
grep -n "get_db_connection()" api.py | wc -l
# Should show ~100+ hits
```

**Affected Endpoints**: All endpoints (uses DB)  
**DB Changes**: No data changes (connection-level optimization)  
**Breaking Changes**: No (can be done iteratively - old and new patterns work together)

---

## üó∫Ô∏è Item 1.6: Error Handling

**Primary Files**: `api.py` + all supporting Python files

| Action | Location | Scope |
|--------|----------|-------|
| Add logging | Top of `api.py` | `import logging`, configure handlers |
| Find bare except | Search all `.py` files | `grep -n "except Exception:" *.py` |
| Replace patterns | Each location | Replace with specific exception types |
| Remove prints | Throughout | `grep -n "print(" *.py` |
| Audit logs | Verify sensitive data | Check logs don't leak passwords/API keys/usernames |

**Files to audit**:
- `api.py` (main)
- `training_data_manager.py`
- `audit.py`
- `secrets_manager.py`
- `c_ssrs_assessment.py`
- Any other `.py` files

**Find problem areas**:
```bash
# Find bare exceptions
grep -rn "except Exception:" . --include="*.py"

# Find print statements  
grep -rn "print(" . --include="*.py" | grep -v "test"

# Find sensitive data in logs
grep -rn "password\|secret\|key\|token" . --include="*.py" | grep -v "test" | grep -v ".pyc"
```

**Affected Endpoints**: All (improves error handling globally)  
**DB Changes**: None  
**Breaking Changes**: No (better error reporting, same external behavior)

---

## üó∫Ô∏è Item 1.8: XSS Prevention

**Primary File**: `templates/index.html`

| Action | Location | What |
|--------|----------|------|
| Add DOMPurify | `<head>` section | `<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>` |
| Find innerHTML | Throughout file | `grep -n "\.innerHTML\s*=" templates/index.html` |
| Replace user data | ~138 locations | Change `.innerHTML = userData` to `.textContent = userData` |
| Add sanitizer | Create/update `static/js/main.js` | `safeSetHTML()` and `safeSetText()` functions |
| Replace rich content | ~X locations | Use `.innerHTML = DOMPurify.sanitize(content)` |

**Find all innerHTML**:
```bash
grep -n "\.innerHTML" templates/index.html | wc -l
# Should show 138+ results
```

**Categorize by type**:
```bash
# User-generated data (pet names, posts, messages, mood notes)
grep -n "\.innerHTML.*pet\|\.innerHTML.*post\|\.innerHTML.*message\|\.innerHTML.*mood" templates/index.html

# UI templates / pre-rendered content
grep -n "\.innerHTML.*template\|\.innerHTML.*html" templates/index.html
```

**Affected Endpoints**: None (frontend-only change)  
**DB Changes**: None  
**Breaking Changes**: No (same data display, safer rendering)

---

## üìä Summary by File

```
api.py
‚îú‚îÄ‚îÄ Line ~50: Add connection pool setup (1.9)
‚îú‚îÄ‚îÄ Line ~165: Reduce session lifetime 30‚Üí7 days (1.5)
‚îú‚îÄ‚îÄ Line 147-165: Session config section (1.5)
‚îú‚îÄ‚îÄ Line ~3600?: Login endpoint - add session rotation (1.5)
‚îú‚îÄ‚îÄ Line ~3900?: Password change endpoint - add invalidation (1.5)
‚îú‚îÄ‚îÄ Line ~4000?: Add @app.before_request middleware (1.5)
‚îú‚îÄ‚îÄ Line 10189-10221: Professional endpoints - fix identity (1.7)
‚îî‚îÄ‚îÄ Throughout: Replace bare exceptions, add logging (1.6)

training_data_manager.py
‚îú‚îÄ‚îÄ Top: Add imports and get_anonymization_salt() function (1.10)
‚îî‚îÄ‚îÄ Line ~20-30: Replace hardcoded salt with function call (1.10)

templates/index.html
‚îú‚îÄ‚îÄ <head>: Add DOMPurify script (1.8)
‚îî‚îÄ‚îÄ Throughout: Replace innerHTML uses (1.8)

.env.example
‚îî‚îÄ‚îÄ Security section: Add ANONYMIZATION_SALT (1.10)

static/js/main.js
‚îî‚îÄ‚îÄ Add: safeSetHTML() and safeSetText() helpers (1.8)
```

---

## üîç Quick Search Commands

```bash
# 1.10: Find hardcoded salt
grep -n "ANONYMIZATION_SALT\s*=" training_data_manager.py

# 1.7: Find forgeable endpoints
grep -n "request.json.get.*username" api.py
grep -n "/api/professional" api.py

# 1.5: Find session config
grep -n "PERMANENT_SESSION_LIFETIME\|session.permanent" api.py
grep -n "def login" api.py

# 1.9: Find DB connections
grep -n "get_db_connection()" api.py | head -20

# 1.6: Find error handling issues
grep -n "except Exception:" api.py | head -20
grep -n "^[[:space:]]*print(" api.py | head -20

# 1.8: Find innerHTML uses
grep -n "\.innerHTML" templates/index.html | head -20
```

---

## ‚úÖ Verification Commands

```bash
# Syntax check after changes
python3 -m py_compile api.py training_data_manager.py cbt_tools/*.py

# Run tests
pytest tests/ -v

# Check specific issue is fixed
python3 -c "from training_data_manager import get_anonymization_salt; print(get_anonymization_salt())"

# Verify no more hardcoded secrets
grep -r "ANONYMIZATION_SALT\s*=\s*['\"]" . --include="*.py"  # Should return nothing

# Verify bare exceptions reduced
grep -n "except Exception:" api.py | wc -l  # Should be lower after fix

# Verify innerHTML reduced (1.8)
grep -n "\.innerHTML" templates/index.html | wc -l  # Should be lower after XSS fix
```

---

## üì± Before/After Patterns

### 1.10 Pattern
```python
# BEFORE
ANONYMIZATION_SALT = "default_salt_12345"

# AFTER
ANONYMIZATION_SALT = get_anonymization_salt()
```

### 1.7 Pattern
```python
# BEFORE
clinician_username = request.json.get('clinician_username')

# AFTER
clinician_username = session.get('username')
if not clinician_username:
    return jsonify({'error': 'Authentication required'}), 401
```

### 1.5 Pattern
```python
# BEFORE
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=30)

# AFTER
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=7)
# Plus: session rotation, inactivity check, invalidation on password change
```

### 1.8 Pattern
```javascript
// BEFORE
document.getElementById('pet-name').innerHTML = petName;

// AFTER
document.getElementById('pet-name').textContent = petName;

// OR for rich content
document.getElementById('content').innerHTML = DOMPurify.sanitize(userContent);
```

---

**Last Updated**: Feb 9, 2026  
**For Details**: See TIER_1_5_TO_1_10_IMPLEMENTATION_PLAN.md
