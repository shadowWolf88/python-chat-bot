<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Healing Space UK ‚Äì Mental Health Companion [v2026.01.17]</title>
    <!-- TIER 1.8: XSS Prevention -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- UX Enhancement System -->
    <link rel="stylesheet" href="/static/css/ux-enhancements.css">
    <script>
        // Functions moved to head to be available for onclick handlers
        function showLanding() {
            hideAllAuthForms();
            document.getElementById('landingPage').classList.remove('hidden');
        }
        
        function showPatientAuth() {
            hideAllAuthForms();
            document.getElementById('patientLoginForm').classList.remove('hidden');
        }
        
        function showClinicianAuth() {
            hideAllAuthForms();
            document.getElementById('clinicianLoginForm').classList.remove('hidden');
        }

        function hideAllAuthForms() {
            // This function will be called by the functions above, so it needs to be here too.
            // It might be defined again later, which is fine.
            const authBox = document.querySelector('.auth-box');
            if (!authBox) return;
            const forms = authBox.querySelectorAll('.hidden');
            forms.forEach(form => {
                if (form.id) { 
                    form.classList.add('hidden');
                }
            });
            const authMessage = document.getElementById('authMessage');
            if(authMessage) authMessage.classList.add('hidden');

            // Explicitly show/hide forms
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientLoginForm').classList.add('hidden');
            document.getElementById('clinicianLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
        }

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input) {
                if (input.type === 'password') {
                    input.type = 'text';
                    button.textContent = 'üôà';
                } else {
                    input.type = 'password';
                    button.textContent = 'üëÅÔ∏è';
                }
            }
        }

        async function login(userType) {
            // Stub - will be properly defined later in body
            // This ensures onclick handlers don't error on page load
            console.log('Login called for:', userType);
        }
    </script>
    <style>
        /* Theme CSS Variables */
        :root {
            /* Light theme (default) */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-sidebar: #f0f0f0;
            --bg-hover: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
            --accent-color: #667eea;
            --accent-gradient: linear-gradient(135deg, #667eea, #764ba2);
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --bg-sidebar: #111827;
            --bg-hover: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow-color: rgba(0,0,0,0.3);
            --accent-color: #818cf8;
            --accent-gradient: linear-gradient(135deg, #818cf8, #a78bfa);
            --success-color: #34d399;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            pointer-events: auto;
            transition: background 0.3s ease;
        }

        [data-theme="dark"] body {
            background: var(--bg-primary);
        }

        /* ========== DARK MODE COMPREHENSIVE FIXES ========== */

        /* Chat Interface - Sessions Dropdown */
        [data-theme="dark"] .sessions-dropdown {
            background: var(--bg-card);
            border-color: var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        [data-theme="dark"] .session-item {
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .session-item:hover {
            background: var(--bg-hover);
        }

        [data-theme="dark"] .session-item.active {
            background: rgba(129, 140, 248, 0.15);
            border-left-color: var(--accent-color);
        }

        [data-theme="dark"] .session-name {
            color: var(--text-primary);
        }

        [data-theme="dark"] .session-meta {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .session-actions button {
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        [data-theme="dark"] .session-actions button:hover {
            background: var(--bg-hover);
        }

        /* Chat Container */
        [data-theme="dark"] .chat-container {
            border-color: var(--border-color);
        }

        /* Chat Messages Area */
        [data-theme="dark"] .chat-messages {
            background: var(--bg-secondary);
        }

        /* AI Message Bubble */
        [data-theme="dark"] .message.ai {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        /* Chat Input Area */
        [data-theme="dark"] .chat-input-area {
            border-top-color: var(--border-color);
            background: var(--bg-card);
        }

        [data-theme="dark"] .chat-input-area textarea {
            background: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .chat-input-area textarea::placeholder {
            color: var(--text-muted);
        }

        [data-theme="dark"] .chat-input-area textarea::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .chat-input-area textarea::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        /* Voice Button */
        [data-theme="dark"] .chat-input-area .voice-btn {
            background: var(--bg-input);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .chat-input-area .voice-btn:hover {
            background: var(--bg-hover);
        }

        /* AI Thinking Animation */
        [data-theme="dark"] .ai-thinking {
            color: var(--text-secondary);
        }

        /* Search Bar Input */
        [data-theme="dark"] .search-bar input {
            background: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-bar input::placeholder {
            color: var(--text-muted);
        }

        /* Stat Cards */
        [data-theme="dark"] .stat-card {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        [data-theme="dark"] .stat-label {
            color: var(--text-secondary);
        }

        /* Crisis Resources Box */
        [data-theme="dark"] .crisis-resources-box,
        [data-theme="dark"] .card[style*="background: #ffebee"],
        [data-theme="dark"] #safetyTab .card:last-child {
            background: rgba(239, 68, 68, 0.15) !important;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="dark"] #safetyTab .card:last-child h4 {
            color: #f87171 !important;
        }

        [data-theme="dark"] #safetyTab .card:last-child p,
        [data-theme="dark"] #safetyTab .card:last-child a {
            color: var(--text-primary);
        }

        /* Insights Tab */
        [data-theme="dark"] #insightsTab .card[style*="background: #f8f9fa"],
        [data-theme="dark"] .insights-date-range {
            background: var(--bg-secondary) !important;
        }

        [data-theme="dark"] #insightsTab input[type="date"] {
            background: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] #aiInsight,
        [data-theme="dark"] div[style*="background: #f5f5f5"] {
            background: var(--bg-secondary) !important;
            color: var(--text-primary);
        }

        /* Clinician Info Box */
        [data-theme="dark"] #clinicianInfo {
            background: var(--bg-secondary) !important;
            color: var(--text-primary);
        }

        [data-theme="dark"] #clinicianInfo p {
            color: var(--text-primary);
        }

        /* Notification Panel */
        [data-theme="dark"] #notificationPanel {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px var(--shadow-color) !important;
        }

        [data-theme="dark"] #notificationPanel h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] #notificationPanel button {
            color: var(--text-muted);
        }

        /* Modal Content */
        [data-theme="dark"] .modal-content {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Tables in dark mode */
        [data-theme="dark"] table tr[style*="border-bottom"] {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] table thead tr[style*="background: #f8f9fa"] {
            background: var(--bg-secondary) !important;
        }

        [data-theme="dark"] table td,
        [data-theme="dark"] table th {
            color: var(--text-primary);
        }

        /* Generic light backgrounds to dark */
        [data-theme="dark"] div[style*="background: #f8f9fa"],
        [data-theme="dark"] div[style*="background: #f9f9f9"],
        [data-theme="dark"] div[style*="background: #fafafa"] {
            background: var(--bg-secondary) !important;
        }

        /* Warning boxes */
        [data-theme="dark"] div[style*="background: #fff3cd"] {
            background: rgba(251, 191, 36, 0.15) !important;
            border-left-color: #fbbf24 !important;
        }

        [data-theme="dark"] div[style*="background: #fff3cd"] p {
            color: #fcd34d !important;
        }

        /* Textareas with hardcoded borders */
        [data-theme="dark"] textarea[style*="border: 2px solid #e0e0e0"],
        [data-theme="dark"] input[style*="border: 2px solid #e0e0e0"] {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        /* Patient cards in professional dashboard */
        [data-theme="dark"] .patient-card,
        [data-theme="dark"] div[style*="border: 2px solid #e0e0e0"] {
            background: var(--bg-card);
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .patient-card strong,
        [data-theme="dark"] .patient-card p {
            color: var(--text-primary);
        }

        /* Calendar day cells */
        [data-theme="dark"] div[style*="background: white"][style*="border: 1px solid #e0e0e0"],
        [data-theme="dark"] div[style*="background: white"][style*="border: 2px solid"] {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] div[style*="background: #fafafa"] {
            background: var(--bg-secondary) !important;
        }
        
        /* Dark mode overrides for inline styles in auth forms */
        [data-theme="dark"] input[style*="border: 2px solid #e0e0e0"],
        [data-theme="dark"] input[style*="border-color: #e0e0e0"],
        [data-theme="dark"] textarea[style*="border: 2px solid #e0e0e0"],
        [data-theme="dark"] select[style*="border: 2px solid #e0e0e0"] {
            border-color: var(--border-color) !important;
            background: var(--bg-input) !important;
            color: var(--text-color) !important;
        }
        
        [data-theme="dark"] small[style*="color: #666"] {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] small[style*="color: #999"] {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] div[style*="background: #f9f9f9"] {
            background: var(--bg-secondary) !important;
        }
        
        [data-theme="dark"] div[style*="border: 2px solid #e0e0e0"][style*="background: #f9f9f9"] {
            border-color: var(--border-color) !important;
            background: var(--bg-secondary) !important;
        }
        
        [data-theme="dark"] div[style*="color: #999"] {
            color: var(--text-secondary) !important;
        }
        
        /* Terms and disclaimer headings */
        [data-theme="dark"] h2[style*="color: #667eea"] {
            color: var(--accent-color) !important;
        }
        
        [data-theme="dark"] strong[style*="color: #c62828"] {
            color: var(--danger-color) !important;
        }
        
        [data-theme="dark"] div[style*="color: #333"] {
            color: var(--text-color) !important;
        }
        
        [data-theme="dark"] p[style*="color: #e74c3c"] {
            color: var(--danger-color) !important;
        }

        [data-theme="dark"] div[style*="background: #e0e0e0"][style*="border-radius: 3px"] {
            background: var(--bg-secondary) !important;
        }
        
        [data-theme="dark"] div[style*="background: #dc3545"] {
            background: var(--danger-color) !important;
        }
        [data-theme="dark"] .reaction-btn {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        [data-theme="dark"] .reaction-btn:hover {
            background: var(--bg-hover);
        }

        /* History cards */
        [data-theme="dark"] .history-card {
            border-color: var(--border-color);
            background: var(--bg-card);
        }

        [data-theme="dark"] .history-card .date {
            color: var(--text-muted);
        }

        /* Med list */
        [data-theme="dark"] .med-list {
            border-color: var(--border-color);
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .med-item {
            background: rgba(129, 140, 248, 0.1);
            border-color: var(--accent-color);
            color: var(--text-primary);
        }

        /* Mood options */
        [data-theme="dark"] .mood-option {
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .mood-option:hover,
        [data-theme="dark"] .mood-option.selected {
            background: rgba(129, 140, 248, 0.15);
            border-color: var(--accent-color);
        }

        /* Generic paragraph colors in specific tabs */
        [data-theme="dark"] #therapyTab > p,
        [data-theme="dark"] #safetyTab > p,
        [data-theme="dark"] #insightsTab > p,
        [data-theme="dark"] #appointmentsTab > p,
        [data-theme="dark"] #aboutmeTab > p,
        [data-theme="dark"] #messagesTab > p,
        [data-theme="dark"] #updatesTab > p,
        [data-theme="dark"] #moodTab > p {
            color: var(--text-secondary) !important;
        }

        /* Alert messages in dark mode */
        [data-theme="dark"] .alert-success {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
            border-color: rgba(52, 211, 153, 0.3);
        }

        [data-theme="dark"] .alert-error {
            background: rgba(248, 113, 113, 0.15);
            color: #f87171;
            border-color: rgba(248, 113, 113, 0.3);
        }

        [data-theme="dark"] .alert-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }

        /* Voice status bar */
        [data-theme="dark"] .voice-status {
            background: rgba(251, 191, 36, 0.15);
            border-top-color: rgba(251, 191, 36, 0.3);
            color: #fcd34d;
        }

        /* Community post styles override */
        [data-theme="dark"] .community-post .post-header {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .community-post .post-message {
            color: var(--text-primary);
        }

        [data-theme="dark"] .community-post .post-likes {
            color: var(--text-muted);
        }

        /* Loading spinner */
        [data-theme="dark"] .loading {
            border-color: var(--bg-hover);
            border-top-color: var(--accent-color);
        }

        /* Crisis Resources Box - Light Mode */
        .crisis-resources-box {
            background: #ffebee;
        }

        .crisis-resources-box .crisis-title {
            color: #c62828;
        }

        /* Crisis Resources Box - Dark Mode */
        [data-theme="dark"] .crisis-resources-box {
            background: rgba(239, 68, 68, 0.15) !important;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="dark"] .crisis-resources-box .crisis-title {
            color: #f87171 !important;
        }

        [data-theme="dark"] .crisis-resources-box p {
            color: var(--text-primary);
        }

        [data-theme="dark"] .crisis-resources-box a {
            color: var(--accent-color);
        }

        /* Tab descriptions */
        .tab-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Themed input */
        .themed-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        /* Insights date card */
        .insights-date-card {
            background: var(--bg-secondary);
        }

        /* AI Insight box */
        .ai-insight-box {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            line-height: 1.6;
            color: var(--text-primary);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .ai-insight-box::-webkit-scrollbar {
            width: 8px;
        }
        
        .ai-insight-box::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 10px;
        }
        
        .ai-insight-box::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }
        
        .ai-insight-box::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color-hover);
        }

        /* Muted text helper */
        .muted-text {
            color: var(--text-muted);
        }

        /* Themed textarea */
        .themed-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .themed-textarea::placeholder {
            color: var(--text-muted);
        }

        /* ========== HOME TAB STYLES ========== */

        /* Home Welcome Card */
        .home-welcome-card {
            background: var(--accent-gradient);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .home-welcome-card h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .last-login-text {
            opacity: 0.9;
            font-size: 14px;
        }

        .home-version-info {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.8;
        }

        .motivational-quote {
            margin-top: 20px;
            font-style: italic;
            font-size: 16px;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
        }

        /* Daily Tasks */
        .home-tasks-card h3 {
            margin-bottom: 15px;
        }

        .daily-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            flex: 1;
            height: 12px;
            background: var(--bg-input);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-gradient);
            transition: width 0.3s ease;
            border-radius: 6px;
        }

        .progress-text {
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .daily-tasks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .daily-task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-input);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .daily-task-item:hover {
            background: var(--bg-hover);
        }

        .daily-task-item.completed {
            opacity: 0.7;
        }

        .daily-task-item.completed .task-label {
            text-decoration: line-through;
        }

        .task-checkbox {
            font-size: 18px;
        }

        .task-label {
            flex: 1;
            color: var(--text-primary);
        }

        .streak-display {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
        }

        .streak-icon {
            margin-right: 5px;
        }

        .streak-count {
            font-size: 32px;
            font-weight: bold;
        }

        /* Quick Navigation */
        .home-quick-nav h3 {
            margin-bottom: 15px;
        }

        .quick-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .quick-nav-btn {
            padding: 20px 15px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .quick-nav-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        /* Help Links */
        .home-help-card h3 {
            margin-bottom: 15px;
        }

        .help-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .help-link {
            padding: 12px 20px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 14px;
        }

        .help-link:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .quick-tips-content ul {
            list-style-type: disc;
        }

        /* Home Pet Card */
        .home-pet-card h3 {
            margin-bottom: 15px;
        }

        /* Home Feedback Card */
        .home-feedback-card h3 {
            margin-bottom: 15px;
        }

        .home-feedback-card .form-group {
            margin-bottom: 15px;
        }

        /* Home Safety Card */
        .home-safety-card {
            border: 2px solid var(--danger-color);
        }

        .home-safety-card p {
            margin: 8px 0;
        }

        /* Dark Mode Specific for Home */
        [data-theme="dark"] .home-welcome-card {
            background: var(--accent-gradient);
        }

        [data-theme="dark"] .motivational-quote {
            background: rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .quick-nav-btn:hover {
            background: var(--accent-color);
        }

        [data-theme="dark"] .streak-display {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
        }

        /* ========== END HOME TAB STYLES ========== */

        /* Clinician info box */
        .clinician-info-box {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            color: var(--text-primary);
        }

        /* Appointment card styles */
        .appointment-details-box {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .appointment-warning-box {
            background: rgba(251, 191, 36, 0.15);
            border-left: 4px solid #fbbf24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        [data-theme="dark"] .appointment-warning-box p {
            color: #fcd34d;
        }

        /* ========== END DARK MODE FIXES ========== */

        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .auth-box {
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-color);
            max-width: 450px;
            width: 100%;
            padding: 40px;
            position: relative;
            z-index: 1001;
            pointer-events: auto;
            transition: background 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-color);
        }

        .auth-box * {
            pointer-events: auto;
        }
        
        .auth-box h1, .auth-box h2, .auth-box h3 {
            color: var(--text-color);
        }
        
        .auth-box label {
            color: var(--text-color);
        }
        
        .auth-box p {
            color: var(--text-color);
        }
        
        .auth-box input[type="text"],
        .auth-box input[type="password"],
        .auth-box input[type="email"] {
            color: var(--text-color) !important;
            background: var(--bg-secondary) !important;
            border: 2px solid var(--border-color) !important;
        }
        
        .auth-box a {
            color: var(--primary-color);
        }

        .auth-box h1 {
            color: var(--accent-color);
            margin-bottom: 10px;
            text-align: center;
        }

        .auth-box .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, background 0.3s;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 1002;
            pointer-events: auto;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-header {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .app-header h2 {
            color: var(--accent-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-primary);
        }

        .app-content {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 220px;
            background: var(--accent-gradient);
            padding: 20px 0;
            overflow-y: auto;
            box-shadow: 2px 0 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        [data-theme="dark"] .sidebar {
            background: var(--bg-sidebar);
        }

        .main-content {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            background: var(--bg-secondary);
            transition: background 0.3s ease;
        }
        [data-theme="dark"] .main-content {
            background: var(--bg-primary);
        }

        .tab-btn {
            display: block;
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: white;
            font-size: 14px;
            border-left: 4px solid transparent;
            margin-bottom: 5px;
        }

        [data-theme="dark"] .tab-btn {
            color: var(--text-secondary);
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            border-left-color: white;
        }

        [data-theme="dark"] .tab-btn:hover {
            background: var(--bg-hover);
            border-left-color: var(--accent-color);
        }

        .tab-btn.active {
            background: var(--bg-card);
            color: var(--accent-color);
            border-left-color: #ffd700;
            font-weight: 700;
        }

        .tab-content {
            display: none;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background 0.3s ease;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px var(--shadow-color);
        }
        [data-theme="dark"] .tab-content {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            box-shadow: 0 10px 40px var(--shadow-color);
        }
        .tab-content.active {
            display: block;
        }

        /* Dark Mode Toggle Switch */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.4s;
            border-radius: 32px;
        }

        .theme-toggle-slider:before {
            position: absolute;
            content: "‚òÄÔ∏è";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: var(--bg-color);
            transition: 0.4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-color);
        }

        .theme-toggle input:checked + .theme-toggle-slider {
            background: var(--accent-gradient);
        }

        .theme-toggle input:checked + .theme-toggle-slider:before {
            transform: translateX(28px);
            content: "üåô";
        }

        /* Chat Interface */
        .chat-sessions {
            margin-bottom: 15px;
        }
        
        .sessions-header {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sessions-dropdown {
            position: relative;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .session-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .session-item:hover {
            background: #f5f5f5;
        }
        
        .session-item.active {
            background: #e8f0fe;
            border-left: 4px solid #4a90e2;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-name {
            font-weight: 600;
            color: #333;
        }
        
        .session-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
        }
        
        .session-actions {
            display: flex;
            gap: 5px;
        }
        
        .session-actions button {
            padding: 4px 8px;
            font-size: 0.85rem;
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .session-actions button:hover {
            background: #f0f0f0;
        }
        
        .chat-container {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .search-bar {
            flex: 1;
            display: flex;
            gap: 5px;
            min-width: 200px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .chat-actions {
            display: flex;
            gap: 8px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: slideIn 0.3s;
            word-wrap: break-word;
            position: relative;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
            font-style: italic;
        }
        
        .message.highlight {
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.4);
            animation: highlightPulse 1s;
        }
        
        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 0 0 5px rgba(255, 193, 7, 0.6); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: white;
            border: 2px solid #e0e0e0;
        }
        
        .chat-input-area {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
        }

        .chat-input-area textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            max-height: 200px;
            overflow-y: auto !important;
            font-family: inherit;
            line-height: 1.4;
            scrollbar-width: thin;
            box-sizing: border-box;
        }

        .chat-input-area textarea::-webkit-scrollbar {
            width: 6px;
        }

        .chat-input-area textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-input-area textarea::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-input-area textarea::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-input-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .chat-input-area .send-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .chat-input-area .voice-btn {
            padding: 12px 14px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .chat-input-area .voice-btn:hover {
            background: #e8e8e8;
        }

        .chat-input-area .voice-btn.listening {
            background: #fee2e2;
            border-color: #ef4444;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .voice-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            background: #fef3c7;
            border-top: 1px solid #fcd34d;
            font-size: 14px;
            color: #92400e;
        }

        .voice-indicator {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-dot 1s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* AI Thinking Animation */
        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            color: #666;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: thinking-bounce 1.4s infinite ease-in-out;
        }

        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes thinking-bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Developer AI Chat */
        .dev-ai-chat-container {
            background: var(--bg-card, #f8f9fa);
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 8px;
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 15px;
            scroll-behavior: smooth;
        }
        .dev-ai-welcome {
            text-align: center;
            color: #999;
            padding: 60px 20px;
        }
        .dev-ai-welcome-title { margin-top: 15px; font-size: 18px; font-weight: 600; }
        .dev-ai-welcome-subtitle { margin-top: 10px; color: #888; }
        .dev-ai-msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .dev-ai-msg.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .dev-ai-msg.assistant {
            background: var(--bg-card, white);
            border: 1.5px solid var(--border-color, #e0e0e0);
            color: var(--text-primary, #333);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .dev-ai-msg .msg-timestamp {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            margin-top: 6px;
            text-align: right;
        }
        .dev-ai-msg.assistant .msg-timestamp { color: #999; }
        .dev-ai-msg pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
            margin: 8px 0;
            white-space: pre-wrap;
        }
        .dev-ai-msg code {
            background: rgba(0,0,0,0.08);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .dev-ai-msg pre code {
            background: none;
            padding: 0;
        }
        .dev-ai-quick-btn {
            padding: 8px 14px;
            border: 1.5px solid #667eea;
            border-radius: 20px;
            background: transparent;
            color: #667eea;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .dev-ai-quick-btn:hover {
            background: #667eea;
            color: white;
        }
        [data-theme="dark"] .dev-ai-msg.assistant {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .dev-ai-msg code {
            background: rgba(255,255,255,0.1);
        }
        [data-theme="dark"] .dev-ai-quick-btn {
            border-color: #7c8cf0;
            color: #7c8cf0;
        }
        [data-theme="dark"] .dev-ai-quick-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Mood Tracker */
        .mood-scale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .mood-option {
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mood-option:hover, .mood-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
        }
        
        .mood-option .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Medication List */
        .med-list {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            min-height: 60px;
            margin: 10px 0;
        }
        
        .med-item {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .med-item button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Pet Display */
        .pet-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        
        .pet-display {
            text-align: center;
            font-size: 80px;
            margin: 20px 0;
        }
        
        .pet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .stat-bar label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
        
        /* History Cards */
        .history-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .history-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .history-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        
        .history-card .date {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* CBT Tools */
        .cbt-container {
            display: grid;
            gap: 20px;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            animation: slideIn 0.3s;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .hidden {
            display: none !important;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        .inline-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .inline-form .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .sleep-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sleep-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
        }
        
        .sleep-item:hover {
            background: var(--bg-hover);
        }
        
        .sleep-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .sleep-item span {
            font-size: 16px;
        }
        
        .community-post {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-color);
        }
        
        .community-post .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .community-post .post-message {
            line-height: 1.6;
            color: #333;
        }
        
        .community-post .post-likes {
            margin-top: 8px;
            color: #999;
            font-size: 13px;
        }

        .reaction-btn {
            background: #f0f0f0;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .reaction-btn.active {
            background: #667eea;
            color: white;
        }

        .reply-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .reply-delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
        }

        .reply-delete-btn:hover {
            background: #c0392b;
        }

        /* Discord-style Community Layout */
        .community-discord-layout {
            display: flex;
            height: calc(100vh - 200px);
            min-height: 500px;
            background: #36393f;
            border-radius: 12px;
            overflow: hidden;
        }

        .community-sidebar {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .community-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #202225;
            background: #2f3136;
        }

        .community-sidebar-header h3 {
            color: #fff;
            font-size: 16px;
            margin: 0;
            font-weight: 600;
        }

        .channel-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            color: #8e9297;
            transition: all 0.15s ease;
        }

        .channel-item:hover {
            background: #393c43;
            color: #dcddde;
        }

        .channel-item.active {
            background: #393c43;
            color: #fff;
        }

        .channel-item .channel-emoji {
            font-size: 18px;
            margin-right: 8px;
            width: 24px;
            text-align: center;
        }

        .channel-item .channel-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .channel-item .unread-badge {
            background: #ed4245;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .community-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
        }

        .community-channel-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #202225;
            background: #36393f;
        }

        .community-channel-header .channel-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .community-channel-header .channel-info h3 {
            color: #fff;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .community-channel-header .channel-info p {
            color: #8e9297;
            margin: 4px 0 0 0;
            font-size: 12px;
        }

        .community-posts-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: #8e9297;
        }

        .welcome-message .welcome-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .welcome-message h2 {
            color: #fff;
            margin: 0 0 12px 0;
        }

        .welcome-message p {
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .community-input-area {
            padding: 16px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid #202225;
        }

        .community-input-area textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #40444b;
            border-radius: 8px;
            background: #40444b;
            color: #dcddde;
            font-size: 14px;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .community-input-area textarea:focus {
            border-color: var(--accent-color);
        }

        .community-input-area textarea::placeholder {
            color: #72767d;
        }

        .community-input-area .btn {
            padding: 12px 24px;
            white-space: nowrap;
            align-self: flex-end;
        }

        /* Discord-style Post Card */
        .discord-post {
            display: flex;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 4px;
            transition: background 0.1s;
        }

        .discord-post:hover {
            background: #32353b;
        }

        .discord-post.pinned {
            background: rgba(250, 166, 26, 0.1);
            border-left: 3px solid #faa61a;
        }

        .discord-post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .discord-post-content {
            flex: 1;
            min-width: 0;
        }

        .discord-post-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .discord-post-username {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
        }

        .discord-post-time {
            color: #72767d;
            font-size: 12px;
        }

        .discord-post-pinned-badge {
            background: #faa61a;
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .discord-post-message {
            color: #dcddde;
            line-height: 1.5;
            font-size: 14px;
            word-wrap: break-word;
        }

        .discord-post-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .discord-reaction-btn {
            background: #4f545c;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #dcddde;
            transition: all 0.15s;
        }

        .discord-reaction-btn:hover {
            background: #5d6269;
        }

        .discord-reaction-btn.active {
            background: rgba(88, 101, 242, 0.3);
            border: 1px solid #5865f2;
        }

        .discord-thread-btn {
            background: none;
            border: none;
            color: #72767d;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
        }

        .discord-thread-btn:hover {
            color: #dcddde;
        }

        .discord-post-admin-actions {
            margin-left: auto;
        }

        .discord-admin-btn {
            background: none;
            border: none;
            color: #72767d;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .discord-admin-btn:hover {
            color: #dcddde;
        }

        .discord-admin-btn.pin-btn.pinned {
            color: #faa61a;
        }

        /* Thread Modal */
        .thread-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            height: 100%;
            background: #2f3136;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .thread-modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .thread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #202225;
        }

        .thread-header h3 {
            color: #fff;
            margin: 0;
            font-size: 16px;
        }

        .thread-close-btn {
            background: none;
            border: none;
            color: #8e9297;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .thread-close-btn:hover {
            color: #fff;
        }

        .thread-original-post {
            padding: 16px;
            border-bottom: 1px solid #202225;
        }

        .thread-replies {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .thread-reply {
            display: flex;
            padding: 8px 0;
        }

        .thread-reply-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .thread-reply-content {
            flex: 1;
        }

        .thread-reply-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .thread-reply-username {
            color: #fff;
            font-weight: 600;
            font-size: 13px;
        }

        .thread-reply-time {
            color: #72767d;
            font-size: 11px;
        }

        .thread-reply-message {
            color: #dcddde;
            font-size: 13px;
            line-height: 1.4;
        }

        .thread-reply-input {
            padding: 16px;
            border-top: 1px solid #202225;
            display: flex;
            gap: 10px;
        }

        .thread-reply-input textarea {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #40444b;
            color: #dcddde;
            font-size: 14px;
            resize: none;
        }

        .thread-reply-input .btn {
            padding: 10px 16px;
        }

        /* Responsive for mobile */
        @media (max-width: 768px) {
            .community-discord-layout {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 150px);
            }

            .community-sidebar {
                width: 100%;
                max-height: 200px;
            }

            .channel-list {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                padding: 8px;
            }

            .channel-item {
                padding: 6px 10px;
                margin: 0;
            }

            .channel-item .channel-name {
                font-size: 12px;
            }

            .thread-modal {
                width: 100%;
            }
        }

        .patient-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .patient-card .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .patient-card .patient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .patient-stat {
            text-align: center;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .patient-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .patient-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Notification Styles */
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            padding: 10px;
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 1000;
        }
        
        .notification-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .notification-body {
            max-height: 450px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .notification-item:hover {
            background: #f5f5f5;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
        }
        
        .notification-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .notification-item p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .notification-item small {
            color: #999;
            font-size: 12px;
        }
        
        /* Approval Styles */
        .approval-request {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .approval-request strong {
            color: #333;
            font-size: 16px;
        }
        
        .approval-request p {
            margin: 5px 0;
            color: #666;
            font-size: 13px;
        }
        
        /* Password Strength Bar */
        .password-strength-bar {
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .password-strength-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
            width: 0%;
            background-color: #ccc;
        }
        
        .password-strength-text {
            font-size: 12px;
            margin-top: 5px;
            color: #666;
        }
        
        /* Password Toggle */
        .password-field-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #999;
            padding: 5px;
            z-index: 10;
            user-select: none;
        }
        
        .password-toggle:hover {
            color: #667eea;
        }
        
        .password-field-wrapper input {
            padding-right: 45px;
        }
        
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
            }
            .tab-btn {
                min-width: 140px;
                border-left: none;
                border-bottom: 4px solid transparent;
                margin: 0 5px;
            }
            .tab-btn.active {
                border-bottom-color: #ffd700;
                border-left-color: transparent;
            }
            .mood-scale {
                grid-template-columns: repeat(2, 1fr);
            }
            .notification-panel {
                right: 10px;
                left: 10px;
                width: auto;
            }
        }

        /* Developer Dashboard Styles */
        .dev-subtab-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .dev-subtab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .dev-subtab-btn.active {
            background: #667eea;
            color: white;
            border: none;
        }

        .dev-subtab-content {
            display: none;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            opacity: 1;
            font-size: 15px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 2px 8px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
        }
        [data-theme="dark"] .card {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        /* ========== PHASE 1 GAMIFICATION STYLES ========== */

        /* Emoji Mood Selector */
        .emoji-mood-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .emoji-mood-btn {
            font-size: 3em;
            padding: 15px;
            border: 3px solid transparent;
            background: var(--bg-input);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px var(--shadow-color);
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-mood-btn:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        .emoji-mood-btn.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color), var(--accent-gradient));
            transform: scale(1.2);
            animation: bounceIn 0.5s;
        }

        .emoji-mood-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Confetti Container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Success Animation */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: successPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes successPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Pet Reward Message */
        .pet-reward-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9998;
            animation: slideInRight 0.5s, slideOutRight 0.5s 3s forwards;
            max-width: 350px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Step Indicator for Progressive Disclosure */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 30px 0;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--accent-color);
            transform: scale(1.5);
        }

        .step-dot.completed {
            background: var(--success-color);
        }

        /* Smooth transitions for progressive forms */
        .progressive-step {
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .progressive-step.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* Enhanced CBT Tool Buttons */
        .cbt-tool-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        .cbt-tool-btn:hover {
            transform: translateY(-8px) !important;
            box-shadow: 0 12px 28px var(--shadow-color) !important;
        }

        .cbt-tool-btn:active {
            transform: translateY(-2px) !important;
        }

        /* Mood Emoji Group */
        .mood-emoji-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ========== PHASE 2 GAMIFICATION STYLES ========== */

        /* Achievement Badge */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
            animation: badgeUnlock 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes badgeUnlock {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            60% {
                transform: scale(1.2) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Badge Popup */
        .badge-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 70px;
            border-radius: 25px;
            text-align: center;
            z-index: 10001;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            animation: badgePopup 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .badge-popup .badge-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: badgeSpin 1s ease-out;
        }

        @keyframes badgePopup {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1) rotate(10deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes badgeSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(720deg); }
        }

        /* Before/After Mood Comparison */
        .mood-comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 25px;
            background: var(--bg-card);
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .mood-before, .mood-after {
            text-align: center;
            flex: 1;
        }

        .mood-comparison-arrow {
            font-size: 2.5em;
            color: var(--accent-color);
            animation: arrowPulse 1.5s infinite;
        }

        @keyframes arrowPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .mood-value {
            font-size: 4em;
            margin: 10px 0;
        }

        .mood-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mood-improvement {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin-top: 15px;
            animation: celebrateImprovement 0.6s ease-out;
        }

        @keyframes celebrateImprovement {
            0%, 100% { transform: scale(1); }
            25%, 75% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.15) rotate(5deg); }
        }

        /* Streak Counter */
        .streak-counter {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 6px 18px rgba(231, 76, 60, 0.4);
            position: relative;
            overflow: hidden;
        }

        .streak-counter::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: streakShine 2s infinite;
        }

        @keyframes streakShine {
            to { left: 100%; }
        }

        .streak-flame {
            font-size: 1.5em;
            animation: flameFlicker 0.5s infinite alternate;
        }

        @keyframes flameFlicker {
            0% { transform: scale(1) rotate(-2deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        .streak-number {
            font-size: 1.8em;
        }

        /* Achievement Showcase */
        .achievement-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .achievement-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.3s;
            cursor: pointer;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        .achievement-card.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .achievement-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .achievement-card .title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .achievement-card .description {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        /* Progress Ring for Streaks */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
        }

        /* Daily Wellness Ritual Styles */
        /* Chat Window Style Wellness Ritual */
        .wellness-chat-card {
            border: 2px solid var(--primary-color);
            background: var(--bg-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .wellness-chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7B2D9E 100%);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .wellness-chat-header h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
        }

        .wellness-chat-header p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            opacity: 0.9;
            color: white;
        }

        .wellness-close-btn {
            font-size: 1.5em;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 6px;
            cursor: pointer;
            color: white !important;
            transition: all 0.2s;
        }

        .wellness-close-btn:hover {
            background: rgba(255, 255, 255, 0.3) !important;
        }

        .wellness-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 250px;
            max-height: 350px;
            background: var(--bg-color);
            color: var(--text-color);
            position: relative;
        }

        .wellness-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .wellness-chat-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .wellness-chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .wellness-message {
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: slideInRight 0.4s ease-out;
        }

        .wellness-message.ai {
            align-items: flex-start;
        }

        .wellness-message.user {
            align-items: flex-end;
        }

        .wellness-bubble {
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 0.95em;
        }

        .wellness-message.ai .wellness-bubble {
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .wellness-message.user .wellness-bubble {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .wellness-options {
            display: grid;
            gap: 8px;
            width: 100%;
        }

        .wellness-option-btn {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .wellness-option-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
        }

        .wellness-option-btn.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .wellness-mood-scale {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            width: 100%;
        }

        .mood-button {
            padding: 10px 6px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.4em;
            line-height: 1;
        }

        .mood-button:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .mood-button.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 179, 237, 0.3);
        }

        .wellness-text-input {
            flex: 1;
            min-width: 0;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1em;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 44px;
        }

        .wellness-text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(99, 179, 237, 0.2);
        }

        .wellness-input-area {
            display: flex;
            gap: 8px;
            padding: 0 20px 20px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .wellness-input-area button {
            font-size: 0.9em;
            padding: 10px 12px;
            color: white;
        }

        .wellness-already-logged {
            animation: slideIn 0.3s ease-out;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin: 15px;
            color: var(--text-color);
        }

        .wellness-already-logged p {
            color: var(--text-color);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .wellness-chat-card {
                max-height: 500px;
            }

            .wellness-chat-messages {
                min-height: 200px;
                max-height: 280px;
            }

            .wellness-input-area {
                flex-wrap: wrap;
            }

            .wellness-input-area button {
                flex: 1;
                min-width: 80px;
            }
        }
        
        /* ===== Safety Check (C-SSRS & Real-Time Risk) ===== */
        .risk-indicator-card {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border: 2px solid #e74c3c;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .risk-dot {
            box-shadow: 0 0 15px currentColor;
            animation: pulse-risk 2s infinite;
        }
        
        .risk-dot.risk-green {
            background: #27ae60;
            color: #27ae60;
        }
        
        .risk-dot.risk-amber {
            background: #f39c12;
            color: #f39c12;
        }
        
        .risk-dot.risk-orange {
            background: #e67e22;
            color: #e67e22;
        }
        
        .risk-dot.risk-red {
            background: #e74c3c;
            color: #e74c3c;
        }
        
        @keyframes pulse-risk {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .assessment-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .assessment-progress {
            margin-bottom: 25px;
        }
        
        .assessment-progress .progress-bar-container {
            margin-bottom: 10px;
            height: 6px;
        }
        
        .assessment-progress .progress-text {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .assessment-question {
            margin: 25px 0;
        }
        
        .assessment-question h4 {
            font-size: 1.1em;
            margin: 0 0 15px 0;
            color: var(--text-primary);
        }
        
        .assessment-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .assessment-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }
        
        .assessment-option:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
        }
        
        .assessment-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .assessment-option-text {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .assessment-option-score {
            font-size: 0.85em;
            opacity: 0.7;
        }
        
        .assessment-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .assessment-buttons button {
            flex: 1;
            padding: 12px;
            min-width: 100px;
        }
        
        .results-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        #resultsLowRiskContent,
        #resultsModerateRiskContent,
        #resultsHighRiskContent {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        #resultsLowRiskContent {
            background: #e8f8e8;
            border-left-color: #27ae60;
            color: #27ae60;
        }
        
        #resultsModerateRiskContent {
            background: #fff8e8;
            border-left-color: #f39c12;
            color: #f39c12;
        }
        
        #resultsHighRiskContent {
            background: #ffe8e8;
            border-left-color: #e74c3c;
            color: #e74c3c;
        }
        
        .safety-plan-form {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .safety-plan-form .form-group {
            margin-bottom: 20px;
        }
        
        .safety-plan-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
        }
        
        .safety-plan-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .safety-person-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
        }
        
        .safety-person-chip button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
        }
        
        /* Risk Prompt Modal (shows during chat) */
        .risk-prompt-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .risk-prompt-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="dark"] .risk-prompt-content {
            background: var(--bg-secondary);
        }
        
        /* In-chat risk indicator */
        .chat-risk-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse-risk 2s infinite;
            vertical-align: middle;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .assessment-card,
            .results-card {
                padding: 20px;
            }
            
            .assessment-buttons {
                flex-wrap: wrap;
            }
            
            .assessment-buttons button {
                flex: 1 1 calc(50% - 5px);
            }
            
            .safety-plan-form {
                padding: 15px;
            }
        }
        /* ==================== MESSAGING SYSTEM STYLES ==================== */
        .msg-tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color, #e0e0e0); padding-bottom: 0; overflow-x: auto; }
        .msg-tab-btn { background: transparent; color: var(--text-secondary, #666); border: none; padding: 12px 20px; cursor: pointer; font-weight: 600; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 14px; }
        .msg-tab-btn:hover { color: var(--primary-color, #667eea); background: var(--hover-bg, #f5f5f5); }
        .msg-tab-btn.active { color: var(--primary-color, #667eea); border-bottom-color: var(--primary-color, #667eea); }
        .msg-tab-btn .badge { background: #e74c3c; color: white; padding: 1px 7px; border-radius: 10px; font-size: 11px; margin-left: 6px; font-weight: bold; }
        .msg-search-bar { display: flex; gap: 8px; margin-bottom: 16px; }
        .msg-search-bar input { flex: 1; padding: 10px 14px; border: 2px solid var(--border-color, #e0e0e0); border-radius: 8px; font-size: 14px; background: var(--input-bg, white); color: var(--text-primary, #333); }
        .msg-search-bar input:focus { border-color: var(--primary-color, #667eea); outline: none; }
        .msg-card { border: 1px solid var(--border-color, #e0e0e0); padding: 14px 16px; margin-bottom: 8px; background: var(--card-bg, white); border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
        .msg-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .msg-card.unread { background: var(--unread-bg, #f0f4ff); border-left: 3px solid var(--primary-color, #667eea); }
        .msg-avatar { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: white; flex-shrink: 0; }
        .msg-avatar.patient { background: #667eea; }
        .msg-avatar.clinician { background: #27ae60; }
        .msg-avatar.developer { background: #e67e22; }
        .msg-avatar.default { background: #95a5a6; }
        .msg-content { flex: 1; min-width: 0; }
        .msg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .msg-sender { font-weight: 600; font-size: 14px; color: var(--text-primary, #333); }
        .msg-role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; margin-left: 6px; }
        .msg-role-badge.patient { background: #eef0ff; color: #667eea; }
        .msg-role-badge.clinician { background: #e8f5e9; color: #27ae60; }
        .msg-role-badge.developer { background: #fff3e0; color: #e67e22; }
        .msg-time { font-size: 12px; color: var(--text-muted, #999); white-space: nowrap; }
        .msg-preview { color: var(--text-secondary, #666); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .msg-unread-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px; }
        .msg-status { font-size: 11px; margin-top: 2px; }
        .msg-status.read { color: #667eea; }
        .msg-status.sent { color: var(--text-muted, #999); }
        .msg-empty { text-align: center; padding: 60px 20px; color: var(--text-muted, #999); }
        .msg-empty-icon { font-size: 48px; margin-bottom: 12px; }
        .msg-empty p { margin: 0; font-size: 15px; }
        .msg-quick-actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .msg-quick-btn { padding: 8px 16px; border: 2px solid var(--border-color, #e0e0e0); border-radius: 20px; background: var(--card-bg, white); color: var(--text-primary, #333); cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .msg-quick-btn:hover { border-color: var(--primary-color, #667eea); color: var(--primary-color, #667eea); background: var(--hover-bg, #f8f9ff); }
        .msg-compose-form { display: flex; flex-direction: column; gap: 12px; }
        .msg-compose-form label { font-weight: 600; font-size: 13px; color: var(--text-secondary, #666); margin-bottom: -4px; }
        .msg-compose-form input, .msg-compose-form textarea { padding: 10px 14px; border: 2px solid var(--border-color, #e0e0e0); border-radius: 8px; font-size: 14px; font-family: inherit; background: var(--input-bg, white); color: var(--text-primary, #333); }
        .msg-compose-form input:focus, .msg-compose-form textarea:focus { border-color: var(--primary-color, #667eea); outline: none; }
        .msg-compose-form textarea { resize: vertical; min-height: 120px; }
        .msg-char-count { font-size: 12px; color: var(--text-muted, #999); text-align: right; }
        .msg-char-count.warning { color: #e67e22; }
        .msg-char-count.danger { color: #e74c3c; }
        .msg-recipient-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg, white); border: 1px solid var(--border-color, #e0e0e0); border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 100; }
        .msg-recipient-item { padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s; }
        .msg-recipient-item:hover { background: var(--hover-bg, #f5f5f5); }
        /* Conversation Modal */
        .conv-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; padding: 20px; }
        .conv-modal { background: var(--card-bg, white); border-radius: 16px; max-width: 720px; margin: 40px auto; height: 82vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .conv-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color, #e0e0e0); display: flex; justify-content: space-between; align-items: center; }
        .conv-header h3 { margin: 0; font-size: 16px; color: var(--text-primary, #333); display: flex; align-items: center; gap: 10px; }
        .conv-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text-muted, #999); padding: 4px 8px; border-radius: 6px; }
        .conv-close:hover { background: var(--hover-bg, #f0f0f0); }
        .conv-messages { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-secondary, #f8f9fa); }
        .conv-bubble { max-width: 75%; margin-bottom: 12px; }
        .conv-bubble.own { margin-left: auto; }
        .conv-bubble.other { margin-right: auto; }
        .conv-bubble-inner { padding: 10px 14px; border-radius: 12px; word-wrap: break-word; font-size: 14px; line-height: 1.5; }
        .conv-bubble.own .conv-bubble-inner { background: var(--primary-color, #667eea); color: white; border-bottom-right-radius: 4px; }
        .conv-bubble.other .conv-bubble-inner { background: var(--card-bg, white); color: var(--text-primary, #333); border: 1px solid var(--border-color, #e0e0e0); border-bottom-left-radius: 4px; }
        .conv-bubble-meta { font-size: 11px; color: var(--text-muted, #999); margin-top: 4px; padding: 0 4px; }
        .conv-bubble.own .conv-bubble-meta { text-align: right; }
        .conv-reply { padding: 14px 20px; border-top: 1px solid var(--border-color, #e0e0e0); background: var(--card-bg, white); border-radius: 0 0 16px 16px; }
        .conv-reply-input { display: flex; gap: 10px; align-items: flex-end; }
        .conv-reply-input textarea { flex: 1; padding: 10px 14px; border: 2px solid var(--border-color, #e0e0e0); border-radius: 10px; resize: none; min-height: 44px; max-height: 120px; font-family: inherit; font-size: 14px; background: var(--input-bg, white); color: var(--text-primary, #333); }
        .conv-reply-input textarea:focus { border-color: var(--primary-color, #667eea); outline: none; }
        .conv-send-btn { padding: 10px 20px; background: var(--primary-color, #667eea); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; }
        .conv-send-btn:hover { opacity: 0.9; }
        .conv-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Dark mode messaging overrides */
        [data-theme="dark"] .msg-card { background: var(--card-bg); border-color: var(--border-color); }
        [data-theme="dark"] .msg-card.unread { background: rgba(102,126,234,0.1); }
        [data-theme="dark"] .conv-modal { background: var(--card-bg); }
        [data-theme="dark"] .conv-messages { background: var(--bg-secondary); }
        [data-theme="dark"] .conv-bubble.other .conv-bubble-inner { background: var(--bg-secondary); }
        [data-theme="dark"] .msg-recipient-dropdown { background: var(--card-bg); border-color: var(--border-color); }
        [data-theme="dark"] .msg-recipient-item:hover { background: var(--hover-bg); }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <!-- Theme Toggle for Login Page -->
        <label class="theme-toggle" style="position: fixed; top: 20px; right: 20px; z-index: 5000; vertical-align: middle;">
            <input type="checkbox" id="authDarkModeToggle" onchange="toggleDarkMode()">
            <span class="theme-toggle-slider"></span>
        </label>
        <div class="auth-box">
            <h1>üåø Healing Space UK</h1>
            <p class="subtitle">Complete Mental Health Companion</p>
            
            <!-- Landing Page -->
            <div id="landingPage">
                <h2 style="text-align: center; margin-bottom: 30px;">Welcome! Please select:</h2>
                <button class="btn" onclick="showPatientAuth();" style="width: 100%; margin-bottom: 15px; padding: 20px; font-size: 18px;">
                    üë§ I'm a Patient
                </button>
                <button class="btn btn-secondary" onclick="showClinicianAuth();" style="width: 100%; padding: 20px; font-size: 18px;">
                    üë®‚Äç‚öïÔ∏è I'm a Clinician
                </button>
            </div>
                
            <!-- Developer Access Button (fixed to window) -->
            <button id="devAccessBtn" onclick="showDevLogin()" style="position: fixed; bottom: 18px; right: 18px; background: var(--bg-secondary); color: var(--text-color); opacity: 0.6; font-size: 13px; padding: 7px 16px; border-radius: 16px; border: 1px solid var(--border-color); z-index: 3000; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: opacity 0.2s; min-width: 0; width: auto; height: auto;">
                Developer Access
            </button>

            <!-- Developer Login Form (modal overlay) -->
            <div id="devLoginForm" class="hidden" style="position: fixed; bottom: 0; right: 0; left: 0; top: 0; background: rgba(0,0,0,0.45); z-index: 4000; display: flex; align-items: center; justify-content: center;">
                <div style="background: var(--bg-color); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); padding: 36px 32px; min-width: 320px; max-width: 95vw; width: 100%; max-width: 350px; color: var(--text-color);">
                    <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Developer Login</h3>
                    <div class="form-group">
                        <label style="color: var(--text-color);">Username</label>
                        <input type="text" id="devLoginUsername" placeholder="Enter developer username" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                    </div>
                    <div class="form-group">
                        <label style="color: var(--text-color);">Password</label>
                        <div class="password-field-wrapper">
                            <input type="password" id="devLoginPassword" placeholder="Enter password" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                            <button type="button" class="password-toggle" onclick="togglePassword('devLoginPassword', this)" title="Show/Hide password">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="color: var(--text-color);">PIN (4 digits) - 2FA</label>
                        <div class="password-field-wrapper">
                            <input type="password" id="devLoginPin" placeholder="Enter your 4-digit PIN" maxlength="4" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                            <button type="button" class="password-toggle" onclick="togglePassword('devLoginPin', this)" title="Show/Hide PIN">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <button class="btn" onclick="login('developer')">Login</button>
                    <button class="btn btn-secondary" onclick="closeDevLogin()" style="margin-top: 10px;">Cancel</button>
                </div>
            </div>
            
            <!-- Patient Login Form -->
            <div id="patientLoginForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Patient Login</h3>
                <div class="form-group">
                    <label style="color: var(--text-color);">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                </div>
                <div class="form-group">
                    <label style="color: var(--text-color);">Password</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="loginPassword" placeholder="Enter password" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)" title="Show/Hide password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: var(--text-color);">PIN (4 digits) - 2FA</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="loginPin" placeholder="Enter your 4-digit PIN" maxlength="4" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPin', this)" title="Show/Hide PIN">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin: 0;">
                    <label for="rememberMe" style="margin: 0; cursor: pointer; color: var(--text-color);">Remember Me</label>
                </div>
                <button class="btn" onclick="login('user')">Login</button>
                <a href="#" onclick="showForgotPassword('patient'); return false;" style="display: block; text-align: center; margin: 15px 0; color: var(--primary-color); text-decoration: none;">Forgot Password or PIN?</a>
                <button class="btn btn-secondary" onclick="showPatientRegister()">Create Patient Account</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <!-- Clinician Login Form -->
            <div id="clinicianLoginForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Clinician Login</h3>
                <div class="form-group">
                    <label style="color: var(--text-color);">Username</label>
                    <input type="text" id="clinicianLoginUsername" placeholder="Enter username" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                </div>
                <div class="form-group">
                    <label style="color: var(--text-color);">Password</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="clinicianLoginPassword" placeholder="Enter password" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                        <button type="button" class="password-toggle" onclick="togglePassword('clinicianLoginPassword', this)" title="Show/Hide password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: var(--text-color);">PIN (4 digits) - 2FA</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="clinicianLoginPin" placeholder="Enter your 4-digit PIN" maxlength="4" style="background: var(--bg-secondary); color: var(--text-color); border: 2px solid var(--border-color);">
                        <button type="button" class="password-toggle" onclick="togglePassword('clinicianLoginPin', this)" title="Show/Hide PIN">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="clinicianRememberMe" style="width: auto; margin: 0;">
                    <label for="clinicianRememberMe" style="margin: 0; cursor: pointer; color: var(--text-color);">Remember Me</label>
                </div>
                <button class="btn" onclick="login('clinician')">Login</button>
                <a href="#" onclick="showForgotPassword('clinician'); return false;" style="display: block; text-align: center; margin: 15px 0; color: var(--primary-color); text-decoration: none;">Forgot Password or PIN?</a>
                <button class="btn btn-secondary" onclick="showClinicianRegister()">Create Clinician Account</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <!-- Patient Registration Form -->
            <div id="registerForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Create Patient Account</h3>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="regFullName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Date of Birth *</label>
                    <input type="date" id="regDOB" required max="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label>Medical Conditions / Diagnosis *</label>
                    <textarea id="regConditions" placeholder="Please describe your current conditions or diagnosis (e.g., Depression, Anxiety, PTSD, etc.)" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 80px; font-family: inherit;"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">This helps your clinician provide better care</small>
                </div>
                <div class="form-group">
                    <label>Area / Region (UK) *</label>
                    <input type="text" id="regArea" placeholder="London, Manchester, Edinburgh, etc." required>
                    <small style="color: #666; display: block; margin-top: 5px;">Your UK region for clinician matching</small>
                </div>
                <div class="form-group">
                    <label>Postcode (optional)</label>
                    <input type="text" id="regPostcode" placeholder="SW1A 1AA">
                </div>
                <div class="form-group">
                    <label>NHS Number (optional)</label>
                    <input type="text" id="regNHS" placeholder="123 456 7890" maxlength="12">
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="regUsername" placeholder="Choose username" required>
                </div>
                <div class="form-group">
                    <label>Preferred Name (What we'll call you) *</label>
                    <input type="text" id="regPreferredName" placeholder="e.g., Sarah, Rick" required>
                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;">This is how the AI will address you</small>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="regPassword" placeholder="Min 8 chars, must include: number, letter, special char" oninput="checkPasswordStrength(this.value)" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regPassword', 'regPasswordToggle')" id="regPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                    <div id="passwordStrengthBar" style="height: 5px; background: #e0e0e0; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                        <div id="passwordStrengthFill" style="height: 100%; width: 0%; background: #dc3545; transition: all 0.3s;"></div>
                    </div>
                    <small id="passwordStrengthText" style="color: #999; display: block; margin-top: 3px;">Password strength: Weak</small>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="regConfirmPassword" placeholder="Re-enter password" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regConfirmPassword', 'regConfirmPasswordToggle')" id="regConfirmPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) *</label>
                    <div style="position: relative;">
                        <input type="password" id="regPin" placeholder="Choose 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regPin', 'regPinToggle')" id="regPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm PIN *</label>
                    <div style="position: relative;">
                        <input type="password" id="regConfirmPin" placeholder="Re-enter 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regConfirmPin', 'regConfirmPinToggle')" id="regConfirmPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="regEmail" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="regPhone" placeholder="+44 7XXX XXXXXX" required>
                </div>
                <div class="form-group" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #f9f9f9;">
                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                        <input type="checkbox" id="regHasClinician" checked style="width: 18px; height: 18px; cursor: pointer; margin-right: 10px;">
                        <span>I have a clinician and want to connect with them</span>
                    </label>
                    <small style="color: #666; display: block; margin-top: 8px;">You can connect with a clinician now or opt to use the app independently</small>
                </div>
                <div id="clinicianSection" style="display: block;">
                    <div class="form-group">
                        <label>Search for Your Clinician *</label>
                        <input type="text" id="regClinicianSearch" placeholder="Enter clinician username or full name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        <small style="color: #666; display: block; margin-top: 5px;">Example: "Dr. Smith" or "dr.smith"</small>
                        <button type="button" onclick="searchClinicians()" class="btn btn-secondary" style="width: 100%; margin-top: 8px; padding: 10px;">üîç Search Clinicians</button>
                    </div>
                    <div class="form-group">
                        <label>Select Your Clinician *</label>
                        <select id="regClinician" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; display: none;" required>
                            <option value="">-- No clinicians found yet --</option>
                        </select>
                        <div id="clinicianDropdownPlaceholder" style="color: #999; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f9f9f9;">
                            Search above to find available clinicians
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Your clinician will need to approve your request</small>
                    </div>
                </div>
                <button class="btn" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="showPatientAuth()">Back to Login</button>
            </div>
            
            <!-- Clinician Registration Form -->
            <div id="clinicianRegisterForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Create Clinician Account</h3>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="clinicianUsername" placeholder="Choose username" required>
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="clinicianFullName" placeholder="Dr. Jane Smith" required>
                </div>
                <div class="form-group">
                    <label>Professional ID Number *</label>
                    <input type="text" id="clinicianProfessionalId" placeholder="License/Registration Number" required>
                    <small style="color: #666; display: block; margin-top: 5px;">e.g., Medical License, GMC number, NMC PIN, etc.</small>
                </div>
                <div class="form-group">
                    <label>Country *</label>
                    <input type="text" id="clinicianCountry" placeholder="United Kingdom" required>
                </div>
                <div class="form-group">
                    <label>Area / Region *</label>
                    <input type="text" id="clinicianArea" placeholder="London, Manchester, etc." required>
                    <small style="color: #666; display: block; margin-top: 5px;">Patients can filter by location to find you</small>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="clinicianEmail" placeholder="doctor@clinic.com" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="clinicianPhone" placeholder="+1234567890" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianPassword" placeholder="Choose password (min 8 chars)" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianPassword', 'clinicianPasswordToggle')" id="clinicianPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianConfirmPassword" placeholder="Re-enter password" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianConfirmPassword', 'clinicianConfirmPasswordToggle')" id="clinicianConfirmPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) - 2FA *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianPin" placeholder="Choose 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianPin', 'clinicianPinToggle')" id="clinicianPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm PIN *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianConfirmPin" placeholder="Re-enter 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianConfirmPin', 'clinicianConfirmPinToggle')" id="clinicianConfirmPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn" onclick="registerClinician()">Create Clinician Account</button>
                <button class="btn btn-secondary" onclick="showClinicianAuth()">Back to Login</button>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Reset Password/PIN</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Enter your username and email. We'll send you a reset link.</p>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="forgotUsername" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your registered email">
                </div>
                <button class="btn" onclick="requestPasswordReset()">Send Reset Link</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <div id="authMessage" class="hidden"></div>
        </div>
    </div>
    
    <!-- PATIENT Legal Disclaimer Modal -->
    <div id="patientDisclaimerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; max-width: 750px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 40px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);">
            <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">‚öñÔ∏è Patient Terms & Legal Disclaimer</h2>

            <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                <strong style="color: #c62828;">‚ö†Ô∏è CRITICAL: READ CAREFULLY BEFORE USE</strong>
            </div>

            <div style="text-align: left; line-height: 1.8; color: #333; font-size: 13px;">
                <p><strong>1. THIS IS NOT MEDICAL CARE - AI IS NOT A REPLACEMENT FOR REAL PROFESSIONALS</strong></p>
                <p style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <strong>PYTHON-CHAT-BOT IS NOT A MEDICAL DEVICE. THE AI CHATBOT IS NOT A DOCTOR, THERAPIST, COUNSELLOR, OR HEALTHCARE PROFESSIONAL.</strong>
                    This application provides <u>peer support and self-help tools only</u>. It does NOT provide medical advice, diagnosis, treatment, or therapy.
                    The AI is a computer algorithm that cannot replace real human professional mental health care. You MUST continue seeing your GP,
                    psychiatrist, therapist, or mental health team. This tool is designed to support you <u>between</u> appointments, not replace them.
                </p>

                <p><strong>2. NOT REGULATED AS MEDICAL DEVICE OR CLINICAL SERVICE</strong></p>
                <p>python-chat-bot is NOT regulated by the Care Quality Commission (CQC), Medicines and Healthcare products Regulatory Agency (MHRA),
                or any clinical regulatory body in the UK. It is a research and self-help platform only. It does not provide NHS services.</p>

                <p><strong>3. EMERGENCY SITUATIONS - DO NOT USE THIS APP IN A CRISIS</strong></p>
                <p style="background: #ffebee; padding: 10px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                    If you are experiencing a mental health crisis, suicidal thoughts, thoughts of self-harm, or are in immediate danger:
                </p>
                <ul style="margin-left: 20px;">
                    <li><strong>Call 999</strong> for emergency services (UK)</li>
                    <li><strong>Call 111</strong> and select option 2 for NHS mental health crisis support</li>
                    <li><strong>Call Samaritans: 116 123</strong> (24/7 free helpline)</li>
                    <li><strong>Text SHOUT to 85258</strong> (Crisis Text Line UK)</li>
                    <li><strong>Call Papyrus (under 35): 0800 068 4141</strong></li>
                    <li>Go to your nearest A&E department</li>
                    <li>Contact your mental health crisis team or community mental health team</li>
                </ul>
                <p>DO NOT rely on this application for crisis intervention. Automated safety detection is unreliable and may fail.</p>

                <p><strong>4. RESEARCH & TRIAL PARTICIPATION</strong></p>
                <p>By using python-chat-bot, you are participating in a research/pilot study. Your participation is entirely <strong>voluntary</strong>.
                You may withdraw at any time without penalty by contacting the study administrator. Data collected includes: mood logs, clinical assessment
                scores (PHQ-9, GAD-7), chat transcripts, journal entries, appointment records, and usage metadata. You may request deletion of your data
                under UK GDPR rights (see Section 6).</p>

                <p><strong>5. STUDENT CLINICIAN SUPERVISION</strong></p>
                <p>If assigned to a clinician through this platform, they may be a student clinician operating under professional supervision.
                They are bound by their professional body's standards (e.g., BACP, UKCP, BPS, HCPC). Any formal therapeutic relationship must be
                established separately through proper clinical channels. Platform interactions do NOT constitute formal psychotherapy or counselling.</p>

                <p><strong>6. DATA PRIVACY & GDPR (UK)</strong></p>
                <p>We comply with UK GDPR and Data Protection Act 2018. Your personal data is processed lawfully under consent and legitimate research interest bases.
                Your rights include:</p>
                <ul style="margin-left: 20px;">
                    <li>Right to access your data (Subject Access Request)</li>
                    <li>Right to rectification of inaccurate data</li>
                    <li>Right to erasure ("right to be forgotten") - with limitations for anonymized research data</li>
                    <li>Right to restrict processing</li>
                    <li>Right to data portability</li>
                    <li>Right to object to processing</li>
                    <li>Right to withdraw consent for AI training data (Settings ‚Üí AI Research Data Contribution)</li>
                </ul>
                <p><strong>Data security:</strong> Personally identifiable information (PII) is encrypted at rest using Fernet encryption. Data is transmitted
                over HTTPS. However, <u>no system is 100% secure</u>. Do not share information you cannot risk being disclosed. Data may be subject to
                legal disclosure requirements (court orders, safeguarding duties).</p>
                <p><strong>ICO Registration:</strong> [Study administrators should insert ICO registration number if applicable]</p>

                <p><strong>7. AI SYSTEM LIMITATIONS & RISKS</strong></p>
                <p>The AI-powered chatbot has significant limitations:</p>
                <ul style="margin-left: 20px;">
                    <li><strong>No professional training:</strong> The AI has no medical, psychological, or therapeutic qualifications</li>
                    <li><strong>Cannot assess risk accurately:</strong> May fail to detect suicidal ideation, self-harm, or crisis situations</li>
                    <li><strong>May give inappropriate advice:</strong> Responses may be inaccurate, harmful, or inappropriate for your situation</li>
                    <li><strong>Cannot diagnose:</strong> Cannot assess or diagnose mental health conditions</li>
                    <li><strong>Cannot prescribe:</strong> Cannot recommend medications or medical treatments</li>
                    <li><strong>Algorithmic errors:</strong> May produce nonsensical, biased, or offensive content</li>
                    <li><strong>No emotional understanding:</strong> Cannot truly understand your emotional state or context</li>
                </ul>
                <p><strong>You use the AI chatbot entirely at your own risk.</strong></p>

                <p><strong>8. YOUR RESPONSIBILITIES AS A USER</strong></p>
                <p>By using python-chat-bot, you agree that:</p>
                <ul style="margin-left: 20px;">
                    <li>You are 18 years or older, OR have parental/guardian consent if 16-17 years old</li>
                    <li>You will NOT use this app if under 16 years old (UK age threshold for research consent)</li>
                    <li>You will continue to attend appointments with your GP, psychiatrist, therapist, or mental health team</li>
                    <li>You will seek professional help immediately if your mental health deteriorates</li>
                    <li>You will NOT rely on the AI for medical decisions</li>
                    <li>You understand this is a research tool, not a clinical service</li>
                    <li>You will contact emergency services (999/111) if in crisis, NOT rely on this app</li>
                    <li>You will use the platform responsibly and not abuse or misuse features</li>
                </ul>

                <p><strong>9. COMPLETE LIMITATION OF LIABILITY & DISCLAIMER (UK LAW)</strong></p>
                <p style="background: #ffebee; padding: 12px; border-radius: 6px; border: 2px solid #e74c3c;">
                    <strong>TO THE FULLEST EXTENT PERMITTED BY UK LAW:</strong>
                </p>
                <p>The creators, developers, operators, administrators, supervisors, institutional hosts, and all associated parties
                of python-chat-bot <strong>ACCEPT ZERO LIABILITY AND ZERO RESPONSIBILITY</strong> for any harm, injury, death, loss, or damages
                of any kind arising from your use of this application, including but not limited to:</p>
                <ul style="margin-left: 20px;">
                    <li>Suicide, self-harm, or deterioration in mental health</li>
                    <li>Reliance on AI-generated content, advice, or suggestions</li>
                    <li>Failure of crisis detection or safety monitoring systems</li>
                    <li>Delayed, inadequate, or harmful treatment decisions</li>
                    <li>Misdiagnosis, missed diagnoses, or medical errors</li>
                    <li>Data breaches, privacy violations, or unauthorized access</li>
                    <li>Technical failures, software bugs, or system downtime</li>
                    <li>Loss of data or inability to access the platform</li>
                    <li>Inappropriate clinician conduct (responsibility lies with their professional regulator)</li>
                    <li>Any direct, indirect, incidental, consequential, or punitive damages</li>
                </ul>
                <p><strong>Consumer Rights Act 2015:</strong> Nothing in this disclaimer excludes liability for death or personal injury caused by
                negligence, fraud, or fraudulent misrepresentation. However, as this is a free research tool provided "as-is" with no commercial
                transaction, Consumer Rights Act protections for goods and services do not apply.</p>
                <p><strong>Limitation period:</strong> Any claims must be brought within 6 months of the incident under applicable UK limitation laws.</p>

                <p><strong>10. PROFESSIONAL HELP RESOURCES (UK)</strong></p>
                <p>You are strongly encouraged to access professional mental health services:</p>
                <ul style="margin-left: 20px;">
                    <li><strong>Your GP:</strong> First point of contact for NHS mental health referrals</li>
                    <li><strong>NHS Talking Therapies (IAPT):</strong> Self-refer at <a href="https://www.nhs.uk/service-search/mental-health/find-a-psychological-therapies-service/" target="_blank">nhs.uk/service-search</a></li>
                    <li><strong>NHS 111:</strong> For urgent mental health support (select option 2)</li>
                    <li><strong>Mind Infoline:</strong> 0300 123 3393 (Mon-Fri 9am-6pm)</li>
                    <li><strong>Rethink Mental Illness:</strong> 0808 801 0525</li>
                </ul>

                <p><strong>11. CHANGES TO SERVICE & TERMINATION</strong></p>
                <p>We reserve the right to modify, suspend, or terminate python-chat-bot at any time without notice or liability.
                The platform may be discontinued if research funding ends. You have no guaranteed right to continued access.</p>

                <p><strong>12. GOVERNING LAW</strong></p>
                <p>These terms are governed by the laws of England and Wales. Disputes will be subject to the exclusive jurisdiction
                of the courts of England and Wales.</p>

                <hr style="margin: 25px 0; border: none; border-top: 2px solid #e0e0e0;">

                <p style="text-align: center; font-weight: bold; color: #e74c3c; margin-top: 20px; font-size: 15px;">
                    By clicking "I Accept," you confirm that you:<br>
                    (1) Have read and understood this entire disclaimer<br>
                    (2) Agree to all terms and accept all risks<br>
                    (3) Understand that AI is NOT a replacement for real professional mental health care<br>
                    (4) Understand that we accept ZERO LIABILITY for any harm arising from your use<br>
                    (5) Will seek professional help and use emergency services (999/111) if in crisis
                </p>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                <button class="btn" onclick="acceptDisclaimer()" style="min-width: 200px; padding: 15px;">
                    ‚úì I Accept All Terms
                </button>
            </div>
        </div>
    </div>

    <!-- CLINICIAN Legal Disclaimer Modal -->
    <div id="clinicianDisclaimerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; max-width: 750px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 40px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);">
            <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">‚öñÔ∏è Clinician Terms & Professional Responsibilities</h2>

            <div style="background: #e8f4fd; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                <strong style="color: #0d47a1;">‚ö†Ô∏è PROFESSIONAL USE ONLY - READ CAREFULLY</strong>
            </div>

            <div style="text-align: left; line-height: 1.8; color: #333; font-size: 13px;">
                <p><strong>1. PROFESSIONAL STATUS & TRAINING CONTEXT</strong></p>
                <p>python-chat-bot is a research and training platform for mental health professionals, including student clinicians.
                By registering as a clinician, you confirm that:</p>
                <ul style="margin-left: 20px;">
                    <li>You are a registered healthcare professional OR a student clinician in training under qualified supervision</li>
                    <li>You hold valid registration/accreditation with a UK professional body (e.g., GMC, NMC, HCPC, BACP, UKCP, BPS, or equivalent)</li>
                    <li>You will provide your professional registration number accurately</li>
                    <li>You understand this platform is for supervised clinical education and research, NOT independent private practice</li>
                    <li>If you are a student, you are operating under the direct supervision of a qualified supervisor/mentor</li>
                </ul>

                <p><strong>2. PLATFORM PURPOSE & LIMITATIONS</strong></p>
                <p style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                    python-chat-bot is <strong>NOT a substitute for formal clinical practice systems</strong>. It is NOT:
                </p>
                <ul style="margin-left: 20px;">
                    <li>A replacement for NHS electronic patient records (EPR/EHR)</li>
                    <li>A CQC-regulated clinical service</li>
                    <li>A MHRA-approved medical device</li>
                    <li>A secure NHS-approved clinical communication platform</li>
                    <li>A replacement for proper clinical documentation systems</li>
                    <li>Suitable for managing high-risk or complex cases without external clinical oversight</li>
                </ul>
                <p>This platform provides supplementary tools for patient monitoring, mood tracking, clinical assessment logging, and AI-assisted
                data summarization for educational purposes only.</p>

                <p><strong>3. YOUR PROFESSIONAL OBLIGATIONS & DUTIES</strong></p>
                <p>You remain <strong>fully responsible</strong> for all clinical decisions and duty of care. You MUST:</p>
                <ul style="margin-left: 20px;">
                    <li><strong>Maintain professional standards:</strong> Adhere to your professional body's code of conduct
                    (e.g., GMC Good Medical Practice, NMC Code, HCPC Standards, BACP Ethical Framework)</li>
                    <li><strong>Obtain informed consent:</strong> Ensure patients understand platform use and provide written consent for research participation</li>
                    <li><strong>Ensure adequate supervision:</strong> Student clinicians must operate under a qualified supervisor with regular clinical supervision sessions</li>
                    <li><strong>Manage clinical risk:</strong> Conduct proper risk assessments. Do NOT rely on automated AI alerts for safeguarding decisions</li>
                    <li><strong>Escalate emergencies immediately:</strong> If a patient discloses suicidal ideation, self-harm, safeguarding concerns,
                    or presents in crisis, you MUST follow your organization's crisis protocols and escalate to senior staff/emergency services</li>
                    <li><strong>Maintain accurate clinical records:</strong> Keep proper clinical documentation in your organization's official systems.
                    Platform notes are supplementary only</li>
                    <li><strong>Respect confidentiality:</strong> Comply with UK GDPR, Data Protection Act 2018, and professional confidentiality standards.
                    Only access patient data when clinically justified</li>
                    <li><strong>Maintain professional boundaries:</strong> No dual relationships, inappropriate contact, or boundary violations</li>
                    <li><strong>Have professional indemnity insurance:</strong> Ensure you have adequate professional indemnity/malpractice insurance covering digital health activities</li>
                </ul>

                <p><strong>4. AI LIMITATIONS & CLINICAL RESPONSIBILITY</strong></p>
                <p style="background: #ffebee; padding: 10px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                    <strong>CRITICAL:</strong> The AI-generated summaries, insights, and alerts are <u>NOT CLINICALLY VALIDATED</u>. They are algorithmic outputs only.
                </p>
                <p>You MUST NOT:</p>
                <ul style="margin-left: 20px;">
                    <li>Rely on AI-generated summaries as a substitute for reading patient records yourself</li>
                    <li>Trust automated crisis detection systems as reliable - they WILL miss serious risk indicators</li>
                    <li>Use AI outputs as clinical decision-making tools without independent professional judgment</li>
                    <li>Assume AI understands patient context, cultural factors, or nuanced clinical presentations</li>
                    <li>Delegate safeguarding responsibilities to automated systems</li>
                </ul>
                <p><strong>You are professionally and legally responsible for all clinical assessments, diagnoses, and treatment decisions.</strong>
                The AI is a research tool for learning purposes, not a clinical decision support system.</p>

                <p><strong>5. CRISIS & SAFEGUARDING DUTIES</strong></p>
                <p>You have a <strong>legal and professional duty</strong> to:</p>
                <ul style="margin-left: 20px;">
                    <li>Respond immediately to safeguarding disclosures (child protection, vulnerable adults, domestic abuse)</li>
                    <li>Follow mandatory reporting requirements under safeguarding legislation</li>
                    <li>Escalate high-risk patients to senior clinicians and crisis teams immediately</li>
                    <li>Document all safeguarding decisions and actions in official clinical systems</li>
                    <li>NOT rely on platform alerts - actively monitor patient communications for risk indicators</li>
                    <li>Ensure patients know how to access crisis support (999, 111 option 2, Samaritans 116 123)</li>
                </ul>
                <p><strong>Failure to act on safeguarding concerns may result in fitness-to-practice proceedings and legal liability.</strong></p>

                <p><strong>6. DATA PROTECTION & GDPR RESPONSIBILITIES</strong></p>
                <p>As a clinician using this platform, you are a <strong>data controller</strong> under UK GDPR. You MUST:</p>
                <ul style="margin-left: 20px;">
                    <li>Process patient data lawfully, fairly, and transparently</li>
                    <li>Only access data when there is a legitimate clinical or research purpose</li>
                    <li>Not share patient data outside the platform without proper consent and safeguards</li>
                    <li>Report any suspected data breaches to the study administrator within 24 hours</li>
                    <li>Comply with Subject Access Requests (patients requesting their data)</li>
                    <li>Not export patient data without explicit consent and ethical approval</li>
                    <li>Use secure devices and networks when accessing the platform (no public Wi-Fi for patient data)</li>
                </ul>
                <p>Breaches of data protection law may result in ICO enforcement action, fines up to ¬£17.5 million, and professional sanctions.</p>

                <p><strong>7. RESEARCH ETHICS & STUDY PARTICIPATION</strong></p>
                <p>If this platform is used within a research study, you MUST:</p>
                <ul style="margin-left: 20px;">
                    <li>Comply with the study protocol and ethical approval conditions</li>
                    <li>Obtain written informed consent from participants</li>
                    <li>Maintain research integrity and follow Good Clinical Practice (GCP) standards</li>
                    <li>Report adverse events and serious incidents to the study lead/ethics committee</li>
                    <li>Not deviate from the approved protocol without amendment approval</li>
                </ul>

                <p><strong>8. PROFESSIONAL BOUNDARIES & CONDUCT</strong></p>
                <p>You MUST maintain professional boundaries at all times:</p>
                <ul style="margin-left: 20px;">
                    <li>No sexual or romantic relationships with patients (fitness-to-practice matter)</li>
                    <li>No financial exploitation or inappropriate dual relationships</li>
                    <li>No communication with patients outside platform unless clinically justified and documented</li>
                    <li>No use of patient data for personal gain or unauthorized research</li>
                    <li>Respect patient autonomy, dignity, and rights</li>
                </ul>

                <p><strong>9. COMPLETE LIMITATION OF PLATFORM LIABILITY</strong></p>
                <p style="background: #ffebee; padding: 12px; border-radius: 6px; border: 2px solid #e74c3c;">
                    <strong>TO THE FULLEST EXTENT PERMITTED BY UK LAW:</strong>
                </p>
                <p>The creators, developers, operators, and administrators of python-chat-bot <strong>ACCEPT ZERO LIABILITY</strong> for:</p>
                <ul style="margin-left: 20px;">
                    <li>Clinical decisions made using platform data</li>
                    <li>Missed diagnoses, misdiagnoses, or treatment errors</li>
                    <li>Failure of automated crisis detection or alert systems</li>
                    <li>Patient harm, suicide, self-harm, or deterioration while using the platform</li>
                    <li>Safeguarding failures or missed disclosures</li>
                    <li>Data breaches or privacy violations</li>
                    <li>Technical failures, system downtime, or data loss</li>
                    <li>Inaccurate AI-generated summaries or insights</li>
                    <li>Professional misconduct by clinicians using the platform</li>
                    <li>Fitness-to-practice proceedings arising from platform use</li>
                </ul>
                <p><strong>YOU are professionally and legally responsible for your clinical practice.</strong> The platform is a tool; it does not
                assume any duty of care to patients. Professional indemnity and clinical negligence claims are YOUR responsibility.</p>
                <p><strong>Vicarious liability:</strong> Your employing organization or training institution may be vicariously liable for your actions.
                Ensure they are aware of and approve your use of this platform.</p>

                <p><strong>10. REGULATORY COMPLIANCE</strong></p>
                <p>You are responsible for ensuring your use of python-chat-bot complies with:</p>
                <ul style="margin-left: 20px;">
                    <li>Your professional regulator's standards (GMC, NMC, HCPC, BACP, UKCP, BPS, etc.)</li>
                    <li>UK GDPR and Data Protection Act 2018</li>
                    <li>Mental Capacity Act 2005 (assessing capacity for consent)</li>
                    <li>Mental Health Act 1983 (if applicable to your practice)</li>
                    <li>Safeguarding legislation (Children Act 1989, Care Act 2014)</li>
                    <li>Human Rights Act 1998</li>
                    <li>Equality Act 2010 (non-discrimination)</li>
                    <li>Your organization's clinical governance policies</li>
                </ul>

                <p><strong>11. ACCOUNT SECURITY & ACCESS CONTROL</strong></p>
                <p>You MUST:</p>
                <ul style="margin-left: 20px;">
                    <li>Keep your login credentials confidential and not share accounts</li>
                    <li>Use a strong, unique password and update it regularly</li>
                    <li>Log out after each session, especially on shared devices</li>
                    <li>Report lost/stolen devices or suspected unauthorized access immediately</li>
                    <li>Not access the platform from public or insecure networks when viewing patient data</li>
                </ul>

                <p><strong>12. CHANGES TO SERVICE & TERMINATION</strong></p>
                <p>We reserve the right to suspend or terminate your account if:</p>
                <ul style="margin-left: 20px;">
                    <li>You breach these terms or professional standards</li>
                    <li>You engage in misconduct or unethical behavior</li>
                    <li>Your professional registration lapses or is suspended</li>
                    <li>The research study concludes</li>
                </ul>
                <p>The platform may be discontinued at any time without liability. You have no guaranteed right to continued access.</p>

                <p><strong>13. GOVERNING LAW & DISPUTES</strong></p>
                <p>These terms are governed by the laws of England and Wales. Disputes will be subject to the exclusive jurisdiction of
                the courts of England and Wales.</p>

                <hr style="margin: 25px 0; border: none; border-top: 2px solid #e0e0e0;">

                <p style="text-align: center; font-weight: bold; color: #0d47a1; margin-top: 20px; font-size: 15px;">
                    By clicking "I Accept," you confirm that you:<br>
                    (1) Are a qualified or trainee mental health professional under supervision<br>
                    (2) Understand your professional duties and responsibilities<br>
                    (3) Will NOT rely on AI outputs for clinical decision-making<br>
                    (4) Accept FULL professional and legal responsibility for patient care<br>
                    (5) Understand the platform accepts ZERO LIABILITY for clinical outcomes<br>
                    (6) Will comply with all professional, ethical, and legal obligations
                </p>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                <button class="btn" onclick="acceptDisclaimer()" style="min-width: 200px; padding: 15px;">
                    ‚úì I Accept All Terms
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <div class="app-header">
            <button id="sidebarToggle" aria-label="Open navigation menu" aria-controls="sidebarNav" aria-expanded="false" style="display:none; background:transparent; border:none; font-size:2rem; margin-right:15px; cursor:pointer;">
                ‚ò∞
            </button>
            <h2>üåø Healing Space UK</h2>
            <div class="user-info">
                <button onclick="showNotifications()" style="position: relative; background: transparent; border: 2px solid var(--accent-color); color: var(--accent-color); padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-right: 10px; font-size: 18px;">
                    üîî
                    <span id="notificationBadge" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none; justify-content: center; align-items: center;">0</span>
                </button>
                <label class="theme-toggle" style="margin-right: 15px; vertical-align: middle;">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="theme-toggle-slider"></span>
                </label>
                <span id="usernameDisplay"></span>
                <button class="btn" onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
            </div>
        </div>
        
        <!-- Notification Panel -->
        <div id="notificationPanel" style="display: none; position: fixed; top: 80px; right: 20px; background: var(--bg-card); border-radius: 15px; box-shadow: 0 10px 40px var(--shadow-color); width: 400px; max-height: 500px; overflow-y: auto; z-index: 10000; padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: var(--text-primary);">Notifications</h3>
                <button onclick="closeNotifications()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">√ó</button>
            </div>
            <div id="notificationList"></div>
        </div>
        
        <div class="app-content">
            <nav id="sidebarNav" class="sidebar" aria-label="Main navigation" tabindex="-1">
                <button class="tab-btn active" onclick="switchTab('home', this)">üè† Home</button>
                <button class="tab-btn" onclick="switchTab('therapy', this)">ü§ñ AI Therapy</button>
                <button class="tab-btn" onclick="switchTab('mood', this)">üìä Mood & Habits</button>
                <button class="tab-btn" onclick="switchTab('safety', this)">üõ°Ô∏è Safety Check</button>
                <button class="tab-btn" onclick="switchTab('gratitude', this)">üôè Gratitude</button>
                <button class="tab-btn" onclick="switchTab('cbt', this)">üß† CBT Tools</button>
                <button class="tab-btn" onclick="switchTab('pet', this)">üê∂ My Pet</button>
                <button class="tab-btn" onclick="switchTab('clinical', this)">üìã Assessments</button>
                <button class="tab-btn" onclick="switchTab('community', this)">üë• Community</button>
                <button class="tab-btn" id="messagesTabBtn" onclick="switchTab('messages', this)">
                    üì¨ Messages
                    <span id="messagesBadge" style="background: #e74c3c; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; margin-left: 5px; display: none;"></span>
                </button>
                <button class="tab-btn" onclick="switchTab('insights', this)">üí° Insights</button>
                <button class="tab-btn" onclick="switchTab('appointments', this)">
                    üìÖ Appointments
                    <span id="appointmentBadge" style="background: #e74c3c; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; margin-left: 5px; display: none;">!</span>
                </button>
                <button class="tab-btn" onclick="switchTab('aboutme', this)">üë§ About Me</button>
                <button class="tab-btn" onclick="switchTab('history', this)">üìà History</button>
                <button class="tab-btn" onclick="switchTab('updates', this)">üÜï Updates</button>
                <button class="tab-btn" id="professionalTabBtn" onclick="switchTab('professional', this)" style="display:none;">üë®‚Äç‚öïÔ∏è Professional</button>
                <button class="tab-btn" id="developerTabBtn" onclick="switchTab('developer', this)" style="display:none;">‚öôÔ∏è Developer</button>
            </nav>
                <script>
                // Hamburger menu toggle for mobile sidebar
                const sidebar = document.getElementById('sidebarNav');
                const sidebarToggle = document.getElementById('sidebarToggle');
                function closeSidebar() {
                    sidebar.classList.remove('open');
                    sidebarToggle.setAttribute('aria-expanded', 'false');
                    document.body.classList.remove('sidebar-open');
                }
                function openSidebar() {
                    sidebar.classList.add('open');
                    sidebarToggle.setAttribute('aria-expanded', 'true');
                    document.body.classList.add('sidebar-open');
                    sidebar.focus();
                }
                sidebarToggle.addEventListener('click', function() {
                    if (sidebar.classList.contains('open')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                });
                // Close sidebar on ESC
                sidebar.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') closeSidebar();
                });
                // Hide sidebar on click outside (mobile)
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                        if (!sidebar.contains(e.target) && e.target !== sidebarToggle) closeSidebar();
                    }
                });
                // Responsive: show/hide hamburger
                function updateSidebarToggle() {
                    if (window.innerWidth <= 768) {
                        sidebarToggle.style.display = '';
                        sidebar.classList.remove('open');
                        document.body.classList.remove('sidebar-open');
                    } else {
                        sidebarToggle.style.display = 'none';
                        sidebar.classList.remove('open');
                        document.body.classList.remove('sidebar-open');
                    }
                }
                window.addEventListener('resize', updateSidebarToggle);
                window.addEventListener('DOMContentLoaded', updateSidebarToggle);
                </script>
            
            <div class="main-content">
            <!-- Home Tab -->
            <div id="homeTab" class="tab-content active">
                <!-- Welcome Section -->
                <div class="card home-welcome-card">
                    <div class="welcome-header">
                        <h2 id="homeWelcomeMessage">Welcome!</h2>
                        <p class="last-login-text" id="homeLastLogin">Loading...</p>
                    </div>
                    <div class="home-version-info">
                        <span class="app-version">Healing Space UK v22.1.0</span>
                    </div>
                    <div class="motivational-quote" id="homeMotivationalQuote">
                        Every day is a fresh start. You're doing great!
                    </div>
                </div>

                <!-- Daily Wellness Ritual - Chat Window (BEFORE Tasks) -->
                <div id="wellnessRitualContainer" class="card wellness-chat-card" style="margin-top: 20px;">
                    <!-- Chat Header -->
                    <div class="wellness-chat-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.8em;">üíô</span>
                            <div>
                                <h3 id="wellnessGreeting" style="margin: 0;">How are you really doing today?</h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9em;">Check in with a quick wellness ritual (2-3 min)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div style="padding: 0 20px;">
                        <div class="progress-bar-container" style="margin: 15px 0 10px 0;">
                            <div class="progress-bar-fill" id="wellnessProgressBar" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span class="progress-text" id="wellnessProgressText" style="font-size: 0.85em;">Step 1 of 10</span>
                            <button id="wellnessCollapseBtn" class="wellness-close-btn" onclick="toggleWellnessChat()" title="Minimize" style="background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--text-secondary);">‚àí</button>
                        </div>
                    </div>

                    <!-- Chat Messages Area -->
                    <div id="wellnessConversation" class="wellness-chat-messages">
                        <!-- Messages rendered here -->
                    </div>

                    <!-- Already Logged Message -->
                    <div id="wellnessAlreadyLogged" class="wellness-already-logged" style="display: none; text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin: 15px; position: relative;">
                        <button onclick="toggleWellnessChat()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--text-secondary);" title="Minimize">‚àí</button>
                        <p style="font-size: 1.1em; margin: 0 0 8px 0;">‚úÖ All set for today!</p>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.95em;">You've completed your wellness check-in. Come back tomorrow!</p>
                    </div>

                    <!-- Input Area -->
                    <div class="wellness-input-area" style="padding: 0 20px 20px 20px; display: flex; gap: 10px; justify-content: space-between;">
                        <button id="wellnessPrevBtn" class="btn btn-secondary" onclick="previousWellnessStep()" style="display: none; flex: 1;">‚Üê Back</button>
                        <button id="wellnessSkipBtn" class="btn btn-secondary" onclick="skipWellnessStep()" style="flex: 1;">Skip</button>
                        <button id="wellnessNextBtn" class="btn btn-primary" onclick="nextWellnessStep()" style="flex: 1;">Next ‚Üí</button>
                        <button id="wellnessSubmitBtn" class="btn btn-success" onclick="submitWellnessRitual()" style="display: none; flex: 1;">‚úì Done</button>
                    </div>
                </div>

                <!-- Daily Tasks Section -->
                <div class="card home-tasks-card" style="margin-top: 20px;">
                    <h3>Today's Wellness Tasks</h3>
                    <div class="daily-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="dailyProgressBar" style="width: 0%"></div>
                        </div>
                        <span class="progress-text" id="dailyProgressText">0/6 completed</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="initializeWellnessRitual()" style="width: 100%;">
                            üíô Start Your Daily Wellness Check-in
                        </button>
                    </div>
                    <div id="dailyTasksList" class="daily-tasks-list">
                        <!-- Tasks rendered dynamically -->
                    </div>
                    <div class="streak-display" id="streakDisplay">
                        <span class="streak-icon">üî•</span>
                        <span class="streak-count" id="streakCount">0</span> day streak
                    </div>
                </div>

                <!-- Quick Navigation Section -->
                <div class="card home-quick-nav" style="margin-top: 20px;">
                    <h3>Quick Access</h3>
                    <div class="quick-nav-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                        <button class="quick-nav-btn" onclick="switchTab('therapy', document.querySelector('[onclick*=&quot;therapy&quot;]'))">
                            ü§ñ AI Therapy
                        </button>
                        <button class="quick-nav-btn" onclick="switchTab('mood', document.querySelector('[onclick*=&quot;mood&quot;]'))">
                            üìä Log Mood
                        </button>
                        <button class="quick-nav-btn" onclick="switchTab('pet', document.querySelector('[onclick*=&quot;pet&quot;]'))">
                            üê∂ My Pet
                        </button>
                        <button class="quick-nav-btn" onclick="switchTab('gratitude', document.querySelector('[onclick*=&quot;gratitude&quot;]'))">
                            üôè Gratitude
                        </button>
                        <button class="quick-nav-btn" onclick="switchTab('cbt', document.querySelector('[onclick*=&quot;cbt&quot;]'))">
                            üß† CBT Tools
                        </button>
                        <button class="quick-nav-btn" onclick="switchTab('clinical', document.querySelector('[onclick*=&quot;clinical&quot;]'))">
                            üìã Assessments
                        </button>
                    </div>
                </div>

                <!-- Help & Documentation Section -->
                <div class="card home-help-card" style="margin-top: 20px;">
                    <h3>Help & Getting Started</h3>
                    <div class="help-links">
                        <button class="help-link" onclick="showQuickTips()">
                            üí° Quick Tips
                        </button>
                        <button class="help-link" onclick="switchTab('updates', document.querySelector('[onclick*=&quot;updates&quot;]'))">
                            üÜï What's New
                        </button>
                        <button class="help-link" onclick="switchTab('cbt', document.querySelector('[onclick*=&quot;cbt&quot;]')); setTimeout(() => loadCBTTool('SafetyPlanBuilder'), 200);">
                            üÜò Safety Plan Builder
                        </button>
                    </div>
                    <div id="quickTipsPanel" class="quick-tips-content" style="display: none; margin-top: 15px;">
                        <div class="card" style="background: var(--bg-secondary);">
                            <p><strong>Getting Started:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                                <li>Log your mood daily to track patterns</li>
                                <li>Chat with AI Therapy when you need support</li>
                                <li>Complete daily tasks to earn pet rewards</li>
                                <li>Use CBT tools for structured exercises</li>
                                <li>Check on your virtual pet regularly</li>
                                <li>Build your streak for bonus rewards!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Pet Status Mini Card -->
                <div class="card home-pet-card" style="margin-top: 20px;" id="homePetCard">
                    <h3>üêæ Your Pet</h3>
                    <div id="homePetStatus" style="display: flex; align-items: center; gap: 20px;">
                        <span id="homePetEmoji" style="font-size: 48px;">üêæ</span>
                        <div>
                            <p><strong id="homePetName">No pet yet</strong></p>
                            <p style="color: var(--text-secondary);">ü™ô <span id="homePetCoins">0</span> coins | ‚≠ê <span id="homePetXP">0</span> XP</p>
                        </div>
                        <button class="btn btn-secondary" onclick="switchTab('pet', document.querySelector('[onclick*=&quot;pet&quot;]'))" style="margin-left: auto;">
                            Visit Pet
                        </button>
                    </div>
                </div>

                <!-- Developer Feedback Section -->
                <div class="card home-feedback-card" style="margin-top: 20px;">
                    <h3>Send Feedback to Developers</h3>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="feedbackCategory" class="themed-input">
                            <option value="bug">üêõ Bug Report</option>
                            <option value="feature">üí° Feature Request</option>
                            <option value="improvement">‚ú® Improvement Suggestion</option>
                            <option value="other">üìù Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Message</label>
                        <textarea id="feedbackMessage" class="themed-textarea" rows="4"
                                  placeholder="Share your feedback, report issues, or suggest improvements..."></textarea>
                    </div>
                    <button class="btn" onclick="submitFeedback()">Send Feedback</button>
                    <p id="feedbackStatus" style="margin-top: 10px; display: none;"></p>
                </div>

                <!-- Safety & Crisis Resources (Always Visible) -->
                <div class="card crisis-resources-box home-safety-card" style="margin-top: 20px;">
                    <h4 class="crisis-title">üÜò Need Immediate Help?</h4>
                    <p><strong>Samaritans:</strong> Call 116 123 (24/7 free)</p>
                    <p><strong>Crisis Text Line:</strong> Text SHOUT to 85258</p>
                    <p><strong>NHS Crisis:</strong> Call 111 (option 2)</p>
                    <button class="btn btn-secondary" style="margin-top: 15px;" onclick="switchTab('cbt', document.querySelector('[onclick*=&quot;cbt&quot;]')); setTimeout(() => loadCBTTool('SafetyPlanBuilder'), 200);">
                        View Safety Plan Builder
                    </button>
                </div>
            </div>

            <!-- Therapy Chat Tab -->
            <div id="therapyTab" class="tab-content">
                <h3 id="therapyChatTitle">Your Therapy Session</h3>
                <p style="color: #666; margin-bottom: 20px;">Share your thoughts and feelings in a safe, confidential space.</p>
                
                <!-- Chat Sessions Manager -->
                <div class="chat-sessions">
                    <div class="sessions-header">
                        <button onclick="showSessionsDropdown()" class="btn-secondary" id="currentSessionBtn">
                            üí¨ Main Chat
                        </button>
                        <button onclick="createNewSession()" class="btn-secondary">‚ûï New Chat</button>
                    </div>
                    <div id="sessionsDropdown" class="sessions-dropdown" style="display:none;">
                        <div id="sessionsList"></div>
                    </div>
                </div>
                
                <!-- Chat Controls -->
                <div class="chat-controls">
                    <div class="search-bar">
                        <input type="text" id="chatSearch" placeholder="üîç Search messages..." oninput="searchMessages()">
                        <button onclick="clearSearch()" id="clearSearchBtn" style="display:none;">Clear</button>
                    </div>
                    <div class="chat-actions">
                        <button onclick="showExportDialog()" class="btn-secondary">üì• Export</button>
                        <button onclick="loadChatHistory()" class="btn-secondary">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <textarea id="chatInput" placeholder="Type your message or use the microphone..." rows="2" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        <div class="chat-input-buttons">
                            <button id="voiceBtn" onclick="toggleVoiceInput()" class="voice-btn" title="Voice input">
                                üé§
                            </button>
                            <button onclick="toggleSuggestionManager()" class="voice-btn" title="Manage AI preferences (/suggest)" style="font-size:1.1em;">
                                ‚öôÔ∏è
                            </button>
                            <button onclick="sendMessage()" class="send-btn">Send</button>
                        </div>
                    </div>
                    <div id="voiceStatus" class="voice-status" style="display: none;">
                        <span class="voice-indicator"></span>
                        <span id="voiceStatusText">Listening...</span>
                    </div>
                    <!-- Suggestion Manager Panel -->
                    <div id="suggestionManager" style="display:none; padding:12px 16px; margin:0 8px 8px; background:var(--card-bg, #f8f9fa); border-radius:8px; border:1px solid var(--border-color, #e0e0e0);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong style="font-size:0.95em;">Your AI Preferences</strong>
                            <button onclick="toggleSuggestionManager()" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted, #666);" title="Close">&times;</button>
                        </div>
                        <div id="suggestionList"></div>
                        <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border-color, #e0e0e0);">
                            <small style="color: var(--text-muted, #888);">Type <strong>/suggest</strong> followed by your feedback in chat to train the AI.<br>Example: <em>/suggest Be more direct and less repetitive</em></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Dialog -->
            <div id="exportChatDialog" class="modal" style="display:none;">
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeExportDialog()">&times;</span>
                    <h3>Export Chat History</h3>
                    <div class="form-group">
                        <label>From Date:</label>
                        <input type="date" id="exportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date:</label>
                        <input type="date" id="exportToDate">
                    </div>
                    <div class="form-group">
                        <label>Format:</label>
                        <select id="exportFormat">
                            <option value="txt">Text File (.txt)</option>
                            <option value="json">JSON (.json)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="exportChat()" class="btn">Export</button>
                        <button onclick="closeExportDialog()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Active Patients Modal -->
            <div id="activePatientsModal" class="modal" style="display:none;">
                <div class="modal-content" style="max-width: 700px;">
                    <span class="close" onclick="closeActivePatientsModal()">&times;</span>
                    <h3>üëÅÔ∏è Active Patients (Last 7 Days)</h3>
                    <p style="color: #666; margin-bottom: 20px;">Patients who have logged in, logged mood, or chatted in the past 7 days</p>
                    <div id="activePatientsListContent" style="max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">Loading...</p>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="closeActivePatientsModal()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
            
            <!-- Safety Check Tab (C-SSRS & Real-time Risk Detection) -->
            <div id="safetyTab" class="tab-content">
                <h3>üõ°Ô∏è Safety Check & Suicide Risk Assessment</h3>
                <p style="color: #666; margin-bottom: 20px;">A confidential assessment to understand how you're feeling and connect you with support.</p>
                
                <!-- Risk Indicator Display (shown when risk detected) -->
                <div id="riskIndicatorContainer" class="card risk-indicator-card" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="riskIndicatorDot" class="risk-dot" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;"></div>
                        <div>
                            <h4 id="riskIndicatorTitle" style="margin: 0 0 5px 0;">Risk Status</h4>
                            <p id="riskIndicatorMessage" style="margin: 0; color: var(--text-secondary);"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Assessment not yet started -->
                <div id="safetyStartScreen" class="card" style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 3em; margin-bottom: 15px;">üíô</div>
                    <h4>Your Well-being Matters</h4>
                    <p style="color: #666; margin: 15px 0;">This brief assessment takes about 3-4 minutes and helps us understand what you're experiencing so we can provide the right support.</p>
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left; font-size: 0.9em;">
                        <p style="margin: 5px 0;"><strong>What we ask about:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Thoughts about suicide or self-harm</li>
                            <li>Any plans or intent to harm yourself</li>
                            <li>Past attempts or actions</li>
                            <li>Your ability to cope right now</li>
                        </ul>
                        <p style="margin: 5px 0; color: #666;"><em>Your responses are completely confidential and will be stored securely.</em></p>
                    </div>
                    <button class="btn btn-primary" onclick="startSafetyAssessment()" style="margin-top: 20px; width: 100%; padding: 12px;">
                        ‚úì Start Assessment
                    </button>
                    <button class="btn btn-secondary" onclick="skipSafetyAssessment()" style="margin-top: 10px; width: 100%; padding: 12px;">
                        Skip for Now
                    </button>
                </div>
                
                <!-- Assessment Questions -->
                <div id="safetyAssessmentContainer" style="display: none;">
                    <div class="card assessment-card">
                        <div class="assessment-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="assessmentProgressBar" style="width: 0%;"></div>
                            </div>
                            <span class="progress-text" id="assessmentProgressText">Question 1 of 6</span>
                        </div>
                        
                        <div id="assessmentQuestionsArea"></div>
                        
                        <div class="assessment-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" id="assessmentPrevBtn" onclick="previousAssessmentQuestion()" style="display: none; flex: 1;">‚Üê Back</button>
                            <button class="btn btn-secondary" onclick="skipAssessmentQuestion()" style="flex: 1;">Skip Question</button>
                            <button class="btn btn-primary" id="assessmentNextBtn" onclick="nextAssessmentQuestion()" style="flex: 1;">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Screen -->
                <div id="safetyResultsContainer" style="display: none;">
                    <div class="card results-card">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div id="resultsRiskIndicator" style="font-size: 4em; margin-bottom: 15px;">üü¢</div>
                            <h3 id="resultsRiskTitle">Assessment Complete</h3>
                            <p id="resultsRiskMessage" style="color: #666; margin: 10px 0;"></p>
                        </div>
                        
                        <!-- Risk Level Specific Content -->
                        <div id="resultsLowRiskContent" style="display: none;">
                            <div class="card" style="background: #e8f8e8; border-left: 4px solid #27ae60; padding: 15px;">
                                <h4 style="margin-top: 0; color: #27ae60;">‚úì You're Doing Well</h4>
                                <p>Based on your responses, you're not currently at high risk. Keep up the self-care and reach out if things change.</p>
                                <p style="color: #666; font-size: 0.9em;"><strong>Remember:</strong> It's always okay to ask for help if you need it.</p>
                            </div>
                        </div>
                        
                        <div id="resultsModerateRiskContent" style="display: none;">
                            <div class="card" style="background: #fff8e8; border-left: 4px solid #f39c12; padding: 15px;">
                                <h4 style="margin-top: 0; color: #f39c12;">‚ö†Ô∏è Some Concern</h4>
                                <p>You've mentioned some concerning thoughts. We want to help you feel better and work through this together.</p>
                                <p style="color: #666;"><strong>Next steps:</strong> A clinician will review your responses and may contact you within 24 hours.</p>
                            </div>
                        </div>
                        
                        <div id="resultsHighRiskContent" style="display: none;">
                            <div class="card" style="background: #ffe8e8; border-left: 4px solid #e74c3c; padding: 15px;">
                                <h4 style="margin-top: 0; color: #e74c3c;">üö® We're Here to Help</h4>
                                <p>Based on your responses, we're concerned about your safety. You're not alone, and help is available right now.</p>
                                <p style="margin: 15px 0;"><strong>Immediate support:</strong></p>
                                <ul style="margin: 10px 0;">
                                    <li><strong>Crisis Line:</strong> Samaritans 116 123 (24/7, free, confidential)</li>
                                    <li><strong>Emergency:</strong> Call 999 or go to nearest A&E</li>
                                    <li><strong>Your Clinician:</strong> Will be notified immediately</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Safety Plan Section (shown for Moderate/High/Critical) -->
                        <div id="safetyPlanSection" style="display: none; margin-top: 30px;">
                            <h4>üìã Your Safety Plan</h4>
                            <p style="color: #666; margin-bottom: 15px;">Let's create a safety plan to help you through difficult moments.</p>
                            
                            <div class="safety-plan-form">
                                <div class="form-group">
                                    <label>‚ö†Ô∏è What tells you a crisis is coming? (warning signs)</label>
                                    <textarea id="safetyWarningSigns" placeholder="e.g., can't sleep, getting angry, thinking about past failures..." style="height: 80px;"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>üí° What can you do alone to cope? (internal coping)</label>
                                    <textarea id="safetyCopingInternal" placeholder="e.g., deep breathing, listen to music, journal..." style="height: 80px;"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>üåç People/places that distract you from the crisis</label>
                                    <textarea id="safetyDistractions" placeholder="e.g., call a friend, go to the park, watch my favorite show..." style="height: 80px;"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>ü§ù People you can contact during a crisis</label>
                                    <div id="safetyPeopleList" style="margin-bottom: 10px;"></div>
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="text" id="safetyPersonName" placeholder="Name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <input type="tel" id="safetyPersonPhone" placeholder="Phone" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <button class="btn" onclick="addSafetyPerson()" style="padding: 8px 15px;">+ Add</button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>‚öïÔ∏è Professional Support</label>
                                    <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em;">
                                        <p style="margin: 5px 0;"><strong>Your Clinician:</strong> <span id="safetyClinicianInfo">Loading...</span></p>
                                        <p style="margin: 5px 0;"><strong>Crisis Services:</strong> Samaritans 116 123</p>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>üîí How can you make your environment safer?</label>
                                    <textarea id="safetyEnvironment" placeholder="e.g., remove medications, give house key to trusted person..." style="height: 80px;"></textarea>
                                </div>
                                
                                <button class="btn btn-primary" onclick="saveSafetyPlan()" style="width: 100%; padding: 12px; margin-top: 15px;">
                                    ‚úì Save My Safety Plan
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeSafetyAssessment()" style="padding: 12px 30px;">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gratitude Journal Tab -->
            <div id="gratitudeTab" class="tab-content">
                <h3>Gratitude Journal</h3>
                <p style="color: #666; margin-bottom: 20px;">What are you grateful for today?</p>
                
                <div class="form-group">
                    <textarea id="gratitudeEntry" placeholder="Write about something you're grateful for today..."></textarea>
                </div>
                
                <button class="btn" onclick="logGratitude()">Save Entry</button>
                <div id="gratitudeMessage" class="hidden"></div>
            </div>
            
            <!-- CBT Tools Tab -->
            <div id="cbtTab" class="tab-content">
                                <h3>Cognitive Behavioral Therapy Tools</h3>
                                <p style="color: #666; margin-bottom: 20px;">Select a CBT tool below to get started. Your progress is saved for each tool.</p>
                                <div id="cbtToolsDashboard" class="cbt-tools-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 30px;"></div>
                                <div id="cbtToolLoader" class="cbt-tool-loader" style="min-height: 320px;"></div>
                                <div id="cbtToolMessage" class="hidden"></div>
                                <script>
                                // --- CBT Tools Dashboard & Loader ---
                                const CBT_TOOLS = [
                                    { id: 'CognitiveDistortionsQuiz', name: 'Cognitive Distortions Quiz', icon: 'üß©' },
                                    { id: 'CoreBeliefsWorksheet', name: 'Core Beliefs Worksheet', icon: 'üß†' },
                                    { id: 'ThoughtDefusionExercise', name: 'Thought Defusion Exercise', icon: 'üå¨Ô∏è' },
                                    { id: 'IfThenCopingPlan', name: 'If-Then Coping Plan', icon: 'üîó' },
                                    { id: 'CopingSkillsSelector', name: 'Coping Skills Selector', icon: 'üõ†Ô∏è' },
                                    { id: 'SelfCompassionLetter', name: 'Self-Compassion Letter', icon: 'üíå' },
                                    { id: 'ProblemSolvingWorksheet', name: 'Problem Solving Worksheet', icon: 'üìù' },
                                    { id: 'ExposureHierarchyBuilder', name: 'Exposure Hierarchy Builder', icon: 'üèîÔ∏è' },
                                    { id: 'RelaxationAudioPlayer', name: 'Guided Breathing Exercise', icon: 'üßò' },
                                    { id: 'UrgeSurfingTimer', name: 'Urge Surfing Timer', icon: 'üèÑ' },
                                    { id: 'ValuesCardSort', name: 'Values Card Sort', icon: 'üÉè' },
                                    { id: 'StrengthsInventory', name: 'Strengths Inventory', icon: 'üí™' },
                                    { id: 'SleepHygieneChecklist', name: 'Sleep Hygiene Checklist', icon: 'üò¥' },
                                    { id: 'SafetyPlanBuilder', name: 'Safety Plan Builder', icon: 'ü¶∫' },
                                    { id: 'ActivityScheduler', name: 'Activity Scheduler', icon: 'üìÖ' }
                                ];

                                function renderCBTToolsDashboard() {
                                    const dash = document.getElementById('cbtToolsDashboard');
                                    dash.innerHTML = CBT_TOOLS.map(tool => `
                                        <button class="cbt-tool-btn" style="padding: 22px 10px; border-radius: 14px; border: 2px solid var(--border-color); background: var(--bg-card); font-size: 18px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: box-shadow .2s; box-shadow: 0 2px 8px var(--shadow-color);" onclick="loadCBTTool('${tool.id}')">
                                            <span style="font-size: 2.2em;">${tool.icon}</span>
                                            <span>${tool.name}</span>
                                        </button>
                                    `).join('');
                                }

                                async function loadCBTTool(toolId) {
                                    const loader = document.getElementById('cbtToolLoader');
                                    loader.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px;">Loading...</div>';
                                    try {
                                        const resp = await fetch(`/cbt_tools/components/${toolId}.html?_t=${Date.now()}`);
                                        if (!resp.ok) throw new Error('Failed to load tool');
                                        let html = await resp.text();
                                        // Inject Save/Load buttons if not present
                                        html += `
                                            <div style='margin-top:30px; display:flex; gap:12px;'>
                                                <button class='btn' onclick="saveCBTToolData('${toolId}')">üíæ Save</button>
                                                <button class='btn btn-secondary' onclick="loadCBTToolData('${toolId}')">‚ü≥ Load</button>
                                                <span id='cbtToolSaveStatus' style='margin-left:15px; color:var(--success-color); display:none;'></span>
                                            </div>
                                        `;
                                        loader.innerHTML = html;
                                        // Auto-load data on tool open
                                        setTimeout(() => loadCBTToolData(toolId), 100);
                                    } catch (e) {
                                        loader.innerHTML = `<div style='color:var(--danger-color); padding:40px;'>Error loading tool: ${e.message}</div>`;
                                    }
                                }

                                // Save tool data (collects all inputs/textareas in the tool loader)
                                async function saveCBTToolData(toolId) {
                                    const loader = document.getElementById('cbtToolLoader');
                                    const inputs = loader.querySelectorAll('input, textarea, select');
                                    const data = {};
                                    inputs.forEach(el => {
                                        if (el.type === 'checkbox' || el.type === 'radio') {
                                            data[el.id || el.name] = el.checked;
                                        } else {
                                            data[el.id || el.name] = el.value;
                                        }
                                    });
                                    try {
                                        const resp = await fetch('/api/cbt-tools/save', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ tool_type: toolId, data, username: currentUser })
                                        });
                                        if (!resp.ok) throw new Error('Save failed');
                                        showCBTToolStatus('Saved!', true);

                                        // Trigger confetti and pet reward
                                        triggerConfetti();
                                        showPetReward(toolId);
                                    } catch (e) {
                                        showCBTToolStatus('Save error', false);
                                    }
                                }

                                // Load tool data (populates all inputs/textareas in the tool loader)
                                async function loadCBTToolData(toolId) {
                                    const loader = document.getElementById('cbtToolLoader');
                                    try {
                                        const resp = await fetch(`/api/cbt-tools/load?tool_type=${encodeURIComponent(toolId)}&username=${encodeURIComponent(currentUser)}`);
                                        if (!resp.ok) {
                                            // Silently fail on auto-load if no saved data exists (404)
                                            return;
                                        }
                                        const result = await resp.json();
                                        if (result && result.data) {
                                            Object.entries(result.data).forEach(([key, value]) => {
                                                const el = loader.querySelector(`#${key}, [name='${key}']`);
                                                if (el) {
                                                    if (el.type === 'checkbox' || el.type === 'radio') {
                                                        el.checked = !!value;
                                                    } else {
                                                        el.value = value;
                                                    }
                                                }
                                            });
                                            showCBTToolStatus('Loaded!', true);
                                        }
                                    } catch (e) {
                                        // Silently fail on auto-load - no saved data is normal
                                    }
                                }

                                function showCBTToolStatus(msg, success) {
                                    const status = document.getElementById('cbtToolSaveStatus');
                                    if (!status) return;
                                    status.textContent = msg;
                                    status.style.color = success ? 'var(--success-color)' : 'var(--danger-color)';
                                    status.style.display = 'inline';
                                    setTimeout(() => { status.style.display = 'none'; }, 2000);
                                }

                                // Render dashboard on tab show
                                document.addEventListener('DOMContentLoaded', () => {
                                    if (document.getElementById('cbtToolsDashboard')) renderCBTToolsDashboard();
                                });

                                // ========== PHASE 1 GAMIFICATION FUNCTIONS ==========

                                // Confetti Animation
                                function triggerConfetti() {
                                    const container = document.createElement('div');
                                    container.className = 'confetti-container';
                                    document.body.appendChild(container);

                                    const colors = ['#667eea', '#764ba2', '#f39c12', '#e74c3c', '#27ae60', '#3498db'];
                                    const confettiCount = 50;

                                    for (let i = 0; i < confettiCount; i++) {
                                        const confetti = document.createElement('div');
                                        confetti.className = 'confetti';
                                        confetti.style.left = Math.random() * 100 + '%';
                                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                                        confetti.style.animationDuration = (Math.random() * 1 + 2) + 's';
                                        container.appendChild(confetti);
                                    }

                                    setTimeout(() => container.remove(), 3000);
                                }

                                // Success Popup
                                function showSuccessPopup(message = 'üéâ Great Work!') {
                                    const popup = document.createElement('div');
                                    popup.className = 'success-popup';
                                    popup.textContent = message;
                                    document.body.appendChild(popup);
                                    setTimeout(() => popup.remove(), 2000);
                                }

                                // Pet Reward Message
                                const PET_MESSAGES = {
                                    'CognitiveDistortionsQuiz': ['üß© Your pet is impressed by your detective work!', 'üê∂ Woof! You caught those tricky thoughts!'],
                                    'CoreBeliefsWorksheet': ['üß† Your pet feels your growth!', 'üê± Purr-fect self-reflection!'],
                                    'ThoughtDefusionExercise': ['üå¨Ô∏è Your pet breathes easier with you!', 'üê∞ Hop hop! Those thoughts are floating away!'],
                                    'IfThenCopingPlan': ['üîó Your pet loves your planning skills!', 'ü¶ä Smart planning = happy pet!'],
                                    'CopingSkillsSelector': ['üõ†Ô∏è Your pet is proud of your toolkit!', 'üêº Awesome coping skills!'],
                                    'SelfCompassionLetter': ['üíå Your pet sends you love!', 'üêß Your kindness to yourself warms my heart!'],
                                    'ProblemSolvingWorksheet': ['üìù Your pet admires your problem-solving!', 'üê∂ You are tackling this like a champion!'],
                                    'ExposureHierarchyBuilder': ['üèîÔ∏è Your pet is climbing with you!', 'ü¶ä Brave steps = happy pet!'],
                                    'RelaxationAudioPlayer': ['üßò Your pet is breathing with you!', 'üê± Deep breaths = peaceful vibes!'],
                                    'UrgeSurfingTimer': ['üèÑ Your pet is riding the waves with you!', 'üê∞ Surf is up! You are doing great!'],
                                    'ValuesCardSort': ['üÉè Your pet values you!', 'üêº Your values shine bright!'],
                                    'StrengthsInventory': ['üí™ Your pet sees your strength!', 'üêß You are stronger than you think!'],
                                    'SleepHygieneChecklist': ['üò¥ Your pet is getting sleepy too!', 'üê∂ Sweet dreams coming your way!'],
                                    'SafetyPlanBuilder': ['ü¶∫ Your pet feels safer with you!', 'ü¶ä Safety first! Great job!'],
                                    'ActivityScheduler': ['üìÖ Your pet loves your planning!', 'üê± Scheduled fun = happy times!']
                                };

                                function showPetReward(toolId) {
                                    const messages = PET_MESSAGES[toolId] || ['üê∂ Your pet is proud of you!', '‚ú® Keep up the great work!'];
                                    const message = messages[Math.floor(Math.random() * messages.length)];

                                    const petMsg = document.createElement('div');
                                    petMsg.className = 'pet-reward-message';
                                    petMsg.innerHTML = `
                                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${message}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">+10 XP ‚Ä¢ +5 Coins</div>
                                    `;
                                    document.body.appendChild(petMsg);
                                    setTimeout(() => petMsg.remove(), 3500);
                                }

                                // Create Emoji Mood Selector
                                function createEmojiMoodSelector(containerId, onSelectCallback) {
                                    const moods = [
                                        { emoji: 'üò∞', value: 1, label: 'Very Anxious' },
                                        { emoji: 'üòü', value: 3, label: 'Anxious' },
                                        { emoji: 'üòê', value: 5, label: 'Neutral' },
                                        { emoji: 'üôÇ', value: 7, label: 'Good' },
                                        { emoji: 'üòä', value: 10, label: 'Great' }
                                    ];

                                    const container = document.getElementById(containerId);
                                    if (!container) return;

                                    container.innerHTML = `
                                        <div class="emoji-mood-selector">
                                            ${moods.map(mood => `
                                                <div class="mood-emoji-group">
                                                    <button type="button" class="emoji-mood-btn" data-mood="${mood.value}" onclick="selectEmojiMood(this, ${mood.value}, '${containerId}')">
                                                        ${mood.emoji}
                                                    </button>
                                                    <div class="emoji-mood-label">${mood.label}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" id="${containerId}_value" name="${containerId}_value" />
                                    `;
                                }

                                function selectEmojiMood(btn, value, containerId) {
                                    // Remove selected class from all buttons in this container
                                    const container = document.getElementById(containerId);
                                    container.querySelectorAll('.emoji-mood-btn').forEach(b => b.classList.remove('selected'));

                                    // Add selected class to clicked button
                                    btn.classList.add('selected');

                                    // Store value in hidden input
                                    const hiddenInput = document.getElementById(containerId + '_value');
                                    if (hiddenInput) hiddenInput.value = value;
                                }

                                // Enhanced Save with Gamification
                                const originalSaveCBTToolData = saveCBTToolData;
                                saveCBTToolData = async function(toolId) {
                                    try {
                                        await originalSaveCBTToolData(toolId);

                                        // Trigger celebrations!
                                        triggerConfetti();
                                        showSuccessPopup('üéâ Saved!');
                                        showPetReward(toolId);

                                        // Try to trigger pet reward on backend
                                        try {
                                            await fetch('/api/pet/reward', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ action: 'cbt_tool_complete', tool_type: toolId })
                                            });
                                        } catch (e) {
                                            console.log('Pet reward optional feature not available');
                                        }
                                    } catch (e) {
                                        console.error('Save error:', e);
                                    }
                                };

                                // ========== PHASE 2 GAMIFICATION FUNCTIONS ==========

                                // Achievement System
                                const ACHIEVEMENTS = {
                                    'first_tool': { icon: 'üéØ', title: 'First Step', description: 'Completed your first tool', tier: 'bronze' },
                                    'thought_detective': { icon: 'üîç', title: 'Thought Detective', description: 'Completed 5 Cognitive Distortion quizzes', tier: 'silver' },
                                    'defusion_master': { icon: 'üå¨Ô∏è', title: 'Defusion Master', description: 'Completed 10 Thought Defusion exercises', tier: 'gold' },
                                    'week_streak': { icon: 'üî•', title: 'Week Warrior', description: '7-day streak on any tool', tier: 'silver' },
                                    'mood_improver': { icon: 'üìà', title: 'Mood Improver', description: 'Improved mood 10 times', tier: 'gold' },
                                    'all_tools': { icon: 'üèÜ', title: 'Tool Explorer', description: 'Tried all 15 CBT tools', tier: 'platinum' },
                                    'consistent_practice': { icon: '‚≠ê', title: 'Consistent Practice', description: '30-day streak', tier: 'platinum' }
                                };

                                let unlockedAchievements = JSON.parse(localStorage.getItem('cbt_achievements') || '[]');
                                let toolStreaks = JSON.parse(localStorage.getItem('cbt_tool_streaks') || '{}');
                                let toolUsageCount = JSON.parse(localStorage.getItem('cbt_tool_usage') || '{}');
                                let moodImprovements = parseInt(localStorage.getItem('mood_improvements') || '0');

                                function showBadgeUnlock(achievementId) {
                                    const achievement = ACHIEVEMENTS[achievementId];
                                    if (!achievement || unlockedAchievements.includes(achievementId)) return;

                                    unlockedAchievements.push(achievementId);
                                    localStorage.setItem('cbt_achievements', JSON.stringify(unlockedAchievements));

                                    const popup = document.createElement('div');
                                    popup.className = 'badge-popup';
                                    popup.innerHTML = `
                                        <div class="badge-icon">${achievement.icon}</div>
                                        <h2 style="margin-bottom: 10px; font-size: 2em;">Achievement Unlocked!</h2>
                                        <div style="font-size: 1.3em; margin-bottom: 5px; font-weight: 600;">${achievement.title}</div>
                                        <div style="opacity: 0.9;">${achievement.description}</div>
                                    `;
                                    document.body.appendChild(popup);
                                    setTimeout(() => popup.remove(), 3500);
                                }

                                function checkAchievements(toolId) {
                                    // Track tool usage
                                    toolUsageCount[toolId] = (toolUsageCount[toolId] || 0) + 1;
                                    localStorage.setItem('cbt_tool_usage', JSON.stringify(toolUsageCount));

                                    const totalTools = Object.keys(toolUsageCount).length;
                                    const totalUses = Object.values(toolUsageCount).reduce((a, b) => a + b, 0);

                                    // Check achievements
                                    if (totalUses === 1) showBadgeUnlock('first_tool');
                                    if (toolUsageCount['CognitiveDistortionsQuiz'] >= 5) showBadgeUnlock('thought_detective');
                                    if (toolUsageCount['ThoughtDefusionExercise'] >= 10) showBadgeUnlock('defusion_master');
                                    if (totalTools >= 15) showBadgeUnlock('all_tools');
                                    if (moodImprovements >= 10) showBadgeUnlock('mood_improver');

                                    // Check streaks
                                    const currentStreak = toolStreaks[toolId] || { count: 0, lastDate: null };
                                    const today = new Date().toDateString();
                                    if (currentStreak.lastDate !== today) {
                                        currentStreak.count += 1;
                                        currentStreak.lastDate = today;
                                        toolStreaks[toolId] = currentStreak;
                                        localStorage.setItem('cbt_tool_streaks', JSON.stringify(toolStreaks));

                                        if (currentStreak.count >= 7) showBadgeUnlock('week_streak');
                                        if (currentStreak.count >= 30) showBadgeUnlock('consistent_practice');
                                    }
                                }

                                // Before/After Mood Visualization
                                function showMoodComparison(beforeMood, afterMood) {
                                    if (!beforeMood || !afterMood) return;

                                    const improvement = afterMood - beforeMood;
                                    if (improvement > 0) {
                                        moodImprovements += 1;
                                        localStorage.setItem('mood_improvements', moodImprovements.toString());
                                    }

                                    const emojis = {
                                        1: 'üò∞', 3: 'üòü', 5: 'üòê', 7: 'üôÇ', 10: 'üòä'
                                    };

                                    const container = document.createElement('div');
                                    container.className = 'mood-comparison';
                                    container.innerHTML = `
                                        <div class="mood-before">
                                            <div class="mood-label">Before</div>
                                            <div class="mood-value">${emojis[beforeMood] || 'üòê'}</div>
                                            <div>${beforeMood}/10</div>
                                        </div>
                                        <div class="mood-comparison-arrow">‚Üí</div>
                                        <div class="mood-after">
                                            <div class="mood-label">After</div>
                                            <div class="mood-value">${emojis[afterMood] || 'üòê'}</div>
                                            <div>${afterMood}/10</div>
                                        </div>
                                    `;

                                    if (improvement > 0) {
                                        container.innerHTML += `
                                            <div class="mood-improvement">
                                                +${improvement} improvement! üéâ
                                            </div>
                                        `;
                                    }

                                    // Find a good place to show it (after tool loader)
                                    const loader = document.getElementById('cbtToolLoader');
                                    if (loader) {
                                        const existing = loader.querySelector('.mood-comparison');
                                        if (existing) existing.remove();
                                        loader.appendChild(container);
                                    }
                                }

                                // Streak Display
                                function showStreakCounter(toolId) {
                                    const streak = toolStreaks[toolId];
                                    if (!streak || streak.count === 0) return;

                                    const counter = document.createElement('div');
                                    counter.className = 'streak-counter';
                                    counter.innerHTML = `
                                        <span class="streak-flame">üî•</span>
                                        <span class="streak-number">${streak.count}</span>
                                        <span>Day Streak!</span>
                                    `;
                                    counter.style.position = 'fixed';
                                    counter.style.top = '20px';
                                    counter.style.right = '20px';
                                    counter.style.zIndex = '9999';
                                    document.body.appendChild(counter);
                                    setTimeout(() => counter.remove(), 4000);
                                }

                                // Enhanced Save with Phase 2 Features
                                const originalEnhancedSave = saveCBTToolData;
                                saveCBTToolData = async function(toolId) {
                                    // Get before mood if available
                                    const beforeMoodInput = document.querySelector('[name="mood_before_value"], [id$="_before_value"]');
                                    const afterMoodInput = document.querySelector('[name="mood_rating"], [name*="mood"], [id$="_value"]');
                                    const beforeMood = beforeMoodInput ? parseInt(beforeMoodInput.value) : null;
                                    const afterMood = afterMoodInput ? parseInt(afterMoodInput.value) : null;

                                    // Call original save
                                    await originalEnhancedSave(toolId);

                                    // Phase 2 features
                                    checkAchievements(toolId);
                                    showStreakCounter(toolId);
                                    if (beforeMood && afterMood) {
                                        showMoodComparison(beforeMood, afterMood);
                                    }
                                };

                                // Optionally, re-render on tab switch if needed
                                </script>
            </div>
            
            <!-- Pet Game Tab -->
            <div id="petTab" class="tab-content">
                <div id="petCreate" class="hidden">
                    <h3>üè° Adopt Your Companion</h3>
                    <p style="color: #666; margin-bottom: 20px;">Choose a virtual pet to care for as you care for yourself.</p>
                    
                    <div class="form-group">
                        <label>Pet Name</label>
                        <input type="text" id="petName" placeholder="e.g., Buddy">
                    </div>
                    <div class="form-group">
                        <label>Species</label>
                        <select id="petSpecies" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Dog">üê∂ Dog</option>
                            <option value="Cat">üê± Cat</option>
                            <option value="Rabbit">üê∞ Rabbit</option>
                            <option value="Fox">ü¶ä Fox</option>
                            <option value="Panda">üêº Panda</option>
                            <option value="Penguin">üêß Penguin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="petGender" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Neutral">Neutral</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createPet()">Adopt Pet!</button>
                </div>
                
                <div id="petDisplay" class="hidden">
                    <div class="pet-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="petNameDisplay" style="margin: 0;"></h3>
                            <div>
                                <span style="font-size: 18px; font-weight: bold;">ü™ô <span id="petCoins">0</span></span>
                                <span style="font-size: 14px; margin-left: 15px;">‚≠ê <span id="petXP">0</span> (<span id="petStage">Baby</span>)</span>
                            </div>
                        </div>
                        
                        <div class="pet-display" id="petEmojiDisplay" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 16px; padding: 40px; text-align: center; font-size: 80px; margin-bottom: 20px; min-height: 150px; display: flex; align-items: center; justify-content: center; position: relative;">
                            <div id="petStatusMessage" style="position: absolute; top: 10px; left: 10px; right: 10px; font-size: 14px; color: #666; font-weight: 500;"></div>
                        </div>
                        
                        <div class="pet-stats">
                            <div class="stat-bar">
                                <label>üçî Hunger</label>
                                <div class="progress-bar"><div class="progress-fill" id="hungerBar" style="background: #e74c3c;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>üòä Happiness</label>
                                <div class="progress-bar"><div class="progress-fill" id="happinessBar" style="background: #2ecc71;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>‚ö° Energy</label>
                                <div class="progress-bar"><div class="progress-fill" id="energyBar" style="background: #f1c40f;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>üßπ Hygiene</label>
                                <div class="progress-bar"><div class="progress-fill" id="hygieneBar" style="background: #3498db;"></div></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="openShop()" style="background: #e67e22; position: relative; z-index: 1;">üõçÔ∏è Shop</button>
                            <button class="btn" onclick="openDeclutter()" style="background: #9b59b6; position: relative; z-index: 1;">üßπ Declutter</button>
                            <button id="walkBtn" class="btn" onclick="startAdventure()" style="background: #27ae60; position: relative; z-index: 1;">üå≤ Walk (30m)</button>
                            <button class="btn" onclick="refreshPet()" style="background: #34495e; position: relative; z-index: 1;">üîÑ Refresh</button>
                        </div>
                        <div id="walkCountdown" style="text-align: center; margin-top: 10px; font-weight: bold; color: #27ae60; display: none;"></div>
                    </div>
                    <p style="color: #666; text-align: center; margin-top: 20px; font-size: 14px;">
                        üí° Earn coins and XP by completing self-care actions! Your pet grows as you grow.
                    </p>
                </div>
            </div>
            
            <!-- Shop Modal -->
            <div id="shopModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000;">
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3>üõçÔ∏è Wellness Shop</h3>
                    <div style="text-align: center; margin-bottom: 20px; font-size: 18px; font-weight: bold;">
                        Your Coins: ü™ô <span id="shopCoins">0</span>
                    </div>
                    <div id="shopItems"></div>
                    <button class="btn btn-secondary" onclick="closeShop()" style="width: 100%; margin-top: 15px;">Close</button>
                </div>
            </div>
            
            <!-- Declutter Modal -->
            <div id="declutterModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000;">
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%;">
                    <h3>üßπ Declutter The Mind</h3>
                    <p style="color: #666; margin-bottom: 20px;">Throw away 3 worries to clean the room:</p>
                    <div class="form-group">
                        <input type="text" id="worry1" placeholder="Worry 1...">
                    </div>
                    <div class="form-group">
                        <input type="text" id="worry2" placeholder="Worry 2...">
                    </div>
                    <div class="form-group">
                        <input type="text" id="worry3" placeholder="Worry 3...">
                    </div>
                    <button class="btn" onclick="submitDeclutter()" style="width: 100%; background: #e74c3c;">üóëÔ∏è Throw Away</button>
                    <button class="btn btn-secondary" onclick="closeDeclutter()" style="width: 100%; margin-top: 10px;">Cancel</button>
                </div>
            </div>
            
            <!-- Clinical Assessments Tab -->
            <div id="clinicalTab" class="tab-content">
                <h3>Clinical Assessments</h3>
                <p style="color: #666; margin-bottom: 20px;">Track your mental health with validated clinical scales.</p>
                
                <div class="grid-2">
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>PHQ-9 (Depression)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">9-question screening for depression severity.</p>
                        <button class="btn" onclick="startPHQ9()">Start PHQ-9</button>
                    </div>
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>GAD-7 (Anxiety)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">7-question screening for anxiety severity.</p>
                        <button class="btn" onclick="startGAD7()">Start GAD-7</button>
                    </div>
                </div>
                
                <div id="assessmentModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 id="assessmentTitle"></h3>
                        <div id="assessmentQuestions"></div>
                        <button class="btn" onclick="submitAssessment()" style="width: auto;">Submit</button>
                        <button class="btn btn-secondary" onclick="closeAssessment()" style="width: auto; margin-left: 10px;">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h3>Your Progress</h3>
                <p style="color: #666; margin-bottom: 20px;">View your mood history and wellness patterns.</p>
                
                <button class="btn" onclick="loadHistory()" style="margin-bottom: 20px;">Load My History</button>
                
                <div id="historyContent">
                    <p style="text-align: center; color: #999; padding: 40px;">Click "Load My History" to view your mood logs</p>
                </div>
            </div>
            
            <!-- Community Support Tab -->
            <div id="communityTab" class="tab-content">
                <!-- Discord-style Community Layout -->
                <div class="community-discord-layout">
                    <!-- Channel Sidebar -->
                    <div class="community-sidebar">
                        <div class="community-sidebar-header">
                            <h3>Channels</h3>
                        </div>
                        <div id="communityChannelList" class="channel-list">
                            <!-- Channels loaded dynamically -->
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="community-main">
                        <!-- Channel Header -->
                        <div class="community-channel-header" id="communityChannelHeader">
                            <span class="channel-icon">üí¨</span>
                            <div class="channel-info">
                                <h3 id="currentChannelName">Select a Channel</h3>
                                <p id="currentChannelDesc">Choose a channel from the sidebar to view posts</p>
                            </div>
                        </div>

                        <!-- Posts Area -->
                        <div class="community-posts-area" id="communityPostsArea">
                            <div class="welcome-message">
                                <div class="welcome-icon">üëã</div>
                                <h2>Welcome to the Community</h2>
                                <p>Select a channel from the sidebar to start connecting with others on their mental health journey.</p>
                            </div>
                        </div>

                        <!-- Message Input (shown when channel selected) -->
                        <div class="community-input-area" id="communityInputArea" style="display: none;">
                            <textarea id="communityMessage" rows="2" placeholder="Share your thoughts..."></textarea>
                            <button class="btn" onclick="postCommunity()">Post</button>
                        </div>
                    </div>
                </div>

                <!-- Thread Modal -->
                <div id="threadModal" class="thread-modal" style="display: none;">
                    <div class="thread-modal-content">
                        <div class="thread-header">
                            <h3>Thread</h3>
                            <button onclick="closeThreadModal()" class="thread-close-btn">&times;</button>
                        </div>
                        <div class="thread-original-post" id="threadOriginalPost">
                            <!-- Original post content -->
                        </div>
                        <div class="thread-replies" id="threadReplies">
                            <!-- Replies -->
                        </div>
                        <div class="thread-reply-input">
                            <textarea id="threadReplyInput" rows="2" placeholder="Reply to this thread..."></textarea>
                            <button class="btn" onclick="postThreadReply()">Reply</button>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Messages Tab -->
            <div id="messagesTab" class="tab-content">
                <h3 style="margin-bottom: 4px;">Messages</h3>
                <p style="color: var(--text-muted, #666); margin-bottom: 16px; font-size: 14px;">Communicate with your care team and the development team.</p>

                <!-- Messages Navigation Tabs -->
                <div class="msg-tabs">
                    <button class="msg-tab-btn active" onclick="switchMessageTab('inbox', this)">
                        Inbox <span id="inboxUnreadBadge" class="badge" style="display:none;"></span>
                    </button>
                    <button class="msg-tab-btn" onclick="switchMessageTab('sent', this)">
                        Sent
                    </button>
                    <button class="msg-tab-btn" onclick="switchMessageTab('newmessage', this)">
                        Compose
                    </button>
                </div>

                <!-- Inbox Subtab -->
                <div id="messagesInboxTabPatient" class="message-subtab-content" style="display: block;">
                    <!-- Search Bar -->
                    <div class="msg-search-bar">
                        <input type="text" id="msgSearchInput" placeholder="Search messages..." oninput="debounceMessageSearch(this.value)">
                    </div>
                    <div id="messagesInboxContainer" style="max-height: 600px; overflow-y: auto;">
                        <div class="msg-empty">
                            <div class="msg-empty-icon">üì¨</div>
                            <p>Loading messages...</p>
                        </div>
                    </div>
                </div>

                <!-- Sent Subtab -->
                <div id="messagesSentTabPatient" class="message-subtab-content" style="display: none;">
                    <div id="messagesSentContainer" style="max-height: 600px; overflow-y: auto;">
                        <div class="msg-empty">
                            <div class="msg-empty-icon">üì§</div>
                            <p>Loading sent messages...</p>
                        </div>
                    </div>
                </div>

                <!-- Compose Subtab -->
                <div id="messagesNewTabPatient" class="message-subtab-content" style="display: none;">
                    <div class="card" style="border: none; box-shadow: none; padding: 0;">
                        <!-- Quick Action Buttons -->
                        <div class="msg-quick-actions">
                            <button class="msg-quick-btn" onclick="prefillMessageTemplate('appointment')">üìÖ Request Appointment</button>
                            <button class="msg-quick-btn" onclick="prefillMessageTemplate('checkin')">üí¨ Check-in</button>
                            <button class="msg-quick-btn" onclick="prefillMessageTemplate('enquiry')">‚ùì General Enquiry</button>
                            <button class="msg-quick-btn" onclick="prefillMessageTemplate('dev')">üõ† Contact Dev Team</button>
                        </div>

                        <div class="msg-compose-form">
                            <label for="messageRecipientPatient">To</label>
                            <div style="position: relative;">
                                <input type="text" id="messageRecipientPatient" placeholder="Start typing a username..." autocomplete="off" oninput="searchRecipients(this.value)">
                                <div id="recipientDropdown" class="msg-recipient-dropdown" style="display:none;"></div>
                            </div>

                            <label for="messageSubjectPatient">Subject <span style="font-weight:400; color:var(--text-muted,#999);">(optional)</span></label>
                            <input type="text" id="messageSubjectPatient" placeholder="What's this about?">

                            <label for="messageContentPatient">Message</label>
                            <textarea id="messageContentPatient" rows="6" placeholder="Type your message..." oninput="updateComposeCharCount()"></textarea>
                            <div id="composeCharCount" class="msg-char-count">0 / 10,000</div>

                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn" id="composeSendBtn" onclick="sendNewMessage()" style="background: var(--primary-color, #667eea); padding: 12px 28px;">Send Message</button>
                                <p id="messageSendStatusPatient" style="margin: 0; display: none; font-size: 14px;"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Modal (Redesigned) -->
                <div id="conversationModal" class="conv-modal-overlay" onclick="if(event.target===this)closeConversationModal()">
                    <div class="conv-modal">
                        <div class="conv-header">
                            <h3>
                                <span id="convAvatar" class="msg-avatar default" style="width:32px;height:32px;font-size:14px;"></span>
                                <span id="conversationWith"></span>
                                <span id="convRoleBadge" class="msg-role-badge"></span>
                            </h3>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button onclick="deleteConversation()" class="conv-close" title="Delete conversation" style="color:#e74c3c;">üóë</button>
                                <button onclick="closeConversationModal()" class="conv-close" title="Close">&times;</button>
                            </div>
                        </div>
                        <div id="conversationMessages" class="conv-messages">
                            <div class="msg-empty">
                                <div class="msg-empty-icon">üí¨</div>
                                <p>Loading conversation...</p>
                            </div>
                        </div>
                        <div class="conv-reply">
                            <div class="conv-reply-input">
                                <textarea id="replyContent" placeholder="Type your reply..." rows="1" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendReply()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
                                <button class="conv-send-btn" onclick="sendReply()" id="replySendBtn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Updates Tab -->
            <div id="updatesTab" class="tab-content active">
                <h3>üÜï What's New</h3>
                <p style="color: #666; margin-bottom: 20px;">Recent updates and improvements to python-chat-bot.</p>

                <div id="updatesContainer" style="max-height: 600px; overflow-y: auto;">
                    <!-- Updates will be populated by JavaScript -->
                </div>
            </div>

            <!-- Progress Insights Tab -->
            <div id="insightsTab" class="tab-content">
                <h3>üí° Progress Insights & Export</h3>
                <p class="tab-description">View AI-generated insights and export your data.</p>

                <div class="card insights-date-card" style="margin-bottom: 20px;">
                    <h4>üìÖ Date Range</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">From Date</label>
                            <input type="date" id="insightsFromDate" class="themed-input">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">To Date</label>
                            <input type="date" id="insightsToDate" class="themed-input">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="setInsightsRange(7)" style="padding: 10px 15px;">7 Days</button>
                            <button class="btn" onclick="setInsightsRange(30)" style="padding: 10px 15px;">30 Days</button>
                            <button class="btn" onclick="setInsightsRange(90)" style="padding: 10px 15px;">90 Days</button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="loadInsights()">Generate Insights</button>
                    <button class="btn" onclick="exportCSV()" style="background: #34495e;">üì• Export CSV</button>
                    <button class="btn" onclick="exportPDF()" style="background: #e74c3c;">üìÑ Export PDF</button>
                </div>

                <div id="insightsContent">
                    <div class="card">
                        <h4>Your Stats</h4>
                        <div id="statsDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value" id="avgMood">-</div>
                                <div class="stat-label">Average Mood</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgSleep">-</div>
                                <div class="stat-label">Average Sleep</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="moodTrend">-</div>
                                <div class="stat-label">Trend</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h4>AI Insights</h4>
                        <div id="aiInsight" class="ai-insight-box">
                            <p class="muted-text">Click "Generate Insights" to get personalized analysis of your progress.</p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>üìä Mood Trend</h4>
                        <canvas id="moodChart" width="600" height="200" style="max-width: 100%;"></canvas>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>üò¥ Sleep Hours Trend</h4>
                        <canvas id="sleepChart" width="600" height="200" style="max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Appointments Tab -->
            <div id="appointmentsTab" class="tab-content">
                <h3>üìÖ My Appointments</h3>
                <p class="tab-description">View and manage appointments scheduled by your clinician.</p>

                <div id="appointmentsList">
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading" style="margin: 0 auto;"></div>
                        <p class="tab-description" style="margin-top: 10px;">Loading appointments...</p>
                    </div>
                </div>
            </div>

            <!-- About Me Tab -->
            <div id="aboutmeTab" class="tab-content">
                <h3>üë§ About Me</h3>
                <p class="tab-description">Manage your personal information and view your activity statistics.</p>

                <div class="card">
                    <h4>Personal Information</h4>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileFullName" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="profileDOB">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="profilePhone" placeholder="+44 1234 567890">
                    </div>
                    <div class="form-group">
                        <label>Medical History / Conditions</label>
                        <textarea id="profileConditions" rows="4" placeholder="Any relevant medical history..."></textarea>
                    </div>
                    <button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
                    <button class="btn btn-secondary" onclick="loadProfile()">üîÑ Reload Profile</button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h4>My Clinician</h4>
                    <div id="clinicianInfo" class="clinician-info-box">
                        <p class="muted-text">Loading clinician information...</p>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>‚öôÔ∏è Settings</h4>
                    <!-- ...existing code... (other settings remain) -->
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h4>Activity Statistics</h4>
                    <div id="activityStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-card">
                            <div class="stat-value" id="statMoodLogs">-</div>
                            <div class="stat-label">Mood Logs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statGratitude">-</div>
                            <div class="stat-label">Gratitude Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCBT">-</div>
                            <div class="stat-label">CBT Exercises</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessions">-</div>
                            <div class="stat-label">Therapy Sessions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sleep Hygiene Tab -->
            <!-- Professional Dashboard Tab -->
            <div id="professionalTab" class="tab-content">
                <h3>üë®‚Äç‚öïÔ∏è Clinical Dashboard</h3>
                <p style="color: #666; margin-bottom: 20px;">Monitor and manage your patients' mental health progress.</p>
                
                <!-- Sub-Navigation for Clinical Dashboard -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; overflow-x: auto; flex-wrap: wrap;">
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('overview', this)" id="overviewSubtabBtn" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üìä Overview
                    </button>
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('patients', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üë• Patients
                    </button>
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('appointments', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üìÖ Calendar
                    </button>
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('approvals', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        ‚è≥ Approvals
                    </button>
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('messages', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üì® Messages
                    </button>
                    <button class="clinical-subtab-btn" onclick="switchClinicalTab('riskmonitor', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üö® Risk Monitor
                    </button>
                </div>
                
                <!-- Overview Subtab -->
                <div id="clinicalOverviewTab" class="clinical-subtab-content">
                    <!-- Quick Stats - Only 3 Cards -->
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="color: white; margin: 0;">üìä Quick Overview</h4>
                            <button onclick="loadAnalyticsDashboard()" class="btn" style="padding: 8px 16px; background: rgba(255,255,255,0.3); border: 2px solid white;">üîÑ Refresh</button>
                        </div>
                        <div id="analyticsError" style="display: none; background: rgba(255,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid rgba(255,0,0,0.5);"></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 36px; font-weight: bold;" id="totalPatientsCount">-</div>
                                <div style="opacity: 0.9;">Total Patients</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer;" onclick="showActivePatients()">
                                <div style="font-size: 36px; font-weight: bold;" id="activePatientsCount">-</div>
                                <div style="opacity: 0.9;">Active (7 days) üëÅÔ∏è</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 36px; font-weight: bold; color: #ffeb3b;" id="highRiskCount">-</div>
                                <div style="opacity: 0.9;">üö® High Risk</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Patients Subtab -->
                <div id="clinicalPatientsTab" class="clinical-subtab-content" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                            <h4>üë• My Patients</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" id="patientSearchInput" placeholder="üîç Search patients..." style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 200px;">
                                <select id="patientFilterSelect" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="all">All Patients</option>
                                    <option value="high_risk">üö® High Risk</option>
                                    <option value="inactive">üí§ Inactive (7+ days)</option>
                                </select>
                                <button class="btn" onclick="searchPatients()" style="padding: 8px 16px;">Search</button>
                                <button class="btn btn-secondary" onclick="loadPatients()" style="padding: 8px 16px;">üîÑ Refresh</button>
                            </div>
                        </div>
                        <div id="patientList">
                            <p style="text-align: center; color: #999; padding: 40px;">Loading patient list...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Appointments Subtab -->
                <div id="clinicalAppointmentsTab" class="clinical-subtab-content" style="display: none;">
                    <!-- Calendar Header with Controls -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button class="btn btn-secondary" onclick="previousMonth()">‚Üê</button>
                                <h3 id="calendarMonth" style="margin: 0; min-width: 200px; text-align: center;">January 2026</h3>
                                <button class="btn btn-secondary" onclick="nextMonth()">‚Üí</button>
                                <button class="btn btn-secondary" onclick="goToToday()">Today</button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" id="monthViewBtn" onclick="setCalendarView('month')" style="background: #667eea;">Month</button>
                                <button class="btn btn-secondary" id="weekViewBtn" onclick="setCalendarView('week')">Week</button>
                                <button class="btn btn-secondary" id="dayViewBtn" onclick="setCalendarView('day')">Day</button>
                                <button class="btn" onclick="showNewAppointmentForm()" style="background: #2ecc71;">‚ûï New</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="card">
                        <!-- Calendar View Container -->
                        <div id="calendarViewContainer">
                            <!-- Month View -->
                            <div id="monthView">
                                <!-- Day Headers -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px;">
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Sun</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Mon</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Tue</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Wed</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Thu</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Fri</div>
                                    <div style="text-align: center; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 4px;">Sat</div>
                                </div>
                                <!-- Calendar Days Grid -->
                                <div id="calendarDaysGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; min-height: 500px;">
                                    <!-- Days populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Week View -->
                            <div id="weekView" style="display: none;">
                                <div id="weekViewContent">
                                    <!-- Week schedule populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Day View -->
                            <div id="dayView" style="display: none;">
                                <h4 id="dayViewDate" style="margin-bottom: 20px;">Today's Schedule</h4>
                                <div id="dayViewContent" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Day's appointments populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Appointment Form (Modal-style) -->
                    <div id="newAppointmentForm" class="card" style="margin-top: 20px; display: none; background: #f8f9fa; border: 2px solid #667eea;">
                        <h4>üìÖ Schedule New Appointment</h4>
                        <div class="form-group">
                            <label>Select Patient</label>
                            <select id="appointmentPatient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">Select a patient...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Appointment Date & Time</label>
                            <input type="datetime-local" id="appointmentDateTime" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <select id="appointmentDuration" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="15">15 minutes</option>
                                <option value="30" selected>30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="appointmentNotes" rows="3" placeholder="Appointment purpose, topics to discuss..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="createAppointment()">üìÖ Book Appointment</button>
                            <button class="btn btn-secondary" onclick="cancelNewAppointment()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Approvals Subtab -->
                <div id="clinicalApprovalsTab" class="clinical-subtab-content" style="display: none;">
                    <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                        <h4>‚è≥ Pending Patient Requests</h4>
                        <p style="color: #856404; margin-top: 10px;">Review and approve new patient registration requests.</p>
                        <div id="pendingApprovals" style="margin-top: 20px;">
                            <p style="color: #999; text-align: center;">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Messages Subtab -->
                <div id="clinicalMessagesTab" class="clinical-subtab-content" style="display: none;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Message Navigation -->
                        <div class="card">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                                <button class="message-subtab-btn" onclick="switchMessageTab('inbox', this)" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üì¨ Inbox
                                </button>
                                <button class="message-subtab-btn" onclick="switchMessageTab('sent', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üì§ Sent
                                </button>
                                <button class="message-subtab-btn" onclick="switchMessageTab('new', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ‚úèÔ∏è New Message
                                </button>
                            </div>

                            <!-- Inbox Tab -->
                            <div id="clinMessagesInboxTab" class="message-subtab-content">
                                <div id="clinMessagesInboxContainer">
                                    <p style="color: #999; text-align: center; padding: 40px;">Loading messages...</p>
                                </div>
                            </div>

                            <!-- Sent Tab -->
                            <div id="clinMessagesSentTab" class="message-subtab-content" style="display: none;">
                                <div id="clinMessagesSentContainer">
                                    <p style="color: #999; text-align: center; padding: 40px;">Loading messages...</p>
                                </div>
                            </div>

                            <!-- New Message Tab -->
                            <div id="clinMessagesNewTab" class="message-subtab-content" style="display: none;">
                                <div style="max-width: 600px;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Recipient</label>
                                        <input type="text" id="clinMessageRecipient" placeholder="Enter patient username..."
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    </div>

                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Subject</label>
                                        <input type="text" id="clinMessageSubject" placeholder="Message subject (optional)..."
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    </div>

                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Message</label>
                                        <textarea id="clinMessageContent" rows="6" placeholder="Type your message..."
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                                    </div>

                                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                        <button class="btn" onclick="sendClinicianMessage()" style="flex: 1;">üì§ Send Message</button>
                                    </div>

                                    <div id="messageSendStatus" style="display: none; padding: 12px; border-radius: 8px; background: #f0f0f0; color: #333; border-left: 4px solid #667eea;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Monitor Subtab -->
                <div id="clinicalRiskmonitorTab" class="clinical-subtab-content" style="display: none;">
                    <!-- Quick Stats Bar -->
                    <div class="card" style="background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <h4 style="color: white; margin: 0;">üö® Risk Overview</h4>
                            <button onclick="loadRiskDashboard()" class="btn" style="padding: 8px 16px; background: rgba(255,255,255,0.3); border: 2px solid white; font-size: 0.85em;">üîÑ Refresh</button>
                        </div>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                            <div style="text-align: center; cursor: pointer;" onclick="filterRiskPatients('critical')">
                                <div style="font-size: 2em; font-weight: bold; color: #ff4444;" id="riskCriticalCount">0</div>
                                <div style="color: #ff4444; font-size: 0.9em;">Critical</div>
                            </div>
                            <div style="text-align: center; cursor: pointer;" onclick="filterRiskPatients('high')">
                                <div style="font-size: 2em; font-weight: bold; color: #ff8800;" id="riskHighCount">0</div>
                                <div style="color: #ff8800; font-size: 0.9em;">High</div>
                            </div>
                            <div style="text-align: center; cursor: pointer;" onclick="filterRiskPatients('moderate')">
                                <div style="font-size: 2em; font-weight: bold; color: #ffcc00;" id="riskModerateCount">0</div>
                                <div style="color: #ffcc00; font-size: 0.9em;">Moderate</div>
                            </div>
                            <div style="text-align: center; cursor: pointer;" onclick="filterRiskPatients('low')">
                                <div style="font-size: 2em; font-weight: bold; color: #44ff44;" id="riskLowCount">0</div>
                                <div style="color: #44ff44; font-size: 0.9em;">Low</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #ff6666;" id="riskUnreviewedCount">0</div>
                                <div style="color: #ff6666; font-size: 0.9em;">Unreviewed</div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Alerts Section -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-top: 0;">Active Alerts</h4>
                        <div id="riskActiveAlertsList" style="max-height: 400px; overflow-y: auto;">
                            <p style="text-align: center; color: #999; padding: 20px;">Loading alerts...</p>
                        </div>
                    </div>

                    <!-- Patient Risk Overview -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <h4 style="margin-top: 0;">Patient Risk Levels</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="filterRiskPatients('all')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em; width: auto;">All</button>
                                <button onclick="filterRiskPatients('critical')" class="btn" style="padding: 6px 12px; font-size: 0.85em; background: #ff4444; width: auto;">Critical</button>
                                <button onclick="filterRiskPatients('high')" class="btn" style="padding: 6px 12px; font-size: 0.85em; background: #ff8800; width: auto;">High</button>
                                <button onclick="filterRiskPatients('moderate')" class="btn" style="padding: 6px 12px; font-size: 0.85em; background: #ccaa00; width: auto;">Moderate</button>
                            </div>
                        </div>
                        <div id="riskPatientsList">
                            <p style="text-align: center; color: #999; padding: 20px;">Loading patient risk data...</p>
                        </div>
                    </div>
                </div>

                <!-- Risk Detail Modal -->
                <div id="riskDetailModal" class="modal" style="display:none;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeRiskDetailModal()">&times;</span>
                        <div id="riskDetailContent">Loading...</div>
                    </div>
                </div>

                <!-- Patient List Section - Hidden by default, kept for compatibility -->
                <div id="patientListSection" style="display: none;">
                </div>
                
                <!-- Patient Detail Section -->
                <div id="patientDetailSection" style="display: none;">
                    <button class="btn btn-secondary" onclick="closePatientDetail()" style="margin-bottom: 15px;">‚Üê Back to Patient List</button>
                    
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                        <h3 id="patientDetailName" style="color: white; margin: 0;"></h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">Patient Overview</p>
                    </div>
                    
                    <!-- Patient Detail Sub-Navigation -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; overflow-x: auto; flex-wrap: wrap;">
                        <button class="patient-subtab-btn" onclick="switchPatientTab('summary', this)" id="summaryPatientSubtabBtn" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            ü§ñ Summary
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('charts', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üìä Charts
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('profile', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üë§ Profile
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('moods', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üòä Mood Logs
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('assessments', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üìã Assessments
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('therapy', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üí¨ Therapy
                        </button>
                        <button class="patient-subtab-btn" onclick="switchPatientTab('alerts', this)" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            üö® Alerts
                        </button>
                    </div>
                    
                    <!-- Summary Subtab -->
                    <div id="patientSummaryTab" class="patient-subtab-content">
                        <div class="card" style="border-left: 4px solid #667eea;">
                            <h4>ü§ñ AI Clinical Summary</h4>
                            <div id="aiSummary">
                                <div style="text-align: center; padding: 20px;">
                                    <div class="loading" style="margin: 0 auto;"></div>
                                    <p style="color: #666; margin-top: 10px;">Generating AI summary...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Subtab -->
                    <div id="patientChartsTab" class="patient-subtab-content" style="display: none;">
                        <!-- Date Range Selector for Charts -->
                        <div class="card" style="margin-bottom: 20px; background: #f8f9fa;">
                            <h4>üìÖ Chart Date Range</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">From Date</label>
                                    <input type="date" id="patientChartFromDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">To Date</label>
                                    <input type="date" id="patientChartToDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="setPatientChartRange(7)" style="padding: 10px 15px;">7 Days</button>
                                    <button class="btn" onclick="setPatientChartRange(30)" style="padding: 10px 15px;">30 Days</button>
                                    <button class="btn" onclick="setPatientChartRange(90)" style="padding: 10px 15px;">90 Days</button>
                                    <button class="btn" onclick="loadPatientCharts()" style="padding: 10px 15px; background: #667eea;">Refresh</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Section -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>üìä Mood Trend</h4>
                            <canvas id="moodChart" style="max-height: 300px;"></canvas>
                        </div>
                        
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>üò¥ Sleep Hours Trend</h4>
                            <canvas id="sleepChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Profile Subtab -->
                    <div id="patientProfileTab" class="patient-subtab-content" style="display: none;">
                        <div id="patientDetailContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Moods Subtab -->
                    <div id="patientMoodsTab" class="patient-subtab-content" style="display: none;">
                        <div id="patientMoodsContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Assessments Subtab -->
                    <div id="patientAssessmentsTab" class="patient-subtab-content" style="display: none;">
                        <div id="patientAssessmentsContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Therapy Subtab -->
                    <div id="patientTherapyTab" class="patient-subtab-content" style="display: none;">
                        <div id="patientTherapyContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Alerts Subtab -->
                    <div id="patientAlertsTab" class="patient-subtab-content" style="display: none;">
                        <div id="patientAlertsContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Developer Dashboard Tab -->
            <div id="developerTab" class="tab-content">
                <h3>‚öôÔ∏è Developer Dashboard</h3>
                <p style="color: #666; margin-bottom: 20px;">Platform administration and development tools.</p>

                <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <strong style="color: #c62828;">‚ö†Ô∏è FULL ACCESS MODE</strong><br>
                    <span style="color: #666; font-size: 14px;">All commands have unrestricted system access. Use responsibly.</span>
                </div>

                <!-- Sub-Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; flex-wrap: wrap;">
                    <button class="dev-subtab-btn active" onclick="switchDevTab('terminal', this)" id="terminalSubtabBtn">
                        üíª Terminal
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('ai', this)">
                        ü§ñ AI Assistant
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('messages', this)">
                        üì® Messages
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('feedback', this)">
                        üìã Feedback
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('stats', this)">
                        üìä Stats
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('users', this)">
                        üë• Users
                    </button>
                    <button class="dev-subtab-btn" onclick="switchDevTab('qa', this)">
                        üß™ QA Tests
                    </button>
                </div>

                <!-- Terminal Subtab -->
                <div id="devTerminalTab" class="dev-subtab-content">
                    <div class="card">
                        <h4>üíª Full Terminal Access</h4>

                        <div id="terminalOutput" style="background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; border-radius: 8px; height: 500px; overflow-y: auto; margin-bottom: 15px; white-space: pre-wrap; position: relative;"><span style="color: #00ff00;">‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   python-chat-bot Developer Terminal v1.0 - FULL ACCESS MODE   ‚ïë
‚ïë   Type any command - no restrictions, no sandboxing          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</span>

$ <input type="text" id="terminalCommand" placeholder="type command here..."
    style="background: transparent; border: none; outline: none; color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; width: calc(100% - 20px); caret-color: #00ff00;"
    onkeypress="if(event.key==='Enter') executeTerminalCommand()"
    autofocus></div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="clearTerminal()">Clear Terminal</button>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Subtab -->
                <div id="devAiTab" class="dev-subtab-content" style="display: none;">
                    <div class="card">
                        <h4>Developer AI Assistant</h4>
                        <p style="color: var(--text-secondary, #666); margin-bottom: 15px;">
                            Codebase-aware technical assistant with test analysis capabilities.
                        </p>

                        <!-- Quick Action Buttons -->
                        <div id="devAIQuickActions" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            <button class="dev-ai-quick-btn" onclick="sendDevAIQuickAction('analyze_tests', 'Analyze the latest QA test results. Identify failures, patterns, and suggest fixes.')">
                                Analyze Latest Tests
                            </button>
                            <button class="dev-ai-quick-btn" onclick="sendDevAIQuickAction('system_status', 'Review the current system status and highlight anything that needs attention.')">
                                System Status
                            </button>
                            <button class="dev-ai-quick-btn" onclick="sendDevAIQuickAction(null, 'What are the most common patterns and conventions used in this codebase?')">
                                Codebase Patterns
                            </button>
                            <button class="dev-ai-quick-btn" onclick="sendDevAIQuickAction(null, 'Help me write a new API endpoint. What template should I follow?')">
                                New Endpoint Template
                            </button>
                            <button class="dev-ai-quick-btn" onclick="sendDevAIQuickAction(null, 'What security checks should I verify before deploying?')">
                                Security Checklist
                            </button>
                        </div>

                        <!-- Chat Messages Container -->
                        <div id="devAIChatMessages" class="dev-ai-chat-container">
                            <div class="dev-ai-welcome">
                                <div style="font-size: 48px;">&#129302;</div>
                                <div class="dev-ai-welcome-title">Developer AI Assistant</div>
                                <div class="dev-ai-welcome-subtitle">Ask about the codebase, debug issues, analyze tests, or get architecture advice.</div>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <textarea id="devAIInput" placeholder="Ask a technical question..."
                                rows="2"
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color, #e0e0e0); border-radius: 8px; resize: none; font-family: inherit; background: var(--bg-card); color: var(--text-primary); box-sizing: border-box;"
                                onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendDevAIMessage(); }"></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="sendDevAIMessage()" id="devAISendBtn" style="flex: 1;">Send</button>
                                <button class="btn btn-secondary" onclick="clearDevAIChat()" style="flex: 1;">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Subtab -->
                <div id="devMessagesTab" class="dev-subtab-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Send Message -->
                        <div class="card">
                            <h4>üì§ Send Message</h4>

                            <div class="form-group">
                                <label>Recipient</label>
                                <select id="messageRecipient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="ALL">üîî Broadcast to All Users</option>
                                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">Users loaded dynamically</small>
                            </div>

                            <div class="form-group">
                                <label>Type</label>
                                <select id="messageType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="info">‚ÑπÔ∏è Information</option>
                                    <option value="warning">‚ö†Ô∏è Warning</option>
                                    <option value="alert">üö® Alert</option>
                                    <option value="system">‚öôÔ∏è System</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Message</label>
                                <textarea id="messageContent" rows="4" placeholder="Enter your message..."
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
                            </div>

                            <button class="btn" onclick="sendDevMessage()">üì§ Send Message</button>
                        </div>

                        <!-- Message Thread -->
                        <div class="card" style="max-height: 600px; overflow-y: auto; background: var(--bg-card); color: var(--text-primary);">
                            <h4>üí¨ Message Thread</h4>
                            <div id="messageThread">
                                <p style="color: #999; text-align: center; padding: 40px;">Loading messages...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Subtab -->
                <div id="devFeedbackTab" class="dev-subtab-content" style="display: none;">
                    <div class="card" style="background: var(--bg-card); color: var(--text-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üìã User Feedback</h4>
                            <button class="btn btn-secondary" onclick="loadFeedback()">üîÑ Refresh</button>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <select id="feedbackCategoryFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">All Categories</option>
                                <option value="bug">üêõ Bug Report</option>
                                <option value="feature">‚ú® Feature Request</option>
                                <option value="improvement">üìà Improvement</option>
                                <option value="ui">üé® UI/UX</option>
                                <option value="performance">‚ö° Performance</option>
                                <option value="other">üìù Other</option>
                            </select>
                            <select id="feedbackStatusFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">All Status</option>
                                <option value="new">üÜï New</option>
                                <option value="reviewed">üëÄ Reviewed</option>
                                <option value="in_progress">‚öôÔ∏è In Progress</option>
                                <option value="resolved">‚úÖ Resolved</option>
                                <option value="wontfix">‚ùå Won't Fix</option>
                            </select>
                            <button class="btn" onclick="filterFeedback()">Filter</button>
                        </div>

                        <div id="feedbackContainer" style="max-height: 600px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px;">Loading feedback...</p>
                        </div>
                    </div>
                </div>

                <!-- System Stats Subtab -->
                <div id="devStatsTab" class="dev-subtab-content" style="display: none;">
                    <div class="card" style="background: var(--bg-card); color: var(--text-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üìä System Statistics</h4>
                            <button class="btn btn-secondary" onclick="loadSystemStats()">üîÑ Refresh</button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalUsers">-</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalPatients">-</div>
                                <div class="stat-label">Patients</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalClinicians">-</div>
                                <div class="stat-label">Clinicians</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalChats">-</div>
                                <div class="stat-label">Total Chats</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalMoodLogs">-</div>
                                <div class="stat-label">Mood Logs</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statDbSize">-</div>
                                <div class="stat-label">Database Size</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Subtab -->
                <div id="devUsersTab" class="dev-subtab-content" style="display: none;">
                    <div class="card" style="background: var(--bg-card); color: var(--text-primary);">
                        <h4>üë• User Management</h4>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="userSearchInput" placeholder="üîç Search users..."
                                style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <select id="userRoleFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="all">All Roles</option>
                                <option value="user">Patients</option>
                                <option value="clinician">Clinicians</option>
                            </select>
                            <button class="btn" onclick="searchUsers()">Search</button>
                        </div>

                        <div id="usersList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999;">Loading users...</p>
                        </div>
                    </div>
                </div>

                <!-- QA Tests Subtab -->
                <div id="devQaTab" class="dev-subtab-content" style="display: none;">
                    <div class="card" style="background: var(--bg-card); color: var(--text-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üß™ QA Test Runner</h4>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn" onclick="runQATests('all')" id="qa-btn-all">Run All Tests</button>
                                <button class="btn btn-secondary" onclick="runQATests('backend')" id="qa-btn-backend">Backend</button>
                                <button class="btn btn-secondary" onclick="runQATests('e2e')" id="qa-btn-e2e">E2E</button>
                                <button class="btn btn-secondary" onclick="runQATests('security')" id="qa-btn-security">Security</button>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;" id="qaStatsGrid">
                            <div class="stat-card">
                                <div class="stat-value" id="qaTotalTests">-</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #27ae60;" id="qaPassed">-</div>
                                <div class="stat-label">Passed</div>
                            </div>
                            <div class="stat-card" onclick="filterQAOutput('FAILED')" style="cursor: pointer;" title="Click to filter failed tests">
                                <div class="stat-value" style="color: #e74c3c;" id="qaFailed">-</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="stat-card" onclick="filterQAOutput('SKIPPED')" style="cursor: pointer;" title="Click to filter skipped tests">
                                <div class="stat-value" style="color: #f39c12;" id="qaSkipped">-</div>
                                <div class="stat-label">Skipped</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="qaDuration">-</div>
                                <div class="stat-label">Duration</div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #888; margin-bottom: 4px;">
                                <span id="qaPassRate">Pass rate: -</span>
                                <span id="qaLastRun">Last run: Never</span>
                            </div>
                            <div style="background: #333; border-radius: 8px; height: 10px; overflow: hidden;">
                                <div id="qaProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 8px; transition: width 0.5s ease;"></div>
                            </div>
                        </div>

                        <!-- Test Output -->
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>Test Output</strong>
                                <div style="display: flex; gap: 6px;">
                                    <button class="btn" onclick="saveQAResults()" style="padding: 4px 10px; font-size: 12px;" id="qaSaveBtn">Save for AI</button>
                                    <button class="btn btn-secondary" onclick="copyQAOutput()" style="padding: 4px 10px; font-size: 12px;">Copy</button>
                                    <button class="btn btn-secondary" onclick="clearQAOutput()" style="padding: 4px 10px; font-size: 12px;">Clear</button>
                                </div>
                            </div>
                            <div id="qaTestOutput" style="background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 16px; border-radius: 8px; height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 13px;">Ready to run tests. Click a button above to start.</div>
                        </div>

                        <!-- Feature Coverage Checklist -->
                        <details style="margin-top: 16px;">
                            <summary style="cursor: pointer; font-weight: 600; padding: 8px 0;">Feature Coverage Checklist (26 areas)</summary>
                            <div style="padding: 12px 0; columns: 2; column-gap: 20px; font-size: 13px;">
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Authentication & Sessions</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Input Validation & CSRF</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Mood Logging & History</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Wellness Logging & Summary</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Gratitude Logging</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Therapy Chat & AI</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Chat History & Sessions</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Chat Export (txt/json/csv)</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> CBT Thought Records</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Clinical Scales (PHQ-9/GAD-7)</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Safety & C-SSRS</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Risk Assessment & Alerts</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Community Forum</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Internal Messaging</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Notifications</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Appointments</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Virtual Pet System</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Wins Board</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> AI Memory System</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Clinician Dashboard</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Developer Dashboard</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> FHIR Export</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> Security Patterns</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> E2E Patient Journey</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> E2E Clinician Journey</div>
                                <div style="break-inside: avoid; padding: 3px 0;"><span style="color: #27ae60;">‚óè</span> E2E Developer Journey</div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

        </div> <!-- End of app-content -->
    </div> <!-- End of app screen -->
    
    <script>
        // Script loading - v2026.01.29-SECURITY-FIX
        let currentUser = null;
        let currentUserRole = 'user';
        let currentClinicianName = null; // Store assigned clinician's name
        let csrfToken = null; // CSRF token for secure requests

        // ========== DARK MODE / THEME SYSTEM ==========
        function initTheme() {
            // Check for saved theme preference or system preference
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }
        }

        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const isDark = currentTheme === 'dark';
            
            // Toggle the theme
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            
            // Sync both toggles
            const darkModeToggle = document.getElementById('darkModeToggle');
            const authDarkModeToggle = document.getElementById('authDarkModeToggle');
            
            const newTheme = document.documentElement.getAttribute('data-theme');
            const isNowDark = newTheme === 'dark';
            
            if (darkModeToggle) {
                darkModeToggle.checked = isNowDark;
            }
            if (authDarkModeToggle) {
                authDarkModeToggle.checked = isNowDark;
            }
        }
        
        // Initialize theme and set toggle state correctly
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Determine if should be dark
            const shouldBeDark = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);
            
            // Apply theme to document
            if (shouldBeDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            // Set all toggle switches to correct state
            const darkModeToggle = document.getElementById('darkModeToggle');
            const authDarkModeToggle = document.getElementById('authDarkModeToggle');
            
            if (darkModeToggle) {
                darkModeToggle.checked = shouldBeDark;
            }
            if (authDarkModeToggle) {
                authDarkModeToggle.checked = shouldBeDark;
            }
        }

        // Apply theme immediately on page load (before DOMContentLoaded)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        // ========== PRODUCTION MODE: Suppress console logging ==========
        // Set to true in production to hide debug info from browser console
        const PRODUCTION_MODE = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';

        if (PRODUCTION_MODE) {
            // Store original console methods for critical errors only
            const originalError = console.error;
            console.log = function() {}; // Suppress logs
            console.warn = function() {}; // Suppress warnings
            console.error = function(...args) {
                // Only log errors without sensitive details
                if (args[0] && typeof args[0] === 'string' && !args[0].includes('token') && !args[0].includes('password')) {
                    originalError.apply(console, ['[App Error]']);
                }
            };
        }

        // ========== SECURITY: HTML SANITIZATION ==========
        // Prevents XSS attacks by escaping HTML special characters
        function sanitizeHTML(str) {
            if (str === null || str === undefined) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // For displaying user content that should preserve some formatting (newlines only)
        function sanitizeWithLineBreaks(str) {
            return sanitizeHTML(str).replace(/\n/g, '<br>');
        }

        // ========== CSRF TOKEN HANDLING ==========
        async function fetchCsrfToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
                console.log('CSRF token obtained');
                return csrfToken;
            } catch (error) {
                console.error('Failed to fetch CSRF token:', error);
                return null;
            }
        }

        // Override fetch to automatically include CSRF token and handle errors
        const originalFetch = window.fetch;
        window.fetch = async function(url, options = {}) {
            // Always send cookies (session, CSRF) for all requests
            options.credentials = 'include';
            // Ensure we have a CSRF token for non-GET requests
            if (options.method && options.method.toUpperCase() !== 'GET') {
                if (!csrfToken) {
                    await fetchCsrfToken();
                }
                if (csrfToken) {
                    options.headers = options.headers || {};
                    if (options.headers instanceof Headers) {
                        options.headers.set('X-CSRF-Token', csrfToken);
                    } else {
                        options.headers['X-CSRF-Token'] = csrfToken;
                    }
                }
            }
            try {
                const response = await originalFetch(url, options);
                return response;
            } catch (networkError) {
                // Handle network errors gracefully
                console.error('Network error:', networkError.message);
                // Return a mock response that won't break JSON parsing
                return {
                    ok: false,
                    status: 0,
                    statusText: 'Network Error',
                    json: async () => ({ error: 'Connection failed. Please check your internet connection.' }),
                    text: async () => 'Connection failed'
                };
            }
        };

        // Safe JSON parsing helper
        async function safeParseJSON(response) {
            try {
                return await response.json();
            } catch (parseError) {
                console.error('JSON parse error');
                return { error: 'Invalid response from server' };
            }
        }

        // Fetch CSRF token on page load
        fetchCsrfToken();
        let selectedMoodValue = null;
        let medications = [];
        let currentAssessment = null;
        let assessmentScores = [];
        let tempLoginData = null; // Store login data for disclaimer flow

        const speciesEmojis = {Dog: 'üê∂', Cat: 'üê±', Rabbit: 'üê∞', Fox: 'ü¶ä', Panda: 'üêº', Penguin: 'üêß'};

        // ========== HOME TAB CONSTANTS AND FUNCTIONS ==========

        const DAILY_TASK_TYPES = [
            { type: 'log_mood', label: 'üìä Log your mood', icon: 'üìä' },
            { type: 'practice_gratitude', label: 'üôè Write gratitude entry', icon: 'üôè' },
            { type: 'check_pet', label: 'üêæ Care for your pet (feed & walk)', icon: 'üêæ' },
            { type: 'breathing_exercise', label: 'ü´Å Start a breathing exercise', icon: 'ü´Å' },
            { type: 'therapy_session', label: 'ü§ñ Chat with AI therapy', icon: 'ü§ñ' },
            { type: 'affirmation', label: 'üí° Get a positive affirmation', icon: 'üí°' }
        ];

        const MOTIVATIONAL_QUOTES = [
            "Every day is a fresh start. You're doing great! üåü",
            "Small steps lead to big changes. Keep going! üí™",
            "Your mental health matters. We're here for you. üíô",
            "Progress, not perfection. You're on the right path. üåà",
            "Taking time for yourself is a sign of strength. ‚ú®",
            "You've got this. One moment at a time. üåª",
            "Be kind to yourself today. You deserve it. üíú",
            "Every breath is a new beginning. üåä",
            "You are stronger than you know. ü¶ã",
            "Today is full of possibilities. üåÖ"
        ];

        async function loadHomeTabData() {
            try {
                const response = await fetch(`/api/home/data`, {
                    method: 'GET',
                    credentials: 'include', // Ensure session cookies are sent
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    renderHomeTab(data);
                } else {
                    // Show static content on error
                    renderHomeTabStatic();
                }
            } catch (error) {
                console.error('Error loading home data:', error);
                renderHomeTabStatic();
            }
        }

        function renderHomeTab(data) {
            // Welcome message
            const welcomeEl = document.getElementById('homeWelcomeMessage');
            const lastLoginEl = document.getElementById('homeLastLogin');

            if (welcomeEl) {
                welcomeEl.textContent = `Welcome back, ${currentUser}!`;
            }

            if (lastLoginEl) {
                if (data.last_login) {
                    const lastDate = new Date(data.last_login);
                    lastLoginEl.textContent = `Last visit: ${lastDate.toLocaleDateString('en-GB', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    })}`;
                } else {
                    lastLoginEl.textContent = "Welcome to Healing Space UK!";
                }
            }

            // Motivational quote
            const quoteEl = document.getElementById('homeMotivationalQuote');
            if (quoteEl) {
                quoteEl.textContent = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
            }

            // Daily tasks
            const completedTasks = data.daily_tasks || [];
            renderDailyTasks(completedTasks);

            // Streak
            const streakEl = document.getElementById('streakCount');
            if (streakEl && data.streak) {
                streakEl.textContent = data.streak.current || 0;
            }

            // Pet info
            if (data.pet) {
                const petNameEl = document.getElementById('homePetName');
                const petCoinsEl = document.getElementById('homePetCoins');
                const petXPEl = document.getElementById('homePetXP');
                const petEmojiEl = document.getElementById('homePetEmoji');

                if (petNameEl) petNameEl.textContent = data.pet.name || 'Your Pet';
                if (petCoinsEl) petCoinsEl.textContent = data.pet.coins || 0;
                if (petXPEl) petXPEl.textContent = data.pet.xp || 0;
                // Pet emoji would need species info - use generic for now
                if (petEmojiEl) petEmojiEl.textContent = 'üêæ';
            }
        }

        function renderHomeTabStatic() {
            // Render static content when API fails
            const welcomeEl = document.getElementById('homeWelcomeMessage');
            if (welcomeEl) {
                welcomeEl.textContent = `Welcome, ${currentUser}!`;
            }

            const lastLoginEl = document.getElementById('homeLastLogin');
            if (lastLoginEl) {
                lastLoginEl.textContent = "Ready to start your wellness journey?";
            }

            const quoteEl = document.getElementById('homeMotivationalQuote');
            if (quoteEl) {
                quoteEl.textContent = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
            }

            renderDailyTasks([]);
        }

        function renderDailyTasks(completedTasks) {
            const container = document.getElementById('dailyTasksList');
            if (!container) return;

            const completedTypes = completedTasks.map(t => t.task_type);
            const completedCount = completedTypes.length;

            // Update progress bar
            const progressBar = document.getElementById('dailyProgressBar');
            const progressText = document.getElementById('dailyProgressText');
            const percentage = (completedCount / DAILY_TASK_TYPES.length) * 100;

            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = `${completedCount}/${DAILY_TASK_TYPES.length} completed`;

            // Render task list (always visible, interactive)
            container.innerHTML = DAILY_TASK_TYPES.map(task => {
                const isCompleted = completedTypes.includes(task.type);
                return `
                    <div class="daily-task-item ${isCompleted ? 'completed' : ''}" onclick="navigateToTask('${task.type}')" tabindex="0" role="button" aria-pressed="${isCompleted}">
                        <span class="task-checkbox">${isCompleted ? '‚úÖ' : '‚¨ú'}</span>
                        <span class="task-label">${task.label}</span>
                        <span class="task-status">${isCompleted ? 'Done' : 'To do'}</span>
                    </div>
                `;
            }).join('');

            // Always show streak and progress
            const streakDisplay = document.getElementById('streakDisplay');
            if (streakDisplay) streakDisplay.style.display = 'block';

            // Check for daily completion celebration
            if (completedCount === DAILY_TASK_TYPES.length) {
                showDailyCompletionCelebration();
            }
        }

        function navigateToTask(taskType) {
            if (taskType === 'check_pet') {
                switchTab('pet', document.querySelector('[onclick*="pet"]'));
                showPetTaskInstructions();
            } else if (taskType === 'breathing_exercise') {
                switchTab('cbt', document.querySelector('[onclick*="cbt"]'));
                showBreathingTaskInstructions();
            } else if (taskType === 'affirmation') {
                showAffirmationModal();
            } else {
                // Default: switch to mapped tab
                const taskTabMap = {
                    'log_mood': 'mood',
                    'practice_gratitude': 'gratitude',
                    'therapy_session': 'therapy'
                };
                const tabName = taskTabMap[taskType];
                if (tabName) {
                    const tabBtn = document.querySelector(`[onclick*="${tabName}"]`);
                    switchTab(tabName, tabBtn);
                }
            }
        }

        // --- PET TASK LOGIC ---
        let petTaskState = { fed: false, walked: false };
        function showPetTaskInstructions() {
            let msg = '';
            if (!petTaskState.fed && !petTaskState.walked) {
                msg = 'To complete this task, you must feed and walk your pet.';
            } else if (!petTaskState.fed) {
                msg = 'Feed your pet to complete this part of the task.';
            } else if (!petTaskState.walked) {
                msg = 'Walk your pet to complete this part of the task.';
            } else {
                msg = 'Pet task complete!';
            }
            let el = document.getElementById('petTaskInstructions');
            if (!el) {
                el = document.createElement('div');
                el.id = 'petTaskInstructions';
                el.style.margin = '12px 0';
                el.style.color = '#888';
                const petTab = document.getElementById('petTab');
                if (petTab) petTab.insertBefore(el, petTab.firstChild);
            }
            el.innerText = msg;
            // Add feed/walk buttons if not complete
            let btns = document.getElementById('petTaskBtns');
            if (!btns) {
                btns = document.createElement('div');
                btns.id = 'petTaskBtns';
                btns.style.margin = '8px 0';
                const petTab = document.getElementById('petTab');
                if (petTab) petTab.insertBefore(btns, el.nextSibling);
            }
            btns.innerHTML = '';
            if (!petTaskState.fed) {
                const feedBtn = document.createElement('button');
                feedBtn.innerText = 'Feed Pet';
                feedBtn.className = 'btn btn-secondary';
                feedBtn.onclick = function() { petTaskState.fed = true; showPetTaskInstructions(); checkPetTaskComplete(); };
                btns.appendChild(feedBtn);
            }
            if (!petTaskState.walked) {
                const walkBtn = document.createElement('button');
                walkBtn.innerText = 'Walk Pet';
                walkBtn.className = 'btn btn-secondary';
                walkBtn.style.marginLeft = '8px';
                walkBtn.onclick = function() { petTaskState.walked = true; showPetTaskInstructions(); checkPetTaskComplete(); };
                btns.appendChild(walkBtn);
            }
            if (petTaskState.fed && petTaskState.walked) {
                btns.innerHTML = '<span style="color: #27ae60;">‚úÖ Pet cared for today!</span>';
            }
        }
        function checkPetTaskComplete() {
            if (petTaskState.fed && petTaskState.walked) {
                markDailyTaskComplete('check_pet');
            }
        }

        // --- BREATHING TASK LOGIC ---
        let breathingTaskStarted = false;
        function showBreathingTaskInstructions() {
            let el = document.getElementById('breathingTaskInstructions');
            if (!el) {
                el = document.createElement('div');
                el.id = 'breathingTaskInstructions';
                el.style.margin = '12px 0';
                el.style.color = '#888';
                const cbtTab = document.getElementById('cbtTab');
                if (cbtTab) cbtTab.insertBefore(el, cbtTab.firstChild);
            }
            if (!breathingTaskStarted) {
                el.innerText = 'Click below to start a breathing exercise.';
                let btn = document.getElementById('breathingTaskStartBtn');
                if (!btn) {
                    btn = document.createElement('button');
                    btn.id = 'breathingTaskStartBtn';
                    btn.className = 'btn btn-secondary';
                    btn.innerText = 'Start Breathing Exercise';
                    btn.onclick = function() { breathingTaskStarted = true; showBreathingTaskInstructions(); markDailyTaskComplete('breathing_exercise'); };
                    el.parentNode.insertBefore(btn, el.nextSibling);
                }
                btn.style.display = '';
            } else {
                el.innerText = 'Breathing exercise started!';
                let btn = document.getElementById('breathingTaskStartBtn');
                if (btn) btn.style.display = 'none';
            }
        }

        // --- AFFIRMATION TASK LOGIC ---
        const POSITIVE_AFFIRMATIONS = [
            'You are capable of amazing things.',
            'Every day is a fresh start.',
            'You have the strength to overcome challenges.',
            'You are worthy of love and respect.',
            'Your feelings are valid.',
            'You are making progress, even if it‚Äôs slow.',
            'You bring value to those around you.',
            'You can handle whatever comes your way.',
            'You are enough just as you are.',
            'You have the power to create change.',
            'You are growing stronger every day.',
            'You deserve peace and happiness.',
            'You are allowed to take things one step at a time.',
            'Your efforts matter.',
            'You are learning and evolving.',
            'You have survived difficult days before.',
            'You are doing the best you can right now.',
            'Your voice deserves to be heard.',
            'You are resilient and brave.',
            'You are not defined by your mistakes.',
            'You deserve kindness, especially from yourself.',
            'Your future holds new possibilities.',
            'You are allowed to rest without guilt.',
            'You are worthy of care and compassion.',
            'You have the power to change your story.',
            'You are capable of healing.',
            'Your thoughts do not control you.',
            'You can choose progress over perfection.',
            'You are allowed to ask for help.',
            'You matter more than you realize.',
            'You bring light into the world.',
            'You are becoming the person you need.',
            'You deserve patience and understanding.',
            'You are safe in this moment.',
            'You can face today with courage.',
            'Your struggles do not make you weak.',
            'You are worthy of feeling proud of yourself.',
            'You are allowed to grow at your own pace.',
            'You have inner strength you haven‚Äôt fully discovered yet.',
            'You are not alone in this journey.',
            'You deserve a future full of hope.',
            'You are capable of positive change.',
            'You can learn from hard moments.',
            'You deserve to feel calm and secure.',
            'You are more than your fears.',
            'You are building a better tomorrow.',
            'You have control over your choices.',
            'You are allowed to feel and still move forward.',
            'You deserve to be treated with respect.',
            'You are stronger than yesterday.',
            'You are worthy of good things.',
            'You are allowed to set boundaries.',
            'You can trust yourself.',
            'You are healing even when it feels slow.',
            'You deserve to feel at peace with who you are.',
            'You are brave for trying.',
            'You are becoming more confident each day.',
            'You are allowed to take up space.',
            'You deserve a life filled with meaning.',
            'You are enough, exactly as you are right now.',

        ];
        function showAffirmationModal() {
            const affirmation = POSITIVE_AFFIRMATIONS[Math.floor(Math.random() * POSITIVE_AFFIRMATIONS.length)];
            alert('Positive Affirmation:\n\n' + affirmation);
            markDailyTaskComplete('affirmation');
        }

        async function markDailyTaskComplete(taskType) {
            try {
                const response = await fetch('/api/daily-tasks/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        task_type: taskType,
                        username: currentUser
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Refresh home tab if on home tab
                    if (document.getElementById('homeTab').classList.contains('active')) {
                        loadHomeTabData();
                    }

                    if (data.bonus_awarded) {
                        showDailyCompletionCelebration();
                    }
                }
            } catch (error) {
                console.error('Error marking task complete:', error);
            }
        }

        function showDailyCompletionCelebration() {
            // Show celebration for completing all daily tasks
            const streakDisplay = document.getElementById('streakDisplay');
            if (streakDisplay) {
                streakDisplay.innerHTML = `
                    <span class="streak-icon">üéâ</span>
                    All tasks complete! +50 coins, +100 XP
                    <br><span style="font-size: 14px; margin-top: 5px; display: block;">
                        üî• <span class="streak-count" id="streakCount">0</span> day streak
                    </span>
                `;
                streakDisplay.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';

                // Reload to get updated streak
                setTimeout(() => loadHomeTabData(), 1000);
            }
        }

        async function submitFeedback() {
            const category = document.getElementById('feedbackCategory').value;
            const message = document.getElementById('feedbackMessage').value.trim();
            const statusEl = document.getElementById('feedbackStatus');

            if (!message) {
                if (statusEl) {
                    statusEl.textContent = '‚ö†Ô∏è Please enter a message';
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'var(--warning-color)';
                }
                return;
            }

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        category,
                        message,
                        username: currentUser
                    })
                });

                if (response.ok) {
                    if (statusEl) {
                        statusEl.textContent = '‚úÖ Thank you for your feedback!';
                        statusEl.style.display = 'block';
                        statusEl.style.color = 'var(--success-color)';
                    }
                    document.getElementById('feedbackMessage').value = '';

                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        if (statusEl) statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    const data = await response.json();
                    if (statusEl) {
                        statusEl.textContent = '‚ùå ' + (data.error || 'Error submitting feedback');
                        statusEl.style.display = 'block';
                        statusEl.style.color = 'var(--danger-color)';
                    }
                }
            } catch (error) {
                console.error('Feedback error:', error);
                if (statusEl) {
                    statusEl.textContent = '‚ùå Connection error. Please try again.';
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'var(--danger-color)';
                }
            }
        }

        function showQuickTips() {
            const panel = document.getElementById('quickTipsPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ========== END HOME TAB FUNCTIONS ==========

        // ========== CHANGELOG - Add new updates at the TOP ==========
        const APP_UPDATES = [
            {
                date: '2026-01-31',
                version: '22.1',
                title: 'fix: Critical save/load API endpoints and AI memory integration',
                changes: [
                    'fix: Critical save/load API endpoints and AI memory integration',
                ]
            },
            {
                date: '2026-01-31',
                version: '22.0',
                title: 'fix: Resolve duplicate tools and save/load issues',
                changes: [
                    'fix: Resolve duplicate tools and save/load issues',
                ]
            },
            {
                date: '2026-01-31',
                version: '21.9',
                title: 'feat: Phase 2 gamification - badges, mood tracking, and streaks',
                changes: [
                    'feat: Phase 2 gamification - badges, mood tracking, and streaks',
                ]
            },
            {
                date: '2026-01-31',
                version: '21.8',
                title: 'feat: Phase 1 - CBT Tools Gamification (Emoji Moods, Confetti, Pet Rewards)',
                changes: [
                    'feat: Phase 1 - CBT Tools Gamification (Emoji Moods, Confetti, Pet Rewards)',
                ]
            },
            {
                date: '2026-01-31',
                version: '21.7',
                title: 'version number update',
                changes: [
                    'version number update',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.6',
                title: 'fix: Remove all remaining duplicate Flask route functions',
                changes: [
                    'fix: Remove all remaining duplicate Flask route functions',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.5',
                title: 'fix: Remove duplicate function definitions causing Flask route conflicts',
                changes: [
                    'fix: Remove duplicate function definitions causing Flask route conflicts',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.4',
                title: 'fix: CBT tools dashboard backend and AI memory integration',
                changes: [
                    'fix: CBT tools dashboard backend and AI memory integration',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.3',
                title: 'Fix: syntax error in POSITIVE_AFFIRMATIONS array, CBT tools dashboard and per...',
                changes: [
                    'Fix: syntax error in POSITIVE_AFFIRMATIONS array, CBT tools dashboard and persistence, ensure AI listens to all tools',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.2',
                title: 'New CBT tools added',
                changes: [
                    'New CBT tools added',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.1',
                title: 'fix: Daily Tasks Errors',
                changes: [
                    'fix: Daily Tasks Errors',
                ]
            },
            {
                date: '2026-01-30',
                version: '21.0',
                title: 'Version History Update v1',
                changes: [
                    'Version History Update v1.1',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.9',
                title: 'Version History Update',
                changes: [
                    'Version History Update',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.8',
                title: 'Home Page Bug Fix 1',
                changes: [
                    'Home Page Bug Fix 1.0',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.7',
                title: 'fix: add detailed error logging and improved error display for mood and grati...',
                changes: [
                    'fix: add detailed error logging and improved error display for mood and gratitude logging',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.6',
                title: 'feat: Home tab, daily tasks, feedback, and polish for Healing Space UK',
                changes: [
                    'feat: Home tab, daily tasks, feedback, and polish for Healing Space UK',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.5',
                title: 'Fix comprehensive dark mode for chat, safety, insights, appointments, and abo...',
                changes: [
                    'Fix comprehensive dark mode for chat, safety, insights, appointments, and about me tabs',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.4',
                title: 'Fix dark mode backgrounds for all tabs and dashboard cards',
                changes: [
                    'Fix dark mode backgrounds for all tabs and dashboard cards',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.3',
                title: 'Update app header branding to Healing Space UK in web UI',
                changes: [
                    'Update app header branding to Healing Space UK in web UI',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.2',
                title: 'Update web UI branding to Healing Space UK',
                changes: [
                    'Update web UI branding to Healing Space UK',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.1',
                title: 'Update all branding to Healing Space UK',
                changes: [
                    'Update all branding to Healing Space UK',
                ]
            },
            {
                date: '2026-01-30',
                version: '20.0',
                title: 'docs update',
                changes: [
                    'docs update',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.9',
                title: 'Fix dark/light theme for all tabs and cards',
                changes: [
                    'Fix dark/light theme for all tabs and cards',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.8',
                title: 'Crash bug fix FlaskApp location incorrect',
                changes: [
                    'Crash bug fix FlaskApp location incorrect',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.7',
                title: 'UI FIX',
                changes: [
                    'UI FIX',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.6',
                title: 'Add full CRUD endpoints, audit logging, and AI memory integration for all new...',
                changes: [
                    'Add full CRUD endpoints, audit logging, and AI memory integration for all new CBT tools (breathing, relaxation, sleep, core belief, exposure, problem-solving, coping cards, self-compassion, values, goals)',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.5',
                title: 'feat: Add site-wide dark mode with toggle in Settings',
                changes: [
                    'feat: Add site-wide dark mode with toggle in Settings',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.4',
                title: 'feat: Discord-style community with channels, threads, and pinned posts',
                changes: [
                    'feat: Discord-style community with channels, threads, and pinned posts',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.3',
                title: 'version_history_update',
                changes: [
                    'version_history_update',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.2',
                title: 'feat: Add category system, inline replies, and auto-refresh to community',
                changes: [
                    'feat: Add category system, inline replies, and auto-refresh to community',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.1',
                title: 'feat: add reply deletion and multiple reaction emojis',
                changes: [
                    'feat: add reply deletion and multiple reaction emojis',
                ]
            },
            {
                date: '2026-01-30',
                version: '19.0',
                title: 'fix: add missing flagged/flag_reason to ContentModerator',
                changes: [
                    'fix: add missing flagged/flag_reason to ContentModerator',
                ]
            },
            {
                date: '2026-01-30',
                version: '18.9',
                title: 'fix: pet database persistence and content moderator',
                changes: [
                    'fix: pet database persistence and content moderator',
                ]
            },
            {
                date: '2026-01-30',
                version: '18.8',
                title: 'fix:PT3 ensure pet table exists before all pet DB access (robust pet features...',
                changes: [
                    'fix:PT3 ensure pet table exists before all pet DB access (robust pet features after Railway reset)',
                ]
            },
            {
                date: '2026-01-30',
                version: '18.7',
                title: 'fix:PT2 ensure pet table exists before all pet DB access (robust pet features...',
                changes: [
                    'fix:PT2 ensure pet table exists before all pet DB access (robust pet features after Railway reset)',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.6',
                title: 'fix: ensure pet table exists before all pet DB access (robust pet features af...',
                changes: [
                    'fix: ensure pet table exists before all pet DB access (robust pet features after Railway reset)',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.5',
                title: 'Update audit',
                changes: [
                    'Update audit.md - Phase 6 complete (88% resolution rate)',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.4',
                title: 'Phase 6: Fix Medium (P2) security and code quality issues',
                changes: [
                    'Phase 6: Fix Medium (P2) security and code quality issues',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.3',
                title: 'Phase 6: Fix all Critical (P0) and High (P1) security issues',
                changes: [
                    'Phase 6: Fix all Critical (P0) and High (P1) security issues',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.2',
                title: 'Phase 6: Fresh security audit - 16 new issues identified',
                changes: [
                    'Phase 6: Fresh security audit - 16 new issues identified',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.1',
                title: 'Merge remote changes and resolve VERSION_HISTORY conflict',
                changes: [
                    'Merge remote changes and resolve VERSION_HISTORY conflict',
                ]
            },
            {
                date: '2026-01-29',
                version: '18.0',
                title: 'Fix: AI summary endpoint - remove non-existent created_at column from users q...',
                changes: [
                    'Fix: AI summary endpoint - remove non-existent created_at column from users query',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.9',
                title: 'Phase 5: Web/Android audit - Fix pet endpoints, duplicate routes, exception l...',
                changes: [
                    'Phase 5: Web/Android audit - Fix pet endpoints, duplicate routes, exception leaks',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.8',
                title: 'Phase 5: Web/Android audit - Fix pet endpoints, duplicate routes, exception l...',
                changes: [
                    'Phase 5: Web/Android audit - Fix pet endpoints, duplicate routes, exception leaks',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.7',
                title: 'fix: Harden /api/professional/ai-summary endpoint (null checks, safe defaults...',
                changes: [
                    'fix: Harden /api/professional/ai-summary endpoint (null checks, safe defaults, debug logging, robust fallback)',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.6',
                title: 'Fix: Add None checks to AI summary prompt string slicing',
                changes: [
                    'Fix: Add None checks to AI summary prompt string slicing',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.5',
                title: 'fix: Set Updates tab as default for changelog debug (shows changelog on load)',
                changes: [
                    'fix: Set Updates tab as default for changelog debug (shows changelog on load)',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.4',
                title: 'Add null safety and error logging to AI summary endpoint',
                changes: [
                    'Add null safety and error logging to AI summary endpoint',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.3',
                title: 'Enhance AI clinical summary and fix patient charts',
                changes: [
                    'Enhance AI clinical summary and fix patient charts',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.2',
                title: 'Fix: Add missing clinician parameter to patient detail endpoint',
                changes: [
                    'Fix: Add missing clinician parameter to patient detail endpoint',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.1',
                title: 'Update VERSION_HISTORY',
                changes: [
                    'Update VERSION_HISTORY.txt with today\'s fixes',
                ]
            },
            {
                date: '2026-01-29',
                version: '17.0',
                title: 'Fix: Clinician dashboard patient data and AI insights',
                changes: [
                    'Fix: Clinician dashboard patient data and AI insights',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.9',
                title: 'Update VERSION_HISTORY',
                changes: [
                    'Update VERSION_HISTORY.txt with recent commits',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.8',
                title: 'Fix: loadInsights sends role=clinician for clinician users (enables clinician...',
                changes: [
                    'Fix: loadInsights sends role=clinician for clinician users (enables clinician data/AI insights)',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.7',
                title: 'Fix: /api/insights always returns avg_mood, avg_sleep, and trend (prevents fr...',
                changes: [
                    'Fix: /api/insights always returns avg_mood, avg_sleep, and trend (prevents frontend errors on empty data)',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.6',
                title: 'Fix: remove syntax error in /api/pet/status endpoint (no nested try)',
                changes: [
                    'Fix: remove syntax error in /api/pet/status endpoint (no nested try)',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.5',
                title: 'Chore: trigger Railway deploy (trivial comment change)',
                changes: [
                    'Chore: trigger Railway deploy (trivial comment change)',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.4',
                title: 'Fix: Insights always sends prompt, pet endpoints handle missing user/pet, fro...',
                changes: [
                    'Fix: Insights always sends prompt, pet endpoints handle missing user/pet, frontend sends username for pet reward',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.3',
                title: 'UI: Add show/hide toggle for PIN fields on all login forms',
                changes: [
                    'UI: Add show/hide toggle for PIN fields on all login forms',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.2',
                title: 'Frontend: always use credentials: include in fetch for CSRF/session reliability',
                changes: [
                    'Frontend: always use credentials: include in fetch for CSRF/session reliability',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.1',
                title: 'Fix CSRF token endpoint: resolve secrets shadowing, use stdlib secrets for to...',
                changes: [
                    'Fix CSRF token endpoint: resolve secrets shadowing, use stdlib secrets for token generation, ensure session cookie set',
                ]
            },
            {
                date: '2026-01-29',
                version: '16.0',
                title: 'Add Phase 4 UX enhancements: onboarding, accessibility, mobile',
                changes: [
                    'Add Phase 4 UX enhancements: onboarding, accessibility, mobile',
                ]
            },
            {
                date: '2026-01-29',
                version: '15.9',
                title: 'Set up venv, install all dependencies, playwright, and fixed test environment',
                changes: [
                    'Set up venv, install all dependencies, playwright, and fixed test environment. Ready for further dev and testing.',
                ]
            },
            {
                date: '2026-01-28',
                version: '15.8',
                title: 'Fix TherapistAI indentation error (production boot fix)',
                changes: [
                    'Fix TherapistAI indentation error (production boot fix)',
                ]
            },
            {
                date: '2026-01-28',
                version: '15.7',
                title: 'Add get_insight method to TherapistAI for insights endpoint compatibility',
                changes: [
                    'Add get_insight method to TherapistAI for insights endpoint compatibility',
                ]
            },
            {
                date: '2026-01-28',
                version: '15.6',
                title: 'Refactor insights endpoint: custom date range, AI prompt, clinician/patient n...',
                changes: [
                    'Refactor insights endpoint: custom date range, AI prompt, clinician/patient narrative',
                ]
            },
            {
                date: '2026-01-28',
                version: '15.5',
                title: 'Updated AUDIT',
                changes: [
                    'Updated AUDIT.md with dynamic audit results',
                ]
            },
            {
                date: '2026-01-28',
                version: '15.4',
                title: 'Rollback: restore project to v1',
                changes: [
                    'Rollback: restore project to v1.0.46 (2026-01-26) - Fix chat input layout for mobile',
                ]
            },
            {
                date: '2026-01-26',
                version: '15.3',
                title: 'Fix chat input layout for mobile - stack textarea above buttons',
                changes: [
                    'Fix chat input layout for mobile - stack textarea above buttons',
                ]
            },
            {
                date: '2026-01-26',
                version: '15.2',
                title: 'Add Updates tab, notification management, and chat improvements',
                changes: [
                    'Add Updates tab, notification management, and chat improvements',
                ]
            },
            {
                date: '2026-01-26',
                version: '15.1',
                title: 'Improve AI chat: voice input, thinking animation, natural responses',
                changes: [
                    'Improve AI chat: voice input, thinking animation, natural responses',
                ]
            },
            {
                date: '2026-01-25',
                version: '15.0',
                title: 'message bugs update',
                changes: [
                    'message bugs update',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.9',
                title: 'API update',
                changes: [
                    'API update',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.8',
                title: 'Remove package',
                changes: [
                    'Remove package.json to fix Railway Python deploy (prevent npm ci)',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.7',
                title: 'Fix Railway deploy: allow pip install in Nixpacks immutable env',
                changes: [
                    'Fix Railway deploy: allow pip install in Nixpacks immutable env',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.6',
                title: 'Add nixpacks',
                changes: [
                    'Add nixpacks.toml to force Python dependency install on Railway',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.5',
                title: 'Add mobile app (Capacitor) and deployment documentation',
                changes: [
                    'Add mobile app (Capacitor) and deployment documentation',
                ]
            },
            {
                date: '2026-01-24',
                version: '14.4',
                title: 'Major update: Fix database concurrency, user deletion, and messaging system',
                changes: [
                    'Major update: Fix database concurrency, user deletion, and messaging system',
                ]
            },
            {
                date: '2026-01-24',
                version: '14.3',
                title: 'Add developer dashboard',
                changes: [
                    'Add developer dashboard',
                ]
            },
            {
                date: '2026-01-23',
                version: '14.2',
                title: 'Add developer dashboard',
                changes: [
                    'Add developer dashboard',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.1',
                title: 'Add api',
                changes: [
                    'Add api.py deep-audit and update roadmap with endpoint mapping and migration plan',
                ]
            },
            {
                date: '2026-01-25',
                version: '14.0',
                title: 'Update ROADMAP',
                changes: [
                    'Update ROADMAP.md with detailed file-by-file audit and next steps (2026-01-25)',
                ]
            },
            {
                date: '2026-01-25',
                version: '13.9',
                title: 'Add roadmap and index for mobile app development',
                changes: [
                    'Add roadmap and index for mobile app development',
                ]
            },
            {
                date: '2026-01-24',
                version: '13.8',
                title: 'docs: add Additional Features & Roadmap under future updates and ideas (2026-...',
                changes: [
                    'docs: add Additional Features & Roadmap under future updates and ideas (2026-01-24)',
                ]
            },
            {
                date: '2026-01-24',
                version: '13.7',
                title: 'docs: update repository README and documentation index to reflect current fea...',
                changes: [
                    'docs: update repository README and documentation index to reflect current features and usage (2026-01-24)',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.6',
                title: 'legal: add role-specific disclaimers with comprehensive UK legal protection',
                changes: [
                    'legal: add role-specific disclaimers with comprehensive UK legal protection',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.5',
                title: 'docs: strengthen pitch‚Äîemphasize AI bridging gap between sessions and patient...',
                changes: [
                    'docs: strengthen pitch‚Äîemphasize AI bridging gap between sessions and patient continuity',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.4',
                title: 'docs: make clinician/patient guides website-only (remove developer instructions)',
                changes: [
                    'docs: make clinician/patient guides website-only (remove developer instructions)',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.3',
                title: 'docs: add non-technical web access guide and surface it in clinician/patient ...',
                changes: [
                    'docs: add non-technical web access guide and surface it in clinician/patient guides',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.2',
                title: 'ci: stabilize workflow, disable pytest plugin autoload, set test env vars',
                changes: [
                    'ci: stabilize workflow, disable pytest plugin autoload, set test env vars',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.1',
                title: 'chore: timezone-aware datetimes; optional browser smoke test + CI step',
                changes: [
                    'chore: timezone-aware datetimes; optional browser smoke test + CI step',
                ]
            },
            {
                date: '2026-01-22',
                version: '13.0',
                title: 'fix: robust FHIR export handling; add integration chat+FHIR tests; add CI wor...',
                changes: [
                    'fix: robust FHIR export handling; add integration chat+FHIR tests; add CI workflow',
                ]
            },
            {
                date: '2026-01-22',
                version: '12.9',
                title: 'chore: normalize timestamp queries, fix analytics; tests passing',
                changes: [
                    'chore: normalize timestamp queries, fix analytics; tests passing',
                ]
            },
            {
                date: '2026-01-22',
                version: '12.8',
                title: 'fix(clinician): show appointments in patient dashboard; add attendance controls',
                changes: [
                    'fix(clinician): show appointments in patient dashboard; add attendance controls',
                ]
            },
            {
                date: '2026-01-22',
                version: '12.7',
                title: 'feat: appointment attendance, notification fixes, deploy automation',
                changes: [
                    'feat: appointment attendance, notification fixes, deploy automation',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.6',
                title: 'Expand pet game: mini-games, mood, journal, daily challenges, healthy habit r...',
                changes: [
                    'Expand pet game: mini-games, mood, journal, daily challenges, healthy habit rewards, and bugfixes. All tests passing.',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.5',
                title: 'Fix patient analytics mood query: use entrestamp/mood_val instead of timestam...',
                changes: [
                    'Fix patient analytics mood query: use entrestamp/mood_val instead of timestamp/mood_score',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.4',
                title: 'Remove Analytics tab, redesign Appointments with calendar views (month/week/d...',
                changes: [
                    'Remove Analytics tab, redesign Appointments with calendar views (month/week/day) for scalability',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.3',
                title: 'Fix active patient tracking: update last_login on login, add clickable active...',
                changes: [
                    'Fix active patient tracking: update last_login on login, add clickable active count with details modal',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.2',
                title: 'Fix clinical_scales column names (scale_name/score not scale_type/total_score)',
                changes: [
                    'Fix clinical_scales column names (scale_name/score not scale_type/total_score)',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.1',
                title: 'Add analytics debug endpoint and refresh button',
                changes: [
                    'Add analytics debug endpoint and refresh button',
                ]
            },
            {
                date: '2026-01-19',
                version: '12.0',
                title: 'Add documentation for Railway database wipe',
                changes: [
                    'Add documentation for Railway database wipe',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.9',
                title: 'Add admin database wipe endpoint and web interface for Railway',
                changes: [
                    'Add admin database wipe endpoint and web interface for Railway',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.8',
                title: 'Add detailed logging to auth endpoints and update version to v2026',
                changes: [
                    'Add detailed logging to auth endpoints and update version to v2026.01.19.5',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.7',
                title: 'Fix password reset email error handling - make SMTP failures graceful',
                changes: [
                    'Fix password reset email error handling - make SMTP failures graceful',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.6',
                title: 'Add 2FA verification system for signup with email and SMS support',
                changes: [
                    'Add 2FA verification system for signup with email and SMS support',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.5',
                title: 'database wipe 3',
                changes: [
                    'database wipe 3.3.5',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.4',
                title: 'Fix alerts query to use status column and add DOM render delay for analytics ...',
                changes: [
                    'Fix alerts query to use status column and add DOM render delay for analytics load',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.3',
                title: 'Add comprehensive logging for analytics dashboard and auto-load on clinician ...',
                changes: [
                    'Add comprehensive logging for analytics dashboard and auto-load on clinician login',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.2',
                title: 'Add migration for chat_session_id column and improve chat session creation er...',
                changes: [
                    'Add migration for chat_session_id column and improve chat session creation error handling',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.1',
                title: 'Add comprehensive error handling to AI chat endpoint - better debugging and c...',
                changes: [
                    'Add comprehensive error handling to AI chat endpoint - better debugging and clearer error messages',
                ]
            },
            {
                date: '2026-01-19',
                version: '11.0',
                title: 'Fix analytics display handling null values, add patient notification when app...',
                changes: [
                    'Fix analytics display handling null values, add patient notification when appointment cancelled, therapy notes already timestamped',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.9',
                title: 'Restructure clinician dashboard: Overview shows only 3 stat cards, charts mov...',
                changes: [
                    'Restructure clinician dashboard: Overview shows only 3 stat cards, charts moved to Analytics tab',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.8',
                title: 'Fix analytics dashboard patient counting queries',
                changes: [
                    'Fix analytics dashboard patient counting queries',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.7',
                title: 'Add organized subtabs for patient detail view',
                changes: [
                    'Add organized subtabs for patient detail view',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.6',
                title: 'Reorganize clinician dashboard with organized subtabs',
                changes: [
                    'Reorganize clinician dashboard with organized subtabs',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.5',
                title: 'DB quick update',
                changes: [
                    'DB quick update',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.4',
                title: 'Fix login error handling and appointment display issues',
                changes: [
                    'Fix login error handling and appointment display issues',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.3',
                title: 'Add clinician analytics dashboard, report generator, and patient search features',
                changes: [
                    'Add clinician analytics dashboard, report generator, and patient search features',
                ]
            },
            {
                date: '2026-01-19',
                version: '10.2',
                title: 'docs: Add comprehensive Android app conversion guide',
                changes: [
                    'docs: Add comprehensive Android app conversion guide',
                ]
            },
            {
                date: '2026-01-18',
                version: '10.1',
                title: 'fix: Load appointments automatically when clinician logs in',
                changes: [
                    'fix: Load appointments automatically when clinician logs in',
                ]
            },
            {
                date: '2026-01-18',
                version: '10.0',
                title: 'fix: Force refresh of appointments list by disabling browser cache',
                changes: [
                    'fix: Force refresh of appointments list by disabling browser cache',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.9',
                title: 'fix: Organize clinician appointments into clear sections',
                changes: [
                    'fix: Organize clinician appointments into clear sections',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.8',
                title: 'fix: Add patient notifications for appointments and improve clinician respons...',
                changes: [
                    'fix: Add patient notifications for appointments and improve clinician response visibility',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.7',
                title: 'feat: Auto-training on Railway + local dev setup',
                changes: [
                    'feat: Auto-training on Railway + local dev setup',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.6',
                title: 'feat: Background AI training system for independent learning',
                changes: [
                    'feat: Background AI training system for independent learning',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.5',
                title: 'feat: Multiple chat sessions with full clinician/ML access',
                changes: [
                    'feat: Multiple chat sessions with full clinician/ML access',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.4',
                title: 'feat: Add chat search, timestamps, and export with date range',
                changes: [
                    'feat: Add chat search, timestamps, and export with date range',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.3',
                title: 'docs: Add comprehensive web app validation report',
                changes: [
                    'docs: Add comprehensive web app validation report',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.2',
                title: 'Add diagnostic page for testing JavaScript loading',
                changes: [
                    'Add diagnostic page for testing JavaScript loading',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.1',
                title: 'CRITICAL FIX: Remove broken text breaking entire JavaScript execution',
                changes: [
                    'CRITICAL FIX: Remove broken text breaking entire JavaScript execution',
                ]
            },
            {
                date: '2026-01-18',
                version: '9.0',
                title: 'Fix: Remove duplicate checkPetReturn function causing syntax error',
                changes: [
                    'Fix: Remove duplicate checkPetReturn function causing syntax error',
                ]
            },
            {
                date: '2026-01-18',
                version: '8.9',
                title: 'Fix: Remove orphaned duplicate code causing login function to not load',
                changes: [
                    'Fix: Remove orphaned duplicate code causing login function to not load',
                ]
            },
            {
                date: '2026-01-18',
                version: '8.8',
                title: 'fix: update node version in Dockerfile',
                changes: [
                    'fix: update node version in Dockerfile',
                ]
            },
            {
                date: '2026-01-18',
                version: '8.7',
                title: 'login issues v1',
                changes: [
                    'login issues v1.8',
                ]
            },
            {
                date: '2026-01-18',
                version: '8.6',
                title: 'docs: update copilot instructions for web API',
                changes: [
                    'docs: update copilot instructions for web API',
                ]
            },
            {
                date: '2026-01-18',
                version: '8.5',
                title: 'landing page issue',
                changes: [
                    'landing page issue',
                ]
            },
            {
                date: '2026-01-17',
                version: '8.4',
                title: 'feat: Add model training script and fix auth flow',
                changes: [
                    'feat: Add model training script and fix auth flow',
                ]
            },
            {
                date: '2026-01-17',
                version: '8.3',
                title: '1',
                changes: [
                    '1.1',
                ]
            },
            {
                date: '2026-01-17',
                version: '8.2',
                title: 'login flow bug fix',
                changes: [
                    'login flow bug fix',
                ]
            },
            {
                date: '2026-01-17',
                version: '8.1',
                title: 'index missed fix',
                changes: [
                    'index missed fix',
                ]
            },
            {
                date: '2026-01-17',
                version: '8.0',
                title: 'Menu Bug Fix',
                changes: [
                    'Menu Bug Fix',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.9',
                title: 'Fix: Remove duplicate walkCountdownInterval declarations causing syntax error',
                changes: [
                    'Fix: Remove duplicate walkCountdownInterval declarations causing syntax error',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.8',
                title: 'Add version tracking and debug logs for auth functions',
                changes: [
                    'Add version tracking and debug logs for auth functions',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.7',
                title: 'Add cache-busting meta tags to fix showClinicianAuth function not loading',
                changes: [
                    'Add cache-busting meta tags to fix showClinicianAuth function not loading',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.6',
                title: 'Fix pet game: increase modal z-index, add 30min walk cooldown with countdown ...',
                changes: [
                    'Fix pet game: increase modal z-index, add 30min walk cooldown with countdown timer, show rewards',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.5',
                title: 'Fix: Show appointments from last 30 days in clinician view (prevent disappear...',
                changes: [
                    'Fix: Show appointments from last 30 days in clinician view (prevent disappearing after patient response)',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.4',
                title: 'Add bidirectional appointments system with patient acknowledgment and respons...',
                changes: [
                    'Add bidirectional appointments system with patient acknowledgment and response tracking',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.3',
                title: 'Fix export errors and enhance signup forms',
                changes: [
                    'Fix export errors and enhance signup forms',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.2',
                title: 'Documentation: Add sleep chart feature documentation',
                changes: [
                    'Documentation: Add sleep chart feature documentation',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.1',
                title: 'Feature: Add sleep chart and custom date ranges to insights',
                changes: [
                    'Feature: Add sleep chart and custom date ranges to insights',
                ]
            },
            {
                date: '2026-01-17',
                version: '7.0',
                title: 'Fix: Insights API column name mismatch',
                changes: [
                    'Fix: Insights API column name mismatch',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.9',
                title: 'Complete audit: All features verified and documented',
                changes: [
                    'Complete audit: All features verified and documented',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.8',
                title: 'Add appointment calendar system to web interface',
                changes: [
                    'Add appointment calendar system to web interface',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.7',
                title: 'Add show/hide password toggle to login screens',
                changes: [
                    'Add show/hide password toggle to login screens',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.6',
                title: 'Fix: Separate desktop and web code, fix tkinter import errors',
                changes: [
                    'Fix: Separate desktop and web code, fix tkinter import errors',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.5',
                title: 'Fix: Add About Me page, fix PDF/CSV exports with reportlab',
                changes: [
                    'Fix: Add About Me page, fix PDF/CSV exports with reportlab',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.4',
                title: 'Add API endpoints for appointments and patient profile',
                changes: [
                    'Add API endpoints for appointments and patient profile',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.3',
                title: 'Deploy to Railway - 2026-01-17 17:48:01',
                changes: [
                    'Deploy to Railway - 2026-01-17 17:48:01',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.2',
                title: 'Add patient About Me page and personal PDF export',
                changes: [
                    'Add patient About Me page and personal PDF export',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.1',
                title: 'Add completion summary for appointment system',
                changes: [
                    'Add completion summary for appointment system',
                ]
            },
            {
                date: '2026-01-17',
                version: '6.0',
                title: 'Add clinician appointment calendar with PDF reports and notifications',
                changes: [
                    'Add clinician appointment calendar with PDF reports and notifications',
                ]
            },
            {
                date: '2026-01-17',
                version: '5.9',
                title: 'Organize all documentation in documentation/ folder with comprehensive coverage',
                changes: [
                    'Organize all documentation in documentation/ folder with comprehensive coverage',
                ]
            },
            {
                date: '2026-01-17',
                version: '5.8',
                title: 'Add comprehensive user guide for patients and clinicians',
                changes: [
                    'Add comprehensive user guide for patients and clinicians',
                ]
            },
            {
                date: '2026-01-17',
                version: '5.7',
                title: 'Implement pet care features and assessment limits',
                changes: [
                    'Implement pet care features and assessment limits',
                ]
            },
            {
                date: '2026-01-17',
                version: '5.6',
                title: 'Fix missing time import in api',
                changes: [
                    'Fix missing time import in api.py',
                ]
            },
            {
                date: '2026-01-17',
                version: '5.5',
                title: 'Trigger Railway redeploy',
                changes: [
                    'Trigger Railway redeploy',
                ]
            },
            {
                date: '2026-01-16',
                version: '5.4',
                title: 'Add pet rewards for all self-care activities',
                changes: [
                    'Add pet rewards for all self-care activities',
                ]
            },
            {
                date: '2026-01-16',
                version: '5.3',
                title: 'Add session persistence and Remember Me functionality',
                changes: [
                    'Add session persistence and Remember Me functionality',
                ]
            },
            {
                date: '2026-01-16',
                version: '5.2',
                title: 'Complete AI memory integration and chat initialization system',
                changes: [
                    'Complete AI memory integration and chat initialization system',
                ]
            },
            {
                date: '2026-01-16',
                version: '5.1',
                title: 'Require full name, DOB, and medical conditions on patient signup',
                changes: [
                    'Require full name, DOB, and medical conditions on patient signup',
                ]
            },
            {
                date: '2026-01-16',
                version: '5.0',
                title: 'Fix chat history loading with correct function names and async flow',
                changes: [
                    'Fix chat history loading with correct function names and async flow',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.9',
                title: 'Fix AI chat, add persistent chat history, make therapy default tab, include a...',
                changes: [
                    'Fix AI chat, add persistent chat history, make therapy default tab, include all patient data in clinician dashboard',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.8',
                title: 'Add deployment checklist for Railway setup',
                changes: [
                    'Add deployment checklist for Railway setup',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.7',
                title: 'Add Railway deployment support with GitHub Actions for 8pm mood reminders',
                changes: [
                    'Add Railway deployment support with GitHub Actions for 8pm mood reminders',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.6',
                title: 'Complete 8pm mood reminder system with cron automation',
                changes: [
                    'Complete 8pm mood reminder system with cron automation',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.5',
                title: 'Add cron job setup for 8pm mood reminders',
                changes: [
                    'Add cron job setup for 8pm mood reminders',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.4',
                title: 'clin notes/ai tracking/dupe prevention implementattion',
                changes: [
                    'clin notes/ai tracking/dupe prevention implementattion',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.3',
                title: 'overhall v1',
                changes: [
                    'overhall v1.45',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.2',
                title: 'Add Railway volume support',
                changes: [
                    'Add Railway volume support',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.1',
                title: 'Patient approval udate v1',
                changes: [
                    'Patient approval udate v1.1',
                ]
            },
            {
                date: '2026-01-16',
                version: '4.0',
                title: 'email/api update',
                changes: [
                    'email/api update',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.9',
                title: 'clin dash update',
                changes: [
                    'clin dash update',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.8',
                title: 'Add implementation summary for email/phone and password reset features',
                changes: [
                    'Add implementation summary for email/phone and password reset features',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.7',
                title: 'Add email/phone to signup, forgot password/PIN functionality with email reset...',
                changes: [
                    'Add email/phone to signup, forgot password/PIN functionality with email reset, and PostgreSQL setup guide',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.6',
                title: 'Fix pending approvals not showing - correct property name from approvals to p...',
                changes: [
                    'Fix pending approvals not showing - correct property name from approvals to pending_approvals',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.5',
                title: 'Fix JavaScript syntax error - incorrect quote escaping in startAdventure func...',
                changes: [
                    'Fix JavaScript syntax error - incorrect quote escaping in startAdventure function',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.4',
                title: 'Add explicit pointer-events: auto and console logging to debug landing page b...',
                changes: [
                    'Add explicit pointer-events: auto and console logging to debug landing page button clicks',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.3',
                title: 'Fix landing page buttons - remove stacking context from app-container and add...',
                changes: [
                    'Fix landing page buttons - remove stacking context from app-container and add explicit z-index to buttons',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.2',
                title: 'Move disclaimer to registration flow - shows after user selects patient/clini...',
                changes: [
                    'Move disclaimer to registration flow - shows after user selects patient/clinician during signup only',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.1',
                title: 'Fix landing page button clicks - add z-index to auth-box',
                changes: [
                    'Fix landing page button clicks - add z-index to auth-box',
                ]
            },
            {
                date: '2026-01-16',
                version: '3.0',
                title: 'Fix login after disclaimer acceptance - use stored auth data instead of re-au...',
                changes: [
                    'Fix login after disclaimer acceptance - use stored auth data instead of re-authenticating',
                ]
            },
            {
                date: '2026-01-16',
                version: '2.9',
                title: 'Fix z-index issue on landing page - auth screen now properly overlays app',
                changes: [
                    'Fix z-index issue on landing page - auth screen now properly overlays app',
                ]
            },
            {
                date: '2026-01-16',
                version: '2.8',
                title: 'Complete pet game implementation with shop, declutter, adventure, time decay ...',
                changes: [
                    'Complete pet game implementation with shop, declutter, adventure, time decay + move menu to left sidebar',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.7',
                title: 'database reset',
                changes: [
                    'database reset',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.6',
                title: 'Add developer README PDF and database reset endpoint for testing',
                changes: [
                    'Add developer README PDF and database reset endpoint for testing',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.5',
                title: 'Dev Files Update (v1',
                changes: [
                    'Dev Files Update (v1.0.1)',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.4',
                title: 'Fix missing clinician_id column and add password special character requiremen...',
                changes: [
                    'Fix missing clinician_id column and add password special character requirement for both patient and clinician registration',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.3',
                title: 'Add legal disclaimer, landing page for clinician/patient separation, and PIN ...',
                changes: [
                    'Add legal disclaimer, landing page for clinician/patient separation, and PIN requirement for clinician registration',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.2',
                title: 'Add comprehensive documentation for new features',
                changes: [
                    'Add comprehensive documentation for new features',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.1',
                title: 'Add 2FA PIN authentication, password strength validation, patient approval wo...',
                changes: [
                    'Add 2FA PIN authentication, password strength validation, patient approval workflow, and notification system',
                ]
            },
            {
                date: '2026-01-14',
                version: '2.0',
                title: 'Implement professional clinician system: clinician registration, patient-clin...',
                changes: [
                    'Implement professional clinician system: clinician registration, patient-clinician linking, role-based dashboard access, clinician filtering',
                ]
            },
            {
                date: '2026-01-14',
                version: '1.9',
                title: 'Add ALL missing features: Community Board, Safety Plan, Progress Insights wit...',
                changes: [
                    'Add ALL missing features: Community Board, Safety Plan, Progress Insights with charts, CSV/PDF export, Sleep Hygiene, Professional Dashboard - complete feature parity with desktop app',
                ]
            },
            {
                date: '2026-01-14',
                version: '1.8',
                title: 'Complete feature implementation: all original app functionality now in web ve...',
                changes: [
                    'Complete feature implementation: all original app functionality now in web version',
                ]
            },
            {
                date: '2026-01-14',
                version: '1.7',
                title: 'database update',
                changes: [
                    'database update',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.6',
                title: 'Fix registration error: remove main',
                changes: [
                    'Fix registration error: remove main. prefix from hash functions',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.5',
                title: 'push for web app',
                changes: [
                    'push for web app',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.4',
                title: 'Fix syntax error in api',
                changes: [
                    'Fix syntax error in api.py hash_pin function',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.3',
                title: 'Fix Railway deployment: Remove tkinter dependency from API',
                changes: [
                    'Fix Railway deployment: Remove tkinter dependency from API',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.2',
                title: 'Add Railway deployment guide (with placeholders for secrets)',
                changes: [
                    'Add Railway deployment guide (with placeholders for secrets)',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.1',
                title: 'Add Flask API for Railway deployment',
                changes: [
                    'Add Flask API for Railway deployment',
                ]
            },
            {
                date: '2026-01-12',
                version: '1.0',
                title: 'Initial commit: Mental health companion app with AI therapy',
                changes: [
                    'Initial commit: Mental health companion app with AI therapy',
                ]
            },
        ];



        function renderUpdatesLog() {
            const container = document.getElementById('updatesContainer');
            if (!container) return;

            container.innerHTML = APP_UPDATES.map(update => `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #667eea;">${update.title}</h4>
                        <span style="color: #999; font-size: 13px;">v${update.version} ‚Ä¢ ${formatUpdateDate(update.date)}</span>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        ${update.changes.map(change => `<li style="margin-bottom: 5px;">${change}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function formatUpdateDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function updateTherapyChatTitle() {
            const titleEl = document.getElementById('therapyChatTitle');
            if (!titleEl) return;

            if (currentClinicianName) {
                // Format clinician name nicely
                let formattedName = currentClinicianName;
                // Capitalize first letter
                formattedName = formattedName.charAt(0).toUpperCase() + formattedName.slice(1);
                // Add Dr. prefix if not already there
                if (!formattedName.toLowerCase().startsWith('dr')) {
                    formattedName = 'Dr. ' + formattedName;
                }
                titleEl.textContent = `${formattedName}'s Therapy Assistant`;
            } else {
                titleEl.textContent = 'Your Therapist';
            }
        }

        const PHQ9_QUESTIONS = [
            "Little interest or pleasure in doing things",
            "Feeling down, depressed, or hopeless",
            "Trouble falling/staying asleep, or sleeping too much",
            "Feeling tired or having little energy",
            "Poor appetite or overeating",
            "Feeling bad about yourself or that you are a failure",
            "Trouble concentrating on things",
            "Moving or speaking slowly, or being fidgety/restless",
            "Thoughts that you would be better off dead or hurting yourself"
        ];
        
        const GAD7_QUESTIONS = [
            "Feeling nervous, anxious or on edge",
            "Not being able to stop or control worrying",
            "Worrying too much about different things",
            "Trouble relaxing",
            "Being so restless that it is hard to sit still",
            "Becoming easily annoyed or irritable",
            "Feeling afraid as if something awful might happen"
        ];
        
        // Auth Functions
        // Auth Navigation Functions
        function showLanding() {
            hideAllAuthForms();
            document.getElementById('landingPage').classList.remove('hidden');
        }
        
        function showPatientAuth() {
            hideAllAuthForms();
            document.getElementById('patientLoginForm').classList.remove('hidden');
        }
        
        function showClinicianAuth() {
            hideAllAuthForms();
            document.getElementById('clinicianLoginForm').classList.remove('hidden');
        }

        // Show dev login modal (does not hide other forms)
        function showDevLogin() {
            document.getElementById('devLoginForm').classList.remove('hidden');
        }
        // Hide dev login modal
        function closeDevLogin() {
            document.getElementById('devLoginForm').classList.add('hidden');
        }
        
        console.log('Auth functions defined:', typeof showPatientAuth, typeof showClinicianAuth);
        
        function showPatientRegister() {
            hideAllAuthForms();
            document.getElementById('registerForm').classList.remove('hidden');
            // Set max date to today for DOB field
            document.getElementById('regDOB').max = new Date().toISOString().split('T')[0];
            initClinicianToggle();
            
            // Auto-search clinicians when area is filled in
            const areaInput = document.getElementById('regArea');
            if (areaInput) {
                areaInput.addEventListener('blur', function() {
                    if (this.value.trim() && document.getElementById('regHasClinician').checked) {
                        searchClinicians();
                    }
                });
            }
        }
        
        function showClinicianRegister() {
            hideAllAuthForms();
            document.getElementById('clinicianRegisterForm').classList.remove('hidden');
        }
        
        function showForgotPassword(userType) {
            hideAllAuthForms();
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
        }
        
        async function requestPasswordReset() {
            const username = document.getElementById('forgotUsername').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!username || !email) {
                showAuthMessage('Please enter your username and email', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Password reset link sent to your email!', 'success');
                    setTimeout(() => showLanding(), 3000);
                } else {
                    showAuthMessage(data.error || 'Failed to send reset link', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Password reset error:', error);
            }
        }
        
        function hideAllAuthForms() {
            // Hide only the direct children forms, not the entire auth screen
            const forms = document.querySelectorAll('#authScreen .auth-box > div');
            forms.forEach(form => {
                if (form.id) { // Only hide divs with an ID
                    form.classList.add('hidden');
                }
            });
            document.getElementById('authMessage').classList.add('hidden');
        }
        
        async function login(userType) {
            let username, password, pin, rememberMe;
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientLoginForm').classList.add('hidden');
            document.getElementById('clinicianLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            
            if (userType === 'user') {
                username = document.getElementById('loginUsername').value.trim();
                password = document.getElementById('loginPassword').value;
                pin = document.getElementById('loginPin').value;
                rememberMe = document.getElementById('rememberMe').checked;
            } else if (userType === 'developer') {
                username = document.getElementById('devLoginUsername').value.trim();
                password = document.getElementById('devLoginPassword').value;
                pin = document.getElementById('devLoginPin').value;
                rememberMe = false; // No remember me for developer
                document.getElementById('devLoginForm').classList.add('hidden');
            } else {
                username = document.getElementById('clinicianLoginUsername').value.trim();
                password = document.getElementById('clinicianLoginPassword').value;
                pin = document.getElementById('clinicianLoginPin').value;
                rememberMe = document.getElementById('clinicianRememberMe').checked;
            }
            
            if (!username || !password) {
                showAuthMessage('Please enter username and password', 'error');
                return;
            }
            
            if (!pin) {
                showAuthMessage('Please enter your 4-digit PIN for 2FA', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, pin })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = username;
                    currentUserRole = data.role || 'user';
                    
                    // Save session data
                    const sessionData = {
                        username: username,
                        role: data.role || 'user',
                        approval_status: data.approval_status,
                        clinician_id: data.clinician_id,
                        disclaimer_accepted: data.disclaimer_accepted
                    };
                    
                    if (rememberMe) {
                        // Save to localStorage (persists across browser sessions)
                        localStorage.setItem('healingSpaceSession', JSON.stringify(sessionData));
                    } else {
                        // Save to sessionStorage (clears when tab closes)
                        sessionStorage.setItem('healingSpaceSession', JSON.stringify(sessionData));
                    }
                    
                    // Proceed with login (disclaimer already accepted during registration)
                    completeLogin(data);
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Login error:', error);
            } finally {
                // Restore form visibility if login failed
                if (!currentUser) {
                    if (userType === 'user') {
                        document.getElementById('patientLoginForm').classList.remove('hidden');
                    } else if (userType === 'developer') {
                        document.getElementById('devLoginForm').classList.remove('hidden');
                    } else {
                        document.getElementById('clinicianLoginForm').classList.remove('hidden');
                    }
                }
            }
        }
        
        function showDisclaimerModal(userType) {
            // Show role-specific disclaimer
            if (userType === 'patient') {
                document.getElementById('patientDisclaimerModal').style.display = 'flex';
            } else if (userType === 'clinician') {
                document.getElementById('clinicianDisclaimerModal').style.display = 'flex';
            }
        }

        async function acceptDisclaimer() {
            try {
                // Close both modals (only one will be open)
                document.getElementById('patientDisclaimerModal').style.display = 'none';
                document.getElementById('clinicianDisclaimerModal').style.display = 'none';

                // Complete the registration with stored data
                if (tempLoginData) {
                    if (tempLoginData.type === 'patient') {
                        await completePatientRegistration(tempLoginData);
                    } else if (tempLoginData.type === 'clinician') {
                        await completeClinicianRegistration(tempLoginData);
                    }
                    tempLoginData = null; // Clear stored data
                }
            } catch (error) {
                console.error('Error accepting disclaimer:', error);
            }
        }
        
        function completeLogin(data) {
            document.getElementById('usernameDisplay').textContent = `Welcome, ${currentUser}!`;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';

            // Initialize AI activity logger
            try {
                if (activityLogger) { activityLogger.destroy(); }
                activityLogger = new ActivityLogger();
            } catch(e) { console.warn('Activity logger init error:', e); }

            // Store clinician name and update therapy chat title
            currentClinicianName = data.clinician_name || null;
            updateTherapyChatTitle();

            // Show professional tab only for clinicians
            if (currentUserRole === 'clinician') {
                document.getElementById('professionalTabBtn').style.display = 'block';
                document.getElementById('messagesTabBtn').style.display = 'inline-block';

                // Hide all patient-facing tab buttons for clinicians (except messages)
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id !== 'professionalTabBtn' && btn.id !== 'messagesTabBtn') {
                        btn.style.display = 'none';
                    }
                });
                
                // Hide all patient-facing tab content for clinicians
                const patientTabs = ['therapyTab', 'moodTab', 'gratitudeTab', 'cbtTab', 'petTab',
                                     'clinicalTab', 'communityTab', 'insightsTab',
                                     'historyTab'];
                patientTabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.style.display = 'none';
                    }
                });
                
                // Auto-switch to professional tab and show it
                document.getElementById('professionalTab').style.display = 'block';
                switchTab('professional', document.getElementById('professionalTabBtn'));
                // Default to overview subtab and load analytics data (with delay for DOM to render)
                setTimeout(() => {
                    switchClinicalTab('overview', document.getElementById('overviewSubtabBtn'));
                }, 100);
            } else if (currentUserRole === 'developer') {
                // DEVELOPER: Show only developer tab
                document.getElementById('developerTabBtn').style.display = 'block';

                // Hide patient and clinician tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id !== 'developerTabBtn') {
                        btn.style.display = 'none';
                    }
                });

                // Auto-switch to developer tab
                setTimeout(() => {
                    switchTab('developer', document.getElementById('developerTabBtn'));
                    switchDevTab('terminal', document.getElementById('terminalSubtabBtn'));
                }, 100);
            } else {
                // PATIENT: Hide professional tab, SHOW all patient tabs including messages
                document.getElementById('professionalTabBtn').style.display = 'none';
                document.getElementById('professionalTab').style.display = 'none';

                // Ensure patient tab buttons are visible (including messages)
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id !== 'professionalTabBtn' && btn.id !== 'developerTabBtn') {
                        btn.style.display = 'inline-block';
                    }
                });

                // Ensure patient tab content exists (will be shown/hidden by switchTab)
                const patientTabs = ['therapyTab', 'moodTab', 'gratitudeTab', 'cbtTab', 'petTab',
                                     'clinicalTab', 'communityTab', 'safetyTab', 'insightsTab',
                                     'sleepTab', 'historyTab'];
                patientTabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        // Don't force display here - let switchTab handle it
                        tab.style.display = '';
                    }
                });
            }
            
            // Check approval status for patients
            if (data.approval_status === 'pending') {
                alert('Your clinician has not yet approved your account. Some features may be limited until approval.');
            }
            
            loadNotifications();

            // Load messages for badge
            if (currentUserRole !== 'developer') {
                loadUserMessages();
            }

            // Only add system message for patients
            if (currentUserRole !== 'clinician') {
                // Load chat history first, then show greeting
                initializePatientSession();

                // Remove all active classes
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

                // Switch to HOME tab as default for patients and set active
                const homeBtn = document.querySelector('[onclick*="home"]');
                const homeTab = document.getElementById('homeTab');
                if (homeBtn) homeBtn.classList.add('active');
                if (homeTab) homeTab.classList.add('active');
                loadHomeTabData();
                // Check wellness ritual completion status on login
                setTimeout(() => initializeWellnessRitual(), 500);
                // Load Wins Board
                setTimeout(() => loadWinsBoard(), 300);

                loadPetStatus();
                checkMoodStatus(); // Check if mood logged today
                loadPatientAppointments(); // Load appointments for patient
            }

            // Refresh notifications and messages every 60 seconds
            setInterval(() => {
                loadNotifications();
                if (currentUserRole !== 'developer') {
                    loadUserMessages();
                }
            }, 60000);
        }
        
        // Initialize patient session with chat history and greeting
        async function initializePatientSession() {
            try {
                // Load chat sessions first
                await loadChatSessions();
                
                // First, check if chat needs initialization (first-time user)
                await initializeChatIfNeeded();
                
                // Load existing chat history
                await loadChatHistory();
                
                // Then show personalized greeting (only if not first time)
                const history = await fetch(`/api/therapy/history?username=${currentUser}`).then(r => r.json());
                if (history.history && history.history.length > 1) {
                    // Has chat history beyond welcome message
                    await showPersonalizedGreeting();
                }
            } catch (error) {
                console.error('Error initializing session:', error);
            }
        }
        
        // Initialize chat for first-time users
        async function initializeChatIfNeeded() {
            try {
                const response = await fetch('/api/therapy/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok && !data.already_exists) {
                    // First-time user - chat initialized with welcome message
                    console.log('Chat initialized for new user');
                }
            } catch (error) {
                console.error('Error initializing chat:', error);
            }
        }
        
        // Load chat history from previous sessions
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/therapy/history?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.history && data.history.length > 0) {
                    // Clear existing messages
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // Add history
                    data.history.forEach(msg => {
                        addMessage(msg.message, msg.sender);
                    });
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        // Show personalized greeting based on user context
        async function showPersonalizedGreeting() {
            try {
                const response = await fetch('/api/therapy/greeting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok && data.greeting) {
                    addMessage(data.greeting, 'ai');
                }
            } catch (error) {
                console.error('Error loading greeting:', error);
                // Fallback to simple greeting
                addMessage('Welcome back! How are you feeling today?', 'ai');
            }
        }
        
        // Check if user has logged mood today
        async function checkMoodStatus() {
            try {
                const response = await fetch(`/api/mood/check-today?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.logged_today) {
                    // Show status indicator that mood is already logged
                    const moodTab = document.querySelector('[onclick*="mood"]');
                    if (moodTab && !moodTab.textContent.includes('‚úì')) {
                        moodTab.innerHTML = '‚úì Mood & Habits';
                    }
                }
            } catch (error) {
                console.error('Error checking mood status:', error);
            }
        }
        
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrengthFill');
            const strengthText = document.getElementById('passwordStrengthText');
            
            let strength = 0;
            let feedback = 'Weak';
            let color = '#dc3545';
            
            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 25;
            
            if (strength <= 25) {
                feedback = 'Weak';
                color = '#dc3545';
            } else if (strength <= 50) {
                feedback = 'Fair';
                color = '#ffc107';
            } else if (strength <= 75) {
                feedback = 'Good';
                color = '#17a2b8';
            } else {
                feedback = 'Strong';
                color = '#28a745';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
            strengthText.textContent = `Password strength: ${feedback}`;
            strengthText.style.color = color;
        }
        
        async function register() {
            const fullName = document.getElementById('regFullName').value.trim();
            const preferredName = document.getElementById('regPreferredName').value.trim();
            const dob = document.getElementById('regDOB').value;
            const conditions = document.getElementById('regConditions').value.trim();
            const area = document.getElementById('regArea').value.trim();
            const postcode = document.getElementById('regPostcode').value.trim();
            const nhs_number = document.getElementById('regNHS').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const pin = document.getElementById('regPin').value;
            const confirmPin = document.getElementById('regConfirmPin').value;
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const hasClinician = document.getElementById('regHasClinician').checked;
            const clinician_id = hasClinician ? document.getElementById('regClinician').value : null;
            
            if (!fullName) {
                showAuthMessage('Please enter your full name', 'error');
                return;
            }
            
            if (!preferredName) {
                showAuthMessage('Please enter your preferred name (what we\'ll call you)', 'error');
                return;
            }
            
            if (!dob) {
                showAuthMessage('Please enter your date of birth', 'error');
                return;
            }
            
            if (!conditions) {
                showAuthMessage('Please describe your medical conditions or diagnosis', 'error');
                return;
            }
            
            if (!area) {
                showAuthMessage('Please enter your UK area/region', 'error');
                return;
            }
            
            if (!username || !password || !pin || !email || !phone) {
                showAuthMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (hasClinician && !clinician_id) {
                showAuthMessage('Please select your clinician or uncheck the clinician option', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showAuthMessage('PINs do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            // Validate password requirements
            if (!/[a-z]/.test(password) || !/[A-Z]/.test(password)) {
                showAuthMessage('Password must contain both lowercase and uppercase letters', 'error');
                return;
            }
            
            if (!/[0-9]/.test(password)) {
                showAuthMessage('Password must contain at least one number', 'error');
                return;
            }
            
            if (!/[^a-zA-Z0-9]/.test(password)) {
                showAuthMessage('Password must contain at least one special character (!@#$%^&* etc.)', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showAuthMessage('PIN must be 4 digits', 'error');
                return;
            }
            
            // Store registration data and show disclaimer
            currentUser = username;
            tempLoginData = { 
                type: 'patient',
                username, 
                password, 
                pin,
                email,
                phone,
                full_name: fullName,
                preferred_name: preferredName,
                dob: dob,
                conditions: conditions,
                clinician_id: clinician_id || undefined,
                country: 'United Kingdom',
                area,
                postcode,
                nhs_number
            };
            showDisclaimerModal('patient');
        }
        
        async function completePatientRegistration(data) {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: data.username, 
                        password: data.password, 
                        pin: data.pin,
                        email: data.email,
                        phone: data.phone,
                        full_name: data.full_name,
                        preferred_name: data.preferred_name,
                        dob: data.dob,
                        conditions: data.conditions,
                        clinician_id: data.clinician_id,
                        country: data.country,
                        area: data.area,
                        postcode: data.postcode,
                        nhs_number: data.nhs_number,
                        disclaimer_accepted: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Account created! Awaiting clinician approval.', 'success');
                    setTimeout(() => {
                        showPatientAuth();
                        document.getElementById('loginUsername').value = data.username;
                    }, 3000);
                } else {
                    showAuthMessage(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Register error:', error);
            }
        }
        
        async function registerClinician() {
            const username = document.getElementById('clinicianUsername').value.trim();
            const password = document.getElementById('clinicianPassword').value;
            const confirmPassword = document.getElementById('clinicianConfirmPassword').value;
            const pin = document.getElementById('clinicianPin').value;
            const confirmPin = document.getElementById('clinicianConfirmPin').value;
            const full_name = document.getElementById('clinicianFullName').value.trim();
            const email = document.getElementById('clinicianEmail').value.trim();
            const phone = document.getElementById('clinicianPhone').value.trim();
            const professional_id = document.getElementById('clinicianProfessionalId').value.trim();
            const country = document.getElementById('clinicianCountry').value.trim();
            const area = document.getElementById('clinicianArea').value.trim();
            
            if (!username || !password || !pin || !email || !phone || !full_name) {
                showAuthMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (!professional_id) {
                showAuthMessage('Please enter your professional ID number', 'error');
                return;
            }
            
            if (!country || !area) {
                showAuthMessage('Please enter your country and area', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showAuthMessage('PINs do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showAuthMessage('PIN must be exactly 4 digits', 'error');
                return;
            }
            
            // Store registration data and show disclaimer
            currentUser = username;
            tempLoginData = { 
                type: 'clinician',
                username, 
                password, 
                pin,
                full_name,
                email,
                phone,
                professional_id,
                country,
                area
            };
            showDisclaimerModal('clinician');
        }
        
        async function completeClinicianRegistration(data) {
            try {
                const response = await fetch('/api/auth/clinician/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: data.username, 
                        password: data.password, 
                        pin: data.pin, 
                        full_name: data.full_name,
                        email: data.email,
                        phone: data.phone,
                        professional_id: data.professional_id,
                        country: data.country,
                        area: data.area,
                        disclaimer_accepted: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Clinician account created successfully! Please login.', 'success');
                    setTimeout(() => {
                        showClinicianAuth();
                        document.getElementById('clinicianLoginUsername').value = data.username;
                    }, 2000);
                } else {
                    showAuthMessage(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Clinician register error:', error);
            }
        }
        
        async function searchClinicians() {
            try {
                const searchQuery = document.getElementById('regClinicianSearch')?.value.trim() || '';
                const area = document.getElementById('regArea')?.value.trim() || '';
                
                if (!searchQuery && !area) {
                    showAuthMessage('Please enter a clinician name/username or area', 'error');
                    return;
                }
                
                let url = '/api/clinicians/list';
                const params = new URLSearchParams();
                params.append('country', 'United Kingdom');
                if (searchQuery) params.append('search', searchQuery);
                if (area) params.append('area', area);
                url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                const select = document.getElementById('regClinician');
                const placeholder = document.getElementById('clinicianDropdownPlaceholder');
                
                if (response.ok && data.clinicians && data.clinicians.length > 0) {
                    select.innerHTML = '<option value="">-- Select your clinician --</option>' +
                        data.clinicians.map(c => 
                            `<option value="${escapeHtml(c.username)}">${escapeHtml(c.full_name || c.username)}${c.area ? ' (' + escapeHtml(c.area) + ')' : ''}</option>`
                        ).join('');
                    select.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    showAuthMessage(`‚úÖ Found ${data.clinicians.length} clinician(s) - Select from dropdown`, 'success');
                } else {
                    select.innerHTML = '<option value="">-- No clinicians found --</option>';
                    select.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    showAuthMessage('‚ö†Ô∏è No clinicians match your search. Try a different name or area.', 'error');
                }
            } catch (error) {
                console.error('Error searching clinicians:', error);
                const select = document.getElementById('regClinician');
                select.innerHTML = '<option value="">Error loading clinicians</option>';
                select.style.display = 'block';
                const placeholder = document.getElementById('clinicianDropdownPlaceholder');
                if (placeholder) placeholder.style.display = 'none';
                showAuthMessage('Error searching for clinicians. Please try again.', 'error');
            }
        }
        
        // Toggle clinician section based on checkbox
        function initClinicianToggle() {
            const clinicianCheckbox = document.getElementById('regHasClinician');
            const clinicianSection = document.getElementById('clinicianSection');
            if (clinicianCheckbox) {
                clinicianCheckbox.addEventListener('change', function() {
                    if (clinicianSection) {
                        clinicianSection.style.display = this.checked ? 'block' : 'none';
                        const clinicianSelect = document.getElementById('regClinician');
                        if (clinicianSelect) {
                            clinicianSelect.required = this.checked;
                        }
                        const clinicianSearch = document.getElementById('regClinicianSearch');
                        if (clinicianSearch) {
                            clinicianSearch.required = this.checked;
                        }
                    }
                });
            }
        }
        
        // Initialize when showing patient registration form
        document.addEventListener('DOMContentLoaded', initClinicianToggle);
        
        function showAuthMessage(message, type) {
            const msgDiv = document.getElementById('authMessage');
            
            // Clear previous content
            msgDiv.innerHTML = '';
            
            // Create message text
            const messageText = document.createElement('div');
            messageText.textContent = message;
            messageText.style.marginBottom = '15px';
            msgDiv.appendChild(messageText);
            
            // Add back button for error messages
            if (type === 'error') {
                const backButton = document.createElement('button');
                backButton.textContent = 'Try Again';
                backButton.className = 'btn btn-secondary';
                backButton.style.marginTop = '10px';
                backButton.onclick = function() {
                    msgDiv.classList.add('hidden');
                    showLanding();
                };
                msgDiv.appendChild(backButton);
            }
            
            msgDiv.className = `alert alert-${type}`;
            msgDiv.classList.remove('hidden');
        }
        
        // Notification Functions
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/notifications?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.notifications) {
                    const unreadCount = data.notifications.filter(n => !n.read).length;
                    const badge = document.getElementById('notificationBadge');
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                    
                    const list = document.getElementById('notificationList');
                    if (data.notifications.length === 0) {
                        list.innerHTML = '<div class="notification-item">No notifications</div>';
                    } else {
                        // Add "Clear All Read" button if there are read notifications
                        const hasReadNotifications = data.notifications.some(n => n.read);
                        let headerHtml = '';
                        if (hasReadNotifications) {
                            headerHtml = `
                                <div style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">
                                    <button onclick="clearReadNotifications()" style="background: #f0f0f0; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        üóëÔ∏è Clear Read
                                    </button>
                                </div>
                            `;
                        }

                        list.innerHTML = headerHtml + data.notifications.map(n => {
                            // Add emoji and action based on notification type
                            let emoji = 'üì¨';
                            let onClick = `markNotificationRead(${n.id})`;

                            if (n.notification_type === 'appointment_new') {
                                emoji = 'üìÖ';
                                onClick = `markNotificationRead(${n.id}); switchTab('appointments')`;
                            } else if (n.notification_type === 'appointment_response') {
                                emoji = '‚úì';
                            } else if (n.notification_type === 'crisis_alert') {
                                emoji = 'üö®';
                            } else if (n.notification_type === 'approval') {
                                emoji = '‚úÖ';
                            } else if (n.notification_type === 'dev_message') {
                                emoji = 'üì®';
                                onClick = `markNotificationRead(${n.id}); switchTab('${currentUserRole === 'clinician' ? 'professional' : currentUserRole === 'developer' ? 'developer' : 'home'}', null); setTimeout(() => switchMessageTab('inbox', null), 100)`;
                            } else if (n.notification_type === 'message') {
                                emoji = 'üí¨';
                                onClick = `markNotificationRead(${n.id}); switchTab('${currentUserRole === 'clinician' ? 'professional' : currentUserRole === 'developer' ? 'developer' : 'home'}', null); setTimeout(() => switchMessageTab('inbox', null), 100)`;
                            }

                            return `
                                <div class="notification-item ${n.read ? '' : 'unread'}" style="position: relative;">
                                    <div onclick="${onClick}" style="cursor: pointer;">
                                        <strong>${emoji} ${n.notification_type}</strong>
                                        <p>${sanitizeHTML(n.message)}</p>
                                        <small>${new Date(n.created_at).toLocaleString()}</small>
                                    </div>
                                    <button onclick="event.stopPropagation(); deleteNotification(${n.id})"
                                        style="position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; opacity: 0.5; font-size: 14px;"
                                        title="Delete notification">‚úï</button>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function showNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeNotifications() {
            document.getElementById('notificationPanel').style.display = 'none';
        }
        
        async function markNotificationRead(id) {
            try {
                await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function deleteNotification(id) {
            try {
                const response = await fetch(`/api/notifications/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadNotifications();
                } else {
                    console.error('Failed to delete notification');
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
            }
        }

        async function clearReadNotifications() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/notifications/clear-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                if (response.ok) {
                    loadNotifications();
                } else {
                    console.error('Failed to clear read notifications');
                }
            } catch (error) {
                console.error('Error clearing read notifications:', error);
            }
        }

        // Patient Approval Functions
        async function loadPendingApprovals() {
            if (currentUserRole !== 'clinician') return;
            
            try {
                const response = await fetch(`/api/approvals/pending?clinician=${currentUser}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                const container = document.getElementById('pendingApprovals');
                if (response.ok && data.pending_approvals && data.pending_approvals.length > 0) {
                    container.innerHTML = data.pending_approvals.map(approval => `
                        <div class="approval-request">
                            <div>
                                <strong>${sanitizeHTML(approval.patient_username)}</strong>
                                <p>Requested: ${new Date(approval.request_date).toLocaleString()}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="approvePatient(${approval.id})">
                                    ‚úì Approve
                                </button>
                                <button class="btn btn-danger" onclick="rejectPatient(${approval.id})">
                                    ‚úó Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #666;">No pending approval requests</p>';
                }
            } catch (error) {
                console.error('Error loading pending approvals:', error);
            }
        }
        
        async function approvePatient(approvalId) {
            if (!confirm('Approve this patient?')) return;
            
            try {
                const response = await fetch(`/api/approvals/${approvalId}/approve`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clinician_username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Patient approved successfully!');
                    loadPendingApprovals();
                    loadNotifications();
                } else {
                    alert(data.error || 'Failed to approve patient');
                }
            } catch (error) {
                console.error('Error approving patient:', error);
                alert('Error approving patient');
            }
        }
        
        async function rejectPatient(approvalId) {
            if (!confirm('Reject this patient request?')) return;
            
            try {
                const response = await fetch(`/api/approvals/${approvalId}/reject`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clinician_username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Patient request rejected');
                    loadPendingApprovals();
                    loadNotifications();
                } else {
                    alert(data.error || 'Failed to reject patient');
                }
            } catch (error) {
                console.error('Error rejecting patient:', error);
                alert('Error rejecting patient');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Log logout to activity logger
                try {
                    if (activityLogger) { activityLogger.destroy(); activityLogger = null; }
                } catch(e) {}

                // Clear all session data
                localStorage.removeItem('healingSpaceSession');
                sessionStorage.removeItem('healingSpaceSession');
                
                currentUser = null;
                currentUserRole = 'user';
                document.getElementById('professionalTabBtn').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('chatMessages').innerHTML = '';
                selectedMoodValue = null;
                medications = [];
                
                // Clear login forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPin').value = '';
                document.getElementById('clinicianLoginUsername').value = '';
                document.getElementById('clinicianLoginPassword').value = '';
                document.getElementById('clinicianLoginPin').value = '';
                
                // Return to landing page
                showLanding();
            }
        }
        
        // Tab Navigation
        function switchTab(tabName, buttonEl) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName + 'Tab').classList.add('active');
            if (buttonEl) buttonEl.classList.add('active');

            // Log tab change to activity logger
            try {
                document.dispatchEvent(new CustomEvent('tabchange', { detail: { tabName: tabName } }));
            } catch(e) {}

            // Always reload Home tab data for patients
            if (tabName === 'home' && currentUserRole !== 'clinician' && currentUserRole !== 'developer') {
                loadHomeTabData();
                // Check and initialize wellness ritual if not yet completed today
                setTimeout(() => initializeWellnessRitual(), 500);
                // Load Wins Board
                setTimeout(() => loadWinsBoard(), 300);
            }

            // Load pet when switching to pet tab
            if (tabName === 'pet') {
                loadPetStatus();
            }
            
            // Load profile when switching to About Me tab
            if (tabName === 'aboutme') {
                loadProfile();
                // Sync dark mode toggle with current theme
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) {
                    toggle.checked = document.documentElement.getAttribute('data-theme') === 'dark';
                }
            }
            
            // Load appointments when switching to appointments tab
            if (tabName === 'appointments' && currentUserRole !== 'clinician') {
                loadPatientAppointments();
            }

            // Load messages when switching to messages tab
            if (tabName === 'messages') {
                checkAndLoadMessages();
            }

            // Load updates when switching to updates tab
            if (tabName === 'updates') {
                renderUpdatesLog();
            }

            // Load professional tab and default to overview
            if (tabName === 'professional' && currentUserRole === 'clinician') {
                // Default to overview subtab
                switchClinicalTab('overview', document.getElementById('overviewSubtabBtn'));
            }

            // Load community channels and start auto-refresh when switching to community tab
            if (tabName === 'community') {
                initCommunity();
                startCommunityAutoRefresh();
            } else {
                // Stop auto-refresh when leaving community tab
                stopCommunityAutoRefresh();
            }
        }
        
        // Clinical Dashboard Subtab Switching
        function switchClinicalTab(subtabName, buttonEl) {
            // Hide all clinical subtabs
            document.querySelectorAll('.clinical-subtab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Reset all clinical subtab buttons
            document.querySelectorAll('.clinical-subtab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#667eea';
                btn.style.border = '2px solid #667eea';
            });
            
            // Show selected subtab
            document.getElementById('clinical' + subtabName.charAt(0).toUpperCase() + subtabName.slice(1) + 'Tab').style.display = 'block';
            
            // Highlight selected button
            if (buttonEl) {
                buttonEl.style.background = '#667eea';
                buttonEl.style.color = 'white';
                buttonEl.style.border = 'none';
            }
            
            // Load data for specific subtabs
            if (subtabName === 'overview') {
                loadAnalyticsDashboard();
            } else if (subtabName === 'patients') {
                loadPatients();
            } else if (subtabName === 'appointments') {
                loadAppointments();
            } else if (subtabName === 'approvals') {
                loadPendingApprovals();
            } else if (subtabName === 'riskmonitor') {
                loadRiskDashboard();
            }
        }
        
        // ===== SAFETY CHECK / C-SSRS ASSESSMENT FUNCTIONS =====
        
        // C-SSRS Assessment Questions (Columbia-Suicide Severity Rating Scale)
        const C_SSRS_QUESTIONS = [
            {
                id: 1,
                question: "In the past week, have you wished you were dead or wished you could go to sleep and not wake up?",
                category: "ideation",
                options: [
                    { text: "No", score: 0 },
                    { text: "Several days", score: 1 },
                    { text: "More than half the days", score: 2 },
                    { text: "Nearly every day", score: 3 }
                ]
            },
            {
                id: 2,
                question: "In the past week, have you actually had any thoughts of killing yourself?",
                category: "ideation_active",
                options: [
                    { text: "No", score: 0 },
                    { text: "Yes, but I don't think I would do it", score: 1 },
                    { text: "Yes, I think about it regularly", score: 2 },
                    { text: "Yes, and I plan to do it", score: 3 }
                ]
            },
            {
                id: 3,
                question: "Have you ever tried to kill yourself, and if so, was it within the past week?",
                category: "attempt",
                options: [
                    { text: "Never tried", score: 0 },
                    { text: "Tried before, but not in past week", score: 1 },
                    { text: "Tried within the past week", score: 2 },
                    { text: "Currently planning an attempt", score: 3 }
                ]
            },
            {
                id: 4,
                question: "In the past week, how have you been feeling about staying alive vs ending your life?",
                category: "intent",
                options: [
                    { text: "I definitely want to live", score: 0 },
                    { text: "I want to live, but it's unclear sometimes", score: 1 },
                    { text: "The thoughts are equal - living vs dying", score: 2 },
                    { text: "I strongly feel I should be dead", score: 3 }
                ]
            },
            {
                id: 5,
                question: "In the past week, have you done anything to prepare for an attempt (stockpiling medication, planning method, saying goodbye)?",
                category: "planning",
                options: [
                    { text: "No, nothing", score: 0 },
                    { text: "I've thought about it but taken no action", score: 1 },
                    { text: "I've started preparing (research, gathering items)", score: 2 },
                    { text: "I've actively prepared (have means, have plan, given things away)", score: 3 }
                ]
            },
            {
                id: 6,
                question: "Right now, how confident are you that you can keep yourself safe?",
                category: "safety",
                options: [
                    { text: "Completely confident - I can keep myself safe", score: 0 },
                    { text: "Fairly confident", score: 1 },
                    { text: "Not very confident", score: 2 },
                    { text: "Not confident at all", score: 3 }
                ]
            }
        ];
        
        // Safety Assessment State
        let safetyAssessmentState = {
            active: false,
            currentQuestion: 0,
            responses: [],
            score: 0,
            timestamp: null,
            riskLevel: null,
            safetyPlan: {
                warningSigns: '',
                copingInternal: '',
                distractions: '',
                people: [],
                environment: ''
            }
        };
        
        function startSafetyAssessment() {
            safetyAssessmentState = {
                active: true,
                currentQuestion: 0,
                responses: [],
                score: 0,
                timestamp: new Date().toISOString(),
                riskLevel: null,
                safetyPlan: {
                    warningSigns: '',
                    copingInternal: '',
                    distractions: '',
                    people: [],
                    environment: ''
                }
            };
            
            // Hide start screen
            document.getElementById('safetyStartScreen').style.display = 'none';
            document.getElementById('safetyAssessmentContainer').style.display = 'block';
            document.getElementById('safetyResultsContainer').style.display = 'none';
            
            // Load first question
            displayAssessmentQuestion();
        }
        
        function displayAssessmentQuestion() {
            const question = C_SSRS_QUESTIONS[safetyAssessmentState.currentQuestion];
            const progress = ((safetyAssessmentState.currentQuestion + 1) / C_SSRS_QUESTIONS.length) * 100;
            
            // Update progress bar
            document.getElementById('assessmentProgressBar').style.width = progress + '%';
            document.getElementById('assessmentProgressText').textContent = `Question ${safetyAssessmentState.currentQuestion + 1} of ${C_SSRS_QUESTIONS.length}`;
            
            // Update button visibility
            document.getElementById('assessmentPrevBtn').style.display = safetyAssessmentState.currentQuestion === 0 ? 'none' : 'block';
            document.getElementById('assessmentNextBtn').textContent = safetyAssessmentState.currentQuestion === C_SSRS_QUESTIONS.length - 1 ? '‚úì Submit Assessment' : 'Next ‚Üí';
            
            // Build question HTML
            let optionsHtml = '<div class="assessment-options">';
            question.options.forEach((option, idx) => {
                const selectedClass = safetyAssessmentState.responses[safetyAssessmentState.currentQuestion]?.score === option.score ? 'selected' : '';
                optionsHtml += `
                    <div class="assessment-option ${selectedClass}" onclick="selectAssessmentOption(${idx}, ${option.score})">
                        <span class="assessment-option-text">${option.text}</span>
                    </div>
                `;
            });
            optionsHtml += '</div>';
            
            const questionsHtml = `
                <div class="assessment-question">
                    <h4>${question.question}</h4>
                    ${optionsHtml}
                </div>
            `;
            
            document.getElementById('assessmentQuestionsArea').innerHTML = questionsHtml;
        }
        
        function selectAssessmentOption(optionIdx, score) {
            const question = C_SSRS_QUESTIONS[safetyAssessmentState.currentQuestion];
            safetyAssessmentState.responses[safetyAssessmentState.currentQuestion] = {
                question: question.id,
                option: question.options[optionIdx].text,
                score: score,
                category: question.category
            };
            
            // Visual feedback
            document.querySelectorAll('.assessment-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Auto-advance to next after selection (subtle UX)
            setTimeout(() => {
                if (safetyAssessmentState.currentQuestion < C_SSRS_QUESTIONS.length - 1) {
                    nextAssessmentQuestion();
                }
            }, 300);
        }
        
        function nextAssessmentQuestion() {
            if (safetyAssessmentState.responses[safetyAssessmentState.currentQuestion] === undefined) {
                alert('Please select an answer before continuing.');
                return;
            }
            
            if (safetyAssessmentState.currentQuestion === C_SSRS_QUESTIONS.length - 1) {
                // Submit assessment
                submitSafetyAssessment();
                return;
            }
            
            safetyAssessmentState.currentQuestion++;
            displayAssessmentQuestion();
        }
        
        function previousAssessmentQuestion() {
            if (safetyAssessmentState.currentQuestion > 0) {
                safetyAssessmentState.currentQuestion--;
                displayAssessmentQuestion();
            }
        }
        
        function skipAssessmentQuestion() {
            safetyAssessmentState.responses[safetyAssessmentState.currentQuestion] = {
                question: C_SSRS_QUESTIONS[safetyAssessmentState.currentQuestion].id,
                option: "Skipped",
                score: 0,
                category: C_SSRS_QUESTIONS[safetyAssessmentState.currentQuestion].category
            };
            
            if (safetyAssessmentState.currentQuestion === C_SSRS_QUESTIONS.length - 1) {
                submitSafetyAssessment();
            } else {
                safetyAssessmentState.currentQuestion++;
                displayAssessmentQuestion();
            }
        }
        
        function submitSafetyAssessment() {
            // Calculate total score
            safetyAssessmentState.score = safetyAssessmentState.responses.reduce((sum, resp) => sum + (resp?.score || 0), 0);
            
            // Determine risk level
            // Score range: 0-18 (6 questions x 3 max)
            if (safetyAssessmentState.score === 0) {
                safetyAssessmentState.riskLevel = 'low';
            } else if (safetyAssessmentState.score <= 6) {
                safetyAssessmentState.riskLevel = 'moderate';
            } else if (safetyAssessmentState.score <= 12) {
                safetyAssessmentState.riskLevel = 'high';
            } else {
                safetyAssessmentState.riskLevel = 'critical';
            }
            
            // Check for critical indicators
            const hasSuicidalPlanning = safetyAssessmentState.responses.some(r => r?.category === 'planning' && r.score >= 2);
            const hasSuicidalIntent = safetyAssessmentState.responses.some(r => r?.category === 'intent' && r.score >= 2);
            const hasSuicidalIdeation = safetyAssessmentState.responses.some(r => r?.category === 'ideation_active' && r.score >= 2);
            
            if ((hasSuicidalPlanning || (hasSuicidalIdeation && hasSuicidalIntent))) {
                safetyAssessmentState.riskLevel = 'critical';
            }
            
            // Show results
            displayAssessmentResults();
            
            // Submit to backend
            submitSafetyAssessmentToBackend();
        }
        
        function displayAssessmentResults() {
            // Hide questions, show results
            document.getElementById('safetyAssessmentContainer').style.display = 'none';
            document.getElementById('safetyResultsContainer').style.display = 'block';
            
            // Update result display based on risk level
            const resultIcons = { low: 'üü¢', moderate: 'üü†', high: 'üî¥', critical: 'üö®' };
            const resultTitles = { 
                low: 'You\'re Doing Well', 
                moderate: 'Some Concern', 
                high: 'We\'re Here to Help',
                critical: 'Crisis Support Available Now'
            };
            
            document.getElementById('resultsRiskIndicator').textContent = resultIcons[safetyAssessmentState.riskLevel];
            document.getElementById('resultsRiskTitle').textContent = resultTitles[safetyAssessmentState.riskLevel];
            
            // Hide all result content, show appropriate one
            document.getElementById('resultsLowRiskContent').style.display = 'none';
            document.getElementById('resultsModerateRiskContent').style.display = 'none';
            document.getElementById('resultsHighRiskContent').style.display = 'none';
            document.getElementById('safetyPlanSection').style.display = 'none';
            
            if (safetyAssessmentState.riskLevel === 'low') {
                document.getElementById('resultsLowRiskContent').style.display = 'block';
            } else if (safetyAssessmentState.riskLevel === 'moderate') {
                document.getElementById('resultsModerateRiskContent').style.display = 'block';
                document.getElementById('safetyPlanSection').style.display = 'block';
            } else {
                document.getElementById('resultsHighRiskContent').style.display = 'block';
                document.getElementById('safetyPlanSection').style.display = 'block';
            }
            
            // Set message
            const messages = {
                low: 'Your responses indicate you\'re coping well right now. Keep using the tools and reach out if things change.',
                moderate: 'Your responses suggest you could use additional support. We want to help you work through this.',
                high: 'Your safety is our priority. We\'re connecting you with immediate support and your clinician will be notified.',
                critical: 'We\'re very concerned about your safety. Professional support is available right now.'
            };
            document.getElementById('resultsRiskMessage').textContent = messages[safetyAssessmentState.riskLevel];
        }
        
        function addSafetyPerson() {
            const name = document.getElementById('safetyPersonName').value.trim();
            const phone = document.getElementById('safetyPersonPhone').value.trim();
            
            if (!name || !phone) {
                alert('Please enter both name and phone number.');
                return;
            }
            
            safetyAssessmentState.safetyPlan.people.push({ name, phone });
            
            // Add to display
            let peopleHtml = '';
            safetyAssessmentState.safetyPlan.people.forEach((person, idx) => {
                peopleHtml += `
                    <div class="safety-person-chip">
                        ${sanitizeHTML(person.name)}: ${sanitizeHTML(person.phone)}
                        <button onclick="removeSafetyPerson(${idx})">√ó</button>
                    </div>
                `;
            });
            document.getElementById('safetyPeopleList').innerHTML = peopleHtml;
            
            // Clear inputs
            document.getElementById('safetyPersonName').value = '';
            document.getElementById('safetyPersonPhone').value = '';
        }
        
        function removeSafetyPerson(idx) {
            safetyAssessmentState.safetyPlan.people.splice(idx, 1);
            
            // Redraw
            let peopleHtml = '';
            safetyAssessmentState.safetyPlan.people.forEach((person, idx) => {
                peopleHtml += `
                    <div class="safety-person-chip">
                        ${sanitizeHTML(person.name)}: ${sanitizeHTML(person.phone)}
                        <button onclick="removeSafetyPerson(${idx})">√ó</button>
                    </div>
                `;
            });
            document.getElementById('safetyPeopleList').innerHTML = peopleHtml;
        }
        
        function saveSafetyPlan() {
            // Collect safety plan data
            safetyAssessmentState.safetyPlan = {
                warningSigns: document.getElementById('safetyWarningSigns').value,
                copingInternal: document.getElementById('safetyCopingInternal').value,
                distractions: document.getElementById('safetyDistractions').value,
                people: safetyAssessmentState.safetyPlan.people,
                environment: document.getElementById('safetyEnvironment').value
            };
            
            if (!safetyAssessmentState.safetyPlan.warningSigns || 
                !safetyAssessmentState.safetyPlan.copingInternal || 
                !safetyAssessmentState.safetyPlan.distractions || 
                !safetyAssessmentState.safetyPlan.environment) {
                alert('Please complete all sections of your safety plan.');
                return;
            }
            
            // Submit safety plan to backend
            submitSafetyPlanToBackend();
        }
        
        async function submitSafetyAssessmentToBackend() {
            try {
                const response = await fetch('/api/c-ssrs/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        responses: safetyAssessmentState.responses,
                        timestamp: safetyAssessmentState.timestamp
                    })
                });
                
                const data = await response.json();
                if (!response.ok) {
                    console.error('Assessment submission error:', data);
                }
            } catch (error) {
                console.error('Safety assessment submission error:', error);
            }
        }
        
        async function submitSafetyPlanToBackend() {
            try {
                const response = await fetch('/api/c-ssrs/{id}/safety-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        safety_plan: safetyAssessmentState.safetyPlan,
                        assessment_timestamp: safetyAssessmentState.timestamp
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('‚úì Your safety plan has been saved and your clinician notified.');
                    closeSafetyAssessment();
                } else {
                    console.error('Safety plan submission error:', data);
                    alert('Safety plan saved locally.');
                    closeSafetyAssessment();
                }
            } catch (error) {
                console.error('Safety plan submission error:', error);
                alert('Safety plan saved locally.');
                closeSafetyAssessment();
            }
        }
        
        function closeSafetyAssessment() {
            document.getElementById('safetyStartScreen').style.display = 'block';
            document.getElementById('safetyAssessmentContainer').style.display = 'none';
            document.getElementById('safetyResultsContainer').style.display = 'none';
            safetyAssessmentState.active = false;
        }
        
        function skipSafetyAssessment() {
            closeSafetyAssessment();
        }
        
        // ===== REAL-TIME RISK DETECTION IN CHAT =====
        function updateChatRiskIndicator(riskAnalysis) {
            if (!riskAnalysis) return;
            
            const container = document.getElementById('riskIndicatorContainer');
            const scoreLevelMap = {
                'green': { title: '‚úì No Risk', message: 'You\'re safe. Keep sharing.' },
                'amber': { title: '‚ö†Ô∏è Monitor', message: 'We\'re watching for changes.' },
                'orange': { title: 'üî∏ Concerning', message: 'Some risk indicators detected.' },
                'red': { title: 'üî¥ High Risk', message: 'We\'re concerned about your safety.' }
            };
            
            const info = scoreLevelMap[riskAnalysis.risk_level] || scoreLevelMap['green'];
            
            // Update indicator
            const dot = document.getElementById('riskIndicatorDot');
            dot.classList = `risk-dot risk-${riskAnalysis.risk_level}`;
            
            document.getElementById('riskIndicatorTitle').textContent = info.title;
            document.getElementById('riskIndicatorMessage').textContent = info.message;
            
            // Show if not low risk
            if (riskAnalysis.risk_level !== 'green') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        // Chat Functions
        let isVoiceListening = false;
        let speechRecognition = null;

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // === /suggest slash command handling ===
            if (message.startsWith('/suggest ')) {
                const suggestionText = message.substring(9).trim();
                if (!suggestionText) {
                    showToast('Please provide feedback after /suggest', 'warning');
                    return;
                }
                if (suggestionText.length > 300) {
                    showToast('Suggestion must be 300 characters or fewer', 'warning');
                    return;
                }
                input.value = '';
                input.style.height = 'auto';
                await saveSuggestion(suggestionText);
                return;
            }
            if (message === '/suggest') {
                showToast('Usage: /suggest Your feedback here', 'info');
                input.value = '';
                return;
            }
            if (message === '/suggestions') {
                input.value = '';
                toggleSuggestionManager();
                return;
            }

            // Log message send to activity logger (metadata only, not content)
            try {
                if (activityLogger) {
                    activityLogger.logActivity('message_sent', 'length:' + message.length, 'therapy');
                }
            } catch(e) {}

            addMessage(message, 'user', null, new Date().toISOString());
            input.value = '';
            input.style.height = 'auto'; // Reset textarea height

            // Show thinking animation
            const thinkingId = Date.now();
            const thinkingHtml = `
                <div class="ai-thinking">
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>Thinking...</span>
                </div>
            `;
            addMessage(thinkingHtml, 'ai', thinkingId, null, true);

            const startTime = Date.now();

            try {
                // Prepare request body with optional wellness data
                const requestBody = {
                    username: currentUser,
                    message: message
                };
                
                // Include wellness data if available (recently completed check-in)
                if (wellnessRitualState && wellnessRitualState.data && Object.keys(wellnessRitualState.data).length > 0) {
                    requestBody.wellness_data = wellnessRitualState.data;
                }
                
                const response = await fetch('/api/therapy/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Ensure minimum "thinking" time of 2-4 seconds for realism
                const elapsed = Date.now() - startTime;
                const minDelay = 2000 + Math.random() * 2000; // 2-4 seconds
                if (elapsed < minDelay) {
                    await new Promise(resolve => setTimeout(resolve, minDelay - elapsed));
                }

                // Remove thinking animation
                const thinkingEl = document.getElementById('msg-' + thinkingId);
                if (thinkingEl) thinkingEl.remove();

                if (response.ok) {
                    const aiMessageEl = addMessage(data.response, 'ai', null, new Date().toISOString());

                    // Scroll so the AI response beginning is visible
                    if (aiMessageEl) {
                        setTimeout(() => {
                            aiMessageEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                    // === NEW: Handle risk analysis from AI ===
                    if (data.risk_analysis) {
                        // Update risk indicator in chat area
                        updateChatRiskIndicator(data.risk_analysis);
                        
                        // If action is needed (risk_score > 60), show assessment prompt
                        if (data.risk_analysis.action_needed && !safetyAssessmentState.active) {
                            setTimeout(() => {
                                showRiskPromptModal(data.risk_analysis.risk_level);
                            }, 2000);
                        }
                        
                        // If urgent action needed (HIGH/CRITICAL), alert clinician immediately
                        if (data.risk_analysis.urgent_action) {
                            console.warn('URGENT: Risk flagged - clinician will be notified');
                            // Additional UI could go here (e.g., show "Clinician notified" message)
                        }
                    }

                    // Reward pet for therapy session
                    await rewardPet('therapy');
                } else {
                    const errorMsg = data.error || 'Sorry, I encountered an error. Please try again.';
                    console.error('Chat API error:', data);
                    addMessage(`Error: ${errorMsg}`, 'ai');
                }
            } catch (error) {
                document.getElementById('msg-' + thinkingId)?.remove();
                addMessage('Connection error. Please check your internet.', 'ai');
                console.error('Chat error:', error);
            }
        }
        
        // === Patient AI Suggestion Functions ===
        async function saveSuggestion(text) {
            try {
                const response = await fetch('/api/suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ suggestion_text: text })
                });
                const data = await response.json();
                if (response.ok) {
                    addMessage('Your suggestion has been saved. I\'ll adapt based on your feedback going forward.', 'ai', null, new Date().toISOString());
                    showToast('Suggestion saved', 'success');
                    if (activityLogger) {
                        activityLogger.logActivity('suggestion_added', 'length:' + text.length, 'therapy');
                    }
                } else {
                    showToast(data.error || 'Failed to save suggestion', 'error');
                }
            } catch (err) {
                showToast('Error saving suggestion', 'error');
                console.error('Suggestion save error:', err);
            }
        }

        function toggleSuggestionManager() {
            const mgr = document.getElementById('suggestionManager');
            if (!mgr) return;
            if (mgr.style.display === 'none' || !mgr.style.display) {
                mgr.style.display = 'block';
                loadSuggestions();
            } else {
                mgr.style.display = 'none';
            }
        }

        async function loadSuggestions() {
            const container = document.getElementById('suggestionList');
            if (!container) return;
            container.innerHTML = '<p style="color: var(--text-muted); font-size:0.9em;">Loading...</p>';
            try {
                const response = await fetch('/api/suggestions', { credentials: 'include' });
                const data = await response.json();
                if (!data.suggestions || data.suggestions.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size:0.9em;">No active suggestions. Type <strong>/suggest</strong> in chat to add one.</p>';
                    return;
                }
                container.innerHTML = data.suggestions.map(function(s) {
                    return '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border-color, #e0e0e0);">' +
                        '<span style="flex:1; font-size:0.9em;">' + sanitizeWithLineBreaks(s.text) + '</span>' +
                        '<button onclick="deleteSuggestion(' + s.id + ')" style="background:none; border:none; color:var(--danger-color, #e74c3c); cursor:pointer; padding:4px 8px;" title="Remove suggestion">' +
                        '<i class="fas fa-trash-alt"></i>' +
                        '</button>' +
                    '</div>';
                }).join('');
            } catch (err) {
                container.innerHTML = '<p style="color: var(--danger-color); font-size:0.9em;">Failed to load suggestions</p>';
                console.error('Failed to load suggestions:', err);
            }
        }

        async function deleteSuggestion(id) {
            if (!confirm('Remove this suggestion? The AI will no longer follow this preference.')) return;
            try {
                const response = await fetch('/api/suggestions/' + id, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) {
                    showToast('Suggestion removed', 'success');
                    loadSuggestions();
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to remove suggestion', 'error');
                }
            } catch (err) {
                showToast('Error removing suggestion', 'error');
            }
        }

        function showRiskPromptModal(riskLevel) {
            const prompts = {
                amber: {
                    title: '‚ö†Ô∏è Check-in',
                    message: 'Your messages have some concerning language. Would you like to take a quick safety assessment?',
                    buttons: [
                        { text: 'Yes, assess me', action: 'startSafetyAssessment()' },
                        { text: 'Not now', action: 'closeRiskPrompt()' }
                    ]
                },
                orange: {
                    title: '‚ö†Ô∏è We\'re Concerned',
                    message: 'Your recent messages suggest you might be struggling. A brief assessment will help us support you better.',
                    buttons: [
                        { text: 'Start assessment', action: 'startSafetyAssessment()' },
                        { text: 'Remind me later', action: 'closeRiskPrompt()' }
                    ]
                },
                red: {
                    title: 'üö® Safety Check Needed',
                    message: 'Based on what you\'ve shared, we want to make sure you\'re safe. Please complete a quick assessment.',
                    buttons: [
                        { text: 'Take assessment now', action: 'startSafetyAssessment()' },
                        { text: 'Contact crisis line: 116 123', action: 'openCrisisSupport()' }
                    ]
                }
            };
            
            const prompt = prompts[riskLevel] || prompts['orange'];
            
            let buttonsHtml = '';
            prompt.buttons.forEach(btn => {
                buttonsHtml += `<button class="btn" onclick="${btn.action}" style="flex: 1; margin-right: 10px;">${btn.text}</button>`;
            });
            
            const modalHtml = `
                <div class="risk-prompt-modal" id="riskPromptModal">
                    <div class="risk-prompt-content">
                        <h3>${prompt.title}</h3>
                        <p>${prompt.message}</p>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            ${buttonsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Inject modal
            const existingModal = document.getElementById('riskPromptModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeRiskPrompt() {
            const modal = document.getElementById('riskPromptModal');
            if (modal) modal.remove();
        }
        
        function openCrisisSupport() {
            window.open('tel:116123', '_self');
            closeRiskPrompt();
        }

        // Voice Input Functions
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = true;
                speechRecognition.interimResults = true;
                speechRecognition.lang = 'en-GB';

                speechRecognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    const input = document.getElementById('chatInput');
                    if (finalTranscript) {
                        input.value += finalTranscript;
                        autoResizeTextarea(input);
                    }

                    document.getElementById('voiceStatusText').textContent =
                        interimTranscript ? `"${interimTranscript}"` : 'Listening...';
                };

                speechRecognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInput();
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access in your browser settings.');
                    }
                };

                speechRecognition.onend = () => {
                    if (isVoiceListening) {
                        // Restart if still supposed to be listening
                        speechRecognition.start();
                    }
                };

                return true;
            }
            return false;
        }

        function toggleVoiceInput() {
            if (isVoiceListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            if (!speechRecognition && !initVoiceRecognition()) {
                alert('Voice input is not supported in your browser. Try Chrome or Edge.');
                return;
            }

            isVoiceListening = true;
            document.getElementById('voiceBtn').classList.add('listening');
            document.getElementById('voiceStatus').style.display = 'flex';
            document.getElementById('voiceStatusText').textContent = 'Listening...';

            try {
                speechRecognition.start();
            } catch (e) {
                console.error('Speech start error:', e);
            }
        }

        function stopVoiceInput() {
            isVoiceListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
            document.getElementById('voiceStatus').style.display = 'none';

            if (speechRecognition) {
                try {
                    speechRecognition.stop();
                } catch (e) {
                    console.error('Speech stop error:', e);
                }
            }
        }

        // Auto-resize textarea as user types
        function autoResizeTextarea(textarea) {
            // Reset height to measure actual content
            textarea.style.height = 'auto';
            // Set to content height, max 200px
            const newHeight = Math.min(textarea.scrollHeight, 200);
            textarea.style.height = newHeight + 'px';
            // If content exceeds max, ensure scroll is enabled
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'scroll' : 'auto';
        }

        // Initialize textarea auto-resize (run after DOM loaded)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChatInput);
        } else {
            // DOM already loaded
            setTimeout(initChatInput, 100);
        }

        function initChatInput() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
            }
        }
        
        function addMessage(text, sender, id, timestamp, isRawHtml = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            if (id) messageEl.id = 'msg-' + id;

            // Add message content (sanitized to prevent XSS, unless isRawHtml is true)
            const contentDiv = document.createElement('div');
            if (isRawHtml) {
                // For trusted HTML (like thinking animation)
                contentDiv.innerHTML = text;
            } else {
                // For user input, sanitize to prevent XSS
                contentDiv.innerHTML = sanitizeWithLineBreaks(text);
            }
            messageEl.appendChild(contentDiv);

            // Add timestamp if provided
            if (timestamp) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'message-timestamp';
                timestampDiv.textContent = formatTimestamp(timestamp);
                messageEl.appendChild(timestampDiv);
                messageEl.dataset.timestamp = timestamp;
                messageEl.dataset.searchText = text.toLowerCase();
            }

            messagesDiv.appendChild(messageEl);

            // For user messages, scroll to bottom; for AI, we'll handle separately
            if (sender === 'user') {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            return messageEl; // Return element for scroll positioning
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            // Format time
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Determine date label
            if (messageDate.getTime() === today.getTime()) {
                return `Today at ${timeStr}`;
            } else if (messageDate.getTime() === today.getTime() - 86400000) {
                return `Yesterday at ${timeStr}`;
            } else if (date.getTime() > today.getTime() - 7 * 86400000) {
                return `${date.toLocaleDateString('en-US', { weekday: 'short' })} at ${timeStr}`;
            } else {
                return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at ${timeStr}`;
            }
        }
        
        // Chat Session Management
        let currentChatSessionId = null;
        let allChatSessions = [];
        
        async function loadChatSessions() {
            try {
                const response = await fetch(`/api/therapy/sessions?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.sessions) {
                    allChatSessions = data.sessions;
                    const activeSession = data.sessions.find(s => s.is_active);
                    if (activeSession) {
                        currentChatSessionId = activeSession.id;
                        document.getElementById('currentSessionBtn').textContent = `üí¨ ${activeSession.name}`;
                    }
                    renderSessionsList();
                }
            } catch (error) {
                console.error('Error loading chat sessions:', error);
            }
        }
        
        function renderSessionsList() {
            const list = document.getElementById('sessionsList');
            list.innerHTML = allChatSessions.map(session => `
                <div class="session-item ${session.is_active ? 'active' : ''}" onclick="switchChatSession(${session.id})">
                    <div class="session-info">
                        <div class="session-name">${sanitizeHTML(session.name)}</div>
                        <div class="session-meta">${session.message_count} messages ¬∑ ${formatSessionDate(session.last_active)}</div>
                    </div>
                    <div class="session-actions" onclick="event.stopPropagation()">
                        <button onclick="renameSession(${session.id})" title="Rename">‚úèÔ∏è</button>
                        <button onclick="deleteSession(${session.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatSessionDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            if (diffMins < 10080) return `${Math.floor(diffMins / 1440)}d ago`;
            return date.toLocaleDateString();
        }
        
        function showSessionsDropdown() {
            const dropdown = document.getElementById('sessionsDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        async function createNewSession() {
            const name = prompt('Enter a name for the new chat:', 'New Chat');
            if (!name) return;
            
            try {
                const response = await fetch('/api/therapy/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        session_name: name
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    await loadChatSessions();
                    await loadChatHistory();
                    showMessage('therapyMessage', `Created new chat: ${name}`, 'success');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Failed to create new chat session');
            }
        }
        
        async function switchChatSession(sessionId) {
            try {
                const response = await fetch(`/api/therapy/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        make_active: true
                    })
                });
                
                if (response.ok) {
                    await loadChatSessions();
                    await loadChatHistory();
                    document.getElementById('sessionsDropdown').style.display = 'none';
                }
            } catch (error) {
                console.error('Error switching session:', error);
            }
        }
        
        async function renameSession(sessionId) {
            const session = allChatSessions.find(s => s.id === sessionId);
            const newName = prompt('Enter new name:', session.name);
            if (!newName || newName === session.name) return;
            
            try {
                const response = await fetch(`/api/therapy/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        session_name: newName
                    })
                });
                
                if (response.ok) {
                    await loadChatSessions();
                    showMessage('therapyMessage', 'Chat renamed successfully', 'success');
                }
            } catch (error) {
                console.error('Error renaming session:', error);
            }
        }
        
        async function deleteSession(sessionId) {
            const session = allChatSessions.find(s => s.id === sessionId);
            if (!confirm(`Delete "${session.name}"? This will permanently delete all messages in this chat.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/therapy/sessions/${sessionId}?username=${currentUser}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (response.ok) {
                    await loadChatSessions();
                    await loadChatHistory();
                    showMessage('therapyMessage', 'Chat deleted', 'success');
                } else {
                    alert(data.error || 'Failed to delete chat');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Failed to delete chat session');
            }
        }
        
        async function loadChatHistory() {
            try {
                const url = currentChatSessionId 
                    ? `/api/therapy/history?username=${currentUser}&chat_session_id=${currentChatSessionId}`
                    : `/api/therapy/history?username=${currentUser}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok && data.history) {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = '';
                    
                    data.history.forEach(msg => {
                        addMessage(msg.message, msg.sender, null, msg.timestamp);
                    });
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        function searchMessages() {
            const searchTerm = document.getElementById('chatSearch').value.toLowerCase();
            const messages = document.querySelectorAll('.message[data-search-text]');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            clearBtn.style.display = searchTerm ? 'block' : 'none';
            
            messages.forEach(msg => {
                const text = msg.dataset.searchText;
                if (!searchTerm || text.includes(searchTerm)) {
                    msg.style.display = '';
                    msg.classList.remove('highlight');
                    if (searchTerm && text.includes(searchTerm)) {
                        msg.classList.add('highlight');
                    }
                } else {
                    msg.style.display = 'none';
                }
            });
        }
        
        function clearSearch() {
            document.getElementById('chatSearch').value = '';
            searchMessages();
        }
        
        function showExportDialog() {
            const dialog = document.getElementById('exportChatDialog');
            
            // Set default date range (last 30 days to today)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            document.getElementById('exportToDate').value = today.toISOString().split('T')[0];
            document.getElementById('exportFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            
            dialog.style.display = 'flex';
        }
        
        function closeExportDialog() {
            document.getElementById('exportChatDialog').style.display = 'none';
        }
        
        async function showActivePatients() {
            const modal = document.getElementById('activePatientsModal');
            const content = document.getElementById('activePatientsListContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
            
            try {
                const response = await fetch(`/api/analytics/active-patients?clinician=${encodeURIComponent(currentUser)}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load active patients');
                }
                
                const data = await response.json();
                
                if (data.active_patients.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #666;">No active patients in the last 7 days</p>';
                    return;
                }
                
                // Build the list
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                data.active_patients.forEach(patient => {
                    // Format the timestamp
                    const activityDate = new Date(patient.last_activity);
                    const now = new Date();
                    const diffMs = now - activityDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    
                    let timeAgo;
                    if (diffMins < 60) {
                        timeAgo = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                    } else if (diffHours < 24) {
                        timeAgo = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                    } else {
                        timeAgo = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                    }
                    
                    // Activity type icon
                    let activityIcon = 'üîµ';
                    let activityText = 'Login';
                    if (patient.activity_type === 'mood_log') {
                        activityIcon = 'üòä';
                        activityText = 'Mood Log';
                    } else if (patient.activity_type === 'chat') {
                        activityIcon = 'üí¨';
                        activityText = 'Chat';
                    }
                    
                    html += `
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">${patient.full_name || patient.username}</div>
                                <div style="color: #666; font-size: 14px;">${activityIcon} ${activityText}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #8b5cf6; font-weight: bold;">${timeAgo}</div>
                                <div style="color: #999; font-size: 12px;">${activityDate.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading active patients:', error);
                content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading active patients</p>';
            }
        }
        
        function closeActivePatientsModal() {
            document.getElementById('activePatientsModal').style.display = 'none';
        }
        
        async function exportChat() {
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            const format = document.getElementById('exportFormat').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            try {
                const response = await fetch('/api/therapy/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        from_date: fromDate,
                        to_date: toDate,
                        format: format
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat_export_${fromDate}_to_${toDate}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    closeExportDialog();
                    showMessage('therapyMessage', 'Chat exported successfully!', 'success');
                } else {
                    const data = await response.json();
                    alert('Export failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export chat. Please try again.');
            }
        }
        
        function addSystemMessage(text) {
            addMessage(text, 'ai');
        }
        
        // Mood Tracking
        function selectMood(value, element) {
            selectedMoodValue = value;
            document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function addMedication() {
            const name = document.getElementById('medName').value.trim();
            const strength = document.getElementById('medStrength').value.trim();
            const qty = document.getElementById('medQty').value.trim() || '1';
            
            if (!name) {
                showMessage('moodMessage', 'Please enter medication name', 'error');
                return;
            }
            
            medications.push({name, strength, quantity: qty});
            updateMedList();
            
            // Clear inputs
            document.getElementById('medName').value = '';
            document.getElementById('medStrength').value = '';
            document.getElementById('medQty').value = '1';
        }
        
        function updateMedList() {
            const listEl = document.getElementById('medList');
            listEl.innerHTML = medications.map((med, idx) => `
                <div class="med-item">
                    <span>${sanitizeHTML(med.name)} ${sanitizeHTML(med.strength)}mg (x${med.quantity})</span>
                    <button onclick="removeMed(${idx})">Remove</button>
                </div>
            `).join('');
        }
        
        function removeMed(index) {
            medications.splice(index, 1);
            updateMedList();
        }
        
        async function logMood() {
            if (!selectedMoodValue) {
                showMessage('moodMessage', 'Please select a mood level', 'error');
                return;
            }
            
            const sleep = parseFloat(document.getElementById('sleepHours').value) || 0;
            const water = parseFloat(document.getElementById('waterPints').value) || 0;
            const exercise = parseInt(document.getElementById('exerciseMins').value) || 0;
            const outside = parseInt(document.getElementById('outsideMins').value) || 0;
            const notes = document.getElementById('moodNotes').value.trim();
            
            try {
                const response = await fetch('/api/mood/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        mood_val: selectedMoodValue,
                        sleep_val: sleep,
                        water_pints: water,
                        exercise_mins: exercise,
                        outside_mins: outside,
                        meds: medications,
                        notes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('moodMessage', 'Mood logged successfully! üéâ Keep tracking your progress! (+5 Coins)', 'success');
                    // Reward pet
                    await rewardPet('mood');
                    // Clear form
                    selectedMoodValue = null;
                    medications = [];
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    document.getElementById('sleepHours').value = '';
                    document.getElementById('waterPints').value = '';
                    document.getElementById('exerciseMins').value = '';
                    document.getElementById('outsideMins').value = '';
                    document.getElementById('moodNotes').value = '';
                    updateMedList();
                } else if (response.status === 409) {
                    // Already logged today - show friendly message
                    showMessage('moodMessage', '‚úì You\'ve already logged your mood today! See you tomorrow! üòä', 'success');
                } else {
                    let errorMsg = data && data.error ? data.error : 'Failed to log mood';
                    if (data && data.trace) {
                        errorMsg += '\n[Server Trace]\n' + data.trace;
                    }
                    showMessage('moodMessage', errorMsg, 'error');
                }
            } catch (error) {
                showMessage('moodMessage', 'Connection error. Please try again.', 'error');
                console.error('Mood log error:', error);
            }
        }
        
        // Gratitude Journal
        async function logGratitude() {
            const entry = document.getElementById('gratitudeEntry').value.trim();
            
            if (!entry) {
                showMessage('gratitudeMessage', 'Please write something you\'re grateful for', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/gratitude/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, entry })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('gratitudeMessage', 'Gratitude entry saved! üôè Practice makes perfect! (+5 Coins)', 'success');
                    await rewardPet('gratitude');
                    document.getElementById('gratitudeEntry').value = '';
                } else {
                    let errorMsg = data && data.error ? data.error : 'Failed to save entry';
                    if (data && data.trace) {
                        errorMsg += '\n[Server Trace]\n' + data.trace;
                    }
                    showMessage('gratitudeMessage', errorMsg, 'error');
                }
            } catch (error) {
                showMessage('gratitudeMessage', 'Connection error. Please try again.', 'error');
                console.error('Gratitude log error:', error);
            }
        }
        
        // CBT Tools
        async function saveCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const thought = document.getElementById('cbtThought').value.trim();
            const evidence = document.getElementById('cbtEvidence').value.trim();
            
            if (!situation || !thought) {
                showMessage('cbtMessage', 'Please fill in situation and thought fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/cbt/thought-record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, situation, thought, evidence })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('cbtMessage', 'Thought record saved! üß† Great work challenging your thoughts! (+15 Coins)', 'success');
                    await rewardPet('cbt', 'cbt');
                    document.getElementById('cbtSituation').value = '';
                    document.getElementById('cbtThought').value = '';
                    document.getElementById('cbtEvidence').value = '';
                } else {
                    showMessage('cbtMessage', data.error || 'Failed to save record', 'error');
                }
            } catch (error) {
                showMessage('cbtMessage', 'Connection error. Please try again.', 'error');
            }
        }
        
        async function startBreathing() {
            const display = document.getElementById('breathingDisplay');
            display.classList.remove('hidden');
            
            for (let cycle = 0; cycle < 3; cycle++) {
                display.textContent = 'Breathe IN for 4...';
                await sleep(4000);
                display.textContent = 'HOLD for 7...';
                await sleep(7000);
                display.textContent = 'Breathe OUT for 8...';
                await sleep(8000);
            }
            
            display.textContent = '‚úÖ Exercise Complete! Well done!';
            await rewardPet('breathing');
            setTimeout(() => display.classList.add('hidden'), 3000);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Pet Game
        async function loadPetStatus() {
            try {
                const response = await fetch(`/api/pet/status?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (data.exists) {
                    document.getElementById('petCreate').classList.add('hidden');
                    document.getElementById('petDisplay').classList.remove('hidden');
                    updatePetDisplay(data.pet);
                } else {
                    document.getElementById('petCreate').classList.remove('hidden');
                    document.getElementById('petDisplay').classList.add('hidden');
                }
            } catch (error) {
                console.error('Pet load error:', error);
            }
        }
        
        async function createPet() {
            const name = document.getElementById('petName').value.trim();
            const species = document.getElementById('petSpecies').value;
            const gender = document.getElementById('petGender').value;
            
            if (!name) {
                alert('Please enter a pet name');
                return;
            }
            
            try {
                const response = await fetch('/api/pet/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, name, species, gender })
                });
                
                if (response.ok) {
                    alert(`${name} adopted! üéâ Take good care of your companion!`);
                    loadPetStatus();
                }
            } catch (error) {
                console.error('Pet create error:', error);
            }
        }
        
        function updatePetDisplay(pet) {
            document.getElementById('petNameDisplay').textContent = pet.name;
            document.getElementById('petEmojiDisplay').textContent = speciesEmojis[pet.species] || 'üêæ';
            document.getElementById('petCoins').textContent = pet.coins;
            document.getElementById('petXP').textContent = pet.xp;
            document.getElementById('petStage').textContent = pet.stage;
            
            document.getElementById('hungerBar').style.width = pet.hunger + '%';
            document.getElementById('happinessBar').style.width = pet.happiness + '%';
            document.getElementById('energyBar').style.width = pet.energy + '%';
            document.getElementById('hygieneBar').style.width = pet.hygiene + '%';
            
            // Check if pet is on an adventure and resume countdown
            if (pet.adventure_end && pet.adventure_end > 0) {
                const now = Date.now() / 1000;
                if (pet.adventure_end > now) {
                    startWalkCountdown(pet.adventure_end);
                }
            }
        }
        
        async function rewardPet(action, activity_type = null) {
            try {
                const response = await fetch('/api/pet/reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, activity_type, username: currentUser })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Show reward notification
                        if (data.evolved) {
                            alert(`üéâ Amazing! Your pet evolved to ${data.new_stage}!`);
                        }
                        // Refresh pet display if on pet tab
                        if (document.getElementById('petTab').classList.contains('active')) {
                            loadPetStatus();
                        }
                    }
                }
            } catch (error) {
                console.error('Pet reward error:', error);
            }
        }
        
        async function refreshPet() {
            await applyPetDecay();
            await loadPetStatus();
            await checkPetReturn();
        }
        
        async function applyPetDecay() {
            try {
                await fetch('/api/pet/apply-decay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser })
                });
            } catch (error) {
                console.error('Pet decay error:', error);
            }
        }
        
        let walkCountdownInterval = null;
        
        async function checkPetReturn() {
            try {
                const response = await fetch('/api/pet/check-return', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.returned) {
                        alert('üéâ ' + data.message + ' Earned: ü™ô ' + data.coins_earned + ' coins!');
                        loadPetStatus();
                    }
                }
            } catch (error) {
                console.error('Pet return check error:', error);
            }
        }
        
        function openShop() {
            const shopModal = document.getElementById('shopModal');
            shopModal.style.display = 'flex';
            loadShopItems();
        }
        
        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
        }
        
        async function loadShopItems() {
            try {
                const response = await fetch('/api/pet/shop');
                const data = await response.json();
                
                const currentCoins = parseInt(document.getElementById('petCoins').textContent);
                document.getElementById('shopCoins').textContent = currentCoins;
                
                const container = document.getElementById('shopItems');
                container.innerHTML = data.items.map(item => `
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px;">${sanitizeHTML(item.name)}</div>
                            <div style="font-size: 13px; color: #666;">${sanitizeHTML(item.description)}</div>
                        </div>
                        <button class="btn" onclick="buyItem('${item.id}')" style="padding: 8px 16px; width: auto; ${currentCoins < item.cost ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ü™ô ${item.cost}
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Shop load error:', error);
            }
        }
        
        async function buyItem(itemId) {
            try {
                const response = await fetch('/api/pet/buy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, item_id: itemId })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('Item purchased! üéâ');
                    loadPetStatus();
                    loadShopItems();
                } else {
                    alert(data.error || 'Purchase failed');
                }
            } catch (error) {
                console.error('Buy error:', error);
                alert('Purchase failed');
            }
        }
        
        function openDeclutter() {
            document.getElementById('declutterModal').style.display = 'flex';
            document.getElementById('worry1').value = '';
            document.getElementById('worry2').value = '';
            document.getElementById('worry3').value = '';
        }
        
        function closeDeclutter() {
            document.getElementById('declutterModal').style.display = 'none';
        }
        
        async function submitDeclutter() {
            const worry1 = document.getElementById('worry1').value.trim();
            const worry2 = document.getElementById('worry2').value.trim();
            const worry3 = document.getElementById('worry3').value.trim();
            
            const worries = [worry1, worry2, worry3].filter(w => w);
            
            if (worries.length === 0) {
                alert('Please enter at least one worry to throw away');
                return;
            }
            
            try {
                const response = await fetch('/api/pet/declutter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, worries })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message);
                    closeDeclutter();
                    loadPetStatus();
                } else {
                    alert(data.error || 'Declutter failed');
                }
            } catch (error) {
                console.error('Declutter error:', error);
            }
        }
        
        async function startAdventure() {
            // Check current status first
            try {
                const statusResponse = await fetch(`/api/pet/status?username=${encodeURIComponent(currentUser)}`);
                const statusData = await statusResponse.json();
                
                if (statusData.exists && statusData.pet.adventure_end) {
                    const remaining = statusData.pet.adventure_end - (Date.now() / 1000);
                    if (remaining > 0) {
                        const minutes = Math.ceil(remaining / 60);
                        alert(`Your pet is still on a walk! Please wait ${minutes} more minute(s).`);
                        return;
                    }
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
            
            const confirm = window.confirm("Send your pet on a 30-minute walk? Your pet will earn rewards when they return!");
            
            if (!confirm) return;
            
            try {
                const response = await fetch('/api/pet/adventure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message + ' They will return with rewards in 30 minutes! üéÅ');
                    startWalkCountdown(data.return_time);
                    loadPetStatus();
                } else {
                    alert(data.error || 'Adventure failed');
                }
            } catch (error) {
                console.error('Adventure error:', error);
            }
        }
        
        function startWalkCountdown(returnTime) {
            const walkBtn = document.getElementById('walkBtn');
            const countdownDiv = document.getElementById('walkCountdown');
            
            walkBtn.disabled = true;
            walkBtn.style.opacity = '0.5';
            walkBtn.style.cursor = 'not-allowed';
            countdownDiv.style.display = 'block';
            
            if (walkCountdownInterval) clearInterval(walkCountdownInterval);
            
            walkCountdownInterval = setInterval(() => {
                const now = Date.now() / 1000;
                const remaining = returnTime - now;
                
                if (remaining <= 0) {
                    clearInterval(walkCountdownInterval);
                    walkBtn.disabled = false;
                    walkBtn.style.opacity = '1';
                    walkBtn.style.cursor = 'pointer';
                    countdownDiv.style.display = 'none';
                    checkPetReturn();
                } else {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = Math.floor(remaining % 60);
                    countdownDiv.textContent = `üå≤ Pet returns in: ${minutes}m ${seconds}s`;
                }
            }, 1000);
        }
        
        // Auto-refresh pet when tab is active
        setInterval(() => {
            if (document.getElementById('petTab').classList.contains('active')) {
                refreshPet();
            }
        }, 60000); // Every minute
        
        // Clinical Assessments
        function startPHQ9() {
            currentAssessment = 'PHQ-9';
            assessmentScores = [];
            showAssessmentModal('PHQ-9 Depression Screening', PHQ9_QUESTIONS);
        }
        
        function startGAD7() {
            currentAssessment = 'GAD-7';
            assessmentScores = [];
            showAssessmentModal('GAD-7 Anxiety Screening', GAD7_QUESTIONS);
        }
        
        function showAssessmentModal(title, questions) {
            document.getElementById('assessmentTitle').textContent = title;
            const container = document.getElementById('assessmentQuestions');
            container.innerHTML = questions.map((q, idx) => `
                <div style="margin: 20px 0; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="margin-bottom: 10px; font-weight: 600;">${idx + 1}. ${sanitizeHTML(q)}</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="0" onchange="setScore(${idx}, 0)"> Not at all
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="1" onchange="setScore(${idx}, 1)"> Several days
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="2" onchange="setScore(${idx}, 2)"> More than half
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="3" onchange="setScore(${idx}, 3)"> Nearly every day
                        </label>
                    </div>
                </div>
            `).join('');
            document.getElementById('assessmentModal').style.display = 'flex';
        }
        
        function setScore(index, value) {
            assessmentScores[index] = parseInt(value);
        }
        
        async function submitAssessment() {
            const expectedLength = currentAssessment === 'PHQ-9' ? 9 : 7;
            
            if (assessmentScores.length !== expectedLength || assessmentScores.includes(undefined)) {
                alert('Please answer all questions');
                return;
            }
            
            try {
                const endpoint = currentAssessment === 'PHQ-9' ? '/api/clinical/phq9' : '/api/clinical/gad7';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, scores: assessmentScores })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Assessment Complete!\n\nScore: ${data.score}\nSeverity: ${data.severity}\n\n+20 Coins for completing assessment!\n\nConsult with a mental health professional for personalized care.`);
                    await rewardPet('clinical', 'clinical');
                    closeAssessment();
                } else {
                    alert('Error submitting assessment');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Assessment error:', error);
            }
        }
        
        function closeAssessment() {
            document.getElementById('assessmentModal').style.display = 'none';
            assessmentScores = [];
            currentAssessment = null;
        }
        
        // History
        async function loadHistory() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading your history...</p></div>';
            
            try {
                const response = await fetch(`/api/mood/history?username=${encodeURIComponent(currentUser)}&limit=30`);
                const data = await response.json();
                
                if (response.ok && data.logs && data.logs.length > 0) {
                    const moodEmojis = {1: 'üò¢', 2: 'üò¢', 3: 'üòî', 4: 'üòî', 5: 'üòê', 6: 'üòê', 7: 'üôÇ', 8: 'üôÇ', 9: 'üòÑ', 10: 'üòÑ'};
                    const html = '<div class="history-grid">' + 
                        data.logs.map(log => `
                            <div class="history-card">
                                <div class="date">${new Date(log.timestamp).toLocaleString()}</div>
                                <div style="font-size: 24px; margin: 10px 0;">${moodEmojis[log.mood_val]} <strong>${log.mood_val}/10</strong></div>
                                <div><strong>Sleep:</strong> ${log.sleep_val} hours</div>
                                ${log.water_pints ? `<div><strong>Water:</strong> ${log.water_pints} pints</div>` : ''}
                                ${log.exercise_mins ? `<div><strong>Exercise:</strong> ${log.exercise_mins} mins</div>` : ''}
                                ${log.outside_mins ? `<div><strong>Outdoors:</strong> ${log.outside_mins} mins</div>` : ''}
                                ${log.meds ? `<div><strong>Medications:</strong> ${sanitizeHTML(log.meds)}</div>` : ''}
                                ${log.notes ? `<div style="margin-top: 10px;"><strong>Notes:</strong><br>${sanitizeWithLineBreaks(log.notes)}</div>` : ''}
                            </div>
                        `).join('') +
                        '</div>';
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = 
                        '<p style="text-align: center; color: #999; padding: 40px;">No mood logs yet. Start tracking in the Mood & Habits tab! üìä</p>';
                }
            } catch (error) {
                historyContent.innerHTML = 
                    '<p style="text-align: center; color: #dc3545; padding: 40px;">Error loading history. Please try again.</p>';
                console.error('History load error:', error);
            }
        }
        
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `alert alert-${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        // Community Functions - Discord-style
        let communityRefreshInterval = null;
        let currentChannel = null;
        let currentThreadPostId = null;

        const CHANNEL_INFO = {
            'anxiety': { emoji: 'üò∞', name: 'Anxiety', description: 'Discuss anxiety and coping strategies' },
            'depression': { emoji: 'üòî', name: 'Depression', description: 'Support for depression' },
            'relationships': { emoji: 'üíë', name: 'Relationships', description: 'Relationship advice and support' },
            'intrusive-thoughts': { emoji: 'üß†', name: 'Intrusive Thoughts', description: 'Managing unwanted thoughts' },
            'grief': { emoji: 'üíî', name: 'Grief & Loss', description: 'Coping with loss' },
            'work-stress': { emoji: 'üíº', name: 'Work Stress', description: 'Workplace mental health' },
            'self-esteem': { emoji: 'ü™û', name: 'Self-Esteem', description: 'Building confidence' },
            'trauma': { emoji: 'ü©π', name: 'Trauma', description: 'Trauma support and healing' },
            'addiction': { emoji: 'üîó', name: 'Addiction', description: 'Recovery support' },
            'sleep': { emoji: 'üò¥', name: 'Sleep Issues', description: 'Better sleep habits' },
            'motivation': { emoji: '‚ö°', name: 'Motivation', description: 'Finding motivation' },
            'general': { emoji: 'üí¨', name: 'General', description: 'General discussion' },
            'celebration': { emoji: 'üéâ', name: 'Celebrations', description: 'Share your wins!' },
            'question': { emoji: '‚ùì', name: 'Questions', description: 'Ask the community' }
        };

        async function loadChannels() {
            try {
                const response = await fetch(`/api/community/channels?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();

                if (response.ok && data.channels) {
                    const channelList = document.getElementById('communityChannelList');
                    channelList.innerHTML = data.channels.map(channel => `
                        <div class="channel-item ${currentChannel === channel.id ? 'active' : ''}"
                             onclick="selectChannel('${channel.id}')"
                             id="channel-${channel.id}">
                            <span class="channel-emoji">${channel.emoji}</span>
                            <span class="channel-name">${sanitizeHTML(channel.name)}</span>
                            ${channel.unread_count > 0 ? `<span class="unread-badge">${channel.unread_count}</span>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Load channels error:', error);
            }
        }

        async function selectChannel(channelId) {
            currentChannel = channelId;
            const info = CHANNEL_INFO[channelId] || { emoji: 'üí¨', name: channelId, description: '' };

            // Update channel header
            document.getElementById('currentChannelName').textContent = info.name;
            document.getElementById('currentChannelDesc').textContent = info.description;
            document.querySelector('.community-channel-header .channel-icon').textContent = info.emoji;

            // Show input area
            document.getElementById('communityInputArea').style.display = 'flex';

            // Update active state in sidebar
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            const activeChannel = document.getElementById(`channel-${channelId}`);
            if (activeChannel) {
                activeChannel.classList.add('active');
                // Remove unread badge
                const badge = activeChannel.querySelector('.unread-badge');
                if (badge) badge.remove();
            }

            // Load posts for this channel
            await loadChannelPosts(channelId);
        }

        async function loadChannelPosts(channelId, showLoading = true) {
            const postsArea = document.getElementById('communityPostsArea');

            if (showLoading) {
                postsArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            }

            try {
                console.log('üîç Loading posts for channel:', channelId);
                const response = await fetch(`/api/community/posts?username=${encodeURIComponent(currentUser)}&category=${encodeURIComponent(channelId)}`);
                const data = await response.json();

                console.log('üìä Response data:', data);

                if (response.ok && data.posts && data.posts.length > 0) {
                    console.log('‚úÖ Found', data.posts.length, 'posts');
                    postsArea.innerHTML = data.posts.map(post => renderDiscordPost(post)).join('');
                    // Auto-scroll to bottom to show newest post
                    setTimeout(() => {
                        postsArea.scrollTop = postsArea.scrollHeight;
                    }, 0);
                } else {
                    console.log('‚ÑπÔ∏è No posts found for channel:', channelId);
                    const info = CHANNEL_INFO[channelId] || { name: channelId };
                    postsArea.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-icon">‚ú®</div>
                            <h2>Welcome to #${info.name}</h2>
                            <p>This is the start of the ${info.name} channel. Be the first to share something!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Load posts error:', error);
                postsArea.innerHTML = '<div style="text-align: center; color: #ed4245; padding: 40px;">Error loading posts</div>';
            }
        }

        function renderDiscordPost(post) {
            const reactions = post.reactions || {};
            const userReactions = post.user_reactions || [];
            const replies = post.replies || [];
            const initial = (post.username || 'U').charAt(0).toUpperCase();
            const isClinician = currentUserRole === 'clinician';

            return `
                <div class="discord-post ${post.is_pinned ? 'pinned' : ''}" id="post-${post.id}">
                    <div class="discord-post-avatar">${initial}</div>
                    <div class="discord-post-content">
                        <div class="discord-post-header">
                            <span class="discord-post-username">${sanitizeHTML(post.username)}</span>
                            <span class="discord-post-time">${formatRelativeTime(post.timestamp)}</span>
                            ${post.is_pinned ? '<span class="discord-post-pinned-badge">PINNED</span>' : ''}
                        </div>
                        <div class="discord-post-message">${sanitizeWithLineBreaks(post.message)}</div>
                        <div class="discord-post-actions">
                            <button onclick="reactToPost(${post.id}, 'like')" class="discord-reaction-btn ${userReactions.includes('like') ? 'active' : ''}">
                                üëç ${reactions.like || 0}
                            </button>
                            <button onclick="reactToPost(${post.id}, 'heart')" class="discord-reaction-btn ${userReactions.includes('heart') ? 'active' : ''}">
                                ‚ù§Ô∏è ${reactions.heart || 0}
                            </button>
                            <button onclick="reactToPost(${post.id}, 'hug')" class="discord-reaction-btn ${userReactions.includes('hug') ? 'active' : ''}">
                                ü§ó ${reactions.hug || 0}
                            </button>
                            <button onclick="reactToPost(${post.id}, 'support')" class="discord-reaction-btn ${userReactions.includes('support') ? 'active' : ''}">
                                üí™ ${reactions.support || 0}
                            </button>
                            <button onclick="openThread(${post.id})" class="discord-thread-btn">
                                üí¨ ${replies.length} ${replies.length === 1 ? 'reply' : 'replies'}
                            </button>
                            <div class="discord-post-admin-actions">
                                ${post.username === currentUser ? `<button onclick="deletePost(${post.id})" class="discord-admin-btn" title="Delete">üóëÔ∏è</button>` : ''}
                                ${isClinician ? `<button onclick="togglePin(${post.id}, ${!post.is_pinned})" class="discord-admin-btn pin-btn ${post.is_pinned ? 'pinned' : ''}" title="${post.is_pinned ? 'Unpin' : 'Pin'}">üìå</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatRelativeTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        async function openThread(postId) {
            currentThreadPostId = postId;
            const modal = document.getElementById('threadModal');
            modal.style.display = 'flex';

            // Load the post and its replies
            try {
                const response = await fetch(`/api/community/posts?username=${encodeURIComponent(currentUser)}&category=${encodeURIComponent(currentChannel)}`);
                const data = await response.json();

                if (response.ok && data.posts) {
                    const post = data.posts.find(p => p.id === postId);
                    if (post) {
                        // Render original post
                        const initial = (post.username || 'U').charAt(0).toUpperCase();
                        document.getElementById('threadOriginalPost').innerHTML = `
                            <div class="discord-post" style="padding: 0;">
                                <div class="discord-post-avatar">${initial}</div>
                                <div class="discord-post-content">
                                    <div class="discord-post-header">
                                        <span class="discord-post-username">${sanitizeHTML(post.username)}</span>
                                        <span class="discord-post-time">${formatRelativeTime(post.timestamp)}</span>
                                    </div>
                                    <div class="discord-post-message">${sanitizeWithLineBreaks(post.message)}</div>
                                </div>
                            </div>
                        `;

                        // Render replies
                        const replies = post.replies || [];
                        if (replies.length > 0) {
                            document.getElementById('threadReplies').innerHTML = replies.map(reply => {
                                const replyInitial = (reply.username || 'U').charAt(0).toUpperCase();
                                return `
                                    <div class="thread-reply">
                                        <div class="thread-reply-avatar">${replyInitial}</div>
                                        <div class="thread-reply-content">
                                            <div class="thread-reply-header">
                                                <span class="thread-reply-username">${sanitizeHTML(reply.username)}</span>
                                                <span class="thread-reply-time">${formatRelativeTime(reply.timestamp)}</span>
                                                ${reply.username === currentUser ? `<button onclick="deleteReply(${reply.id}, ${postId})" class="discord-admin-btn" style="margin-left: auto;">üóëÔ∏è</button>` : ''}
                                            </div>
                                            <div class="thread-reply-message">${sanitizeWithLineBreaks(reply.message)}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            document.getElementById('threadReplies').innerHTML = '<div style="text-align: center; color: #72767d; padding: 20px;">No replies yet. Start the conversation!</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('Open thread error:', error);
            }
        }

        function closeThreadModal() {
            document.getElementById('threadModal').style.display = 'none';
            currentThreadPostId = null;
        }

        async function postThreadReply() {
            if (!currentThreadPostId) return;

            const input = document.getElementById('threadReplyInput');
            const message = input.value.trim();

            if (!message) {
                alert('Please write a reply');
                return;
            }

            try {
                const response = await fetch(`/api/community/post/${currentThreadPostId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, message })
                });

                if (response.ok) {
                    input.value = '';
                    // Refresh thread view
                    openThread(currentThreadPostId);
                    // Refresh main posts area
                    loadChannelPosts(currentChannel, false);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error posting reply');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Reply error:', error);
            }
        }

        async function togglePin(postId, pin) {
            try {
                const response = await fetch(`/api/community/post/${postId}/pin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, pin })
                });

                if (response.ok) {
                    loadChannelPosts(currentChannel, false);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error pinning post');
                }
            } catch (error) {
                console.error('Pin error:', error);
            }
        }

        async function postCommunity() {
            if (!currentChannel) {
                alert('Please select a channel first');
                return;
            }

            const message = document.getElementById('communityMessage').value.trim();

            if (!message) {
                alert('Please write a message');
                return;
            }

            try {
                console.log('üì§ Posting to community:', { username: currentUser, message, category: currentChannel });
                const response = await fetch('/api/community/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: currentUser, message, category: currentChannel })
                });

                console.log('üì• Response status:', response.status, response.ok);
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ Post successful:', responseData);
                    document.getElementById('communityMessage').value = '';
                    
                    // Wait longer to ensure database write is complete
                    await new Promise(resolve => setTimeout(resolve, 500));
                    console.log('üîÑ Reloading posts...');
                    await loadChannelPosts(currentChannel, false);
                    console.log('‚úÖ Posts reloaded');
                } else {
                    const data = await response.json();
                    console.error('‚ùå Post failed:', data);
                    alert(data.error || 'Error posting message');
                }
            } catch (error) {
                console.error('‚ùå Post error:', error);
                alert('Connection error: ' + error.message);
            }
        }

        async function reactToPost(postId, reactionType) {
            try {
                const response = await fetch(`/api/community/post/${postId}/react`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser, reaction: reactionType })
                });

                if (response.ok) {
                    loadChannelPosts(currentChannel, false);
                }
            } catch (error) {
                console.error('Reaction error:', error);
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }

            try {
                const response = await fetch(`/api/community/post/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });

                if (response.ok) {
                    loadChannelPosts(currentChannel, false);
                } else {
                    alert('Error deleting post. You can only delete your own posts.');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        async function deleteReply(replyId, postId) {
            if (!confirm('Are you sure you want to delete this reply?')) {
                return;
            }

            try {
                const response = await fetch(`/api/community/reply/${replyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ username: currentUser })
                });

                if (response.ok) {
                    // Refresh thread if open
                    if (currentThreadPostId === postId) {
                        openThread(postId);
                    }
                    loadChannelPosts(currentChannel, false);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error deleting reply');
                }
            } catch (error) {
                console.error('Delete reply error:', error);
            }
        }

        function startCommunityAutoRefresh() {
            if (communityRefreshInterval) {
                clearInterval(communityRefreshInterval);
            }
            // Refresh channels and posts every 30 seconds
            communityRefreshInterval = setInterval(() => {
                loadChannels();
                if (currentChannel) {
                    loadChannelPosts(currentChannel, false);
                }
            }, 30000);
        }

        function stopCommunityAutoRefresh() {
            if (communityRefreshInterval) {
                clearInterval(communityRefreshInterval);
                communityRefreshInterval = null;
            }
        }

        // Initialize community when tab is opened
        async function initCommunity() {
            await loadChannels();
            // Auto-select general channel if none selected
            if (!currentChannel) {
                selectChannel('general');
            }
        }
        
        // Safety Plan Builder is now in CBT Tools - no separate functions needed
        
        // Appointments Functions
        async function loadPatientAppointments() {
            try {
                const response = await fetch(`/api/appointments?patient=${encodeURIComponent(currentUser)}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                const listDiv = document.getElementById('appointmentsList');
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    // Count pending appointments that need response
                    const pendingCount = data.appointments.filter(apt => 
                        !apt.patient_acknowledged && new Date(apt.appointment_date) > new Date()
                    ).length;
                    
                    // Update badge
                    const badge = document.getElementById('appointmentBadge');
                    if (badge) {
                        if (pendingCount > 0) {
                            badge.textContent = pendingCount;
                            badge.style.display = 'inline';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                    
                    listDiv.innerHTML = data.appointments.map(apt => {
                        const date = new Date(apt.appointment_date);
                        const dateStr = date.toLocaleDateString('en-GB', {
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                        });
                        const timeStr = date.toLocaleTimeString('en-GB', {
                            hour: '2-digit', minute: '2-digit'
                        });

                        const isPast = date < new Date();
                        const statusColor = apt.patient_response === 'accepted' ? 'var(--success-color)' :
                                           apt.patient_response === 'declined' ? 'var(--danger-color)' : 'var(--warning-color)';
                        const statusText = apt.patient_response === 'accepted' ? '‚úì Accepted' :
                                          apt.patient_response === 'declined' ? '‚úó Declined' :
                                          '‚è≥ Awaiting Response';

                        return `
                            <div class="card" style="margin-bottom: 20px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: var(--accent-color);">üìÖ ${apt.appointment_type || 'Consultation'}</h4>
                                        <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">With ${sanitizeHTML(apt.clinician_username)}</p>
                                    </div>
                                    <span style="background: ${statusColor}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                        ${statusText}
                                    </span>
                                </div>

                                <div class="appointment-details-box">
                                    <p style="margin: 0 0 5px 0;"><strong>üìÜ Date:</strong> ${dateStr}</p>
                                    <p style="margin: 0 0 5px 0;"><strong>üïê Time:</strong> ${timeStr}</p>
                                    ${apt.notes ? `<p style="margin: 10px 0 0 0; padding-top: 10px; border-top: 1px solid var(--border-color);"><strong>Notes:</strong> ${sanitizeWithLineBreaks(apt.notes)}</p>` : ''}
                                </div>

                                ${!apt.patient_acknowledged && !isPast ? `
                                    <div class="appointment-warning-box">
                                        <p style="margin: 0 0 10px 0;">
                                            <strong>‚ö†Ô∏è Please acknowledge this appointment</strong>
                                        </p>
                                        <label style="display: flex; align-items: center; cursor: pointer; color: var(--text-primary);">
                                            <input type="checkbox" id="ack-${apt.id}" style="width: 20px; height: 20px; margin-right: 10px;">
                                            <span>I have read and understood this appointment</span>
                                        </label>
                                    </div>

                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="respondToAppointment(${apt.id}, 'accepted')" style="flex: 1; background: var(--success-color);">
                                            ‚úì Accept Appointment
                                        </button>
                                        <button class="btn" onclick="respondToAppointment(${apt.id}, 'declined')" style="flex: 1; background: var(--danger-color);">
                                            ‚úó Decline Appointment
                                        </button>
                                    </div>
                                ` : apt.patient_response_date ? `
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 13px; text-align: center;">
                                        Response sent: ${new Date(apt.patient_response_date).toLocaleString('en-GB')}
                                    </p>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    // No appointments - hide badge
                    const badge = document.getElementById('appointmentBadge');
                    if (badge) {
                        badge.style.display = 'none';
                    }
                    
                    listDiv.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <p style="font-size: 48px; margin: 0 0 15px 0;">üìÖ</p>
                            <h4 style="margin: 0 0 10px 0;">No Appointments</h4>
                            <p style="color: var(--text-secondary); margin: 0;">You don't have any upcoming appointments scheduled.</p>
                            <p style="color: var(--text-muted); margin-top: 10px; font-size: 14px;">Your clinician will schedule appointments as needed.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsList').innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545;">Failed to load appointments. Please try again.</p>
                    </div>
                `;
            }
        }
        
        async function respondToAppointment(appointmentId, response) {
            const checkbox = document.getElementById(`ack-${appointmentId}`);
            
            if (!checkbox || !checkbox.checked) {
                alert('‚ö†Ô∏è You must tick the box to confirm you have read the appointment details before responding.');
                return;
            }
            
            const action = response === 'accepted' ? 'accept' : 'decline';
            if (!confirm(`Are you sure you want to ${action} this appointment?`)) {
                return;
            }
            
            try {
                const apiResponse = await fetch(`/api/appointments/${appointmentId}/respond`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_username: currentUser,
                        acknowledged: true,
                        response: response
                    })
                });
                
                const data = await apiResponse.json();
                
                if (apiResponse.ok) {
                    alert(`‚úì Appointment ${response}! Your clinician has been notified.`);
                    loadPatientAppointments(); // Reload to show updated status and update badge
                    closeNotifications(); // Close notification panel if open
                } else {
                    alert('Error: ' + (data.error || 'Failed to respond to appointment'));
                }
            } catch (error) {
                console.error('Error responding to appointment:', error);
                alert('Failed to respond to appointment. Please try again.');
            }
        }
        
        // Insights Functions
        function setInsightsRange(days) {
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - days);
            
            document.getElementById('insightsToDate').valueAsDate = toDate;
            document.getElementById('insightsFromDate').valueAsDate = fromDate;
            loadInsights();
        }
        
        async function loadInsights() {
            try {
                let url = `/api/insights?username=${encodeURIComponent(currentUser)}`;
                // Always include a default prompt for insights
                const defaultPrompt = encodeURIComponent('Generate a detailed, narrative, and empathetic summary of the user\'s recent mental health progress, including mood, sleep, therapy, and self-care activities. Highlight trends, strengths, and areas for growth.');
                url += `&prompt=${defaultPrompt}`;
                // Add role (default to patient)
                url += `&role=patient`;
                // Add date range if specified
                const fromDate = document.getElementById('insightsFromDate')?.value;
                const toDate = document.getElementById('insightsToDate')?.value;
                if (fromDate) url += `&from_date=${fromDate}`;
                if (toDate) url += `&to_date=${toDate}`;
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (response.ok) {
                    // Null-safe display of insights data
                    const avgMood = typeof data.avg_mood === 'number' ? data.avg_mood : 0;
                    const avgSleep = typeof data.avg_sleep === 'number' ? data.avg_sleep : 0;
                    document.getElementById('avgMood').textContent = avgMood.toFixed(1);
                    document.getElementById('avgSleep').textContent = avgSleep.toFixed(1) + 'h';
                    document.getElementById('moodTrend').textContent = data.trend || 'No data';
                    document.getElementById('aiInsight').innerHTML = `<p>${sanitizeWithLineBreaks(data.insight || 'No insights available yet. Log some moods to get started!')}</p>`;
                    
                    // Draw mood chart
                    if (data.mood_data && data.mood_data.length > 0) {
                        drawMoodChart(data.mood_data);
                    }
                    
                    // Draw sleep chart
                    if (data.sleep_data && data.sleep_data.length > 0) {
                        drawSleepChart(data.sleep_data);
                    }
                } else {
                    alert('Error loading insights');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Insights load error:', error);
            }
        }
        
        function drawMoodChart(moodData) {
            const canvas = document.getElementById('moodChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = height - padding - (i * (height - 2 * padding) / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i, padding - 10, y + 4);
            }
            
            // Draw line
            if (moodData.length > 1) {
                const stepX = (width - 2 * padding) / (moodData.length - 1);
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moodData.forEach((point, index) => {
                    const x = padding + index * stepX;
                    const y = height - padding - (point.value * (height - 2 * padding) / 10);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            moodData.forEach((point, index) => {
                const x = padding + index * ((width - 2 * padding) / (moodData.length - 1));
                const date = new Date(point.timestamp);
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                ctx.fillText(label, x, height - padding + 20);
            });
        }
        
        function drawSleepChart(sleepData) {
            const canvas = document.getElementById('sleepChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const maxHours = 12; // Maximum sleep hours for scale
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= maxHours; i++) {
                const y = height - padding - (i * (height - 2 * padding) / maxHours);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i + 'h', padding - 10, y + 4);
            }
            
            // Draw line
            if (sleepData.length > 1) {
                const stepX = (width - 2 * padding) / (sleepData.length - 1);
                
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                sleepData.forEach((point, index) => {
                    const x = padding + index * stepX;
                    const y = height - padding - (point.value * (height - 2 * padding) / maxHours);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            sleepData.forEach((point, index) => {
                const x = padding + index * ((width - 2 * padding) / (sleepData.length - 1));
                const date = new Date(point.timestamp);
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                ctx.fillText(label, x, height - padding + 20);
            });
        }
        
        async function exportCSV() {
            window.location.href = `/api/export/csv?username=${encodeURIComponent(currentUser)}`;
        }
        
        async function exportPDF() {
            window.location.href = `/api/export/pdf?username=${encodeURIComponent(currentUser)}`;
        }
        
        // About Me Functions
        async function loadProfile() {
            try {
                const response = await fetch(`/api/patient/profile?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Fill in profile fields
                    document.getElementById('profileFullName').value = data.profile.full_name || '';
                    document.getElementById('profileDOB').value = data.profile.dob || '';
                    document.getElementById('profileEmail').value = data.profile.email || '';
                    document.getElementById('profilePhone').value = data.profile.phone || '';
                    document.getElementById('profileConditions').value = data.profile.conditions || '';
                    
                    // Display clinician info
                    const clinicianDiv = document.getElementById('clinicianInfo');
                    if (data.profile.assigned_clinician) {
                        clinicianDiv.innerHTML = `
                            <p><strong>Assigned Clinician:</strong> ${sanitizeHTML(data.profile.assigned_clinician)}</p>
                            <p><strong>Email:</strong> ${sanitizeHTML(data.profile.clinician_email || 'Not provided')}</p>
                            <p style="margin-top: 10px; color: var(--text-secondary); font-size: 14px;">
                                Your clinician can view your progress and provide professional support.
                            </p>
                        `;
                    } else {
                        clinicianDiv.innerHTML = '<p class="muted-text">No clinician assigned yet.</p>';
                    }
                    
                    // Display activity stats
                    document.getElementById('statMoodLogs').textContent = data.stats.mood_logs || 0;
                    document.getElementById('statGratitude').textContent = data.stats.gratitude_entries || 0;
                    document.getElementById('statCBT').textContent = data.stats.cbt_entries || 0;
                    document.getElementById('statSessions').textContent = data.stats.therapy_sessions || 0;
                } else {
                    alert('Error loading profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile');
            }
        }
        
        async function saveProfile() {
            const profileData = {
                username: currentUser,
                full_name: document.getElementById('profileFullName').value,
                dob: document.getElementById('profileDOB').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                conditions: document.getElementById('profileConditions').value
            };
            
            try {
                const response = await fetch('/api/patient/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Profile saved successfully!');
                } else {
                    alert('Error saving profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile');
            }
        }
        
        // Sleep Hygiene Functions
        function resetSleepChecklist() {
            document.querySelectorAll('.sleep-check').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Professional Dashboard Functions
        let currentPatientData = null;
        let currentPatientTab = 'profile';
        
        async function loadPatients() {
            if (currentUserRole !== 'clinician') {
                alert('Access denied. Professional dashboard is only for clinicians.');
                return;
            }
            
            const listDiv = document.getElementById('patientList');
            listDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/professional/patients?clinician=${encodeURIComponent(currentUser)}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    const html = data.patients.map(patient => `
                        <div class="patient-card" onclick="viewPatientDetail('${patient.username}')" style="cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s; hover: {border-color: #667eea;}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <strong style="font-size: 20px; color: #333;">${patient.username}</strong>
                                    <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Last active: ${new Date(patient.last_login || Date.now()).toLocaleDateString()}</p>
                                </div>
                                ${patient.alert_count_7d > 0 ? `<span style="background: #e74c3c; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold;">üö® ${patient.alert_count_7d} alerts</span>` : `<span style="background: #28a745; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px;">‚úì No alerts</span>`}
                            </div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 28px; font-weight: bold; color: #667eea;">${patient.avg_mood_7d || 'N/A'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">Avg Mood (7d)</div>
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 28px; font-weight: bold; color: ${getSeverityColor(patient.latest_assessment?.severity)}">${patient.latest_assessment?.score || 'N/A'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">${patient.latest_assessment ? patient.latest_assessment.name : 'No Assessment'}</div>
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 20px; font-weight: bold; color: ${getSeverityColor(patient.latest_assessment?.severity)}">${patient.latest_assessment?.severity || '-'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">Severity</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No patients found. Patients will appear here after you approve their requests.</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading patients</p>';
                console.error('Patient load error:', error);
            }
        }
        
        async function viewPatientDetail(username) {
            // Hide all clinical tabs when viewing individual patient
            document.querySelectorAll('.clinical-subtab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.getElementById('patientListSection').style.display = 'none';
            document.getElementById('patientDetailSection').style.display = 'block';
            document.getElementById('patientDetailName').textContent = username;
            currentPatientTab = 'profile';
            
            // Initialize date range to last 30 days
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - 30);
            document.getElementById('patientChartToDate').valueAsDate = toDate;
            document.getElementById('patientChartFromDate').valueAsDate = fromDate;
            
            // Default to summary tab
            switchPatientTab('summary', document.getElementById('summaryPatientSubtabBtn'));
            
            try {
                const response = await fetch(`/api/professional/patient/${encodeURIComponent(username)}?clinician=${encodeURIComponent(currentUser)}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (response.ok) {
                    currentPatientData = data;
                    
                    // Generate AI summary
                    generateAISummary(username, data);
                } else {
                    document.getElementById('aiSummary').innerHTML = '<p style="color: #dc3545;">Error loading patient data</p>';
                }
            } catch (error) {
                document.getElementById('aiSummary').innerHTML = '<p style="color: #dc3545;">Connection error</p>';
                console.error('Patient detail error:', error);
            }
        }
        
        function setPatientChartRange(days) {
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - days);
            
            document.getElementById('patientChartToDate').valueAsDate = toDate;
            document.getElementById('patientChartFromDate').valueAsDate = fromDate;
            loadPatientCharts();
        }
        
        async function loadPatientCharts() {
            if (!currentPatientData) return;

            const fromDate = document.getElementById('patientChartFromDate')?.value;
            const toDate = document.getElementById('patientChartToDate')?.value;

            try {
                // Build URL with required prompt parameter for clinician view
                const chartPrompt = encodeURIComponent('Generate a clinical summary of mood and sleep patterns for charting purposes.');
                let url = `/api/insights?username=${encodeURIComponent(currentPatientData.username)}&prompt=${chartPrompt}&role=clinician`;
                if (fromDate) url += `&from_date=${fromDate}`;
                if (toDate) url += `&to_date=${toDate}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (response.ok) {
                    // Draw mood chart
                    if (data.mood_data && data.mood_data.length > 0) {
                        drawPatientMoodChart(data.mood_data);
                    }
                    
                    // Draw sleep chart
                    if (data.sleep_data && data.sleep_data.length > 0) {
                        drawPatientSleepChart(data.sleep_data);
                    }
                }
            } catch (error) {
                console.error('Chart loading error:', error);
            }
        }
        
        function drawPatientMoodChart(moods) {
            const canvas = document.getElementById('moodChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            if (!moods || moods.length === 0) {
                ctx.clearRect(0, 0, width, height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No mood data available', width / 2, height / 2);
                return;
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = height - padding - (i * (height - 2 * padding) / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i, padding - 10, y + 4);
            }
            
            // Draw line
            if (moods.length > 1) {
                const stepX = (width - 2 * padding) / (moods.length - 1);
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moods.forEach((point, index) => {
                    const moodValue = point.value !== undefined ? point.value : point.mood;
                    const x = padding + index * stepX;
                    const y = height - padding - (moodValue * (height - 2 * padding) / 10);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelStep = Math.max(1, Math.floor(moods.length / 10));
            moods.forEach((point, index) => {
                if (index % labelStep === 0 || index === moods.length - 1) {
                    const x = padding + index * ((width - 2 * padding) / (moods.length - 1));
                    const date = new Date(point.timestamp);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, x, height - padding + 20);
                }
            });
        }
        
        function drawPatientSleepChart(sleepData) {
            const canvas = document.getElementById('sleepChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const maxHours = 12;
            
            if (!sleepData || sleepData.length === 0) {
                ctx.clearRect(0, 0, width, height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No sleep data available', width / 2, height / 2);
                return;
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= maxHours; i++) {
                const y = height - padding - (i * (height - 2 * padding) / maxHours);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i + 'h', padding - 10, y + 4);
            }
            
            // Draw line
            if (sleepData.length > 1) {
                const stepX = (width - 2 * padding) / (sleepData.length - 1);
                
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                sleepData.forEach((point, index) => {
                    const sleepValue = point.value !== undefined ? point.value : point.sleep;
                    const x = padding + index * stepX;
                    const y = height - padding - (sleepValue * (height - 2 * padding) / maxHours);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelStep = Math.max(1, Math.floor(sleepData.length / 10));
            sleepData.forEach((point, index) => {
                if (index % labelStep === 0 || index === sleepData.length - 1) {
                    const x = padding + index * ((width - 2 * padding) / (sleepData.length - 1));
                    const date = new Date(point.timestamp);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, x, height - padding + 20);
                }
            });
        }
        
        async function generateAISummary(username, data) {
            const summaryDiv = document.getElementById('aiSummary');

            try {
                // Call API to get AI summary (must include clinician_username for authorization)
                const response = await fetch('/api/professional/ai-summary', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, clinician_username: currentUser })
                });
                
                const result = await response.json();
                
                if (response.ok && result.summary) {
                    summaryDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.8;">
                            <p style="white-space: pre-wrap;">${result.summary}</p>
                        </div>
                    `;
                } else {
                    // Fallback to basic summary with null safety
                    const recentMoods = data.recent_moods || [];
                    const avgMood = recentMoods.length > 0
                        ? recentMoods.reduce((acc, m) => acc + (m.mood || 0), 0) / recentMoods.length
                        : 0;
                    const latestAssessment = (data.clinical_scales || [])[0];
                    const alertCount = (data.recent_alerts || []).length;
                    
                    summaryDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p><strong>Clinical Overview:</strong></p>
                            <ul style="line-height: 1.8; margin-top: 10px;">
                                <li>Average mood over last 30 days: <strong>${avgMood.toFixed(1)}/10</strong></li>
                                <li>Latest assessment: <strong>${latestAssessment ? `${latestAssessment.name} - ${latestAssessment.severity} (Score: ${latestAssessment.score})` : 'No assessments recorded'}</strong></li>
                                <li>Recent alerts: <strong style="color: ${alertCount > 0 ? '#e74c3c' : '#28a745'}">${alertCount} ${alertCount === 1 ? 'alert' : 'alerts'}</strong></li>
                                <li>Therapy sessions: <strong>${recentMoods.length} mood entries recorded</strong></li>
                            </ul>
                            ${alertCount > 0 ? '<p style="color: #e74c3c; margin-top: 15px; font-weight: bold;">‚ö†Ô∏è Requires immediate attention</p>' : '<p style="color: #28a745; margin-top: 15px;">‚úì Patient appears stable</p>'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI summary error:', error);
                summaryDiv.innerHTML = '<p style="color: #999;">AI summary unavailable</p>';
            }
        }
        
        // Patient Detail Subtab Switching
        function switchPatientTab(subtabName, buttonEl) {
            // Hide all patient subtabs
            document.querySelectorAll('.patient-subtab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Reset all patient subtab buttons
            document.querySelectorAll('.patient-subtab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#667eea';
                btn.style.border = '2px solid #667eea';
            });
            
            // Show selected subtab
            const tabId = 'patient' + subtabName.charAt(0).toUpperCase() + subtabName.slice(1) + 'Tab';
            document.getElementById(tabId).style.display = 'block';
            
            // Highlight selected button
            if (buttonEl) {
                buttonEl.style.background = '#667eea';
                buttonEl.style.color = 'white';
                buttonEl.style.border = 'none';
            }
            
            // Load data for specific subtabs
            if (subtabName === 'charts') {
                loadPatientCharts();
            } else if (subtabName === 'profile') {
                showPatientTab('profile');
            } else if (subtabName === 'moods') {
                showPatientTab('moods');
            } else if (subtabName === 'assessments') {
                showPatientTab('assessments');
            } else if (subtabName === 'therapy') {
                showPatientTab('therapy');
            } else if (subtabName === 'alerts') {
                showPatientTab('alerts');
            }
        }
        
        function showPatientTab(tabName) {
            currentPatientTab = tabName;
            const data = currentPatientData;
            
            if (!data) {
                return;
            }
            
            // Determine which content div to use based on tab name
            let contentDiv;
            switch (tabName) {
                case 'profile':
                    contentDiv = document.getElementById('patientDetailContent');
                    break;
                case 'moods':
                    contentDiv = document.getElementById('patientMoodsContent');
                    break;
                case 'assessments':
                    contentDiv = document.getElementById('patientAssessmentsContent');
                    break;
                case 'therapy':
                    contentDiv = document.getElementById('patientTherapyContent');
                    break;
                case 'alerts':
                    contentDiv = document.getElementById('patientAlertsContent');
                    break;
                default:
                    contentDiv = document.getElementById('patientDetailContent');
            }
            
            if (!contentDiv) {
                console.error('Content div not found for tab:', tabName);
                return;
            }
            
            let html = '';
            
            switch (tabName) {
                case 'profile':
                    html = `
                        <div class="card">
                            <h4>Patient Profile</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold; width: 30%;">Username</td>
                                    <td style="padding: 12px 0;">${data.profile.username || 'N/A'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Full Name</td>
                                    <td style="padding: 12px 0;">${data.profile.name || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Email</td>
                                    <td style="padding: 12px 0;">${data.profile.email || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Phone</td>
                                    <td style="padding: 12px 0;">${data.profile.phone || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Date of Birth</td>
                                    <td style="padding: 12px 0;">${data.profile.dob || 'Not provided'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 0; font-weight: bold; vertical-align: top;">Conditions</td>
                                    <td style="padding: 12px 0;">${data.profile.conditions || 'Not provided'}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                    break;
                    
                case 'moods':
                    html = `
                        <div class="card">
                            <h4>Mood Logs (Last 30 Days)</h4>
                            ${data.recent_moods.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left;">Date</th>
                                            <th style="padding: 12px; text-align: center;">Mood</th>
                                            <th style="padding: 12px; text-align: center;">Sleep</th>
                                            <th style="padding: 12px; text-align: center;">Exercise</th>
                                            <th style="padding: 12px; text-align: left;">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.recent_moods.map(m => `
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="padding: 12px;">${new Date(m.timestamp).toLocaleDateString()}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: bold; color: ${m.mood >= 7 ? '#28a745' : m.mood >= 4 ? '#ffc107' : '#dc3545'};">${m.mood}/10</td>
                                                <td style="padding: 12px; text-align: center;">${m.sleep || 0}h</td>
                                                <td style="padding: 12px; text-align: center;">${m.exercise || 0}min</td>
                                                <td style="padding: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${m.notes || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: #999; padding: 20px; text-align: center;">No mood logs recorded yet</p>'}
                        </div>
                    `;
                    break;
                    
                case 'assessments':
                    html = `
                        <div class="card">
                            <h4>Clinical Assessments</h4>
                            ${data.clinical_scales.length > 0 ? data.clinical_scales.map(s => `
                                <div style="padding: 20px; border-bottom: 1px solid #eee; margin-bottom: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="font-size: 18px;">${s.name}</strong>
                                        <span style="background: ${getSeverityColor(s.severity)}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">${s.severity}</span>
                                    </div>
                                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                                        <div>
                                            <div style="font-size: 32px; font-weight: bold; color: ${getSeverityColor(s.severity)};">${s.score}</div>
                                            <div style="font-size: 12px; color: #666;">Score</div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="color: #666; font-size: 14px;">Completed: ${new Date(s.timestamp).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #999; padding: 20px; text-align: center;">No clinical assessments completed yet</p>'}
                        </div>
                    `;
                    break;
                    
                case 'therapy':
                    html = `
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>üìù Add Therapy / Appointment Note</h4>
                            <textarea id="newClinicianNote" placeholder="Enter therapy session notes, appointment summaries, or clinical observations..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 120px; font-family: inherit; margin-bottom: 10px;"></textarea>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="highlightNote" style="cursor: pointer;">
                                    <span>‚≠ê Highlight as important</span>
                                </label>
                                <button class="btn" onclick="saveClinicianNote()" style="margin-left: auto;">üíæ Save Note</button>
                            </div>
                        </div>
                        <div class="card">
                            <h4>Previous Therapy Notes & Appointments</h4>
                            <div id="clinicianNotesContainer">
                                ${data.clinician_notes && data.clinician_notes.length > 0 ? 
                                    data.clinician_notes.map(note => `
                                        <div class="note-item" style="padding: 15px; border-left: 4px solid ${note.highlighted ? '#ffc107' : '#e0e0e0'}; background: ${note.highlighted ? '#fff3cd' : '#f8f9fa'}; border-radius: 8px; margin-bottom: 15px; position: relative;">
                                            ${note.highlighted ? '<span style="position: absolute; top: 10px; right: 10px; font-size: 20px;">‚≠ê</span>' : ''}
                                            <div style="color: #666; font-size: 13px; margin-bottom: 8px;">üìÖ ${new Date(note.timestamp).toLocaleString()}</div>
                                            <div style="white-space: pre-wrap; line-height: 1.6;">${note.note}</div>
                                            <button class="btn btn-secondary" onclick="deleteNote(${note.id})" style="margin-top: 10px; padding: 6px 12px; font-size: 13px;">üóëÔ∏è Delete</button>
                                        </div>
                                    `).join('') 
                                    : '<p style="color: #999; padding: 20px; text-align: center;">No therapy notes yet. Add your first note above.</p>'
                                }
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'alerts':
                    html = `
                        <div class="card">
                            <h4>Safety Alerts & Warnings</h4>
                            ${data.recent_alerts.length > 0 ? data.recent_alerts.map(a => `
                                <div style="padding: 20px; margin-bottom: 15px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="font-size: 16px; color: #c62828;">üö® ${a.type}</strong>
                                        <span style="font-size: 13px; color: #666;">${new Date(a.timestamp).toLocaleString()}</span>
                                    </div>
                                    <p style="margin: 0; color: #666;">${a.message}</p>
                                </div>
                            `).join('') : '<p style="color: #28a745; padding: 20px; text-align: center; font-weight: bold;">‚úì No recent safety alerts - patient appears stable</p>'}
                        </div>
                    `;
                    break;
            }
            
            contentDiv.innerHTML = html;
        }
        
        function closePatientDetail() {
            document.getElementById('patientListSection').style.display = 'block';
            document.getElementById('patientDetailSection').style.display = 'none';
            currentPatientData = null;
            
            // Return to Patients tab
            switchClinicalTab('patients', document.querySelector('[onclick*="switchClinicalTab(\'patients\'"]'));
        }
        
        function getSeverityColor(severity) {
            if (!severity) return '#999';
            const colors = {
                'Minimal': '#28a745',
                'Mild': '#ffc107',
                'Moderate': '#fd7e14',
                'Moderately Severe': '#dc3545',
                'Severe': '#dc3545'
            };
            return colors[severity] || '#999';
        }
        
        async function saveClinicianNote() {
            const noteText = document.getElementById('newClinicianNote').value.trim();
            const isHighlighted = document.getElementById('highlightNote').checked;
            
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            
            if (!currentPatientData || !currentPatientData.username) {
                alert('No patient selected');
                return;
            }
            
            try {
                const response = await fetch('/api/professional/notes', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clinician_username: currentUser,
                        patient_username: currentPatientData.username,
                        note_text: noteText,
                        is_highlighted: isHighlighted ? 1 : 0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Note saved successfully! AI will reference this in patient conversations.');
                    document.getElementById('newClinicianNote').value = '';
                    document.getElementById('highlightNote').checked = false;
                    // Reload patient data to show new note
                    viewPatient(currentPatientData.username);
                } else {
                    alert('Error saving note: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note');
            }
        }
        
        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            try {
                const response = await fetch(`/api/professional/notes/${noteId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Note deleted');
                    viewPatient(currentPatientData.username);
                } else {
                    alert('Error deleting note: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note');
            }
        }
        
        // Appointment Management Functions
        // Calendar state
        let currentCalendarDate = new Date();
        let calendarView = 'month';  // 'month', 'week', or 'day'
        let allAppointments = [];
        
        async function loadAppointments() {
            if (currentUserRole !== 'clinician') {
                return;
            }
            
            try {
                const response = await fetch(`/api/appointments?clinician=${encodeURIComponent(currentUser)}&_t=${Date.now()}`, {
                    cache: 'no-store',
                    credentials: 'include',
                    headers: { 'Cache-Control': 'no-cache', 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (response.ok && data.appointments) {
                    allAppointments = data.appointments;
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }
        
        function setCalendarView(view) {
            calendarView = view;
            
            // Update button styles
            document.getElementById('monthViewBtn').className = view === 'month' ? 'btn' : 'btn btn-secondary';
            document.getElementById('monthViewBtn').style.background = view === 'month' ? '#667eea' : '';
            document.getElementById('weekViewBtn').className = view === 'week' ? 'btn' : 'btn btn-secondary';
            document.getElementById('weekViewBtn').style.background = view === 'week' ? '#667eea' : '';
            document.getElementById('dayViewBtn').className = view === 'day' ? 'btn' : 'btn btn-secondary';
            document.getElementById('dayViewBtn').style.background = view === 'day' ? '#667eea' : '';
            
            // Show/hide views
            document.getElementById('monthView').style.display = view === 'month' ? 'block' : 'none';
            document.getElementById('weekView').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('dayView').style.display = view === 'day' ? 'block' : 'none';
            
            renderCalendar();
        }
        
        function previousMonth() {
            if (calendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else if (calendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
            }
            renderCalendar();
        }
        
        function nextMonth() {
            if (calendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            } else if (calendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
            }
            renderCalendar();
        }
        
        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }
        
        function renderCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            if (calendarView === 'month') {
                document.getElementById('calendarMonth').textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
                renderMonthView();
            } else if (calendarView === 'week') {
                const weekStart = new Date(currentCalendarDate);
                weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                document.getElementById('calendarMonth').textContent = `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
                renderWeekView();
            } else {
                document.getElementById('calendarMonth').textContent = currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                renderDayView();
            }
        }
        
        function renderMonthView() {
            const grid = document.getElementById('calendarDaysGrid');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const monthLength = lastDay.getDate();
            
            let html = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div style="background: #fafafa; min-height: 100px; border: 1px solid #e0e0e0; border-radius: 4px;"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= monthLength; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                // Get appointments for this day
                const dayAppointments = allAppointments.filter(apt => {
                    const aptDate = new Date(apt.appointment_date);
                    return aptDate.toDateString() === date.toDateString();
                });
                
                let aptHtml = '';
                if (dayAppointments.length > 0) {
                    // Show first 3 appointments
                    const toShow = dayAppointments.slice(0, 3);
                    toShow.forEach(apt => {
                        const time = new Date(apt.appointment_date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        const statusColor = apt.patient_response === 'accepted' ? '#28a745' : 
                                          apt.patient_response === 'declined' ? '#dc3545' : '#ffc107';
                        aptHtml += `<div style="background: ${statusColor}; color: white; padding: 2px 6px; font-size: 11px; border-radius: 3px; margin-top: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" onclick="viewDayAppointments('${dateStr}')" title="${apt.patient_username} at ${time}">${time} ${apt.patient_username}</div>`;
                    });
                    if (dayAppointments.length > 3) {
                        aptHtml += `<div style="color: #667eea; font-size: 11px; margin-top: 2px; cursor: pointer;" onclick="viewDayAppointments('${dateStr}')">+${dayAppointments.length - 3} more</div>`;
                    }
                }
                
                html += `
                    <div onclick="viewDayAppointments('${dateStr}')" style="background: ${isToday ? '#e3f2fd' : 'white'}; min-height: 100px; border: ${isToday ? '2px solid #667eea' : '1px solid #e0e0e0'}; border-radius: 4px; padding: 8px; cursor: pointer; position: relative;">
                        <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? '#667eea' : '#333'}; margin-bottom: 5px;">${day}</div>
                        ${dayAppointments.length > 0 ? `<div style="position: absolute; top: 5px; right: 5px; background: #667eea; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${dayAppointments.length}</div>` : ''}
                        ${aptHtml}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        function renderWeekView() {
            const content = document.getElementById('weekViewContent');
            const weekStart = new Date(currentCalendarDate);
            weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
            
            let html = '<div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 5px;">';
            
            // Header row
            html += '<div style="background: #f5f5f5; padding: 10px; font-weight: bold; text-align: center;">Time</div>';
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const isToday = day.toDateString() === new Date().toDateString();
                html += `<div style="background: ${isToday ? '#667eea' : '#f5f5f5'}; color: ${isToday ? 'white' : '#333'}; padding: 10px; font-weight: bold; text-align: center;">${day.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>`;
            }
            
            // Time slots (8 AM to 6 PM)
            for (let hour = 8; hour < 18; hour++) {
                html += `<div style="background: #fafafa; padding: 10px; text-align: right; font-size: 12px; color: #666;">${hour}:00</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    const dateStr = day.toISOString().split('T')[0];
                    
                    // Find appointments in this hour slot
                    const hourApts = allAppointments.filter(apt => {
                        const aptDate = new Date(apt.appointment_date);
                        return aptDate.toDateString() === day.toDateString() && aptDate.getHours() === hour;
                    });
                    
                    let cellHtml = '';
                    hourApts.forEach(apt => {
                        const time = new Date(apt.appointment_date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        const statusColor = apt.patient_response === 'accepted' ? '#28a745' : 
                                          apt.patient_response === 'declined' ? '#dc3545' : '#ffc107';
                        cellHtml += `<div style="background: ${statusColor}; color: white; padding: 5px; margin-bottom: 3px; font-size: 11px; border-radius: 4px; cursor: pointer;" onclick="viewAppointmentDetails(${apt.id})" title="${apt.patient_username} at ${time}">${time}<br>${apt.patient_username}</div>`;
                    });
                    
                    html += `<div style="background: white; border: 1px solid #e0e0e0; min-height: 60px; padding: 5px;">${cellHtml}</div>`;
                }
            }
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function renderDayView() {
            const content = document.getElementById('dayViewContent');
            const dateStr = currentCalendarDate.toISOString().split('T')[0];
            
            const dayAppointments = allAppointments.filter(apt => {
                const aptDate = new Date(apt.appointment_date);
                return aptDate.toDateString() === currentCalendarDate.toDateString();
            }).sort((a, b) => new Date(a.appointment_date) - new Date(b.appointment_date));
            
            if (dayAppointments.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No appointments scheduled for this day</p>';
                return;
            }
            
            let html = '';
            const now = new Date();
            
            dayAppointments.forEach(apt => {
                const aptDate = new Date(apt.appointment_date);
                const time = aptDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                const isPast = aptDate < now;
                const isUpcoming = !isPast && (aptDate - now) < 3600000; // Within 1 hour
                
                const statusColor = apt.patient_response === 'accepted' ? '#28a745' : 
                                   apt.patient_response === 'declined' ? '#dc3545' : '#ffc107';
                const statusIcon = apt.patient_response === 'accepted' ? '‚úì' : 
                                  apt.patient_response === 'declined' ? '‚úó' : '‚è≥';
                
                html += `
                    <div style="border: 2px solid ${isUpcoming ? '#ff9800' : isPast ? '#ccc' : statusColor}; border-radius: 8px; padding: 20px; background: ${isPast ? '#f5f5f5' : isUpcoming ? '#fff3e0' : 'white'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px;">${time}</div>
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">${apt.patient_username}</div>
                                ${apt.notes ? `<div style="color: #666; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px;">${apt.notes}</div>` : ''}
                                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                    <span style="background: ${statusColor}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                                        ${statusIcon} ${apt.patient_response === 'accepted' ? 'Accepted' : apt.patient_response === 'declined' ? 'Declined' : 'Pending'}
                                    </span>
                                    ${isUpcoming ? '<span style="background: #ff9800; color: white; padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: bold;">‚ö° Upcoming Soon</span>' : ''}
                                    ${isPast ? '<span style="background: #999; color: white; padding: 6px 14px; border-radius: 20px; font-size: 14px;">üìç Completed</span>' : ''}
                                    ${apt.patient_acknowledged ? '<span style="background: #28a745; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px;">‚úì Read</span>' : '<span style="background: #999; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px;">‚óã Unread</span>'}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button onclick="viewPatientDetail('${apt.patient_username}')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; white-space: nowrap;">View Patient</button>
                                <button onclick="cancelAppointment(${apt.id})" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; white-space: nowrap;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function viewDayAppointments(dateStr) {
            currentCalendarDate = new Date(dateStr + 'T12:00:00');
            setCalendarView('day');
        }
        
        function viewAppointmentDetails(aptId) {
            const apt = allAppointments.find(a => a.id === aptId);
            if (apt) {
                const aptDate = new Date(apt.appointment_date);
                currentCalendarDate = aptDate;
                setCalendarView('day');
            }
        }
        
        function showNewAppointmentForm() {
            document.getElementById('newAppointmentForm').style.display = 'block';
            
            // Populate patient dropdown
            const select = document.getElementById('appointmentPatient');
            const patientList = document.getElementById('patientList');
            const patientCards = patientList.querySelectorAll('.patient-card');
            
            select.innerHTML = '<option value="">Select a patient...</option>';
            patientCards.forEach(card => {
                const username = card.querySelector('strong').textContent;
                select.innerHTML += `<option value="${escapeHtml(username)}">${escapeHtml(username)}</option>`;
            });
            
            // Set minimum date to today
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('appointmentDateTime').min = now.toISOString().slice(0, 16);
        }
        
        function cancelNewAppointment() {
            document.getElementById('newAppointmentForm').style.display = 'none';
            document.getElementById('appointmentPatient').value = '';
            document.getElementById('appointmentDateTime').value = '';
            document.getElementById('appointmentNotes').value = '';
        }
        
        async function createAppointment() {
            const patientUsername = document.getElementById('appointmentPatient').value;
            const dateTime = document.getElementById('appointmentDateTime').value;
            const notes = document.getElementById('appointmentNotes').value;
            
            if (!patientUsername || !dateTime) {
                alert('Please select a patient and appointment date/time');
                return;
            }
            
            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clinician_username: currentUser,
                        patient_username: patientUsername,
                        appointment_date: dateTime,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Appointment scheduled successfully!');
                    cancelNewAppointment();
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to create appointment'));
                }
            } catch (error) {
                console.error('Error creating appointment:', error);
                alert('Connection error. Please try again.');
            }
        }
        
        async function cancelAppointment(appointmentId) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Appointment cancelled');
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel'));
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('Connection error');
            }
        }
        
        // Restore session on page load
        async function restoreSession() {
            // Check localStorage first (Remember Me), then sessionStorage
            let sessionData = localStorage.getItem('healingSpaceSession');
            let storage = 'localStorage';
            
            if (!sessionData) {
                sessionData = sessionStorage.getItem('healingSpaceSession');
                storage = 'sessionStorage';
            }
            
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    
                    // Validate session with server before restoring
                    const response = await fetch('/api/validate-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: data.username,
                            role: data.role || 'user'
                        })
                    });
                    
                    if (response.ok) {
                        currentUser = data.username;
                        currentUserRole = data.role || 'user';
                        
                        console.log('Session restored from ' + storage + ' for user:', currentUser);
                        
                        // Restore the app state
                        completeLogin(data);
                        // If patient, switch to Home tab after login/session restore
                        if ((data.role || 'user') === 'user') {
                            setTimeout(() => {
                                switchTab('home', document.querySelector('[onclick*="home"]'));
                            }, 100);
                        }
                    } else {
                        // Session invalid, clear it
                        console.log('Session validation failed, clearing session data');
                        localStorage.removeItem('healingSpaceSession');
                        sessionStorage.removeItem('healingSpaceSession');
                        showLanding();
                    }
                } catch (error) {
                    console.error('Error restoring session:', error);
                    // Clear corrupted session data
                    localStorage.removeItem('healingSpaceSession');
                    sessionStorage.removeItem('healingSpaceSession');
                    showLanding();
                }
            } else {
                // No session data, show landing page
                showLanding();
            }
        }
        
        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
                button.title = 'Hide password';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
                button.title = 'Show password';
            }
        }
        
        // Alias for registration form compatibility
        function togglePasswordVisibility(inputId, buttonId) {
            const button = document.getElementById(buttonId);
            togglePassword(inputId, button);
        }
        
        // Analytics Dashboard Functions
        let moodChartInstance = null;
        let phq9ChartInstance = null;
        let gad7ChartInstance = null;
        
        async function loadAnalyticsDashboard() {
            if (currentUserRole !== 'clinician' && currentUserRole !== 'professional') {
                console.log('Not loading analytics - user role:', currentUserRole);
                return;
            }
            
            const errorDiv = document.getElementById('analyticsError');
            errorDiv.style.display = 'none';
            
            console.log('Loading analytics for clinician:', currentUser);
            
            try {
                const url = `/api/analytics/dashboard?clinician=${encodeURIComponent(currentUser)}&_t=${Date.now()}`;
                console.log('Fetching analytics from:', url);
                
                const response = await fetch(url, {
                    cache: 'no-store',
                    credentials: 'include',
                    headers: { 'Cache-Control': 'no-cache', 'Content-Type': 'application/json' }
                });
                
                console.log('Analytics response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to load analytics:', response.status, errorText);
                    
                    if (errorDiv) {
                        errorDiv.textContent = `Error loading analytics (${response.status}): ${errorText.substring(0, 100)}`;
                        errorDiv.style.display = 'block';
                    }
                    return;
                }
                
                const data = await response.json();
                
                console.log('Analytics data received:', data);
                console.log('Total patients:', data.total_patients, 'Active:', data.active_patients, 'High risk:', data.high_risk_count);
                
                // Update stat cards - ensure numbers are shown, not dashes
                const totalEl = document.getElementById('totalPatientsCount');
                const activeEl = document.getElementById('activePatientsCount');
                const highRiskEl = document.getElementById('highRiskCount');
                
                console.log('Elements found:', !!totalEl, !!activeEl, !!highRiskEl);
                
                if (totalEl) {
                    totalEl.textContent = (data.total_patients !== undefined && data.total_patients !== null) ? data.total_patients : 0;
                    console.log('Set totalPatientsCount to:', totalEl.textContent);
                }
                if (activeEl) {
                    activeEl.textContent = (data.active_patients !== undefined && data.active_patients !== null) ? data.active_patients : 0;
                    console.log('Set activePatientsCount to:', activeEl.textContent);
                }
                if (highRiskEl) {
                    highRiskEl.textContent = (data.high_risk_count !== undefined && data.high_risk_count !== null) ? data.high_risk_count : 0;
                    console.log('Set highRiskCount to:', highRiskEl.textContent);
                }
                
                // Render charts
                renderMoodTrendChart(data.mood_trends || []);
                renderAssessmentCharts(data.assessment_summary || { phq9: {}, gad7: {} });
                
            } catch (error) {
                console.error('Error loading analytics dashboard:', error);
            }
        }
        
        function renderMoodTrendChart(moodTrends) {
            const canvas = document.getElementById('moodTrendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (moodChartInstance) {
                moodChartInstance.destroy();
            }
            
            // Prepare data
            const labels = moodTrends.map(item => item.date);
            const avgMoods = moodTrends.map(item => item.avg_mood);
            const counts = moodTrends.map(item => item.count);
            
            moodChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Mood',
                        data: avgMoods,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Entries: ${counts[index]}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Mood Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
        
        function renderAssessmentCharts(assessmentSummary) {
            // Render PHQ-9 Chart
            const phq9Canvas = document.getElementById('phq9Chart');
            if (phq9Canvas) {
                const phq9Ctx = phq9Canvas.getContext('2d');
                
                if (phq9ChartInstance) {
                    phq9ChartInstance.destroy();
                }
                
                const phq9Data = assessmentSummary.phq9 || {};
                phq9ChartInstance = new Chart(phq9Ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Severe', 'Moderate', 'Mild', 'Minimal'],
                        datasets: [{
                            data: [
                                phq9Data.severe || 0,
                                phq9Data.moderate || 0,
                                phq9Data.mild || 0,
                                phq9Data.minimal || 0
                            ],
                            backgroundColor: [
                                '#ef4444',
                                '#f97316',
                                '#fbbf24',
                                '#10b981'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Render GAD-7 Chart
            const gad7Canvas = document.getElementById('gad7Chart');
            if (gad7Canvas) {
                const gad7Ctx = gad7Canvas.getContext('2d');
                
                if (gad7ChartInstance) {
                    gad7ChartInstance.destroy();
                }
                
                const gad7Data = assessmentSummary.gad7 || {};
                gad7ChartInstance = new Chart(gad7Ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Severe', 'Moderate', 'Mild', 'Minimal'],
                        datasets: [{
                            data: [
                                gad7Data.severe || 0,
                                gad7Data.moderate || 0,
                                gad7Data.mild || 0,
                                gad7Data.minimal || 0
                            ],
                            backgroundColor: [
                                '#dc2626',
                                '#ea580c',
                                '#facc15',
                                '#059669'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
        
        // Patient Search and Filter Functions
        async function searchPatients() {
            const searchInput = document.getElementById('patientSearchInput');
            const filterSelect = document.getElementById('patientFilterSelect');
            
            if (!searchInput || !filterSelect) return;
            
            const query = searchInput.value.trim();
            const filter = filterSelect.value;
            
            try {
                const params = new URLSearchParams({
                    clinician: currentUser,
                    filter: filter
                });
                
                if (query) {
                    params.append('q', query);
                }
                
                const response = await fetch(`/api/patients/search?${params.toString()}&_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (!response.ok) {
                    console.error('Search failed:', response.status);
                    return;
                }
                
                const patients = await response.json();
                displaySearchResults(patients);
                
            } catch (error) {
                console.error('Error searching patients:', error);
            }
        }
        
        function displaySearchResults(patients) {
            const patientList = document.getElementById('patientList');
            if (!patientList) return;
            
            if (patients.length === 0) {
                patientList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No patients found matching your search.</p>';
                return;
            }
            
            patientList.innerHTML = patients.map(patient => {
                const riskColor = patient.risk_level === 'high' ? '#ef4444' : 
                                 patient.risk_level === 'moderate' ? '#f97316' : '#10b981';
                
                const lastActive = patient.last_active || 'Never';
                const phq9Score = patient.phq9_score !== null ? patient.phq9_score : 'N/A';
                
                return `
                    <div class="patient-card" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #1f2937;">${sanitizeHTML(patient.full_name || patient.username)}</h4>
                                <p style="margin: 0; font-size: 13px; color: #6b7280;">@${sanitizeHTML(patient.username)}</p>
                                ${patient.email ? `<p style="margin: 3px 0 0 0; font-size: 13px; color: #6b7280;">${sanitizeHTML(patient.email)}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <span style="display: inline-block; padding: 4px 12px; background: ${riskColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 5px;">
                                    ${patient.risk_level.toUpperCase()}
                                </span>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">PHQ-9: ${phq9Score}</p>
                                <p style="margin: 3px 0 0 0; font-size: 12px; color: #6b7280;">Last Active: ${lastActive}</p>
                            </div>
                        </div>
                        ${patient.alert_count > 0 ? `
                        <div style="margin-top: 10px; padding: 8px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <p style="margin: 0; font-size: 13px; color: #991b1b; font-weight: 600;">‚ö†Ô∏è ${patient.alert_count} Active Alert${patient.alert_count > 1 ? 's' : ''}</p>
                        </div>
                        ` : ''}
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button onclick="viewPatientDetails('${patient.username}')" style="flex: 1; padding: 8px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">View Details</button>
                            <button onclick="showReportGenerator('${patient.username}')" style="flex: 1; padding: 8px; background: #06b6d4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Generate Report</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Clinical Report Generator Functions
        function showReportGenerator(username) {
            const reportType = prompt('Select report type:\n1. GP Referral\n2. Progress Notes\n3. Discharge Summary\n\nEnter 1, 2, or 3:');
            
            const types = {
                '1': 'gp_referral',
                '2': 'progress',
                '3': 'discharge'
            };
            
            if (types[reportType]) {
                generateClinicalReport(username, types[reportType]);
            }
        }
        
        async function generateClinicalReport(username, reportType) {
            try {
                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        report_type: reportType,
                        clinician: currentUser
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error generating report: ' + (error.error || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                displayReport(data.report, reportType, username);
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report. Please try again.');
            }
        }
        
        function displayReport(reportText, reportType, username) {
            // Create modal for report display
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            const reportTypeNames = {
                'gp_referral': 'GP Referral Letter',
                'progress': 'Progress Notes',
                'discharge': 'Discharge Summary'
            };
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1f2937;">${reportTypeNames[reportType]}</h2>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">√ó</button>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; color: #1f2937;">
${reportText}
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="copyReportToClipboard(this)" style="flex: 1; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Copy to Clipboard</button>
                        <button onclick="printReport()" style="flex: 1; padding: 12px; background: #06b6d4; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Print</button>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyReportToClipboard(button) {
            const reportContent = button.closest('[style*="background: white"]').querySelector('[style*="white-space: pre-wrap"]').textContent;
            navigator.clipboard.writeText(reportContent).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#8b5cf6';
                }, 2000);
            });
        }
        
        function printReport() {
            window.print();
        }
        
        async function viewPatientDetails(username) {
            try {
                const response = await fetch(`/api/analytics/patient/${username}?_t=${Date.now()}`, {
                    cache: 'no-store',
                    credentials: 'include',
                    headers: { 'Cache-Control': 'no-cache', 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    alert('Failed to load patient details');
                    return;
                }
                
                const data = await response.json();
                displayPatientDetailsModal(username, data);
                
            } catch (error) {
                console.error('Error loading patient details:', error);
                alert('Failed to load patient details');
            }
        }

        async function confirmAttendance(appointmentId, status, patientUsername) {
            if (!confirm(`Confirm marking appointment ${appointmentId} as ${status}?`)) return;
            try {
                const resp = await fetch(`/api/appointments/${appointmentId}/attendance`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ clinician_username: currentUser, status })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showToast('Failed to update attendance: ' + (data.error || JSON.stringify(data)), 'error');
                    return;
                }

                // Inline UI update: update status text and disable buttons for this appointment
                const statusEl = document.getElementById(`apt-status-${appointmentId}`);
                if (statusEl) statusEl.textContent = status;

                // Disable buttons in this appointment card
                const btns = Array.from(document.querySelectorAll(`[onclick*="confirmAttendance(${appointmentId},"]`));
                btns.forEach(b => { b.disabled = true; b.style.opacity = 0.6; b.style.cursor = 'not-allowed'; });

                showToast(data.message || 'Attendance updated', 'success');
            } catch (err) {
                console.error('Attendance update error', err);
                showToast('Error updating attendance', 'error');
            }
        }

        // Toast helper
        function showToast(message, type='info', timeout=4000) {
            try {
                const containerId = 'hs-toast-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.style.cssText = 'position:fixed; right:20px; top:20px; z-index:20000; display:flex; flex-direction:column; gap:10px; max-width:320px;';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.style.cssText = 'padding:10px 14px; border-radius:8px; color:white; box-shadow:0 6px 18px rgba(0,0,0,0.12); font-weight:600;';
                if (type === 'success') toast.style.background = '#10b981';
                else if (type === 'error') toast.style.background = '#ef4444';
                else toast.style.background = '#374151';
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.transition = 'opacity 300ms';
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, timeout);
            } catch (e) {
                console.log('Toast error', e);
            }
        }
        
        function displayPatientDetailsModal(username, data) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000; overflow-y: auto;';
            
            const moodTrend = data.mood_trend || [];
            const assessments = data.assessments || [];
            const activity = data.activity || {};
            const risk = data.risk || {};
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 900px; width: 90%; margin: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1f2937;">Patient Details: ${username}</h2>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">√ó</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white;">
                            <p style="margin: 0; font-size: 13px; opacity: 0.9;">Sessions</p>
                            <h3 style="margin: 5px 0 0 0; font-size: 28px;">${activity.total_sessions || 0}</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white;">
                            <p style="margin: 0; font-size: 13px; opacity: 0.9;">Mood Logs</p>
                            <h3 style="margin: 5px 0 0 0; font-size: 28px;">${activity.mood_logs || 0}</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white;">
                            <p style="margin: 0; font-size: 13px; opacity: 0.9;">Last Active</p>
                            <h3 style="margin: 5px 0 0 0; font-size: 16px;">${activity.last_active || 'Never'}</h3>
                        </div>
                    </div>
                    
                    ${risk.alert_count > 0 ? `
                    <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #991b1b;">‚ö†Ô∏è Active Alerts (${risk.alert_count})</h4>
                        ${risk.alerts ? risk.alerts.map(alert => `
                            <p style="margin: 5px 0; font-size: 13px; color: #7f1d1d;">‚Ä¢ ${alert.message} - ${alert.created_at}</p>
                        `).join('') : ''}
                    </div>
                    ` : ''}
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #1f2937;">Recent Assessment Scores</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${assessments.length > 0 ? assessments.map(assessment => `
                                <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #1f2937;">${assessment.scale_type}</strong>
                                        <span style="margin-left: 10px; color: #6b7280; font-size: 12px;">${assessment.date}</span>
                                    </div>
                                    <span style="background: ${assessment.severity === 'severe' ? '#ef4444' : assessment.severity === 'moderate' ? '#f97316' : assessment.severity === 'mild' ? '#fbbf24' : '#10b981'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        Score: ${assessment.score} (${assessment.severity})
                                    </span>
                                </div>
                            `).join('') : '<p style="color: #6b7280; text-align: center;">No assessments recorded</p>'}
                        </div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h3 style="margin: 0 0 15px 0; color: #1f2937;">Mood Trend (Last 90 Days)</h3>
                        <canvas id="patientMoodChart" style="max-height: 250px;"></canvas>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="showReportGenerator('${username}')" style="flex: 1; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Generate Report</button>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                    
                    <!-- Appointments Section -->
                    <div style="background: #ffffff; padding: 16px; border-radius: 8px; margin-top: 18px; border: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">Upcoming Appointments</h3>
                        ${data.upcoming_appointments && data.upcoming_appointments.length > 0 ? `
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${data.upcoming_appointments.map(a => `
                                    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:6px; background:#f8fafc;">
                                        <div>
                                            <strong>${a.appointment_type}</strong>
                                            <div style="font-size:13px; color:#6b7280;">${a.appointment_date} ‚Äî Clinician: ${a.clinician_username}</div>
                                            ${a.notes ? `<div style="font-size:13px; color:#374151; margin-top:6px;">${a.notes}</div>` : ''}
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:600; color:#374151">Status: ${a.attendance_status || 'scheduled'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<p style="color:#6b7280;">No upcoming appointments</p>`}
                    </div>

                    <div style="background: #ffffff; padding: 16px; border-radius: 8px; margin-top: 12px; border: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">Recent Appointments (past 7 days)</h3>
                        ${data.recent_past_appointments && data.recent_past_appointments.length > 0 ? `
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                ${data.recent_past_appointments.map(a => `
                                    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:6px; background:#f8fafc;">
                                        <div>
                                            <strong>${a.appointment_type}</strong>
                                            <div style="font-size:13px; color:#6b7280;">${a.appointment_date} ‚Äî Clinician: ${a.clinician_username}</div>
                                            ${a.notes ? `<div style="font-size:13px; color:#374151; margin-top:6px;">${a.notes}</div>` : ''}
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:600; color:#374151">Status: <span id="apt-status-${a.id}">${a.attendance_status || 'scheduled'}</span></div>
                                            ${currentUserRole === 'clinician' && currentUser === a.clinician_username ? `
                                                <div style="margin-top:8px; display:flex; gap:6px; justify-content:flex-end;">
                                                    <button onclick="confirmAttendance(${a.id}, 'attended', '${username}')" style="padding:6px 8px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer;">Mark attended</button>
                                                    <button onclick="confirmAttendance(${a.id}, 'no_show', '${username}')" style="padding:6px 8px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer;">Mark no-show</button>
                                                    <button onclick="confirmAttendance(${a.id}, 'missed', '${username}')" style="padding:6px 8px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer;">Mark missed</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<p style="color:#6b7280;">No recent appointments</p>`}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Render mood trend chart in modal
            setTimeout(() => {
                const canvas = document.getElementById('patientMoodChart');
                if (canvas && moodTrend.length > 0) {
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: moodTrend.map(item => item.date),
                            datasets: [{
                                label: 'Mood Score',
                                data: moodTrend.map(item => item.mood),
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10,
                                    title: { display: true, text: 'Mood Score' }
                                },
                                x: {
                                    title: { display: true, text: 'Date' }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }
        
        // Initialize and restore session on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('python-chat-bot Complete Edition initialized');
            
            // Initialize theme and set toggle state
            initializeTheme();
            
            // Ensure authScreen is visible by default
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            
            // Try to restore session (will handle visibility if successful)
            await await restoreSession();
        });
        
        // Debug helper: Call this from browser console to clear all session data
        window.clearAllSessions = function() {
            localStorage.removeItem('healingSpaceSession');
            sessionStorage.removeItem('healingSpaceSession');
            console.log('All session data cleared. Reloading page...');
            location.reload();
        };

        // ========== DEVELOPER DASHBOARD FUNCTIONS ==========

        // Developer Tab Management
        function switchDevTab(subtabName, buttonEl) {
            document.querySelectorAll('.dev-subtab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            document.querySelectorAll('.dev-subtab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById('dev' + subtabName.charAt(0).toUpperCase() + subtabName.slice(1) + 'Tab').style.display = 'block';

            if (buttonEl) {
                buttonEl.classList.add('active');
            }

            if (subtabName === 'messages') {
                loadMessageRecipients();
                loadMessageThread();
            } else if (subtabName === 'feedback') {
                loadFeedback();
            } else if (subtabName === 'stats') {
                loadSystemStats();
            } else if (subtabName === 'users') {
                loadUsersList();
            } else if (subtabName === 'qa') {
                // QA tab - no auto-load needed
            }
        }

        // Terminal Functions
        async function executeTerminalCommand() {
            const inputField = document.getElementById('terminalCommand');
            const command = inputField.value.trim();
            if (!command) return;

            const output = document.getElementById('terminalOutput');
            const timestamp = new Date().toLocaleTimeString();

            // Remove the input field temporarily
            inputField.remove();

            // Add command to output
            output.innerHTML += `<span style="color: #00ff00;">[${timestamp}]</span> $ ${sanitizeHTML(command)}\n`;

            try {
                const response = await fetch('/api/developer/terminal/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        command
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    output.innerHTML += `<span style="color: #ffffff;">${sanitizeHTML(data.output)}</span>\n`;
                    output.innerHTML += `<span style="color: #888;">[Exit: ${data.exit_code}, Time: ${data.duration_ms}ms]</span>\n`;
                } else {
                    output.innerHTML += `<span style="color: #ff0000;">ERROR: ${sanitizeHTML(data.error)}</span>\n`;
                }
            } catch (error) {
                output.innerHTML += `<span style="color: #ff0000;">NETWORK ERROR: ${sanitizeHTML(error.message)}</span>\n`;
            }

            // Recreate input field at the end
            output.innerHTML += `$ <input type="text" id="terminalCommand" placeholder="type command here..."
                style="background: transparent; border: none; outline: none; color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; width: calc(100% - 20px); caret-color: #00ff00;"
                onkeypress="if(event.key==='Enter') executeTerminalCommand()"
                autofocus>`;

            output.scrollTop = output.scrollHeight;
            document.getElementById('terminalCommand').focus();
        }

        function clearTerminal() {
            document.getElementById('terminalOutput').innerHTML = `<span style="color: #00ff00;">‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   python-chat-bot Developer Terminal v1.0 - FULL ACCESS MODE   ‚ïë
‚ïë   Type any command - no restrictions, no sandboxing          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</span>

$ <input type="text" id="terminalCommand" placeholder="type command here..."
    style="background: transparent; border: none; outline: none; color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; width: calc(100% - 20px); caret-color: #00ff00;"
    onkeypress="if(event.key==='Enter') executeTerminalCommand()"
    autofocus>`;
            document.getElementById('terminalCommand').focus();
        }

        // ========== QA TEST RUNNER FUNCTIONS ==========
        let qaRunning = false;

        async function runQATests(scope) {
            if (qaRunning) return;
            qaRunning = true;

            const btns = ['qa-btn-all', 'qa-btn-backend', 'qa-btn-e2e', 'qa-btn-security'];
            btns.forEach(id => { const b = document.getElementById(id); if (b) b.disabled = true; });

            const output = document.getElementById('qaTestOutput');
            const cmdMap = {
                'all': 'python -m pytest tests/ -v --tb=short',
                'backend': 'python -m pytest tests/backend/ -v --tb=short',
                'e2e': 'python -m pytest tests/e2e/ -v --tb=short',
                'security': 'python -m pytest tests/backend/test_auth.py tests/backend/test_security.py tests/backend/test_safety.py -v --tb=short'
            };

            output.innerHTML = `<span style="color: #3498db;">Running ${scope} tests...</span>\n\n`;

            try {
                const resp = await fetch('/api/developer/terminal/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: currentUser,
                        command: cmdMap[scope] || cmdMap['all']
                    })
                });

                const data = await resp.json();

                if (data.error) {
                    output.innerHTML += `<span style="color: #e74c3c;">Error: ${sanitizeHTML(data.error)}</span>`;
                    qaRunning = false;
                    btns.forEach(id => { const b = document.getElementById(id); if (b) b.disabled = false; });
                    return;
                }

                const raw = data.output || '';
                output.innerHTML = colorizeTestOutput(raw);
                parseTestResults(raw);
                document.getElementById('qaLastRun').textContent = 'Last run: ' + new Date().toLocaleTimeString();

            } catch (err) {
                output.innerHTML += `<span style="color: #e74c3c;">Network error: ${sanitizeHTML(err.message)}</span>`;
            }

            qaRunning = false;
            btns.forEach(id => { const b = document.getElementById(id); if (b) b.disabled = false; });
        }

        // Store raw test output for filtering
        let lastRawTestOutput = '';

        function colorizeTestOutput(raw) {
            lastRawTestOutput = raw;
            return raw
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/(PASSED)/g, '<span style="color: #27ae60;">$1</span>')
                .replace(/(FAILED)/g, '<span style="color: #e74c3c; font-weight: bold;">$1</span>')
                .replace(/(SKIPPED)/g, '<span style="color: #f39c12;">$1</span>')
                .replace(/(ERROR)/g, '<span style="color: #e74c3c; font-weight: bold;">$1</span>')
                .replace(/(={3,}.*={3,})/g, '<span style="color: #3498db;">$1</span>')
                .replace(/(_{3,}.*_{3,})/g, '<span style="color: #3498db;">$1</span>');
        }

        function filterQAOutput(type) {
            if (!lastRawTestOutput) {
                if (typeof showToast === 'function') showToast('No test results to filter', 'warning');
                return;
            }

            const lines = lastRawTestOutput.split('\n');
            let filtered = [];

            if (type === 'FAILED') {
                // Get all FAILED test lines and the error details sections
                let inFailureSection = false;
                for (const line of lines) {
                    if (line.includes('FAILED')) {
                        filtered.push(line);
                    }
                    // Capture the FAILURES section with tracebacks
                    if (line.match(/^={3,}\s*FAILURES\s*={3,}/) || line.match(/^={3,}\s*ERRORS\s*={3,}/)) {
                        inFailureSection = true;
                    }
                    if (inFailureSection) {
                        filtered.push(line);
                    }
                    if (inFailureSection && line.match(/^={3,}\s*short test summary/i)) {
                        inFailureSection = false;
                    }
                }
            } else if (type === 'SKIPPED') {
                for (const line of lines) {
                    if (line.includes('SKIPPED') || line.includes('skipped')) {
                        filtered.push(line);
                    }
                }
            }

            if (filtered.length === 0) {
                if (typeof showToast === 'function') showToast('No ' + type.toLowerCase() + ' tests found', 'info');
                return;
            }

            // Add a header and show button to restore full output
            const header = `Showing ${filtered.length} ${type} lines (click "Show All" to restore full output)\n${'='.repeat(70)}\n`;
            const output = document.getElementById('qaTestOutput');
            output.innerHTML = '<span style="color: #3498db; cursor: pointer;" onclick="restoreFullQAOutput()">[ Show All Results ]</span>\n\n' + colorizeFilteredOutput(header + filtered.join('\n'));
        }

        function colorizeFilteredOutput(text) {
            return text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/(PASSED)/g, '<span style="color: #27ae60;">$1</span>')
                .replace(/(FAILED)/g, '<span style="color: #e74c3c; font-weight: bold;">$1</span>')
                .replace(/(SKIPPED)/g, '<span style="color: #f39c12;">$1</span>')
                .replace(/(ERROR)/g, '<span style="color: #e74c3c; font-weight: bold;">$1</span>')
                .replace(/(={3,}.*={3,})/g, '<span style="color: #3498db;">$1</span>')
                .replace(/(_{3,}.*_{3,})/g, '<span style="color: #3498db;">$1</span>');
        }

        function restoreFullQAOutput() {
            if (lastRawTestOutput) {
                document.getElementById('qaTestOutput').innerHTML = colorizeTestOutput(lastRawTestOutput);
            }
        }

        function parseTestResults(raw) {
            // Parse pytest summary line like "X passed, Y failed, Z skipped in Ns"
            const summaryMatch = raw.match(/(\d+)\s+passed/);
            const failMatch = raw.match(/(\d+)\s+failed/);
            const skipMatch = raw.match(/(\d+)\s+skipped/);
            const durationMatch = raw.match(/in\s+([\d.]+)s/);

            const passed = summaryMatch ? parseInt(summaryMatch[1]) : 0;
            const failed = failMatch ? parseInt(failMatch[1]) : 0;
            const skipped = skipMatch ? parseInt(skipMatch[1]) : 0;
            const total = passed + failed + skipped;
            const duration = durationMatch ? durationMatch[1] + 's' : '-';

            document.getElementById('qaTotalTests').textContent = total || '-';
            document.getElementById('qaPassed').textContent = passed || '-';
            document.getElementById('qaFailed').textContent = failed || '-';
            document.getElementById('qaSkipped').textContent = skipped || '-';
            document.getElementById('qaDuration').textContent = duration;

            const pct = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            document.getElementById('qaPassRate').textContent = `Pass rate: ${pct}%`;

            const bar = document.getElementById('qaProgressBar');
            bar.style.width = pct + '%';
            bar.style.background = pct >= 90 ? 'linear-gradient(90deg, #27ae60, #2ecc71)'
                                 : pct >= 70 ? 'linear-gradient(90deg, #f39c12, #e67e22)'
                                 : 'linear-gradient(90deg, #e74c3c, #c0392b)';
        }

        function copyQAOutput() {
            const output = document.getElementById('qaTestOutput').innerText;
            navigator.clipboard.writeText(output).then(() => {
                if (typeof showToast === 'function') {
                    showToast('Test output copied to clipboard', 'success');
                }
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = output;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                if (typeof showToast === 'function') {
                    showToast('Test output copied to clipboard', 'success');
                }
            });
        }

        async function saveQAResults() {
            const output = document.getElementById('qaTestOutput').innerText;
            if (!output || output.includes('Ready to run tests')) {
                if (typeof showToast === 'function') showToast('No test results to save', 'warning');
                return;
            }

            const passed = parseInt(document.getElementById('qaPassed').textContent) || 0;
            const failed = parseInt(document.getElementById('qaFailed').textContent) || 0;
            const errors = (output.match(/ERROR/g) || []).length;
            const btn = document.getElementById('qaSaveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const resp = await fetch('/api/developer/tests/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: currentUser,
                        test_output: output,
                        passed_count: passed,
                        failed_count: failed,
                        error_count: errors,
                        exit_code: failed > 0 ? 1 : 0
                    })
                });
                const data = await resp.json();
                if (resp.ok) {
                    if (typeof showToast === 'function') showToast('Test results saved! Use AI Assistant to analyze.', 'success');
                } else {
                    if (typeof showToast === 'function') showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                if (typeof showToast === 'function') showToast('Save failed: ' + err.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Save for AI';
        }

        function clearQAOutput() {
            document.getElementById('qaTestOutput').innerHTML = 'Ready to run tests. Click a button above to start.';
            document.getElementById('qaTotalTests').textContent = '-';
            document.getElementById('qaPassed').textContent = '-';
            document.getElementById('qaFailed').textContent = '-';
            document.getElementById('qaSkipped').textContent = '-';
            document.getElementById('qaDuration').textContent = '-';
            document.getElementById('qaPassRate').textContent = 'Pass rate: -';
            document.getElementById('qaProgressBar').style.width = '0%';
        }

        // AI Assistant Functions
        function formatDevAIResponse(text) {
            // Escape HTML first for XSS safety, then apply markdown formatting
            let html = escapeHtml(text);
            // Code blocks (triple backtick with optional language)
            html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Headers (###, ##, #)
            html = html.replace(/^### (.+)$/gm, '<strong style="font-size:1em;">$1</strong>');
            html = html.replace(/^## (.+)$/gm, '<strong style="font-size:1.1em;">$1</strong>');
            html = html.replace(/^# (.+)$/gm, '<strong style="font-size:1.2em;">$1</strong>');
            // Bullet points
            html = html.replace(/^- (.+)$/gm, '&bull; $1');
            // Numbered lists
            html = html.replace(/^(\d+)\. (.+)$/gm, '$1. $2');
            // Line breaks (but not inside pre blocks)
            html = html.replace(/\n/g, '<br>');
            // Clean up extra <br> inside pre blocks
            html = html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, function(match, code) {
                return '<pre><code>' + code.replace(/<br>/g, '\n') + '</code></pre>';
            });
            return html;
        }

        function sendDevAIQuickAction(command, message) {
            const input = document.getElementById('devAIInput');
            input.value = message;
            sendDevAIMessage(command);
        }

        async function sendDevAIMessage(command = null) {
            const input = document.getElementById('devAIInput');
            const message = input.value.trim();
            if (!message && !command) return;

            const container = document.getElementById('devAIChatMessages');
            const sendBtn = document.getElementById('devAISendBtn');

            // Clear welcome screen on first message
            const welcome = container.querySelector('.dev-ai-welcome');
            if (welcome) welcome.remove();

            // Show user message bubble
            const userMsg = message || '(Quick action)';
            const now = new Date();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'dev-ai-msg user';
            msgDiv.innerHTML = escapeHtml(userMsg) + '<div class="msg-timestamp">' + formatTimestamp(now.toISOString()) + '</div>';
            container.appendChild(msgDiv);

            input.value = '';
            sendBtn.disabled = true;
            container.scrollTop = container.scrollHeight;

            // Show thinking animation
            const thinkingId = 'dev-thinking-' + Date.now();
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'dev-ai-msg assistant';
            thinkingDiv.id = thinkingId;
            thinkingDiv.innerHTML = '<div class="ai-thinking"><div class="thinking-dots"><span></span><span></span><span></span></div><span>Thinking...</span></div>';
            container.appendChild(thinkingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const body = { username: currentUser, message: userMsg };
                if (command) body.command = command;

                const response = await fetch('/api/developer/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                // Remove thinking bubble
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) thinkingEl.remove();

                if (response.ok) {
                    const formatted = formatDevAIResponse(data.response);
                    const aiDiv = document.createElement('div');
                    aiDiv.className = 'dev-ai-msg assistant';
                    aiDiv.innerHTML = formatted + '<div class="msg-timestamp">' + formatTimestamp(new Date().toISOString()) + '</div>';
                    container.appendChild(aiDiv);
                } else {
                    const errDiv = document.createElement('div');
                    errDiv.className = 'dev-ai-msg assistant';
                    errDiv.style.borderColor = '#e53935';
                    errDiv.innerHTML = '<strong>Error:</strong> ' + escapeHtml(data.error || 'Unknown error');
                    container.appendChild(errDiv);
                }
            } catch (error) {
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) thinkingEl.remove();
                const errDiv = document.createElement('div');
                errDiv.className = 'dev-ai-msg assistant';
                errDiv.style.borderColor = '#e53935';
                errDiv.innerHTML = '<strong>Network Error:</strong> ' + escapeHtml(error.message);
                container.appendChild(errDiv);
            }

            sendBtn.disabled = false;
            container.scrollTop = container.scrollHeight;
        }

        function clearDevAIChat() {
            document.getElementById('devAIChatMessages').innerHTML = `
                <div class="dev-ai-welcome">
                    <div style="font-size: 48px;">&#129302;</div>
                    <div class="dev-ai-welcome-title">Developer AI Assistant</div>
                    <div class="dev-ai-welcome-subtitle">Ask about the codebase, debug issues, analyze tests, or get architecture advice.</div>
                </div>
            `;
        }

        // Messaging Functions
        async function loadMessageRecipients() {
            try {
                const select = document.getElementById('messageRecipient');
                if (!select) {
                    console.error('messageRecipient select element not found');
                    return;
                }

                const response = await fetch(`/api/developer/users/list?username=${currentUser}&role=all`);
                if (!response.ok) {
                    console.error('Failed to fetch users:', response.statusText);
                    return;
                }

                const data = await response.json();

                // Clear and rebuild options
                select.innerHTML = `
                    <option value="ALL">üîî Broadcast to All Users</option>
                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                `;

                // Add individual users
                if (data.users && Array.isArray(data.users)) {
                    data.users.forEach(user => {
                        if (user.role !== 'developer') {
                            const option = document.createElement('option');
                            option.value = user.username;
                            option.textContent = `${user.username} (${user.role})`;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load recipients:', error);
            }
        }

        async function sendDevMessage() {
            const recipient = document.getElementById('messageRecipient').value;
            const type = document.getElementById('messageType').value;
            const content = document.getElementById('messageContent').value.trim();

            // Validate recipient
            if (!recipient || recipient === '') {
                alert('Please select a recipient');
                return;
            }

            // Validate content
            if (!content) {
                alert('Please enter a message');
                return;
            }

            try {
                const response = await fetch('/api/developer/messages/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_username: currentUser,
                        to_username: recipient,
                        message: content,
                        message_type: type
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Message sent to ${recipient === 'ALL' ? 'all users' : recipient}!`);
                    document.getElementById('messageContent').value = '';
                    loadMessageThread();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        async function loadMessageThread() {
            try {
                const response = await fetch(`/api/developer/messages/list?username=${currentUser}`);
                const data = await response.json();

                const thread = document.getElementById('messageThread');

                if (data.messages.length === 0) {
                    thread.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No messages yet</p>';
                    return;
                }

                thread.innerHTML = data.messages.map(msg => {
                    const isFromDev = msg.from_username === currentUser;
                    const icon = msg.message_type === 'warning' ? '‚ö†Ô∏è' :
                                msg.message_type === 'alert' ? 'üö®' :
                                msg.message_type === 'system' ? '‚öôÔ∏è' : '‚ÑπÔ∏è';

                    return `
                        <div style="background: ${isFromDev ? '#e8f4fd' : '#f8f9fa'}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${isFromDev ? '#2196F3' : '#667eea'};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong>${icon} ${sanitizeHTML(msg.from_username)} ‚Üí ${sanitizeHTML(msg.to_username)}</strong>
                                <span style="color: #999; font-size: 12px;">${new Date(msg.created_at).toLocaleString()}</span>
                            </div>
                            <div>${sanitizeWithLineBreaks(msg.message)}</div>
                            ${!isFromDev ? `<button onclick="replyToMessage(${msg.id})" style="margin-top: 8px; padding: 5px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Reply</button>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function replyToMessage(messageId) {
            const reply = prompt('Enter your reply:');
            if (!reply) return;

            fetch('/api/developer/messages/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    from_username: currentUser,
                    parent_message_id: messageId,
                    message: reply
                })
            }).then(response => {
                if (response.ok) {
                    alert('Reply sent!');
                    loadMessageThread();
                } else {
                    alert('Failed to send reply');
                }
            });
        }

        // System Stats Functions
        async function loadSystemStats() {
            try {
                const response = await fetch(`/api/developer/stats?username=${currentUser}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('statTotalUsers').textContent = data.total_users;
                    document.getElementById('statTotalPatients').textContent = data.total_patients;
                    document.getElementById('statTotalClinicians').textContent = data.total_clinicians;
                    document.getElementById('statTotalChats').textContent = data.total_chats;
                    document.getElementById('statTotalMoodLogs').textContent = data.total_mood_logs;
                    document.getElementById('statDbSize').textContent = data.database_size_mb + ' MB';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // User Management Functions
        async function loadUsersList() {
            searchUsers();
        }

        async function searchUsers() {
            const search = document.getElementById('userSearchInput').value;
            const role = document.getElementById('userRoleFilter').value;

            try {
                const response = await fetch(`/api/developer/users/list?username=${currentUser}&role=${role}&search=${search}`);
                const data = await response.json();

                const list = document.getElementById('usersList');

                if (data.users.length === 0) {
                    list.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">No users found</p>';
                    return;
                }

                list.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                                <th style="padding: 12px; text-align: left;">Username</th>
                                <th style="padding: 12px; text-align: left;">Role</th>
                                <th style="padding: 12px; text-align: left;">Last Login</th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.users.map(user => `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 12px;">${user.username}</td>
                                    <td style="padding: 12px;">
                                        <span style="background: ${user.role === 'clinician' ? '#e8f4fd' : '#f0f4ff'}; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                            ${user.role}
                                        </span>
                                    </td>
                                    <td style="padding: 12px; color: #666; font-size: 13px;">${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        ${user.role !== 'developer' ?
                                            `<button onclick="deleteUserAccount('${user.username}')"
                                                style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                üóëÔ∏è Delete
                                            </button>`
                                            : '<span style="color: #999; font-size: 12px;">Protected</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersList').innerHTML = '<p style="color: #e74c3c; padding: 20px;">Error loading users</p>';
            }
        }

        async function deleteUserAccount(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis will permanently delete:\n‚Ä¢ User account\n‚Ä¢ All chats and mood logs\n‚Ä¢ All assessments and exercises\n‚Ä¢ All personal data\n\nThis action CANNOT be undone!`)) {
                return;
            }

            try {
                const response = await fetch('/api/developer/users/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        target_username: username
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ User "${username}" has been deleted successfully.`);
                    searchUsers(); // Refresh the list
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Failed to delete user:', error);
                alert('‚ùå Failed to delete user. Please try again.');
            }
        }

        // Feedback Functions
        async function loadFeedback() {
            try {
                const container = document.getElementById('feedbackContainer');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Loading feedback...</p>';

                const response = await fetch('/api/feedback/all', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.status === 403) {
                    container.innerHTML = '<p style="color: #e74c3c; padding: 20px;">‚ùå You do not have permission to view feedback.</p>';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load feedback');
                }

                const data = await response.json();

                if (!data.feedback || data.feedback.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">üì≠ No feedback submissions yet</p>';
                    return;
                }

                // Organize feedback by category and status
                const organized = {};
                const categoryOrder = ['bug', 'feature', 'improvement', 'other'];
                const statusOrder = ['pending', 'in_progress', 'resolved', 'wont_fix', 'duplicate'];

                categoryOrder.forEach(cat => {
                    organized[cat] = {};
                    statusOrder.forEach(stat => {
                        organized[cat][stat] = [];
                    });
                });

                // Sort feedback into organized structure
                data.feedback.forEach(item => {
                    const cat = item.category.toLowerCase();
                    const stat = (item.status || 'pending').toLowerCase();
                    if (organized[cat] && organized[cat][stat] !== undefined) {
                        organized[cat][stat].push(item);
                    }
                });

                // Build HTML with organized feedback
                let html = '';
                categoryOrder.forEach(category => {
                    const items = organized[category];
                    const totalInCategory = Object.values(items).reduce((sum, arr) => sum + arr.length, 0);
                    
                    if (totalInCategory === 0) return;

                    html += `<div style="margin-bottom: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid ${getCategoryColor(category)};">
                            ${getCategoryEmoji(category)} ${category.toUpperCase()} (${totalInCategory} total)
                        </h4>`;

                    statusOrder.forEach(status => {
                        const statusItems = items[status];
                        if (statusItems.length === 0) return;

                        html += `<div style="margin-left: 20px; margin-bottom: 20px;">
                            <div style="color: #666; font-size: 12px; font-weight: bold; margin-bottom: 10px;">
                                ${getStatusEmoji(status)} ${status.replace(/_/g, ' ').toUpperCase()} (${statusItems.length})
                            </div>`;

                        statusItems.forEach(item => {
                            html += `
                                <div style="border-left: 4px solid ${getCategoryColor(item.category)}; padding: 12px; margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.2s;" 
                                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateX(4px)'" 
                                     onmouseout="this.style.boxShadow=''; this.style.transform='translateX(0)'"
                                     onclick="viewFeedbackDetail(${item.id}, '${item.category}', '${item.status}', \`${item.message.replace(/`/g, '\\`')}\`, '${item.username}', '${item.user_role}', '${new Date(item.created_at).toLocaleString()}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                        <strong style="color: #333; font-size: 14px;">${item.category}</strong>
                                        <span style="background: ${getStatusColor(item.status)}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                            ${item.status}
                                        </span>
                                    </div>
                                    <div style="color: #666; font-size: 11px; margin-bottom: 6px;">
                                        üë§ ${item.username} (${item.user_role}) ‚Ä¢ ${new Date(item.created_at).toLocaleString()}
                                    </div>
                                    <div style="color: #555; font-size: 13px; line-height: 1.5;">
                                        ${item.message.substring(0, 100)}${item.message.length > 100 ? '...' : ''}
                                    </div>
                                    <div style="color: #999; font-size: 11px; margin-top: 6px;">
                                        Click to update status
                                    </div>
                                </div>
                            `;
                        });

                        html += `</div>`;
                    });

                    html += `</div>`;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackContainer').innerHTML = `<p style="color: #e74c3c; padding: 20px;">‚ùå Error: ${sanitizeHTML(error.message)}</p>`;
            }
        }

        function viewFeedbackDetail(id, category, status, message, username, role, createdAt) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'feedbackDetailModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.6); display: flex; align-items: center; 
                justify-content: center; z-index: 10000;
            `;

            const validStatuses = ['pending', 'in_progress', 'resolved', 'wont_fix', 'duplicate'];

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">Feedback Details</h3>
                        <button onclick="document.getElementById('feedbackDetailModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
                    </div>

                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 4px;">CATEGORY</div>
                                <div style="color: #333; font-size: 14px;">${getCategoryEmoji(category)} ${category.toUpperCase()}</div>
                            </div>
                            <div>
                                <div style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 4px;">STATUS</div>
                                <div style="color: #333; font-size: 14px;">${getStatusEmoji(status)} ${status.replace(/_/g, ' ').toUpperCase()}</div>
                            </div>
                        </div>
                        <div>
                            <div style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 4px;">SUBMITTED BY</div>
                            <div style="color: #333; font-size: 14px;">üë§ ${username} (${role}) ‚Ä¢ ${createdAt}</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 8px;">MESSAGE</div>
                        <div style="color: #555; font-size: 14px; line-height: 1.6;">${message}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #999; font-size: 12px; font-weight: bold; margin-bottom: 8px;">UPDATE STATUS</label>
                        <select id="feedbackStatusSelect" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            ${validStatuses.map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${getStatusEmoji(s)} ${s.replace(/_/g, ' ').toUpperCase()}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #999; font-size: 12px; font-weight: bold; margin-bottom: 8px;">ADMIN NOTES (optional)</label>
                        <textarea id="feedbackNotesTextarea" placeholder="Add notes about this feedback..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 80px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="document.getElementById('feedbackDetailModal').remove()" style="padding: 10px 20px; background: #e0e0e0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">Cancel</button>
                        <button onclick="submitFeedbackUpdate(${id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">‚úÖ Update Feedback</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function submitFeedbackUpdate(feedbackId) {
            const newStatus = document.getElementById('feedbackStatusSelect').value;
            const adminNotes = document.getElementById('feedbackNotesTextarea').value.trim();

            try {
                const response = await fetch(`/api/feedback/${feedbackId}/status`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        admin_notes: adminNotes
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Feedback updated to ${newStatus.replace(/_/g, ' ').toUpperCase()}`);
                    document.getElementById('feedbackDetailModal').remove();
                    loadFeedback(); // Reload the list
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Network error: ${error.message}`);
            }
        }

        function filterFeedback() {
            const categoryFilter = document.getElementById('feedbackCategoryFilter').value;
            const statusFilter = document.getElementById('feedbackStatusFilter').value;

            const feedbackItems = document.querySelectorAll('#feedbackContainer > div');
            feedbackItems.forEach(item => {
                const category = item.innerText.split('\n')[0].toLowerCase();
                const status = item.innerText.split('\n')[1].toLowerCase();

                const categoryMatch = !categoryFilter || category.includes(categoryFilter);
                const statusMatch = !statusFilter || status.includes(statusFilter);

                item.style.display = (categoryMatch && statusMatch) ? 'block' : 'none';
            });
        }

        function getCategoryColor(category) {
            const colors = {
                'bug': '#e74c3c',
                'feature': '#3498db',
                'improvement': '#f39c12',
                'ui': '#9b59b6',
                'performance': '#e67e22',
                'other': '#95a5a6'
            };
            return colors[category] || '#95a5a6';
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'bug': 'üêõ',
                'feature': '‚ú®',
                'improvement': 'üìà',
                'ui': 'üé®',
                'performance': '‚ö°',
                'other': 'üìù'
            };
            return emojis[category] || 'üìù';
        }

        function getStatusColor(status) {
            const colors = {
                'new': '#3498db',
                'reviewed': '#f39c12',
                'in_progress': '#e67e22',
                'resolved': '#27ae60',
                'wontfix': '#e74c3c'
            };
            return colors[status] || '#95a5a6';
        }

        function getStatusEmoji(status) {
            const emojis = {
                'new': 'üÜï',
                'reviewed': 'üëÄ',
                'in_progress': '‚öôÔ∏è',
                'resolved': '‚úÖ',
                'wontfix': '‚ùå'
            };
            return emojis[status] || 'üìù';
        }

        // ========== END DEVELOPER DASHBOARD FUNCTIONS ==========

        // ========== MESSAGING SYSTEM (Complete Overhaul) ==========
        const messageTabCache = {
            inbox: null,
            sent: null,
            lastLoadTime: {}
        };

        // --- Helper: Get avatar class from role ---
        function getMsgAvatarClass(role) {
            if (!role) return 'default';
            const r = role.toLowerCase();
            if (r === 'patient' || r === 'user') return 'patient';
            if (r === 'clinician' || r === 'therapist') return 'clinician';
            if (r === 'developer' || r === 'admin') return 'developer';
            return 'default';
        }
        function getMsgInitial(username) {
            return username ? username.charAt(0).toUpperCase() : '?';
        }
        function formatMsgTime(timestamp) {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            const now = new Date();
            const diffMs = now - d;
            if (diffMs < 60000) return 'Just now';
            if (diffMs < 3600000) return Math.floor(diffMs/60000) + 'm ago';
            if (diffMs < 86400000) return Math.floor(diffMs/3600000) + 'h ago';
            if (diffMs < 604800000) return d.toLocaleDateString(undefined, {weekday:'short'});
            return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
        }

        // --- Render Inbox ---
        function renderInbox(data) {
            const container = document.getElementById('messagesInboxContainer');
            if (!container) return;
            if (!data || !data.conversations || data.conversations.length === 0) {
                container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">üì≠</div><p>No messages yet</p><p style="font-size:13px;margin-top:8px;">Click <strong>Compose</strong> to start a conversation</p></div>';
                return;
            }
            container.innerHTML = data.conversations.map(function(conv) {
                const avatarClass = getMsgAvatarClass(conv.with_role);
                const initial = getMsgInitial(conv.with_user);
                const escapedUser = sanitizeHTML(conv.with_user || 'Unknown');
                return '<div class="msg-card' + (conv.unread_count > 0 ? ' unread' : '') + '" onclick="openConversation(\'' + escapedUser + '\')">' +
                    '<div class="msg-avatar ' + avatarClass + '">' + initial + '</div>' +
                    '<div class="msg-content">' +
                        '<div class="msg-header">' +
                            '<span class="msg-sender">' + escapedUser + '</span>' +
                            '<span class="msg-time">' + formatMsgTime(conv.last_message_time) + '</span>' +
                        '</div>' +
                        '<div class="msg-preview">' +
                            (conv.last_message ? sanitizeHTML(conv.last_message.substring(0, 100)) : 'No messages') +
                            (conv.unread_count > 0 ? '<span class="msg-unread-badge">' + conv.unread_count + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            updateUnreadBadge(data);
        }

        // --- Render Sent ---
        function renderSent(data) {
            const container = document.getElementById('messagesSentContainer');
            if (!container) return;
            if (!data || !data.messages || data.messages.length === 0) {
                container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">üì§</div><p>No sent messages</p></div>';
                return;
            }
            container.innerHTML = data.messages.map(function(msg) {
                const initial = getMsgInitial(msg.recipient);
                return '<div class="msg-card" onclick="openConversation(\'' + sanitizeHTML(msg.recipient) + '\')">' +
                    '<div class="msg-avatar default">' + initial + '</div>' +
                    '<div class="msg-content">' +
                        '<div class="msg-header">' +
                            '<span class="msg-sender">To: ' + sanitizeHTML(msg.recipient) + '</span>' +
                            '<span class="msg-time">' + formatMsgTime(msg.sent_at) + '</span>' +
                        '</div>' +
                        (msg.subject ? '<div style="font-size:12px;font-weight:600;color:var(--text-secondary,#555);margin-bottom:2px;">' + sanitizeHTML(msg.subject) + '</div>' : '') +
                        '<div class="msg-preview">' + sanitizeHTML((msg.content || '').substring(0, 120)) + '</div>' +
                        '<div class="msg-status ' + (msg.is_read ? 'read' : 'sent') + '">' + (msg.is_read ? '‚úì‚úì Read' : '‚úì Sent') + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // --- Tab Switching ---
        function switchMessageTab(tabName, buttonEl) {
            try {
                document.querySelectorAll('.message-subtab-content').forEach(function(t) { t.style.display = 'none'; });
                document.querySelectorAll('.msg-tab-btn').forEach(function(b) { b.classList.remove('active'); });

                var capitalizedTab = tabName === 'newmessage' ? 'New' : tabName.charAt(0).toUpperCase() + tabName.slice(1);
                var tab = document.getElementById('messages' + capitalizedTab + 'TabPatient') || document.getElementById('messages' + capitalizedTab + 'Tab');
                if (tab) {
                    tab.style.display = 'block';
                    if (buttonEl) buttonEl.classList.add('active');

                    var now = Date.now();
                    var age = messageTabCache.lastLoadTime[tabName] ? now - messageTabCache.lastLoadTime[tabName] : Infinity;
                    var CACHE_TTL = 30000;

                    if (tabName === 'inbox') {
                        if (!messageTabCache.inbox || age > CACHE_TTL) { loadMessagesInbox(); } else { renderInbox(messageTabCache.inbox); }
                    } else if (tabName === 'sent') {
                        if (!messageTabCache.sent || age > CACHE_TTL) { loadMessagesSent(); } else { renderSent(messageTabCache.sent); }
                    }
                }
            } catch (e) { console.error('[switchMessageTab]', e); }
        }

        // --- Load Inbox ---
        async function loadMessagesInbox() {
            var container = document.getElementById('messagesInboxContainer');
            if (!container) return;
            container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">‚è≥</div><p>Loading messages...</p></div>';
            try {
                var response = await fetch('/api/messages/inbox', { method: 'GET', credentials: 'include' });
                if (response.status === 401) { container.innerHTML = '<div class="msg-empty"><p>Session expired. Please log in again.</p></div>'; return; }
                if (!response.ok) throw new Error('Failed to load inbox');
                var data = await response.json();
                messageTabCache.inbox = data;
                messageTabCache.lastLoadTime.inbox = Date.now();
                renderInbox(data);
            } catch (e) {
                console.error('[loadMessagesInbox]', e);
                container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">‚ö†Ô∏è</div><p>Error loading messages: ' + sanitizeHTML(e.message) + '</p></div>';
            }
        }

        // --- Load Sent ---
        async function loadMessagesSent() {
            var container = document.getElementById('messagesSentContainer');
            if (!container) return;
            container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">‚è≥</div><p>Loading sent messages...</p></div>';
            try {
                var response = await fetch('/api/messages/sent', { method: 'GET', credentials: 'include' });
                if (response.status === 401) { container.innerHTML = '<div class="msg-empty"><p>Session expired.</p></div>'; return; }
                if (!response.ok) throw new Error('Failed to load sent messages');
                var data = await response.json();
                messageTabCache.sent = data;
                messageTabCache.lastLoadTime.sent = Date.now();
                renderSent(data);
            } catch (e) {
                console.error('[loadMessagesSent]', e);
                container.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">‚ö†Ô∏è</div><p>Error: ' + sanitizeHTML(e.message) + '</p></div>';
            }
        }

        // --- Message Search (debounced) ---
        let _msgSearchTimer = null;
        function debounceMessageSearch(query) {
            clearTimeout(_msgSearchTimer);
            _msgSearchTimer = setTimeout(function() { performMessageSearch(query); }, 400);
        }
        async function performMessageSearch(query) {
            if (!query || query.length < 2) { renderInbox(messageTabCache.inbox); return; }
            try {
                var response = await fetch('/api/messages/search?q=' + encodeURIComponent(query), { credentials: 'include' });
                if (!response.ok) return;
                var data = await response.json();
                var container = document.getElementById('messagesInboxContainer');
                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<div class="msg-empty"><p>No results for "' + sanitizeHTML(query) + '"</p></div>';
                    return;
                }
                container.innerHTML = data.results.map(function(msg) {
                    var isOwn = msg.sender === currentUser;
                    var otherUser = isOwn ? msg.recipient : msg.sender;
                    return '<div class="msg-card" onclick="openConversation(\'' + sanitizeHTML(otherUser) + '\')">' +
                        '<div class="msg-avatar default">' + getMsgInitial(otherUser) + '</div>' +
                        '<div class="msg-content">' +
                            '<div class="msg-header"><span class="msg-sender">' + sanitizeHTML(otherUser) + '</span><span class="msg-time">' + formatMsgTime(msg.sent_at) + '</span></div>' +
                            '<div class="msg-preview">' + sanitizeHTML((msg.content || '').substring(0, 120)) + '</div>' +
                        '</div></div>';
                }).join('');
            } catch (e) { console.error('[search]', e); }
        }

        // --- Recipient Autocomplete ---
        let _recipientTimer = null;
        async function searchRecipients(query) {
            var dropdown = document.getElementById('recipientDropdown');
            if (!dropdown) return;
            if (!query || query.length < 2) { dropdown.style.display = 'none'; return; }
            clearTimeout(_recipientTimer);
            _recipientTimer = setTimeout(async function() {
                try {
                    var response = await fetch('/api/messages/recipients/search?q=' + encodeURIComponent(query), { credentials: 'include' });
                    if (!response.ok) { dropdown.style.display = 'none'; return; }
                    var data = await response.json();
                    var users = data.users || data.results || [];
                    if (users.length === 0) { dropdown.style.display = 'none'; return; }
                    dropdown.innerHTML = users.map(function(u) {
                        var uname = u.username || u;
                        var role = u.role || '';
                        var avatarClass = getMsgAvatarClass(role);
                        return '<div class="msg-recipient-item" onclick="selectRecipient(\'' + sanitizeHTML(uname) + '\')">' +
                            '<div class="msg-avatar ' + avatarClass + '" style="width:30px;height:30px;font-size:13px;">' + getMsgInitial(uname) + '</div>' +
                            '<span>' + sanitizeHTML(uname) + '</span>' +
                            (role ? '<span class="msg-role-badge ' + avatarClass + '">' + sanitizeHTML(role) + '</span>' : '') +
                        '</div>';
                    }).join('');
                    dropdown.style.display = 'block';
                } catch (e) { dropdown.style.display = 'none'; }
            }, 300);
        }
        function selectRecipient(username) {
            document.getElementById('messageRecipientPatient').value = username;
            var dropdown = document.getElementById('recipientDropdown');
            if (dropdown) dropdown.style.display = 'none';
        }
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#messageRecipientPatient') && !e.target.closest('#recipientDropdown')) {
                var dd = document.getElementById('recipientDropdown');
                if (dd) dd.style.display = 'none';
            }
        });

        // --- Compose Character Counter ---
        function updateComposeCharCount() {
            var el = document.getElementById('composeCharCount');
            var textarea = document.getElementById('messageContentPatient');
            if (!el || !textarea) return;
            var len = textarea.value.length;
            el.textContent = len.toLocaleString() + ' / 10,000';
            el.className = 'msg-char-count' + (len > 9500 ? ' danger' : len > 8000 ? ' warning' : '');
        }

        // --- Quick Action Templates ---
        function prefillMessageTemplate(type) {
            switchMessageTab('newmessage', document.querySelectorAll('.msg-tab-btn')[2]);
            var recipientEl = document.getElementById('messageRecipientPatient');
            var subjectEl = document.getElementById('messageSubjectPatient');
            var contentEl = document.getElementById('messageContentPatient');
            var templates = {
                appointment: { recipient: '', subject: 'Appointment Request', content: 'Hi,\n\nI would like to request an appointment. Please could you let me know your available times?\n\nPreferred days: \nPreferred time: \n\nThank you.' },
                checkin: { recipient: '', subject: 'Check-in', content: 'Hi,\n\nJust checking in to let you know how I\'ve been doing.\n\n' },
                enquiry: { recipient: '', subject: 'General Enquiry', content: 'Hi,\n\nI have a question about: \n\n' },
                dev: { recipient: 'dev', subject: 'Feedback / Issue Report', content: 'Hi Development Team,\n\nI wanted to report the following:\n\nType: [Bug / Feature Request / Feedback]\nDetails: \n\nThank you.' }
            };
            var t = templates[type];
            if (t) {
                if (t.recipient) recipientEl.value = t.recipient;
                subjectEl.value = t.subject;
                contentEl.value = t.content;
                updateComposeCharCount();
                recipientEl.focus();
            }
        }

        // --- Send New Message ---
        async function sendNewMessage() {
            var recipientEl = document.getElementById('messageRecipientPatient') || document.getElementById('messageRecipient');
            var subjectEl = document.getElementById('messageSubjectPatient') || document.getElementById('messageSubject');
            var contentEl = document.getElementById('messageContentPatient') || document.getElementById('messageContent');
            var statusEl = document.getElementById('messageSendStatusPatient') || document.getElementById('messageSendStatus');
            var sendBtn = document.getElementById('composeSendBtn');

            var recipient = recipientEl.value.trim();
            var subject = subjectEl.value.trim();
            var content = contentEl.value.trim();

            if (!recipient) { showMsgStatus(statusEl, 'Please enter a recipient', 'warning'); return; }
            if (!content) { showMsgStatus(statusEl, 'Please enter a message', 'warning'); return; }
            if (content.length > 10000) { showMsgStatus(statusEl, 'Message exceeds 10,000 characters', 'warning'); return; }

            try {
                showMsgStatus(statusEl, 'Sending...', 'info');
                if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Sending...'; }

                var response = await fetch('/api/messages/send', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: recipient, subject: subject, content: content })
                });

                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send Message'; }
                if (!response.ok) {
                    var errorData = await response.json().catch(function() { return {}; });
                    throw new Error(errorData.error || 'Failed to send message');
                }
                showMsgStatus(statusEl, 'Message sent!', 'success');
                recipientEl.value = '';
                subjectEl.value = '';
                contentEl.value = '';
                updateComposeCharCount();
                messageTabCache.inbox = null;
                messageTabCache.sent = null;
                showToast('Message sent successfully', 'success');
                setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
            } catch (e) {
                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send Message'; }
                showMsgStatus(statusEl, e.message, 'error');
                console.error('[sendNewMessage]', e);
            }
        }
        function showMsgStatus(el, msg, type) {
            if (!el) return;
            el.textContent = msg;
            el.style.color = type === 'success' ? '#27ae60' : type === 'warning' ? '#e67e22' : type === 'info' ? '#667eea' : '#e74c3c';
            el.style.display = 'block';
        }

        // --- Open Conversation Modal ---
        async function openConversation(withUser) {
            try {
                document.getElementById('conversationWith').textContent = withUser;
                document.getElementById('convAvatar').textContent = getMsgInitial(withUser);
                document.getElementById('replyContent').value = '';
                document.getElementById('conversationModal').style.display = 'block';
                var messagesEl = document.getElementById('conversationMessages');
                messagesEl.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">‚è≥</div><p>Loading...</p></div>';

                var response = await fetch('/api/messages/conversation/' + encodeURIComponent(withUser), { method: 'GET', credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load conversation');
                var data = await response.json();
                var messages = data.messages || [];

                if (messages.length === 0) {
                    messagesEl.innerHTML = '<div class="msg-empty"><div class="msg-empty-icon">üí¨</div><p>No messages yet. Send the first one!</p></div>';
                    return;
                }

                // Mark unread messages as read
                for (var i = 0; i < messages.length; i++) {
                    var msg = messages[i];
                    if (!msg.is_read && msg.recipient_username === currentUser) {
                        fetch('/api/messages/' + msg.id + '/read', { method: 'PATCH', credentials: 'include' }).catch(function(){});
                    }
                }

                // Render conversation bubbles
                var html = '';
                messages.forEach(function(msg) {
                    var isOwn = msg.sender === currentUser || msg.sender_username === currentUser;
                    var senderName = msg.sender || msg.sender_username || 'Unknown';
                    var timeStr = msg.sent_at ? new Date(msg.sent_at).toLocaleString() : '';
                    html += '<div class="conv-bubble ' + (isOwn ? 'own' : 'other') + '">' +
                        '<div class="conv-bubble-inner">' + sanitizeWithLineBreaks(msg.content || '') + '</div>' +
                        '<div class="conv-bubble-meta">' + sanitizeHTML(senderName) + ' &middot; ' + timeStr +
                            (isOwn && msg.is_read ? ' &middot; <span class="msg-status read">Read</span>' : '') +
                        '</div>' +
                    '</div>';
                });
                messagesEl.innerHTML = html;
                messagesEl.scrollTop = messagesEl.scrollHeight;

                // Invalidate inbox cache to refresh unread counts
                messageTabCache.inbox = null;
                updateUnreadBadge(null);
            } catch (e) {
                console.error('[openConversation]', e);
                document.getElementById('conversationMessages').innerHTML = '<div class="msg-empty"><p>Error: ' + sanitizeHTML(e.message) + '</p></div>';
            }
        }

        function closeConversationModal() {
            document.getElementById('conversationModal').style.display = 'none';
            // Refresh inbox to update unread counts
            if (!messageTabCache.inbox) loadMessagesInbox();
        }

        // --- Send Reply in Conversation ---
        async function sendReply() {
            var withUser = document.getElementById('conversationWith').textContent;
            var contentEl = document.getElementById('replyContent');
            var content = contentEl.value.trim();
            var sendBtn = document.getElementById('replySendBtn');
            if (!content) return;

            try {
                if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Sending...'; }
                var response = await fetch('/api/messages/send', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: withUser, content: content })
                });
                if (!response.ok) {
                    var errorData = await response.json().catch(function() { return {}; });
                    throw new Error(errorData.error || 'Failed to send');
                }
                contentEl.value = '';
                contentEl.style.height = 'auto';
                messageTabCache.inbox = null;
                messageTabCache.sent = null;
                await openConversation(withUser);
            } catch (e) {
                showToast('Failed to send: ' + e.message, 'error');
                console.error('[sendReply]', e);
            } finally {
                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send'; }
            }
        }

        // --- Delete Conversation ---
        async function deleteConversation() {
            var withUser = document.getElementById('conversationWith').textContent;
            if (!confirm('Delete this conversation with ' + withUser + '?')) return;
            // Get all messages in conversation and delete them
            try {
                var response = await fetch('/api/messages/conversation/' + encodeURIComponent(withUser), { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load conversation');
                var data = await response.json();
                var messages = data.messages || [];
                for (var i = 0; i < messages.length; i++) {
                    await fetch('/api/messages/' + messages[i].id, { method: 'DELETE', credentials: 'include' });
                }
                showToast('Conversation deleted', 'success');
                closeConversationModal();
                messageTabCache.inbox = null;
                loadMessagesInbox();
            } catch (e) {
                showToast('Error deleting conversation', 'error');
            }
        }

        // --- Unread Badge ---
        function updateUnreadBadge(data) {
            var badge = document.getElementById('inboxUnreadBadge');
            var navBadge = document.getElementById('messagesBadge');
            var total = 0;
            if (data && data.conversations) {
                data.conversations.forEach(function(c) { total += (c.unread_count || 0); });
            }
            if (badge) {
                if (total > 0) { badge.textContent = total; badge.style.display = 'inline'; }
                else { badge.style.display = 'none'; }
            }
            if (navBadge) {
                if (total > 0) { navBadge.textContent = total; navBadge.style.display = 'inline'; }
                else { navBadge.style.display = 'none'; }
            }
        }

        // --- Periodic unread check (every 60s) ---
        setInterval(function() {
            if (document.visibilityState === 'visible' && currentUser) {
                fetch('/api/messages/inbox', { credentials: 'include' })
                    .then(function(r) { return r.ok ? r.json() : null; })
                    .then(function(data) { if (data) updateUnreadBadge(data); })
                    .catch(function(){});
            }
        }, 60000);

        // --- Load messages when switching to messages tab ---
        function checkAndLoadMessages() {
            loadMessagesInbox();
        }
        function loadUserMessages() { loadMessagesInbox(); }

        // Legacy function stubs for compatibility
        function renderInboxFromCache() { renderInbox(messageTabCache.inbox); }
        function renderSentFromCache() { renderSent(messageTabCache.sent); }
        // (legacy autocomplete removed - now using searchRecipients above)
        
        async function sendClinicianMessage() {
            const recipient = document.getElementById('clinMessageRecipient').value.trim();
            const subject = document.getElementById('clinMessageSubject').value.trim();
            const content = document.getElementById('clinMessageContent').value.trim();
            const statusEl = document.getElementById('messageSendStatus');

            if (!recipient) {
                statusEl.textContent = '‚ö†Ô∏è Please enter a patient username';
                statusEl.style.color = '#ff9800';
                statusEl.style.display = 'block';
                return;
            }

            if (!content) {
                statusEl.textContent = '‚ö†Ô∏è Please enter a message';
                statusEl.style.color = '#ff9800';
                statusEl.style.display = 'block';
                return;
            }

            try {
                statusEl.textContent = 'üì§ Sending message...';
                statusEl.style.color = '#667eea';
                statusEl.style.display = 'block';

                // Use the correct endpoint with correct field names
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        recipient: recipient,
                        subject: subject,
                        content: content
                    })
                });

                if (response.status === 403) {
                    statusEl.textContent = '‚ùå You cannot send messages to this person';
                    statusEl.style.color = '#e74c3c';
                    statusEl.style.display = 'block';
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to send message');
                }

                statusEl.textContent = '‚úÖ Message sent successfully!';
                statusEl.style.color = '#4caf50';
                statusEl.style.display = 'block';

                // Clear form
                document.getElementById('clinMessageRecipient').value = '';
                document.getElementById('clinMessageSubject').value = '';
                document.getElementById('clinMessageContent').value = '';
                
                // Hide autocomplete dropdown if visible
                const dropdown = document.getElementById('recipientAutocompleteDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }

                // Hide success message after 3 seconds
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);

                // Reload messages

                loadUserMessages();

            } catch (error) {
                console.error('Error sending message:', error);
                statusEl.textContent = `‚ùå ${error.message}`;
                statusEl.style.color = '#e74c3c';
                statusEl.style.display = 'block';
            }
        }

        // ========== DAILY WELLNESS RITUAL FUNCTIONS ==========
        
        let wellnessRitualState = {
            currentStep: 0,
            data: {},
            timeOfDay: '',
            startTime: Date.now(),
            skipped: [],
            conversationHistory: [], // Track AI/user messages for context
            steps: [
                { id: 'mood', title: 'How are you feeling today?', emoji: 'üòä', type: 'text' },
                { id: 'sleep', title: 'How did you sleep last night?', emoji: 'üò¥', type: 'options' },
                { id: 'hydration', title: 'How\'s your hydration today?', emoji: 'üíß', type: 'number' },
                { id: 'exercise', title: 'Any movement or exercise today?', emoji: 'üèÉ', type: 'options' },
                { id: 'social', title: 'How\'s your social connection today?', emoji: 'üë•', type: 'options' },
                { id: 'medication', title: 'Have you taken your medication?', emoji: 'üíä', type: 'options' },
                { id: 'energy', title: 'What\'s your energy level right now?', emoji: '‚ö°', type: 'options' },
                { id: 'homework', title: 'Any progress on your CBT homework?', emoji: 'üìù', type: 'options' },
                { id: 'wrap_up', title: 'Session complete!', emoji: '‚ú®', type: 'summary' }
            ]
        };

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            return 'evening';
        }

        function updateWellnessTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) {
                wellnessRitualState.timeOfDay = 'morning';
                return 'Good morning! üåÖ';
            } else if (hour >= 12 && hour < 17) {
                wellnessRitualState.timeOfDay = 'afternoon';
                return 'Good afternoon! ‚òÄÔ∏è';
            } else {
                wellnessRitualState.timeOfDay = 'evening';
                return 'Good evening! üåô';
            }
        }

        async function initializeWellnessRitual() {
            try {
                // Fetch user's preferred name from profile
                const preferredNameResponse = await fetch('/api/user/preferred-name', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (preferredNameResponse.ok) {
                    const preferredNameData = await preferredNameResponse.json();
                    wellnessRitualState.data.preferred_name = preferredNameData.preferred_name;
                }
                
                // Check if already logged today
                const todayResponse = await fetch('/api/wellness/today', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!todayResponse.ok) throw new Error('Failed to check wellness status');
                
                const todayData = await todayResponse.json();
                
                if (todayData.exists) {
                    // Already logged today
                    document.getElementById('wellnessConversation').style.display = 'none';
                    document.getElementById('wellnessAlreadyLogged').style.display = 'block';
                    document.querySelector('.wellness-input-area').style.display = 'none';
                    document.querySelector('.wellness-chat-header').style.display = 'flex';
                    return;
                }

                // Show all wellness components
                const header = document.querySelector('.wellness-chat-header');
                if (header) header.style.display = 'flex';
                
                document.getElementById('wellnessAlreadyLogged').style.display = 'none';
                document.getElementById('wellnessConversation').style.display = 'flex';
                document.querySelector('.wellness-input-area').style.display = 'flex';
                
                // Clear conversation and initialize
                const conversationDiv = document.getElementById('wellnessConversation');
                conversationDiv.innerHTML = '';
                
                wellnessRitualState.currentStep = 0;
                // data already has preferred_name, keep it
                wellnessRitualState.skipped = [];
                wellnessRitualState.startTime = Date.now();
                wellnessRitualState.conversationHistory = [];

                // Ensure div is in DOM and visible before rendering
                setTimeout(() => {
                    showWellnessStep();
                }, 100);
                
            } catch (error) {
                console.error('Error initializing wellness ritual:', error);
            }
        }

        function addWellnessMessage(text, isUser = false) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const message = document.createElement('div');
            message.className = `wellness-message ${isUser ? 'user' : 'ai'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'wellness-bubble';
            bubble.textContent = text;
            
            message.appendChild(bubble);
            messagesDiv.appendChild(message);
            
            // Track for AI context
            wellnessRitualState.conversationHistory.push({
                speaker: isUser ? 'user' : 'ai',
                text: text,
                timestamp: new Date().toISOString()
            });
            
            // Auto scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addWellnessOptions(optionsArray, callback) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'wellness-options';
            
            optionsArray.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'wellness-option-btn';
                btn.textContent = option.label;
                btn.onclick = () => {
                    addWellnessMessage(option.label, true);
                    callback(option.value || option.label);
                };
                optionsDiv.appendChild(btn);
            });
            messagesDiv.appendChild(optionsDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addWellnessTextInput(placeholder, callback) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const inputDiv = document.createElement('div');
            inputDiv.style.display = 'flex';
            inputDiv.style.gap = '8px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = placeholder;
            input.className = 'wellness-text-input';
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = '‚Üí';
            btn.onclick = () => {
                if (input.value.trim()) {
                    addWellnessMessage(input.value, true);
                    callback(input.value);
                }
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') btn.onclick();
            };
            
            inputDiv.appendChild(input);
            inputDiv.appendChild(btn);
            messagesDiv.appendChild(inputDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            input.focus();
        }

        function addWellnessScaleInput(placeholder, callback) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '12px';
            
            // Scale section
            const scaleDiv = document.createElement('div');
            scaleDiv.style.display = 'flex';
            scaleDiv.style.gap = '4px';
            scaleDiv.style.justifyContent = 'center';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'wellness-option-btn';
                btn.textContent = i;
                btn.style.flex = '1';
                btn.style.padding = '6px 2px';
                btn.style.fontSize = '0.85em';
                btn.onclick = function() {
                    selectedScale = i;
                    // Highlight selected
                    Array.from(scaleDiv.querySelectorAll('button')).forEach(b => b.style.opacity = '0.5');
                    btn.style.opacity = '1';
                };
                scaleDiv.appendChild(btn);
            }
            
            // Text input
            const inputDiv = document.createElement('div');
            inputDiv.style.display = 'flex';
            inputDiv.style.gap = '8px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = placeholder;
            input.className = 'wellness-text-input';
            
            let selectedScale = null;
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = '‚Üí';
            btn.onclick = () => {
                const text = input.value.trim();
                if (selectedScale || text) {
                    const response = `${selectedScale ? 'Mood: ' + selectedScale + '/10' : ''} ${text}`;
                    addWellnessMessage(response, true);
                    callback({ scale: selectedScale, narrative: text });
                }
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') btn.onclick();
            };
            
            inputDiv.appendChild(input);
            inputDiv.appendChild(btn);
            
            container.appendChild(scaleDiv);
            container.appendChild(inputDiv);
            messagesDiv.appendChild(container);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            input.focus();
        }

        function addWellnessNumberInput(placeholder, callback) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const inputDiv = document.createElement('div');
            inputDiv.style.display = 'flex';
            inputDiv.style.gap = '8px';
            
            const input = document.createElement('input');
            input.type = 'number';
            input.placeholder = placeholder;
            input.className = 'wellness-text-input';
            input.min = '0';
            input.step = '0.5';
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = '‚Üí';
            btn.onclick = () => {
                const value = input.value.trim();
                if (value) {
                    addWellnessMessage(value, true);
                    callback(parseFloat(value));
                }
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') btn.onclick();
            };
            
            inputDiv.appendChild(input);
            inputDiv.appendChild(btn);
            messagesDiv.appendChild(inputDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            input.focus();
        }

        function addWellnessOptionWithText(optionsArray, textPlaceholder, callback) {
            const messagesDiv = document.getElementById('wellnessConversation');
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '12px';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'wellness-options';
            
            let selectedOption = null;
            
            optionsArray.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'wellness-option-btn';
                btn.textContent = option.label;
                btn.onclick = () => {
                    selectedOption = option.value;
                    // Show text input if option is selected
                    inputDiv.style.display = 'flex';
                    input.focus();
                };
                optionsDiv.appendChild(btn);
            });
            
            // Text input (hidden initially)
            const inputDiv = document.createElement('div');
            inputDiv.style.display = 'none';
            inputDiv.style.gap = '8px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = textPlaceholder;
            input.className = 'wellness-text-input';
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = '‚Üí';
            btn.onclick = () => {
                const text = input.value.trim();
                if (selectedOption !== null && (selectedOption === false || text || selectedOption !== null)) {
                    const response = text ? `${optionsArray.find(o => o.value === selectedOption)?.label || ''} - ${text}` : optionsArray.find(o => o.value === selectedOption)?.label;
                    addWellnessMessage(response, true);
                    callback({ option: selectedOption, text: text });
                }
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') btn.onclick();
            };
            
            inputDiv.appendChild(input);
            inputDiv.appendChild(btn);
            
            container.appendChild(optionsDiv);
            container.appendChild(inputDiv);
            messagesDiv.appendChild(container);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function toggleWellnessChat() {
            const messagesDiv = document.getElementById('wellnessConversation');
            const inputArea = document.querySelector('.wellness-input-area');
            const alreadyLogged = document.getElementById('wellnessAlreadyLogged');
            const progressHeader = document.querySelector('.wellness-chat-header');
            
            // Check if already logged is showing
            if (alreadyLogged.style.display === 'block') {
                // Collapse - hide everything except progress header
                alreadyLogged.style.display = 'none';
                messagesDiv.style.display = 'none';
                inputArea.style.display = 'none';
                progressHeader.style.display = 'none';
            } else if (alreadyLogged.style.display === 'none' && messagesDiv.style.display === 'none') {
                // Expand - show already logged message
                alreadyLogged.style.display = 'block';
                progressHeader.style.display = 'flex';
            } else {
                // Toggle between showing/hiding messages
                if (messagesDiv.style.display === 'none') {
                    messagesDiv.style.display = 'flex';
                    inputArea.style.display = 'flex';
                } else {
                    messagesDiv.style.display = 'none';
                    inputArea.style.display = 'none';
                }
            }
        }

        function showWellnessStep() {
            const step = wellnessRitualState.steps[wellnessRitualState.currentStep];
            if (!step) return;

            const messagesDiv = document.getElementById('wellnessConversation');
            
            // Fade out current content if not first step
            if (wellnessRitualState.currentStep > 0) {
                messagesDiv.style.opacity = '0';
                messagesDiv.style.transition = 'opacity 0.2s ease-out';
                
                setTimeout(() => {
                    // Clear and reset
                    messagesDiv.innerHTML = '';
                    messagesDiv.style.opacity = '1';
                    messagesDiv.style.transition = 'opacity 0.3s ease-in';
                    
                    // Show new content
                    const question = `${step.emoji} ${step.title}`;
                    addWellnessMessage(question, false);
                    updateWellnessProgress();
                    renderWellnessStepContent(step.id);
                }, 200);
            } else {
                // First step - just render
                messagesDiv.innerHTML = '';
                const question = `${step.emoji} ${step.title}`;
                addWellnessMessage(question, false);
                updateWellnessProgress();
                renderWellnessStepContent(step.id);
            }
            
            // Show/hide buttons
            const prevBtn = document.getElementById('wellnessPrevBtn');
            const nextBtn = document.getElementById('wellnessNextBtn');
            const submitBtn = document.getElementById('wellnessSubmitBtn');
            
            prevBtn.style.display = wellnessRitualState.currentStep > 0 ? 'inline-block' : 'none';
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }

        function renderWellnessStepContent(stepId) {
            switch(stepId) {
                case 'mood':
                    addWellnessScaleInput('Tell me more about how you\'re feeling...', (response) => {
                        wellnessRitualState.data.mood = response.scale;
                        wellnessRitualState.data.mood_narrative = response.narrative;
                        setTimeout(() => nextWellnessStep(), 600);
                    });
                    break;
                case 'sleep':
                    const sleepContainer = document.getElementById('wellnessConversation');
                    const sleepDiv = document.createElement('div');
                    sleepDiv.style.display = 'flex';
                    sleepDiv.style.flexDirection = 'column';
                    sleepDiv.style.gap = '12px';
                    
                    const sleepQualityDiv = document.createElement('div');
                    sleepQualityDiv.innerHTML = '<strong>Sleep Quality:</strong>';
                    const sleepOptionsDiv = document.createElement('div');
                    sleepOptionsDiv.className = 'wellness-options';
                    
                    let selectedSleepQuality = null;
                    const sleepOptions = [
                        { label: 'üò¥ Excellent sleep', value: 9 },
                        { label: 'üôÇ Good sleep', value: 7 },
                        { label: 'üòê OK sleep', value: 5 },
                        { label: 'üòü Poor sleep', value: 3 },
                        { label: 'üò¢ Very poor/no sleep', value: 1 }
                    ];
                    
                    sleepOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.className = 'wellness-option-btn';
                        btn.textContent = option.label;
                        btn.onclick = () => {
                            selectedSleepQuality = option.value;
                            addWellnessMessage(option.label, true);
                            // Show hours input
                            hoursInputDiv.style.display = 'flex';
                            hoursInput.focus();
                        };
                        sleepOptionsDiv.appendChild(btn);
                    });
                    
                    // Hours input
                    const hoursInputDiv = document.createElement('div');
                    hoursInputDiv.style.display = 'none';
                    hoursInputDiv.style.gap = '8px';
                    hoursInputDiv.style.marginTop = '8px';
                    
                    const hoursInput = document.createElement('input');
                    hoursInput.type = 'number';
                    hoursInput.placeholder = 'How many hours of sleep? (e.g. 6.5)';
                    hoursInput.className = 'wellness-text-input';
                    hoursInput.min = '0';
                    hoursInput.step = '0.5';
                    hoursInput.max = '24';
                    
                    const submitSleepBtn = document.createElement('button');
                    submitSleepBtn.className = 'btn btn-primary';
                    submitSleepBtn.textContent = '‚Üí';
                    submitSleepBtn.onclick = () => {
                        if (hoursInput.value) {
                            addWellnessMessage(hoursInput.value + ' hours', true);
                            wellnessRitualState.data.sleep_quality = selectedSleepQuality;
                            wellnessRitualState.data.sleep_hours = parseFloat(hoursInput.value);
                            setTimeout(() => nextWellnessStep(), 600);
                        }
                    };
                    
                    hoursInput.onkeypress = (e) => {
                        if (e.key === 'Enter') submitSleepBtn.onclick();
                    };
                    
                    hoursInputDiv.appendChild(hoursInput);
                    hoursInputDiv.appendChild(submitSleepBtn);
                    
                    sleepDiv.appendChild(sleepQualityDiv);
                    sleepDiv.appendChild(sleepOptionsDiv);
                    sleepDiv.appendChild(hoursInputDiv);
                    sleepContainer.appendChild(sleepDiv);
                    break;
                case 'hydration':
                    addWellnessNumberInput('How many pints of water have you drank today?', (value) => {
                        wellnessRitualState.data.hydration_pints = value;
                        setTimeout(() => nextWellnessStep(), 600);
                    });
                    break;
                case 'exercise':
                    addWellnessOptions([
                        { label: 'üèÉ Vigorous exercise (45+ min)', value: 'vigorous' },
                        { label: 'üö∂ Moderate exercise (20-45 min)', value: 'moderate' },
                        { label: 'üö∂‚Äç‚ôÇÔ∏è Light movement (walk, stretch)', value: 'light' },
                        { label: 'üò¥ No movement yet', value: 'none' }
                    ], (value) => {
                        wellnessRitualState.data.exercise_type = value;
                        setTimeout(() => nextWellnessStep(), 600);
                    });
                    break;
                case 'social':
                    addWellnessOptionWithText([
                        { label: 'üë• Strong connection (in-person time)', value: 'strong' },
                        { label: 'üí¨ Good contact (calls, texts)', value: 'good' },
                        { label: 'üì± Some interaction', value: 'some' },
                        { label: 'üòî Minimal or no contact', value: 'minimal' }
                    ], 'Tell me more about your connections today...', (response) => {
                        wellnessRitualState.data.social_contact = response.option;
                        wellnessRitualState.data.social_notes = response.text;
                        setTimeout(() => nextWellnessStep(), 600);
                    });
                    break;
                case 'medication':
                    const medContainer = document.getElementById('wellnessConversation');
                    const medDiv = document.createElement('div');
                    medDiv.style.display = 'flex';
                    medDiv.style.flexDirection = 'column';
                    medDiv.style.gap = '12px';
                    
                    const medOptionsDiv = document.createElement('div');
                    medOptionsDiv.className = 'wellness-options';
                    
                    let medicationTaken = null;
                    
                    const yesBtn = document.createElement('button');
                    yesBtn.className = 'wellness-option-btn';
                    yesBtn.textContent = '‚úÖ Yes, took my medication';
                    yesBtn.onclick = () => {
                        medicationTaken = true;
                        addWellnessMessage('‚úÖ Yes, took my medication', true);
                        // Show medication name input
                        medNameDiv.style.display = 'flex';
                        medNameInput.focus();
                    };
                    
                    const noBtn = document.createElement('button');
                    noBtn.className = 'wellness-option-btn';
                    noBtn.textContent = '‚è≥ Missed it';
                    noBtn.onclick = () => {
                        medicationTaken = false;
                        addWellnessMessage('‚è≥ Missed it', true);
                        wellnessRitualState.data.medication_taken = false;
                        wellnessRitualState.data.medication_name = '';
                        setTimeout(() => nextWellnessStep(), 600);
                    };
                    
                    medOptionsDiv.appendChild(yesBtn);
                    medOptionsDiv.appendChild(noBtn);
                    
                    // Medication name input (hidden initially)
                    const medNameDiv = document.createElement('div');
                    medNameDiv.style.display = 'none';
                    medNameDiv.style.gap = '8px';
                    
                    const medNameInput = document.createElement('input');
                    medNameInput.type = 'text';
                    medNameInput.placeholder = 'What medication? (e.g. Sertraline 50mg)';
                    medNameInput.className = 'wellness-text-input';
                    
                    const submitMedBtn = document.createElement('button');
                    submitMedBtn.className = 'btn btn-primary';
                    submitMedBtn.textContent = '‚Üí';
                    submitMedBtn.onclick = () => {
                        if (medNameInput.value) {
                            addWellnessMessage(medNameInput.value, true);
                            wellnessRitualState.data.medication_taken = true;
                            wellnessRitualState.data.medication_name = medNameInput.value;
                            setTimeout(() => nextWellnessStep(), 600);
                        }
                    };
                    
                    medNameInput.onkeypress = (e) => {
                        if (e.key === 'Enter') submitMedBtn.onclick();
                    };
                    
                    medNameDiv.appendChild(medNameInput);
                    medNameDiv.appendChild(submitMedBtn);
                    
                    medDiv.appendChild(medOptionsDiv);
                    medDiv.appendChild(medNameDiv);
                    medContainer.appendChild(medDiv);
                    break;
                case 'energy':
                    const energyContainer = document.getElementById('wellnessConversation');
                    const energyDiv = document.createElement('div');
                    energyDiv.style.display = 'flex';
                    energyDiv.style.flexDirection = 'column';
                    energyDiv.style.gap = '12px';
                    
                    const energyOptionsDiv = document.createElement('div');
                    energyOptionsDiv.className = 'wellness-options';
                    
                    let selectedEnergy = null;
                    const energyOptions = [
                        { label: '‚ö° Energized & capable', value: 9 },
                        { label: 'üôÇ Good energy', value: 7 },
                        { label: 'üòê OK', value: 5 },
                        { label: 'üòü Low energy', value: 3 },
                        { label: 'üò¥ Exhausted', value: 1 }
                    ];
                    
                    energyOptions.forEach(option => {
                        const btn = document.createElement('button');
                        btn.className = 'wellness-option-btn';
                        btn.textContent = option.label;
                        btn.onclick = () => {
                            selectedEnergy = option.value;
                            addWellnessMessage(option.label, true);
                            // Show notes input
                            energyNotesDiv.style.display = 'flex';
                            energyNotesInput.focus();
                        };
                        energyOptionsDiv.appendChild(btn);
                    });
                    
                    // Notes input
                    const energyNotesDiv = document.createElement('div');
                    energyNotesDiv.style.display = 'none';
                    energyNotesDiv.style.gap = '8px';
                    
                    const energyNotesInput = document.createElement('input');
                    energyNotesInput.type = 'text';
                    energyNotesInput.placeholder = 'Any notes? (what\'s affecting your energy?)';
                    energyNotesInput.className = 'wellness-text-input';
                    
                    const submitEnergyBtn = document.createElement('button');
                    submitEnergyBtn.className = 'btn btn-primary';
                    submitEnergyBtn.textContent = '‚Üí';
                    submitEnergyBtn.onclick = () => {
                        wellnessRitualState.data.energy_level = selectedEnergy;
                        wellnessRitualState.data.energy_notes = energyNotesInput.value || '';
                        if (energyNotesInput.value) {
                            addWellnessMessage(energyNotesInput.value, true);
                        }
                        setTimeout(() => nextWellnessStep(), 600);
                    };
                    
                    energyNotesInput.onkeypress = (e) => {
                        if (e.key === 'Enter') submitEnergyBtn.onclick();
                    };
                    
                    energyNotesDiv.appendChild(energyNotesInput);
                    energyNotesDiv.appendChild(submitEnergyBtn);
                    
                    energyDiv.appendChild(energyOptionsDiv);
                    energyDiv.appendChild(energyNotesDiv);
                    energyContainer.appendChild(energyDiv);
                    break;
                case 'homework':
                    addWellnessOptions([
                        { label: '‚úÖ Completed my homework', value: true },
                        { label: '‚è≥ Still working on it', value: false },
                        { label: 'ü§î Don\'t have homework this week', value: null }
                    ], (value) => {
                        wellnessRitualState.data.homework_completed = value;
                        setTimeout(() => nextWellnessStep(), 600);
                    });
                    break;
                case 'wrap_up':
                    showWellnessWrapUp();
                    break;
            }
        }

        function updateWellnessProgress() {
            const total = wellnessRitualState.steps.length;
            const current = wellnessRitualState.currentStep + 1;
            const progress = Math.min(100, (current / total) * 100);
            
            document.getElementById('wellnessProgressBar').style.width = progress + '%';
            document.getElementById('wellnessProgressText').textContent = `Step ${current} of ${total}`;
        }

        function nextWellnessStep() {
            wellnessRitualState.currentStep++;
            if (wellnessRitualState.currentStep >= wellnessRitualState.steps.length) {
                showWellnessWrapUp();
            } else {
                showWellnessStep();
            }
        }

        function previousWellnessStep() {
            if (wellnessRitualState.currentStep > 0) {
                wellnessRitualState.currentStep--;
                // Clear and re-render
                document.getElementById('wellnessConversation').innerHTML = '';
                showWellnessStep();
            }
        }

        function skipWellnessStep() {
            nextWellnessStep();
        }

        function showWellnessWrapUp() {
            // Session complete
            wellnessRitualState.data.session_duration_seconds = Math.floor((Date.now() - wellnessRitualState.startTime) / 1000);
            
            document.getElementById('wellnessProgressText').textContent = 'Complete! ‚ú®';
            document.getElementById('wellnessProgressBar').style.width = '100%';
            
            const messagesDiv = document.getElementById('wellnessConversation');
            const preferredName = wellnessRitualState.data.preferred_name || 'friend';
            
            // Get personalized thank you message
            const gratitudeMessages = [
                `That was wonderful, ${preferredName}. Thank you for being so honest with me today. üíô`,
                `Thank you for checking in, ${preferredName}. I can see you're really taking care of yourself. üíô`,
                `I appreciate you taking the time today, ${preferredName}. This helps me understand you better. üíô`,
                `That's really insightful, ${preferredName}. Thank you for sharing. üíô`
            ];
            
            const message = gratitudeMessages[Math.floor(Math.random() * gratitudeMessages.length)];
            addWellnessMessage(message, false);
            
            // Add action items or encouragement
            let encouragement = '';
            if (wellnessRitualState.data.sleep_quality && wellnessRitualState.data.sleep_quality < 5) {
                encouragement += 'Let\'s focus on sleep tonight‚Äîeven 10 minutes earlier can help. ';
            }
            if (wellnessRitualState.data.total_hydration_cups && wellnessRitualState.data.total_hydration_cups < 3) {
                encouragement += 'Don\'t forget to drink more water today! ';
            }
            if (wellnessRitualState.data.exercise_type === 'none') {
                encouragement += 'Even a 5-minute walk would help boost your mood. ';
            }
            
            if (encouragement) {
                setTimeout(() => addWellnessMessage(encouragement, false), 1200);
            }
            
            // Final wrap-up
            setTimeout(() => {
                addWellnessMessage('Come back tomorrow to check in again. I\'ll be here. üåü', false);
            }, encouragement ? 2400 : 1200);
            
            // Show submit button
            const submitBtn = document.getElementById('wellnessSubmitBtn');
            submitBtn.style.display = 'inline-block';
        }

        async function submitWellnessRitual() {
            try {
                // Prepare payload - map all captured data
                const payload = {
                    mood: wellnessRitualState.data.mood || null,
                    mood_descriptor: wellnessRitualState.data.mood_narrative || '',
                    mood_context: wellnessRitualState.data.mood_narrative || '',
                    sleep_quality: wellnessRitualState.data.sleep_quality || null,
                    sleep_hours: wellnessRitualState.data.sleep_hours || null,
                    sleep_notes: '',
                    hydration_level: 'measured',
                    hydration_pints: wellnessRitualState.data.hydration_pints || 0,
                    total_hydration_cups: 0,
                    exercise_type: wellnessRitualState.data.exercise_type || '',
                    exercise_duration: 0,
                    outdoor_time_minutes: 0,
                    social_contact: wellnessRitualState.data.social_contact || '',
                    social_notes: wellnessRitualState.data.social_notes || '',
                    medication_taken: wellnessRitualState.data.medication_taken === true,
                    medication_name: wellnessRitualState.data.medication_name || '',
                    medication_reason_if_missed: '',
                    caffeine_intake_time: '',
                    energy_level: wellnessRitualState.data.energy_level || null,
                    energy_notes: wellnessRitualState.data.energy_notes || '',
                    capacity_index: wellnessRitualState.data.energy_level || null,
                    weekly_goal_progress: 0,
                    homework_completed: wellnessRitualState.data.homework_completed === true,
                    homework_blockers: '',
                    emotional_narrative: wellnessRitualState.data.mood_narrative || '',
                    preferred_name: wellnessRitualState.data.preferred_name || '',
                    time_of_day_category: getTimeOfDay(),
                    session_duration_seconds: wellnessRitualState.data.session_duration_seconds || 0,
                    conversation_history: wellnessRitualState.conversationHistory
                };

                console.log('Submitting wellness data:', payload);

                const response = await fetch('/api/wellness/log', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || 'Failed to save wellness ritual');
                    } catch (e) {
                        throw new Error(`Server error (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                }

                const result = await response.json();
                console.log('Wellness saved successfully:', result);

                // Log wellness completion to activity logger
                try {
                    if (activityLogger) {
                        activityLogger.logActivity('wellness_saved', 'mood:' + (wellnessRitualState.data.mood || '?'), 'wellness');
                    }
                } catch(e) {}

                // Show success message
                await new Promise(r => setTimeout(r, 1000));
                addWellnessMessage('‚úÖ All saved! See you tomorrow, ' + (wellnessRitualState.data.preferred_name || 'friend') + '.', false);
                
                // Collapse wellness card after a short delay
                setTimeout(() => {
                    document.getElementById('wellnessConversation').style.display = 'none';
                    document.querySelector('.wellness-input-area').style.display = 'none';
                    document.getElementById('wellnessAlreadyLogged').style.display = 'block';
                    document.getElementById('wellnessProgressBar').style.width = '100%';
                    document.getElementById('wellnessProgressText').textContent = 'Completed! ‚ú®';
                }, 2000);
                
            } catch (error) {
                console.error('Error submitting wellness ritual:', error);
                addWellnessMessage('‚ùå Error saving: ' + error.message + '. Please try again.', false);
            }
        }

        // ==================== WINS BOARD ====================

        const WIN_PRESETS = [
            { type: 'had_a_laugh', emoji: '\u{1F604}', label: 'Had a laugh' },
            { type: 'self_care', emoji: '\u{1F486}', label: 'Kind to myself' },
            { type: 'kept_promise', emoji: '\u{1F91D}', label: 'Kept a promise' },
            { type: 'tried_new', emoji: '\u{1F31F}', label: 'Tried something new' },
            { type: 'stood_up', emoji: '\u{1F4AA}', label: 'Stood up for myself' },
            { type: 'got_outside', emoji: '\u{1F333}', label: 'Got outside' },
            { type: 'helped_someone', emoji: '\u{2764}\u{FE0F}', label: 'Helped someone' }
        ];

        function renderWinPresets() {
            var presetsDiv = document.getElementById('winsPresets');
            if (!presetsDiv) return;
            presetsDiv.innerHTML = WIN_PRESETS.map(function(p) {
                return '<button class="win-preset-btn" onclick="logPresetWin(\'' + p.type + '\', \'' + p.label + '\')">' + p.emoji + ' ' + p.label + '</button>';
            }).join('');
        }

        async function loadWinsBoard() {
            try {
                renderWinPresets();
                var response = await fetch('/api/wins/recent?limit=10', {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) return;
                var data = await response.json();
                var countEl = document.getElementById('winsWeekCount');
                if (countEl) countEl.textContent = data.this_week_count + ' this week';
                renderRecentWins(data.wins || []);
            } catch (e) {
                console.warn('Wins board load error:', e);
            }
        }

        async function logPresetWin(winType, defaultText) {
            var detail = prompt('Add a detail (optional):', '');
            var winText = detail !== null && detail.trim() !== '' ? detail.trim() : defaultText;
            await submitWin(winType, winText);
        }

        async function logCustomWin() {
            var input = document.getElementById('customWinInput');
            var text = input.value.trim();
            if (!text) return;
            await submitWin('custom', text);
            input.value = '';
        }

        async function submitWin(winType, winText) {
            try {
                var response = await fetch('/api/wins/log', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ win_type: winType, win_text: winText })
                });
                if (!response.ok) {
                    var err = await response.json();
                    alert(err.error || 'Failed to log win');
                    return;
                }
                try {
                    if (activityLogger) activityLogger.logActivity('win_logged', winType, 'home');
                } catch(e) {}
                showWinCelebration(winText);
                loadWinsBoard();
            } catch (e) {
                console.error('Error logging win:', e);
            }
        }

        function renderRecentWins(wins) {
            var listDiv = document.getElementById('recentWinsList');
            if (!listDiv) return;
            if (!wins || wins.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 15px;">No wins yet. Celebrate something today!</p>';
                return;
            }
            var emojiMap = {};
            WIN_PRESETS.forEach(function(p) { emojiMap[p.type] = p.emoji; });
            listDiv.innerHTML = wins.map(function(w) {
                var emoji = emojiMap[w.win_type] || '\u{1F3C6}';
                var timeAgo = getTimeAgo(w.created_at);
                return '<div class="win-entry">' +
                    '<span>' + emoji + '</span>' +
                    '<span>' + escapeHtml(w.win_text) + '</span>' +
                    '<span class="win-time">' + timeAgo + '</span>' +
                    '</div>';
            }).join('');
        }

        function showWinCelebration(winText) {
            var listDiv = document.getElementById('recentWinsList');
            if (!listDiv) return;
            var celebDiv = document.createElement('div');
            celebDiv.className = 'win-entry win-celebration';
            celebDiv.style.background = 'rgba(99, 179, 237, 0.1)';
            celebDiv.style.borderRadius = '8px';
            celebDiv.style.padding = '12px';
            celebDiv.innerHTML = '<span>\u{1F389}</span><span><strong>Win logged!</strong> ' + escapeHtml(winText) + '</span>';
            listDiv.insertBefore(celebDiv, listDiv.firstChild);
            setTimeout(function() { celebDiv.remove(); }, 3000);
        }

        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            var date = new Date(dateStr);
            var now = new Date();
            var diffMs = now - date;
            var diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            var diffHrs = Math.floor(diffMins / 60);
            if (diffHrs < 24) return diffHrs + 'h ago';
            var diffDays = Math.floor(diffHrs / 24);
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString();
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }

        // === RISK DASHBOARD FUNCTIONS ===
        let allRiskPatients = [];

        async function loadRiskDashboard() {
            try {
                const response = await fetch('/api/risk/dashboard', {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to load risk dashboard');

                document.getElementById('riskCriticalCount').textContent = data.summary.critical || 0;
                document.getElementById('riskHighCount').textContent = data.summary.high || 0;
                document.getElementById('riskModerateCount').textContent = data.summary.moderate || 0;
                document.getElementById('riskLowCount').textContent = data.summary.low || 0;
                document.getElementById('riskUnreviewedCount').textContent = data.unreviewed_alerts || 0;

                allRiskPatients = data.patients || [];
                renderRiskPatients(allRiskPatients);
                renderRiskAlerts(data.recent_alerts || []);
            } catch (err) {
                console.error('Risk dashboard error:', err);
                document.getElementById('riskPatientsList').innerHTML = '<p style="text-align:center; color:#e74c3c; padding:20px;">Error loading risk data: ' + err.message + '</p>';
            }
        }

        function renderRiskAlerts(alerts) {
            const container = document.getElementById('riskActiveAlertsList');
            if (!alerts || !alerts.length) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No active alerts - all patients stable</p>';
                return;
            }
            const severityColors = { critical: '#ff4444', high: '#ff8800', moderate: '#ffcc00', low: '#44ff44' };
            container.innerHTML = alerts.map(function(a) {
                return '<div style="border-left: 4px solid ' + (severityColors[a.severity] || '#999') + '; padding: 12px; margin-bottom: 10px; background: ' + (a.acknowledged ? 'var(--bg-card)' : '#fff5f5') + '; border-radius: 0 8px 8px 0;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 8px;">' +
                        '<div>' +
                            '<strong>' + (a.severity === 'critical' ? 'üî¥' : a.severity === 'high' ? 'üü†' : a.severity === 'moderate' ? 'üü°' : 'üü¢') + ' ' + escapeHtml(a.title || 'Alert') + '</strong>' +
                            '<div style="color: var(--text-secondary); font-size: 0.85em;">Patient: ' + escapeHtml(a.patient_name || a.patient_username) + ' | ' + new Date(a.created_at).toLocaleString() + '</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 5px;">' +
                            (!a.acknowledged ? '<button onclick="acknowledgeRiskAlert(' + a.id + ')" class="btn btn-secondary" style="padding:4px 10px; font-size:0.8em; width:auto;">Acknowledge</button>' : '') +
                            '<button onclick="resolveRiskAlertPrompt(' + a.id + ')" class="btn" style="padding:4px 10px; font-size:0.8em; background:#2ecc71; width:auto;">Resolve</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderRiskPatients(patients) {
            const container = document.getElementById('riskPatientsList');
            if (!patients || !patients.length) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No patients found</p>';
                return;
            }
            const levelColors = { critical: '#ff4444', high: '#ff8800', moderate: '#ccaa00', low: '#2ecc71' };
            container.innerHTML = patients.map(function(p) {
                return '<div onclick="openRiskDetail(\'' + escapeHtml(p.username) + '\')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--shadow-color); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'rgba(102,126,234,0.05)\'" onmouseout="this.style.background=\'transparent\'">' +
                    '<div>' +
                        '<strong>' + escapeHtml(p.full_name || p.username) + '</strong>' +
                        '<div style="font-size: 0.85em; color: var(--text-secondary);">' + (p.last_assessed ? 'Last assessed: ' + new Date(p.last_assessed).toLocaleDateString() : 'Not yet assessed') + '</div>' +
                    '</div>' +
                    '<span style="background: ' + (levelColors[p.risk_level] || '#ccc') + '; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 0.85em;">' + (p.risk_level || 'low').toUpperCase() + '</span>' +
                '</div>';
            }).join('');
        }

        function filterRiskPatients(level) {
            if (level === 'all') {
                renderRiskPatients(allRiskPatients);
            } else {
                renderRiskPatients(allRiskPatients.filter(function(p) { return p.risk_level === level; }));
            }
        }

        async function acknowledgeRiskAlert(alertId) {
            try {
                const response = await fetch('/api/risk/alert/' + alertId + '/acknowledge', {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) loadRiskDashboard();
                else alert(data.error || 'Failed to acknowledge alert');
            } catch (err) { alert('Error: ' + err.message); }
        }

        function resolveRiskAlertPrompt(alertId) {
            const action = prompt('What action was taken to resolve this alert?');
            if (!action) return;
            resolveRiskAlert(alertId, action);
        }

        async function resolveRiskAlert(alertId, actionTaken) {
            try {
                const response = await fetch('/api/risk/alert/' + alertId + '/resolve', {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_taken: actionTaken })
                });
                const data = await response.json();
                if (data.success) loadRiskDashboard();
                else alert(data.error || 'Failed to resolve alert');
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function openRiskDetail(patientUsername) {
            const modal = document.getElementById('riskDetailModal');
            const content = document.getElementById('riskDetailContent');
            modal.style.display = 'flex';
            content.innerHTML = '<p style="text-align:center; padding:40px;">Loading risk details...</p>';
            try {
                const scoreRes = await fetch('/api/risk/score/' + encodeURIComponent(patientUsername), { credentials: 'include' });
                const scoreData = await scoreRes.json();

                const histRes = await fetch('/api/risk/history/' + encodeURIComponent(patientUsername) + '?days=30', { credentials: 'include' });
                const histData = await histRes.json();

                const levelColors = { critical: '#ff4444', high: '#ff8800', moderate: '#ccaa00', low: '#2ecc71' };
                const level = scoreData.risk_level || 'low';
                const factors = scoreData.contributing_factors || [];

                content.innerHTML =
                    '<h3 style="margin-top:0;">' + escapeHtml(patientUsername) + ' - Risk Assessment</h3>' +
                    '<div style="text-align: center; margin: 20px 0;">' +
                        '<div style="display: inline-block; background: ' + (levelColors[level] || '#ccc') + '; color: white; padding: 15px 30px; border-radius: 12px; font-size: 1.5em; font-weight: bold;">' +
                            level.toUpperCase() + ' RISK (Score: ' + (scoreData.risk_score || 0) + '/100)' +
                        '</div>' +
                    '</div>' +
                    '<h4>Score Breakdown</h4>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">' +
                        '<div style="background: var(--bg-card); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--shadow-color);">' +
                            '<div style="font-size: 1.5em; font-weight: bold;">' + (scoreData.clinical_score || 0) + '/40</div>' +
                            '<div style="color: var(--text-secondary); font-size: 0.85em;">Clinical</div>' +
                        '</div>' +
                        '<div style="background: var(--bg-card); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--shadow-color);">' +
                            '<div style="font-size: 1.5em; font-weight: bold;">' + (scoreData.behavioral_score || 0) + '/30</div>' +
                            '<div style="color: var(--text-secondary); font-size: 0.85em;">Behavioral</div>' +
                        '</div>' +
                        '<div style="background: var(--bg-card); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--shadow-color);">' +
                            '<div style="font-size: 1.5em; font-weight: bold;">' + (scoreData.conversational_score || 0) + '/30</div>' +
                            '<div style="color: var(--text-secondary); font-size: 0.85em;">Conversational</div>' +
                        '</div>' +
                    '</div>' +
                    '<h4>Contributing Factors</h4>' +
                    '<ul style="margin-bottom: 20px;">' +
                        (factors.length > 0 ? factors.map(function(f) { return '<li>' + escapeHtml(f) + '</li>'; }).join('') : '<li style="color: var(--text-secondary);">No contributing factors identified</li>') +
                    '</ul>' +
                    '<h4>Risk History (30 days)</h4>' +
                    '<div style="max-height: 200px; margin-bottom: 20px;"><canvas id="riskHistoryChart"></canvas></div>' +
                    '<div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">' +
                        '<button onclick="triggerRiskRecalc(\'' + escapeHtml(patientUsername) + '\')" class="btn" style="background: #667eea; width: auto;">Recalculate Risk</button>' +
                        '<button onclick="closeRiskDetailModal()" class="btn btn-secondary" style="width: auto;">Close</button>' +
                    '</div>';

                // Render Chart.js timeline
                var history = histData.history || [];
                if (history.length > 0) {
                    history.reverse();
                    var ctx = document.getElementById('riskHistoryChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(function(h) { return new Date(h.assessed_at).toLocaleDateString(); }),
                            datasets: [{
                                label: 'Risk Score',
                                data: history.map(function(h) { return h.risk_score; }),
                                borderColor: '#ff4444',
                                backgroundColor: 'rgba(255, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { min: 0, max: 100, title: { display: true, text: 'Risk Score' } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            } catch (err) {
                content.innerHTML = '<p style="color: #e74c3c; padding: 20px;">Error loading risk details: ' + err.message + '</p>';
            }
        }

        function closeRiskDetailModal() {
            document.getElementById('riskDetailModal').style.display = 'none';
        }

        async function triggerRiskRecalc(username) {
            try {
                const res = await fetch('/api/risk/score/' + encodeURIComponent(username), { credentials: 'include' });
                if (res.ok) {
                    openRiskDetail(username);
                    loadRiskDashboard();
                }
            } catch (err) { alert('Error: ' + err.message); }
        }

        // === CRISIS SUPPORT FUNCTIONS ===
        function openCrisisSupport() {
            document.getElementById('crisisSupportModal').style.display = 'flex';
            try {
                if (typeof activityLogger !== 'undefined' && activityLogger) {
                    activityLogger.logActivity('crisis_resources_viewed', '', 'safety');
                }
            } catch(e) {}
        }

        function closeCrisisSupport() {
            document.getElementById('crisisSupportModal').style.display = 'none';
        }

    </script>
    <!-- UX Enhancement System -->
    <script src="/static/js/ux-enhancements.js"></script>
    <!-- AI Memory System - Activity Logger -->
    <script src="/static/js/activity-logger.js"></script>

    <!-- Persistent Crisis Support Button (visible on all tabs) -->
    <button id="crisisSupportBtn" onclick="openCrisisSupport()"
        style="position: fixed; bottom: 80px; right: 20px; z-index: 9999;
               background: #c62828; color: white; border: none; border-radius: 50%;
               width: 52px; height: 52px; font-size: 22px; cursor: pointer;
               box-shadow: 0 4px 12px rgba(198,40,40,0.4); transition: transform 0.2s;"
        onmouseover="this.style.transform='scale(1.1)'"
        onmouseout="this.style.transform='scale(1)'"
        title="Crisis Support - Get Help Now">
        üÜò
    </button>

    <!-- Crisis Support Modal -->
    <div id="crisisSupportModal" class="modal" style="display:none; z-index: 10000;">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeCrisisSupport()">&times;</span>
            <h3 style="color: #c62828; margin-top: 0;">Crisis Support</h3>
            <p style="color: var(--text-secondary);">If you or someone you know is in immediate danger, please call <strong>999</strong>.</p>

            <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="color: #c62828; margin-top: 0;">Immediate Help</h4>
                <p style="margin: 8px 0;"><strong>Emergency Services:</strong> <a href="tel:999" style="color: #c62828; font-weight: bold; font-size: 1.1em;">999</a></p>
                <p style="margin: 8px 0;"><strong>NHS Mental Health Crisis:</strong> <a href="tel:111" style="color: #c62828;">111</a> (press 2)</p>
            </div>

            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin-top: 0;">Mental Health Crisis Lines</h4>
                <p style="margin: 8px 0;"><strong>Samaritans:</strong> <a href="tel:116123">116 123</a> (24/7, free, confidential)</p>
                <p style="margin: 8px 0;"><strong>Crisis Text Line:</strong> Text <strong>SHOUT</strong> to <strong>85258</strong></p>
                <p style="margin: 8px 0;"><strong>CALM:</strong> <a href="tel:08005858">0800 58 58 58</a> (5pm-midnight)</p>
                <p style="margin: 8px 0;"><strong>Papyrus (Under 35s):</strong> <a href="tel:08000684141">0800 068 41 41</a></p>
                <p style="margin: 8px 0;"><strong>Childline (Under 18s):</strong> <a href="tel:08001111">0800 1111</a></p>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin-top: 0;">Specialist Support</h4>
                <p style="margin: 8px 0;"><strong>Self-Injury Support:</strong> <a href="tel:08088008088">0808 800 8088</a> (evenings)</p>
                <p style="margin: 8px 0;"><strong>Frank (Drug Support):</strong> <a href="tel:03001236600">0300 123 6600</a></p>
                <p style="margin: 8px 0;"><strong>Drinkline:</strong> <a href="tel:03001231110">0300 123 1110</a></p>
                <p style="margin: 8px 0;"><strong>Domestic Abuse Helpline:</strong> <a href="tel:08082000247">0808 2000 247</a></p>
                <p style="margin: 8px 0;"><strong>Mind Infoline:</strong> <a href="tel:03001233393">0300 123 3393</a></p>
                <p style="margin: 8px 0;"><strong>Beat (Eating Disorders):</strong> <a href="tel:08088010677">0808 801 0677</a></p>
                <p style="margin: 8px 0;"><strong>Combat Stress (Veterans):</strong> <a href="tel:08001381619">0800 138 1619</a></p>
                <p style="margin: 8px 0;"><strong>Cruse Bereavement:</strong> <a href="tel:08088081677">0808 808 1677</a></p>
            </div>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin-top: 0;">Online Resources</h4>
                <p style="margin: 8px 0;"><a href="https://www.nhs.uk/every-mind-matters" target="_blank" rel="noopener">NHS Every Mind Matters</a></p>
                <p style="margin: 8px 0;"><a href="https://www.mind.org.uk" target="_blank" rel="noopener">Mind</a></p>
                <p style="margin: 8px 0;"><a href="https://hubofhope.co.uk" target="_blank" rel="noopener">Hub of Hope (find local services)</a></p>
            </div>

            <button onclick="switchTab('cbt', document.querySelector('[onclick*=&quot;cbt&quot;]')); setTimeout(function() { loadCBTTool('SafetyPlanBuilder'); }, 200); closeCrisisSupport();"
                    class="btn" style="padding: 12px; margin-top: 10px;">
                View My Safety Plan
            </button>
        </div>
    </div>
    <!-- TIER 1.1: Clinician Dashboard Module -->
    <script src="/static/js/clinician.js"></script>
</body>
</html>