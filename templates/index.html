<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healing Space - Complete Mental Health Companion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            padding: 40px;
        }
        
        .auth-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .auth-box .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .app-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .app-header h2 {
            color: #667eea;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: rgba(255,255,255,0.9);
            border: 2px solid transparent;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }
        
        .tab-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .tab-btn.active {
            background: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chat Interface */
        .chat-container {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: slideIn 0.3s;
            word-wrap: break-word;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: white;
            border: 2px solid #e0e0e0;
        }
        
        .chat-input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .chat-input-area button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Mood Tracker */
        .mood-scale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .mood-option {
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mood-option:hover, .mood-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
        }
        
        .mood-option .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Medication List */
        .med-list {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            min-height: 60px;
            margin: 10px 0;
        }
        
        .med-item {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .med-item button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Pet Display */
        .pet-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        
        .pet-display {
            text-align: center;
            font-size: 80px;
            margin: 20px 0;
        }
        
        .pet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .stat-bar label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
        
        /* History Cards */
        .history-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .history-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .history-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        
        .history-card .date {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* CBT Tools */
        .cbt-container {
            display: grid;
            gap: 20px;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            animation: slideIn 0.3s;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .hidden {
            display: none !important;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        .inline-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .inline-form .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .sleep-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sleep-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sleep-item:hover {
            background: #e8e8e8;
        }
        
        .sleep-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .sleep-item span {
            font-size: 16px;
        }
        
        .community-post {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .community-post .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .community-post .post-message {
            line-height: 1.6;
            color: #333;
        }
        
        .community-post .post-likes {
            margin-top: 8px;
            color: #999;
            font-size: 13px;
        }
        
        .patient-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .patient-card .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .patient-card .patient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .patient-stat {
            text-align: center;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .patient-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .patient-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            .tab-btn {
                width: 100%;
            }
            .mood-scale {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <h1>üåø Healing Space</h1>
            <p class="subtitle">Complete Mental Health Companion</p>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" placeholder="Choose username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Choose password (min 8 chars)">
                </div>
                <div class="form-group">
                    <label>PIN (4 digits)</label>
                    <input type="password" id="regPin" placeholder="Choose 4-digit PIN" maxlength="4">
                </div>
                <div class="form-group">
                    <label>Select Your Clinician</label>
                    <select id="regClinician" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        <option value="">-- Loading clinicians --</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">Your assigned mental health professional</small>
                </div>
                <button class="btn" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
                <button class="btn btn-secondary" onclick="showClinicianRegister()">I'm a Clinician</button>
            </div>
            
            <div id="clinicianRegisterForm" class="hidden">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="clinicianUsername" placeholder="Choose username">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="clinicianFullName" placeholder="Dr. Jane Smith">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="clinicianPassword" placeholder="Choose password (min 8 chars)">
                </div>
                <button class="btn" onclick="registerClinician()">Create Clinician Account</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </div>
            
            <div id="authMessage" class="hidden"></div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <div class="app-header">
            <h2>üåø Healing Space</h2>
            <div class="user-info">
                <span id="usernameDisplay"></span>
                <button class="btn" onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
            </div>
        </div>
        
        <div class="app-content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('therapy', this)">ü§ñ AI Therapy</button>
                <button class="tab-btn" onclick="switchTab('mood', this)">üìä Mood & Habits</button>
                <button class="tab-btn" onclick="switchTab('gratitude', this)">üôè Gratitude Journal</button>
                <button class="tab-btn" onclick="switchTab('cbt', this)">üß† CBT Tools</button>
                <button class="tab-btn" onclick="switchTab('pet', this)">üê∂ My Pet</button>
                <button class="tab-btn" onclick="switchTab('clinical', this)">üìã Assessments</button>
                <button class="tab-btn" onclick="switchTab('community', this)">üë• Community</button>
                <button class="tab-btn" onclick="switchTab('safety', this)">üÜò Safety Plan</button>
                <button class="tab-btn" onclick="switchTab('insights', this)">üí° Insights</button>
                <button class="tab-btn" onclick="switchTab('sleep', this)">üò¥ Sleep Hygiene</button>
                <button class="tab-btn" onclick="switchTab('history', this)">üìà My History</button>
                <button class="tab-btn" id="professionalTabBtn" onclick="switchTab('professional', this)" style="display:none;">üë®‚Äç‚öïÔ∏è Professional</button>
            </div>
            
            <!-- Therapy Chat Tab -->
            <div id="therapyTab" class="tab-content active">
                <h3>Talk to Your AI Therapist</h3>
                <p style="color: #666; margin-bottom: 20px;">Share your thoughts and feelings in a safe, confidential space.</p>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Mood Tracker Tab -->
            <div id="moodTab" class="tab-content">
                <h3>Mood, Sleep, Habits & Medications</h3>
                <p style="color: #666; margin-bottom: 20px;">Complete daily check-in to track your wellness journey.</p>
                
                <div class="mood-scale">
                    <div class="mood-option" data-mood="1" onclick="selectMood(1, this)">
                        <div class="emoji">üò¢</div>
                        <div>Very Low (1)</div>
                    </div>
                    <div class="mood-option" data-mood="3" onclick="selectMood(3, this)">
                        <div class="emoji">üòî</div>
                        <div>Low (3)</div>
                    </div>
                    <div class="mood-option" data-mood="5" onclick="selectMood(5, this)">
                        <div class="emoji">üòê</div>
                        <div>Neutral (5)</div>
                    </div>
                    <div class="mood-option" data-mood="7" onclick="selectMood(7, this)">
                        <div class="emoji">üôÇ</div>
                        <div>Good (7)</div>
                    </div>
                    <div class="mood-option" data-mood="10" onclick="selectMood(10, this)">
                        <div class="emoji">üòÑ</div>
                        <div>Great (10)</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Hours of Sleep</label>
                        <input type="number" id="sleepHours" min="0" max="24" step="0.5" placeholder="e.g., 7.5">
                    </div>
                    <div class="form-group">
                        <label>Water (Pints)</label>
                        <input type="number" id="waterPints" min="0" step="0.5" placeholder="e.g., 4">
                    </div>
                    <div class="form-group">
                        <label>Exercise (Minutes)</label>
                        <input type="number" id="exerciseMins" min="0" placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label>Outdoor Time (Minutes)</label>
                        <input type="number" id="outsideMins" min="0" placeholder="e.g., 20">
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Medications Taken Today</h4>
                <div class="inline-form">
                    <div class="form-group">
                        <label>Medication Name</label>
                        <input type="text" id="medName" placeholder="e.g., Sertraline">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>Strength (mg)</label>
                        <input type="number" id="medStrength" placeholder="50">
                    </div>
                    <div class="form-group" style="max-width: 80px;">
                        <label>Quantity</label>
                        <input type="number" id="medQty" placeholder="1" value="1">
                    </div>
                    <button class="btn" onclick="addMedication()" style="width: auto; padding: 12px 20px;">+ Add</button>
                </div>
                <div id="medList" class="med-list"></div>
                
                <div class="form-group">
                    <label>Journal Notes</label>
                    <textarea id="moodNotes" placeholder="How are you feeling? Any specific thoughts or events?"></textarea>
                </div>
                
                <button class="btn" onclick="logMood()">Save Full Check-In</button>
                <div id="moodMessage" class="hidden"></div>
            </div>
            
            <!-- Gratitude Journal Tab -->
            <div id="gratitudeTab" class="tab-content">
                <h3>Gratitude Journal</h3>
                <p style="color: #666; margin-bottom: 20px;">What are you grateful for today?</p>
                
                <div class="form-group">
                    <textarea id="gratitudeEntry" placeholder="Write about something you're grateful for today..."></textarea>
                </div>
                
                <button class="btn" onclick="logGratitude()">Save Entry</button>
                <div id="gratitudeMessage" class="hidden"></div>
            </div>
            
            <!-- CBT Tools Tab -->
            <div id="cbtTab" class="tab-content">
                <h3>Cognitive Behavioral Therapy Tools</h3>
                <p style="color: #666; margin-bottom: 20px;">Challenge negative thoughts and build healthier thinking patterns.</p>
                
                <div class="cbt-container">
                    <div class="form-group">
                        <label>What situation triggered this thought?</label>
                        <input type="text" id="cbtSituation" placeholder="e.g., Received critical feedback at work">
                    </div>
                    <div class="form-group">
                        <label>What automatic thought came to mind?</label>
                        <textarea id="cbtThought" placeholder="e.g., I'm terrible at my job and everyone thinks so"></textarea>
                    </div>
                    <div class="form-group">
                        <label>What evidence challenges this thought?</label>
                        <textarea id="cbtEvidence" placeholder="e.g., I received positive feedback last week, my manager praised my recent project"></textarea>
                    </div>
                    <button class="btn" onclick="saveCBT()">Save Thought Record</button>
                    <div id="cbtMessage" class="hidden"></div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h4>Breathing Exercise</h4>
                    <p style="color: #666; margin-bottom: 10px;">Follow the guided 4-7-8 breathing technique.</p>
                    <button class="btn" onclick="startBreathing()">Start Breathing Exercise</button>
                    <div id="breathingDisplay" class="hidden" style="text-align: center; padding: 40px; font-size: 24px; font-weight: bold;"></div>
                </div>
            </div>
            
            <!-- Pet Game Tab -->
            <div id="petTab" class="tab-content">
                <div id="petCreate" class="hidden">
                    <h3>Adopt Your Companion</h3>
                    <p style="color: #666; margin-bottom: 20px;">Choose a virtual pet to care for as you care for yourself.</p>
                    
                    <div class="form-group">
                        <label>Pet Name</label>
                        <input type="text" id="petName" placeholder="e.g., Buddy">
                    </div>
                    <div class="form-group">
                        <label>Species</label>
                        <select id="petSpecies" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Dog">üê∂ Dog</option>
                            <option value="Cat">üê± Cat</option>
                            <option value="Rabbit">üê∞ Rabbit</option>
                            <option value="Fox">ü¶ä Fox</option>
                            <option value="Panda">üêº Panda</option>
                            <option value="Penguin">üêß Penguin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="petGender" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Neutral">Neutral</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createPet()">Adopt Pet!</button>
                </div>
                
                <div id="petDisplay" class="hidden">
                    <div class="pet-container">
                        <h3 style="text-align: center; margin-bottom: 10px;" id="petNameDisplay"></h3>
                        <div class="pet-display" id="petEmojiDisplay"></div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 18px;">ü™ô Coins: <span id="petCoins">0</span></div>
                            <div style="font-size: 14px; margin-top: 5px;">‚≠ê XP: <span id="petXP">0</span> (<span id="petStage">Baby</span>)</div>
                        </div>
                        <div class="pet-stats">
                            <div class="stat-bar">
                                <label>Hunger</label>
                                <div class="progress-bar"><div class="progress-fill" id="hungerBar"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>Happiness</label>
                                <div class="progress-bar"><div class="progress-fill" id="happinessBar"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>Energy</label>
                                <div class="progress-bar"><div class="progress-fill" id="energyBar"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>Hygiene</label>
                                <div class="progress-bar"><div class="progress-fill" id="hygieneBar"></div></div>
                            </div>
                        </div>
                    </div>
                    <p style="color: #666; text-align: center; margin-top: 20px;">
                        üí° Earn coins and XP by completing self-care actions! Your pet grows as you grow.
                    </p>
                </div>
            </div>
            
            <!-- Clinical Assessments Tab -->
            <div id="clinicalTab" class="tab-content">
                <h3>Clinical Assessments</h3>
                <p style="color: #666; margin-bottom: 20px;">Track your mental health with validated clinical scales.</p>
                
                <div class="grid-2">
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>PHQ-9 (Depression)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">9-question screening for depression severity.</p>
                        <button class="btn" onclick="startPHQ9()">Start PHQ-9</button>
                    </div>
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>GAD-7 (Anxiety)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">7-question screening for anxiety severity.</p>
                        <button class="btn" onclick="startGAD7()">Start GAD-7</button>
                    </div>
                </div>
                
                <div id="assessmentModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 id="assessmentTitle"></h3>
                        <div id="assessmentQuestions"></div>
                        <button class="btn" onclick="submitAssessment()">Submit</button>
                        <button class="btn btn-secondary" onclick="closeAssessment()">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h3>Your Progress</h3>
                <p style="color: #666; margin-bottom: 20px;">View your mood history and wellness patterns.</p>
                
                <button class="btn" onclick="loadHistory()" style="margin-bottom: 20px;">Load My History</button>
                
                <div id="historyContent">
                    <p style="text-align: center; color: #999; padding: 40px;">Click "Load My History" to view your mood logs</p>
                </div>
            </div>
            
            <!-- Community Support Tab -->
            <div id="communityTab" class="tab-content">
                <h3>Community Support Board</h3>
                <p style="color: #666; margin-bottom: 20px;">Connect with others on their mental health journey.</p>
                
                <div class="card">
                    <h4>Share Your Message</h4>
                    <textarea id="communityMessage" rows="4" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px;" placeholder="Share encouragement, hope, or ask for support..."></textarea>
                    <button class="btn" onclick="postCommunity()">Post Message</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Recent Posts</h4>
                    <button class="btn btn-secondary" onclick="loadCommunity()" style="margin-bottom: 15px;">Refresh Posts</button>
                    <div id="communityPosts">
                        <p style="text-align: center; color: #999;">Click "Refresh Posts" to load community messages</p>
                    </div>
                </div>
            </div>
            
            <!-- Safety Plan Tab -->
            <div id="safetyTab" class="tab-content">
                <h3>üÜò My Safety Plan</h3>
                <p style="color: #666; margin-bottom: 20px;">Create a plan for when you're feeling in crisis.</p>
                
                <div class="card">
                    <div class="form-group">
                        <label><strong>Warning Signs/Triggers:</strong></label>
                        <textarea id="safetyTriggers" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="What triggers distress for me..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Coping Strategies:</strong></label>
                        <textarea id="safetyCoping" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="What helps me calm down..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Support Contacts:</strong></label>
                        <textarea id="safetySupport" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="Friends/family I can call..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Professional Contacts:</strong></label>
                        <textarea id="safetyProfessional" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="Therapist, crisis hotline numbers..."></textarea>
                    </div>
                    
                    <button class="btn" onclick="saveSafetyPlan()">Save Safety Plan</button>
                    <button class="btn btn-secondary" onclick="loadSafetyPlan()">Load Saved Plan</button>
                </div>
                
                <div class="card" style="margin-top: 20px; background: #ffebee;">
                    <h4 style="color: #c62828;">üö® Crisis Resources</h4>
                    <p><strong>988 Suicide & Crisis Lifeline:</strong> Call or text 988 (US)</p>
                    <p><strong>Crisis Text Line:</strong> Text HOME to 741741</p>
                    <p><strong>International:</strong> <a href="https://findahelpline.com" target="_blank">findahelpline.com</a></p>
                </div>
            </div>
            
            <!-- Progress Insights Tab -->
            <div id="insightsTab" class="tab-content">
                <h3>üí° Progress Insights & Export</h3>
                <p style="color: #666; margin-bottom: 20px;">View AI-generated insights and export your data.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="loadInsights()">Generate Insights</button>
                    <button class="btn" onclick="exportCSV()" style="background: #34495e;">üì• Export CSV</button>
                    <button class="btn" onclick="exportPDF()" style="background: #e74c3c;">üìÑ Export PDF</button>
                </div>
                
                <div id="insightsContent">
                    <div class="card">
                        <h4>Your Stats</h4>
                        <div id="statsDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value" id="avgMood">-</div>
                                <div class="stat-label">Average Mood</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgSleep">-</div>
                                <div class="stat-label">Average Sleep</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="moodTrend">-</div>
                                <div class="stat-label">Trend</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>AI Insights</h4>
                        <div id="aiInsight" style="padding: 20px; background: #f5f5f5; border-radius: 12px; line-height: 1.6;">
                            <p style="color: #999;">Click "Generate Insights" to get personalized analysis of your progress.</p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>Mood Trend (Last 7 Entries)</h4>
                        <canvas id="moodChart" width="600" height="200" style="max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Sleep Hygiene Tab -->
            <div id="sleepTab" class="tab-content">
                <h3>üò¥ Sleep Hygiene Checklist</h3>
                <p style="color: #666; margin-bottom: 20px;">Complete your bedtime routine for better sleep.</p>
                
                <div class="card">
                    <h4>Bedtime Routine</h4>
                    <p style="margin-bottom: 15px;">Check off each task as you complete it:</p>
                    
                    <div class="sleep-checklist">
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üí° Lights Dimmed (at least 1 hour before bed)</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üì± Phone on Do Not Disturb</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üì∫ No Screens for 30 mins</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üôè Gratitude Recorded</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üßò Deep Breathing Done</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üõèÔ∏è Bedroom Cool & Dark</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üìñ Reading Something Calming</span>
                        </label>
                    </div>
                    
                    <button class="btn" onclick="resetSleepChecklist()" style="margin-top: 20px;">Reset Checklist</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Sleep Tips</h4>
                    <ul style="line-height: 1.8; color: #555;">
                        <li>Maintain a consistent sleep schedule (same bedtime & wake time)</li>
                        <li>Avoid caffeine after 2 PM</li>
                        <li>Keep bedroom temperature between 60-67¬∞F (15-19¬∞C)</li>
                        <li>Use your bed only for sleep (not work or TV)</li>
                        <li>If you can't sleep after 20 minutes, get up and do a calm activity</li>
                    </ul>
                </div>
            </div>
            
            <!-- Professional Dashboard Tab -->
            <div id="professionalTab" class="tab-content">
                <h3>üë®‚Äç‚öïÔ∏è Professional Dashboard</h3>
                <p style="color: #666; margin-bottom: 20px;">Overview of all patients under your care.</p>
                
                <button class="btn" onclick="loadPatients()" style="margin-bottom: 20px;">Load Patient List</button>
                
                <div id="patientList">
                    <p style="text-align: center; color: #999; padding: 40px;">Click "Load Patient List" to view all patients</p>
                </div>
                
                <div id="patientDetail" style="display: none;" class="card">
                    <button class="btn btn-secondary" onclick="closeProfessionalDetail()" style="margin-bottom: 15px;">‚Üê Back to Patient List</button>
                    <h4 id="patientDetailName"></h4>
                    <div id="patientDetailContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let currentUserRole = 'user';
        let selectedMoodValue = null;
        let medications = [];
        let currentAssessment = null;
        let assessmentScores = [];
        
        const speciesEmojis = {Dog: 'üê∂', Cat: 'üê±', Rabbit: 'üê∞', Fox: 'ü¶ä', Panda: 'üêº', Penguin: 'üêß'};
        
        const PHQ9_QUESTIONS = [
            "Little interest or pleasure in doing things",
            "Feeling down, depressed, or hopeless",
            "Trouble falling/staying asleep, or sleeping too much",
            "Feeling tired or having little energy",
            "Poor appetite or overeating",
            "Feeling bad about yourself or that you are a failure",
            "Trouble concentrating on things",
            "Moving or speaking slowly, or being fidgety/restless",
            "Thoughts that you would be better off dead or hurting yourself"
        ];
        
        const GAD7_QUESTIONS = [
            "Feeling nervous, anxious or on edge",
            "Not being able to stop or control worrying",
            "Worrying too much about different things",
            "Trouble relaxing",
            "Being so restless that it is hard to sit still",
            "Becoming easily annoyed or irritable",
            "Feeling afraid as if something awful might happen"
        ];
        
        // Auth Functions
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAuthMessage('Please enter username and password', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = username;
                    currentUserRole = data.role || 'user';
                    document.getElementById('usernameDisplay').textContent = `Welcome, ${username}!`;
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('appScreen').style.display = 'block';
                    
                    // Show professional tab only for clinicians
                    if (currentUserRole === 'clinician') {
                        document.getElementById('professionalTabBtn').style.display = 'block';
                    }
                    
                    addSystemMessage('Welcome to Healing Space! How are you feeling today?');
                    loadPetStatus();
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }
        
        async function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const pin = document.getElementById('regPin').value;
            const clinician_id = document.getElementById('regClinician').value;
            
            if (!username || !password || !pin) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (!clinician_id) {
                showAuthMessage('Please select your clinician', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showAuthMessage('PIN must be 4 digits', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, pin, clinician_id })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Account created successfully! Please login.', 'success');
                    setTimeout(() => {
                        showLogin();
                        document.getElementById('loginUsername').value = username;
                    }, 2000);
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Register error:', error);
            }
        }
        
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('authMessage').classList.add('hidden');
        }
        
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('authMessage').classList.add('hidden');
            loadCliniciansForRegistration();
        }
        
        function showClinicianRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.remove('hidden');
            document.getElementById('authMessage').classList.add('hidden');
        }
        
        async function registerClinician() {
            const username = document.getElementById('clinicianUsername').value.trim();
            const password = document.getElementById('clinicianPassword').value;
            const full_name = document.getElementById('clinicianFullName').value.trim();
            
            if (!username || !password) {
                showAuthMessage('Please fill in username and password', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/clinician/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, full_name })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Clinician account created successfully! Please login.', 'success');
                    setTimeout(() => {
                        showLogin();
                        document.getElementById('loginUsername').value = username;
                    }, 2000);
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Clinician register error:', error);
            }
        }
        
        async function loadCliniciansForRegistration() {
            try {
                const response = await fetch('/api/clinicians/list');
                const data = await response.json();
                
                const select = document.getElementById('regClinician');
                if (response.ok && data.clinicians && data.clinicians.length > 0) {
                    select.innerHTML = '<option value="">-- Select your clinician --</option>' +
                        data.clinicians.map(c => 
                            `<option value="${c.username}">${c.full_name || c.username}</option>`
                        ).join('');
                } else {
                    select.innerHTML = '<option value="">No clinicians available yet</option>';
                }
            } catch (error) {
                console.error('Error loading clinicians:', error);
                document.getElementById('regClinician').innerHTML = '<option value="">Error loading clinicians</option>';
            }
        }
        
        function showAuthMessage(message, type) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.textContent = message;
            msgDiv.className = `alert alert-${type}`;
            msgDiv.classList.remove('hidden');
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                currentUserRole = 'user';
                document.getElementById('professionalTabBtn').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                selectedMoodValue = null;
                medications = [];
            }
        }
        
        // Tab Navigation
        function switchTab(tabName, buttonEl) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            buttonEl.classList.add('active');
            
            // Load pet when switching to pet tab
            if (tabName === 'pet') {
                loadPetStatus();
            }
        }
        
        // Chat Functions
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading
            const loadingId = Date.now();
            addMessage('<div class="loading"></div>', 'ai', loadingId);
            
            try {
                const response = await fetch('/api/therapy/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, message })
                });
                
                const data = await response.json();
                
                // Remove loading
                const loadingEl = document.getElementById('msg-' + loadingId);
                if (loadingEl) loadingEl.remove();
                
                if (response.ok) {
                    addMessage(data.response, 'ai');
                    // Reward pet for therapy session
                    await rewardPet('therapy');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            } catch (error) {
                document.getElementById('msg-' + loadingId)?.remove();
                addMessage('Connection error. Please check your internet.', 'ai');
                console.error('Chat error:', error);
            }
        }
        
        function addMessage(text, sender, id) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            if (id) messageEl.id = 'msg-' + id;
            messageEl.innerHTML = text;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addSystemMessage(text) {
            addMessage(text, 'ai');
        }
        
        // Mood Tracking
        function selectMood(value, element) {
            selectedMoodValue = value;
            document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function addMedication() {
            const name = document.getElementById('medName').value.trim();
            const strength = document.getElementById('medStrength').value.trim();
            const qty = document.getElementById('medQty').value.trim() || '1';
            
            if (!name) {
                showMessage('moodMessage', 'Please enter medication name', 'error');
                return;
            }
            
            medications.push({name, strength, quantity: qty});
            updateMedList();
            
            // Clear inputs
            document.getElementById('medName').value = '';
            document.getElementById('medStrength').value = '';
            document.getElementById('medQty').value = '1';
        }
        
        function updateMedList() {
            const listEl = document.getElementById('medList');
            listEl.innerHTML = medications.map((med, idx) => `
                <div class="med-item">
                    <span>${med.name} ${med.strength}mg (x${med.quantity})</span>
                    <button onclick="removeMed(${idx})">Remove</button>
                </div>
            `).join('');
        }
        
        function removeMed(index) {
            medications.splice(index, 1);
            updateMedList();
        }
        
        async function logMood() {
            if (!selectedMoodValue) {
                showMessage('moodMessage', 'Please select a mood level', 'error');
                return;
            }
            
            const sleep = parseFloat(document.getElementById('sleepHours').value) || 0;
            const water = parseFloat(document.getElementById('waterPints').value) || 0;
            const exercise = parseInt(document.getElementById('exerciseMins').value) || 0;
            const outside = parseInt(document.getElementById('outsideMins').value) || 0;
            const notes = document.getElementById('moodNotes').value.trim();
            
            try {
                const response = await fetch('/api/mood/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        mood_val: selectedMoodValue,
                        sleep_val: sleep,
                        water_pints: water,
                        exercise_mins: exercise,
                        outside_mins: outside,
                        meds: medications,
                        notes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('moodMessage', 'Mood logged successfully! üéâ Keep tracking your progress! (+5 Coins)', 'success');
                    // Reward pet
                    await rewardPet('mood');
                    // Clear form
                    selectedMoodValue = null;
                    medications = [];
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    document.getElementById('sleepHours').value = '';
                    document.getElementById('waterPints').value = '';
                    document.getElementById('exerciseMins').value = '';
                    document.getElementById('outsideMins').value = '';
                    document.getElementById('moodNotes').value = '';
                    updateMedList();
                } else {
                    showMessage('moodMessage', data.error || 'Failed to log mood', 'error');
                }
            } catch (error) {
                showMessage('moodMessage', 'Connection error. Please try again.', 'error');
                console.error('Mood log error:', error);
            }
        }
        
        // Gratitude Journal
        async function logGratitude() {
            const entry = document.getElementById('gratitudeEntry').value.trim();
            
            if (!entry) {
                showMessage('gratitudeMessage', 'Please write something you\'re grateful for', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/gratitude/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, entry })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('gratitudeMessage', 'Gratitude entry saved! üôè Practice makes perfect! (+5 Coins)', 'success');
                    await rewardPet('gratitude');
                    document.getElementById('gratitudeEntry').value = '';
                } else {
                    showMessage('gratitudeMessage', data.error || 'Failed to save entry', 'error');
                }
            } catch (error) {
                showMessage('gratitudeMessage', 'Connection error. Please try again.', 'error');
                console.error('Gratitude log error:', error);
            }
        }
        
        // CBT Tools
        async function saveCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const thought = document.getElementById('cbtThought').value.trim();
            const evidence = document.getElementById('cbtEvidence').value.trim();
            
            if (!situation || !thought) {
                showMessage('cbtMessage', 'Please fill in situation and thought fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/cbt/thought-record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, situation, thought, evidence })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('cbtMessage', 'Thought record saved! üß† Great work challenging your thoughts!', 'success');
                    document.getElementById('cbtSituation').value = '';
                    document.getElementById('cbtThought').value = '';
                    document.getElementById('cbtEvidence').value = '';
                } else {
                    showMessage('cbtMessage', data.error || 'Failed to save record', 'error');
                }
            } catch (error) {
                showMessage('cbtMessage', 'Connection error. Please try again.', 'error');
            }
        }
        
        async function startBreathing() {
            const display = document.getElementById('breathingDisplay');
            display.classList.remove('hidden');
            
            for (let cycle = 0; cycle < 3; cycle++) {
                display.textContent = 'Breathe IN for 4...';
                await sleep(4000);
                display.textContent = 'HOLD for 7...';
                await sleep(7000);
                display.textContent = 'Breathe OUT for 8...';
                await sleep(8000);
            }
            
            display.textContent = '‚úÖ Exercise Complete! Well done!';
            await rewardPet('breathing');
            setTimeout(() => display.classList.add('hidden'), 3000);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Pet Game
        async function loadPetStatus() {
            try {
                const response = await fetch(`/api/pet/status?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (data.exists) {
                    document.getElementById('petCreate').classList.add('hidden');
                    document.getElementById('petDisplay').classList.remove('hidden');
                    updatePetDisplay(data.pet);
                } else {
                    document.getElementById('petCreate').classList.remove('hidden');
                    document.getElementById('petDisplay').classList.add('hidden');
                }
            } catch (error) {
                console.error('Pet load error:', error);
            }
        }
        
        async function createPet() {
            const name = document.getElementById('petName').value.trim();
            const species = document.getElementById('petSpecies').value;
            const gender = document.getElementById('petGender').value;
            
            if (!name) {
                alert('Please enter a pet name');
                return;
            }
            
            try {
                const response = await fetch('/api/pet/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, species, gender })
                });
                
                if (response.ok) {
                    alert(`${name} adopted! üéâ Take good care of your companion!`);
                    loadPetStatus();
                }
            } catch (error) {
                console.error('Pet create error:', error);
            }
        }
        
        function updatePetDisplay(pet) {
            document.getElementById('petNameDisplay').textContent = pet.name;
            document.getElementById('petEmojiDisplay').textContent = speciesEmojis[pet.species] || 'üêæ';
            document.getElementById('petCoins').textContent = pet.coins;
            document.getElementById('petXP').textContent = pet.xp;
            document.getElementById('petStage').textContent = pet.stage;
            
            document.getElementById('hungerBar').style.width = pet.hunger + '%';
            document.getElementById('happinessBar').style.width = pet.happiness + '%';
            document.getElementById('energyBar').style.width = pet.energy + '%';
            document.getElementById('hygieneBar').style.width = pet.hygiene + '%';
        }
        
        async function rewardPet(action) {
            try {
                const response = await fetch('/api/pet/reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Refresh pet display if on pet tab
                        if (document.getElementById('petTab').classList.contains('active')) {
                            loadPetStatus();
                        }
                    }
                }
            } catch (error) {
                console.error('Pet reward error:', error);
            }
        }
        
        // Clinical Assessments
        function startPHQ9() {
            currentAssessment = 'PHQ-9';
            assessmentScores = [];
            showAssessmentModal('PHQ-9 Depression Screening', PHQ9_QUESTIONS);
        }
        
        function startGAD7() {
            currentAssessment = 'GAD-7';
            assessmentScores = [];
            showAssessmentModal('GAD-7 Anxiety Screening', GAD7_QUESTIONS);
        }
        
        function showAssessmentModal(title, questions) {
            document.getElementById('assessmentTitle').textContent = title;
            const container = document.getElementById('assessmentQuestions');
            container.innerHTML = questions.map((q, idx) => `
                <div style="margin: 20px 0; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="margin-bottom: 10px; font-weight: 600;">${idx + 1}. ${q}</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="0" onchange="setScore(${idx}, 0)"> Not at all
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="1" onchange="setScore(${idx}, 1)"> Several days
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="2" onchange="setScore(${idx}, 2)"> More than half
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="3" onchange="setScore(${idx}, 3)"> Nearly every day
                        </label>
                    </div>
                </div>
            `).join('');
            document.getElementById('assessmentModal').classList.remove('hidden');
        }
        
        function setScore(index, value) {
            assessmentScores[index] = parseInt(value);
        }
        
        async function submitAssessment() {
            const expectedLength = currentAssessment === 'PHQ-9' ? 9 : 7;
            
            if (assessmentScores.length !== expectedLength || assessmentScores.includes(undefined)) {
                alert('Please answer all questions');
                return;
            }
            
            try {
                const endpoint = currentAssessment === 'PHQ-9' ? '/api/clinical/phq9' : '/api/clinical/gad7';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, scores: assessmentScores })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Assessment Complete!\n\nScore: ${data.score}\nSeverity: ${data.severity}\n\nConsult with a mental health professional for personalized care.`);
                    closeAssessment();
                } else {
                    alert('Error submitting assessment');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Assessment error:', error);
            }
        }
        
        function closeAssessment() {
            document.getElementById('assessmentModal').classList.add('hidden');
            assessmentScores = [];
            currentAssessment = null;
        }
        
        // History
        async function loadHistory() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading your history...</p></div>';
            
            try {
                const response = await fetch(`/api/mood/history?username=${encodeURIComponent(currentUser)}&limit=30`);
                const data = await response.json();
                
                if (response.ok && data.logs && data.logs.length > 0) {
                    const moodEmojis = {1: 'üò¢', 2: 'üò¢', 3: 'üòî', 4: 'üòî', 5: 'üòê', 6: 'üòê', 7: 'üôÇ', 8: 'üôÇ', 9: 'üòÑ', 10: 'üòÑ'};
                    const html = '<div class="history-grid">' + 
                        data.logs.map(log => `
                            <div class="history-card">
                                <div class="date">${new Date(log.timestamp).toLocaleString()}</div>
                                <div style="font-size: 24px; margin: 10px 0;">${moodEmojis[log.mood_val]} <strong>${log.mood_val}/10</strong></div>
                                <div><strong>Sleep:</strong> ${log.sleep_val} hours</div>
                                ${log.water_pints ? `<div><strong>Water:</strong> ${log.water_pints} pints</div>` : ''}
                                ${log.exercise_mins ? `<div><strong>Exercise:</strong> ${log.exercise_mins} mins</div>` : ''}
                                ${log.outside_mins ? `<div><strong>Outdoors:</strong> ${log.outside_mins} mins</div>` : ''}
                                ${log.meds ? `<div><strong>Medications:</strong> ${log.meds}</div>` : ''}
                                ${log.notes ? `<div style="margin-top: 10px;"><strong>Notes:</strong><br>${log.notes}</div>` : ''}
                            </div>
                        `).join('') +
                        '</div>';
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = 
                        '<p style="text-align: center; color: #999; padding: 40px;">No mood logs yet. Start tracking in the Mood & Habits tab! üìä</p>';
                }
            } catch (error) {
                historyContent.innerHTML = 
                    '<p style="text-align: center; color: #dc3545; padding: 40px;">Error loading history. Please try again.</p>';
                console.error('History load error:', error);
            }
        }
        
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `alert alert-${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        // Community Functions
        async function loadCommunity() {
            const postsDiv = document.getElementById('communityPosts');
            postsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch('/api/community/posts');
                const data = await response.json();
                
                if (response.ok && data.posts && data.posts.length > 0) {
                    const html = data.posts.map(post => `
                        <div class="community-post">
                            <div class="post-header">
                                <strong>${post.username}</strong>
                                <span>${new Date(post.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="post-message">${post.message}</div>
                            <div class="post-likes">‚ù§Ô∏è ${post.likes} likes</div>
                        </div>
                    `).join('');
                    postsDiv.innerHTML = html;
                } else {
                    postsDiv.innerHTML = '<p style="text-align: center; color: #999;">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                postsDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading posts</p>';
                console.error('Community load error:', error);
            }
        }
        
        async function postCommunity() {
            const message = document.getElementById('communityMessage').value.trim();
            
            if (!message) {
                alert('Please write a message before posting');
                return;
            }
            
            try {
                const response = await fetch('/api/community/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, message })
                });
                
                if (response.ok) {
                    document.getElementById('communityMessage').value = '';
                    alert('Message posted successfully!');
                    loadCommunity();
                } else {
                    alert('Error posting message');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Post error:', error);
            }
        }
        
        // Safety Plan Functions
        async function loadSafetyPlan() {
            try {
                const response = await fetch(`/api/safety-plan?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('safetyTriggers').value = data.triggers || '';
                    document.getElementById('safetyCoping').value = data.coping_strategies || '';
                    document.getElementById('safetySupport').value = data.support_contacts || '';
                    document.getElementById('safetyProfessional').value = data.professional_contacts || '';
                    alert('Safety plan loaded successfully');
                } else {
                    alert('Error loading safety plan');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Safety plan load error:', error);
            }
        }
        
        async function saveSafetyPlan() {
            const triggers = document.getElementById('safetyTriggers').value;
            const coping = document.getElementById('safetyCoping').value;
            const support = document.getElementById('safetySupport').value;
            const professional = document.getElementById('safetyProfessional').value;
            
            try {
                const response = await fetch('/api/safety-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        triggers,
                        coping_strategies: coping,
                        support_contacts: support,
                        professional_contacts: professional
                    })
                });
                
                if (response.ok) {
                    alert('Safety plan saved successfully!');
                } else {
                    alert('Error saving safety plan');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Safety plan save error:', error);
            }
        }
        
        // Insights Functions
        async function loadInsights() {
            try {
                const response = await fetch(`/api/insights?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('avgMood').textContent = data.avg_mood.toFixed(1);
                    document.getElementById('avgSleep').textContent = data.avg_sleep.toFixed(1) + 'h';
                    document.getElementById('moodTrend').textContent = data.trend;
                    document.getElementById('aiInsight').innerHTML = `<p>${data.insight}</p>`;
                    
                    // Draw mood chart
                    if (data.mood_data && data.mood_data.length > 0) {
                        drawMoodChart(data.mood_data);
                    }
                } else {
                    alert('Error loading insights');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Insights load error:', error);
            }
        }
        
        function drawMoodChart(moodData) {
            const canvas = document.getElementById('moodChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = height - padding - (i * (height - 2 * padding) / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i, padding - 10, y + 4);
            }
            
            // Draw line
            if (moodData.length > 1) {
                const stepX = (width - 2 * padding) / (moodData.length - 1);
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moodData.forEach((point, index) => {
                    const x = padding + index * stepX;
                    const y = height - padding - (point.value * (height - 2 * padding) / 10);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            moodData.forEach((point, index) => {
                const x = padding + index * ((width - 2 * padding) / (moodData.length - 1));
                const date = new Date(point.timestamp);
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                ctx.fillText(label, x, height - padding + 20);
            });
        }
        
        async function exportCSV() {
            window.location.href = `/api/export/csv?username=${encodeURIComponent(currentUser)}`;
        }
        
        async function exportPDF() {
            window.location.href = `/api/export/pdf?username=${encodeURIComponent(currentUser)}`;
        }
        
        // Sleep Hygiene Functions
        function resetSleepChecklist() {
            document.querySelectorAll('.sleep-check').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Professional Dashboard Functions
        async function loadPatients() {
            if (currentUserRole !== 'clinician') {
                alert('Access denied. Professional dashboard is only for clinicians.');
                return;
            }
            
            const listDiv = document.getElementById('patientList');
            listDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/professional/patients?clinician=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    const html = data.patients.map(patient => `
                        <div class="patient-card" onclick="viewPatientDetail('${patient.username}')">
                            <div class="patient-header">
                                <strong style="font-size: 18px;">${patient.username}</strong>
                                ${patient.alert_count_7d > 0 ? `<span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üö® ${patient.alert_count_7d} alerts</span>` : ''}
                            </div>
                            <div class="patient-stats">
                                <div class="patient-stat">
                                    <div class="patient-stat-value">${patient.avg_mood_7d}</div>
                                    <div class="patient-stat-label">Avg Mood (7d)</div>
                                </div>
                                <div class="patient-stat">
                                    <div class="patient-stat-value">${patient.latest_assessment ? patient.latest_assessment.score : 'N/A'}</div>
                                    <div class="patient-stat-label">${patient.latest_assessment ? patient.latest_assessment.name : 'No Assessment'}</div>
                                </div>
                                <div class="patient-stat">
                                    <div class="patient-stat-value" style="color: ${getSeverityColor(patient.latest_assessment?.severity)}">${patient.latest_assessment?.severity || '-'}</div>
                                    <div class="patient-stat-label">Severity</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999;">No patients found</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading patients</p>';
                console.error('Patient load error:', error);
            }
        }
        
        async function viewPatientDetail(username) {
            document.getElementById('patientList').style.display = 'none';
            document.getElementById('patientDetail').style.display = 'block';
            document.getElementById('patientDetailName').textContent = username;
            document.getElementById('patientDetailContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/professional/patient/${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (response.ok) {
                    let html = `
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>Profile</h4>
                            <p><strong>Name:</strong> ${data.profile.name || 'Not provided'}</p>
                            <p><strong>DOB:</strong> ${data.profile.dob || 'Not provided'}</p>
                            <p><strong>Conditions:</strong> ${data.profile.conditions || 'Not provided'}</p>
                        </div>
                        
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>Recent Mood Logs</h4>
                            ${data.recent_moods.map(m => `
                                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                    <strong>Mood:</strong> ${m.mood}/10 | <strong>Sleep:</strong> ${m.sleep}h | ${new Date(m.timestamp).toLocaleDateString()}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>Clinical Assessments</h4>
                            ${data.clinical_scales.length > 0 ? data.clinical_scales.map(s => `
                                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                    <strong>${s.name}:</strong> Score ${s.score} (${s.severity}) | ${new Date(s.timestamp).toLocaleDateString()}
                                </div>
                            `).join('') : '<p>No assessments yet</p>'}
                        </div>
                        
                        <div class="card">
                            <h4>Recent Alerts</h4>
                            ${data.recent_alerts.length > 0 ? data.recent_alerts.map(a => `
                                <div style="padding: 8px; border-bottom: 1px solid #eee; background: #ffebee; margin-bottom: 4px; border-radius: 4px;">
                                    <strong>${a.type}:</strong> ${a.message} | ${new Date(a.timestamp).toLocaleString()}
                                </div>
                            `).join('') : '<p style="color: #28a745;">No recent alerts</p>'}
                        </div>
                    `;
                    document.getElementById('patientDetailContent').innerHTML = html;
                } else {
                    document.getElementById('patientDetailContent').innerHTML = '<p style="color: #dc3545;">Error loading patient data</p>';
                }
            } catch (error) {
                document.getElementById('patientDetailContent').innerHTML = '<p style="color: #dc3545;">Connection error</p>';
                console.error('Patient detail error:', error);
            }
        }
        
        function closeProfessionalDetail() {
            document.getElementById('patientList').style.display = 'block';
            document.getElementById('patientDetail').style.display = 'none';
        }
        
        function getSeverityColor(severity) {
            if (!severity) return '#999';
            const colors = {
                'Minimal': '#28a745',
                'Mild': '#ffc107',
                'Moderate': '#fd7e14',
                'Moderately Severe': '#dc3545',
                'Severe': '#dc3545'
            };
            return colors[severity] || '#999';
        }
        
        // Initialize
        console.log('Healing Space Complete Edition initialized');
    </script>
</body>
</html>