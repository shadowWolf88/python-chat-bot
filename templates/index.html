<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Healing Space - Mental Health Companion [v2026.01.17]</title>
    <script>
        // Functions moved to head to be available for onclick handlers
        function showLanding() {
            hideAllAuthForms();
            document.getElementById('landingPage').classList.remove('hidden');
        }
        
        function showPatientAuth() {
            hideAllAuthForms();
            document.getElementById('patientLoginForm').classList.remove('hidden');
        }
        
        function showClinicianAuth() {
            hideAllAuthForms();
            document.getElementById('clinicianLoginForm').classList.remove('hidden');
        }

        function hideAllAuthForms() {
            // This function will be called by the functions above, so it needs to be here too.
            // It might be defined again later, which is fine.
            const authBox = document.querySelector('.auth-box');
            if (!authBox) return;
            const forms = authBox.querySelectorAll('.hidden');
            forms.forEach(form => {
                if (form.id) { 
                    form.classList.add('hidden');
                }
            });
            const authMessage = document.getElementById('authMessage');
            if(authMessage) authMessage.classList.add('hidden');

            // Explicitly show/hide forms
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientLoginForm').classList.add('hidden');
            document.getElementById('clinicianLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            pointer-events: auto;
        }
        
        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .auth-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            padding: 40px;
            position: relative;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .auth-box * {
            pointer-events: auto;
        }
        
        .auth-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .auth-box .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 1002;
            pointer-events: auto;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .app-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .app-header h2 {
            color: #667eea;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-content {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 220px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 0;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .tab-btn {
            display: block;
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: white;
            font-size: 14px;
            border-left: 4px solid transparent;
            margin-bottom: 5px;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            border-left-color: white;
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-left-color: #ffd700;
            font-weight: 700;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chat Interface */
        .chat-container {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: slideIn 0.3s;
            word-wrap: break-word;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: white;
            border: 2px solid #e0e0e0;
        }
        
        .chat-input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .chat-input-area button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Mood Tracker */
        .mood-scale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .mood-option {
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mood-option:hover, .mood-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
        }
        
        .mood-option .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Medication List */
        .med-list {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            min-height: 60px;
            margin: 10px 0;
        }
        
        .med-item {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .med-item button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Pet Display */
        .pet-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        
        .pet-display {
            text-align: center;
            font-size: 80px;
            margin: 20px 0;
        }
        
        .pet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .stat-bar label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
        
        /* History Cards */
        .history-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .history-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .history-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        
        .history-card .date {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* CBT Tools */
        .cbt-container {
            display: grid;
            gap: 20px;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            animation: slideIn 0.3s;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .hidden {
            display: none !important;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        .inline-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .inline-form .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .sleep-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sleep-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sleep-item:hover {
            background: #e8e8e8;
        }
        
        .sleep-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .sleep-item span {
            font-size: 16px;
        }
        
        .community-post {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .community-post .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .community-post .post-message {
            line-height: 1.6;
            color: #333;
        }
        
        .community-post .post-likes {
            margin-top: 8px;
            color: #999;
            font-size: 13px;
        }
        
        .patient-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .patient-card .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .patient-card .patient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .patient-stat {
            text-align: center;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .patient-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .patient-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Notification Styles */
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            padding: 10px;
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 1000;
        }
        
        .notification-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .notification-body {
            max-height: 450px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .notification-item:hover {
            background: #f5f5f5;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
        }
        
        .notification-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .notification-item p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .notification-item small {
            color: #999;
            font-size: 12px;
        }
        
        /* Approval Styles */
        .approval-request {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .approval-request strong {
            color: #333;
            font-size: 16px;
        }
        
        .approval-request p {
            margin: 5px 0;
            color: #666;
            font-size: 13px;
        }
        
        /* Password Strength Bar */
        .password-strength-bar {
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .password-strength-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
            width: 0%;
            background-color: #ccc;
        }
        
        .password-strength-text {
            font-size: 12px;
            margin-top: 5px;
            color: #666;
        }
        
        /* Password Toggle */
        .password-field-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #999;
            padding: 5px;
            z-index: 10;
            user-select: none;
        }
        
        .password-toggle:hover {
            color: #667eea;
        }
        
        .password-field-wrapper input {
            padding-right: 45px;
        }
        
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
            }
            .tab-btn {
                min-width: 140px;
                border-left: none;
                border-bottom: 4px solid transparent;
                margin: 0 5px;
            }
            .tab-btn.active {
                border-bottom-color: #ffd700;
                border-left-color: transparent;
            }
            .mood-scale {
                grid-template-columns: repeat(2, 1fr);
            }
            .notification-panel {
                right: 10px;
                left: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <h1>üåø Healing Space</h1>
            <p class="subtitle">Complete Mental Health Companion</p>
            
            <!-- Landing Page -->
            <div id="landingPage">
                <h2 style="text-align: center; margin-bottom: 30px;">Welcome! Please select:</h2>
                <button class="btn" onclick="console.log('Patient button clicked'); showPatientAuth();" style="width: 100%; margin-bottom: 15px; padding: 20px; font-size: 18px;">
                    üë§ I'm a Patient
                </button>
                <button class="btn btn-secondary" onclick="console.log('Clinician button clicked'); showClinicianAuth();" style="width: 100%; padding: 20px; font-size: 18px;">
                    üë®‚Äç‚öïÔ∏è I'm a Clinician
                </button>
            </div>
            
            <!-- Patient Login Form -->
            <div id="patientLoginForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Patient Login</h3>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="loginPassword" placeholder="Enter password">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)" title="Show/Hide password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) - 2FA</label>
                    <input type="password" id="loginPin" placeholder="Enter your 4-digit PIN" maxlength="4">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin: 0;">
                    <label for="rememberMe" style="margin: 0; cursor: pointer;">Remember Me</label>
                </div>
                <button class="btn" onclick="login('user')">Login</button>
                <a href="#" onclick="showForgotPassword('patient'); return false;" style="display: block; text-align: center; margin: 15px 0; color: #667eea; text-decoration: none;">Forgot Password or PIN?</a>
                <button class="btn btn-secondary" onclick="showPatientRegister()">Create Patient Account</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <!-- Clinician Login Form -->
            <div id="clinicianLoginForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Clinician Login</h3>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="clinicianLoginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="clinicianLoginPassword" placeholder="Enter password">
                        <button type="button" class="password-toggle" onclick="togglePassword('clinicianLoginPassword', this)" title="Show/Hide password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) - 2FA</label>
                    <input type="password" id="clinicianLoginPin" placeholder="Enter your 4-digit PIN" maxlength="4">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="clinicianRememberMe" style="width: auto; margin: 0;">
                    <label for="clinicianRememberMe" style="margin: 0; cursor: pointer;">Remember Me</label>
                </div>
                <button class="btn" onclick="login('clinician')">Login</button>
                <a href="#" onclick="showForgotPassword('clinician'); return false;" style="display: block; text-align: center; margin: 15px 0; color: #667eea; text-decoration: none;">Forgot Password or PIN?</a>
                <button class="btn btn-secondary" onclick="showClinicianRegister()">Create Clinician Account</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <!-- Patient Registration Form -->
            <div id="registerForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Create Patient Account</h3>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="regFullName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Date of Birth *</label>
                    <input type="date" id="regDOB" required max="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label>Medical Conditions / Diagnosis *</label>
                    <textarea id="regConditions" placeholder="Please describe your current conditions or diagnosis (e.g., Depression, Anxiety, PTSD, etc.)" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 80px; font-family: inherit;"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">This helps your clinician provide better care</small>
                </div>
                <div class="form-group">
                    <label>Country *</label>
                    <input type="text" id="regCountry" placeholder="United Kingdom" required>
                </div>
                <div class="form-group">
                    <label>Area / Region *</label>
                    <input type="text" id="regArea" placeholder="London, Manchester, etc." required>
                </div>
                <div class="form-group">
                    <label>Postcode (optional)</label>
                    <input type="text" id="regPostcode" placeholder="SW1A 1AA">
                </div>
                <div class="form-group">
                    <label>NHS Number (optional)</label>
                    <input type="text" id="regNHS" placeholder="123 456 7890" maxlength="12">
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="regUsername" placeholder="Choose username" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="regPassword" placeholder="Min 8 chars, must include: number, letter, special char" oninput="checkPasswordStrength(this.value)" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regPassword', 'regPasswordToggle')" id="regPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                    <div id="passwordStrengthBar" style="height: 5px; background: #e0e0e0; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                        <div id="passwordStrengthFill" style="height: 100%; width: 0%; background: #dc3545; transition: all 0.3s;"></div>
                    </div>
                    <small id="passwordStrengthText" style="color: #999; display: block; margin-top: 3px;">Password strength: Weak</small>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="regConfirmPassword" placeholder="Re-enter password" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regConfirmPassword', 'regConfirmPasswordToggle')" id="regConfirmPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) *</label>
                    <div style="position: relative;">
                        <input type="password" id="regPin" placeholder="Choose 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regPin', 'regPinToggle')" id="regPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm PIN *</label>
                    <div style="position: relative;">
                        <input type="password" id="regConfirmPin" placeholder="Re-enter 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('regConfirmPin', 'regConfirmPinToggle')" id="regConfirmPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="regEmail" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="regPhone" placeholder="+1234567890" required>
                </div>
                <div class="form-group">
                    <label>Select Your Clinician *</label>
                    <select id="regClinician" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        <option value="">-- Loading clinicians --</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">Your assigned mental health professional</small>
                </div>
                <button class="btn" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="showPatientAuth()">Back to Login</button>
            </div>
            
            <!-- Clinician Registration Form -->
            <div id="clinicianRegisterForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Create Clinician Account</h3>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="clinicianUsername" placeholder="Choose username" required>
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="clinicianFullName" placeholder="Dr. Jane Smith" required>
                </div>
                <div class="form-group">
                    <label>Professional ID Number *</label>
                    <input type="text" id="clinicianProfessionalId" placeholder="License/Registration Number" required>
                    <small style="color: #666; display: block; margin-top: 5px;">e.g., Medical License, GMC number, NMC PIN, etc.</small>
                </div>
                <div class="form-group">
                    <label>Country *</label>
                    <input type="text" id="clinicianCountry" placeholder="United Kingdom" required>
                </div>
                <div class="form-group">
                    <label>Area / Region *</label>
                    <input type="text" id="clinicianArea" placeholder="London, Manchester, etc." required>
                    <small style="color: #666; display: block; margin-top: 5px;">Patients can filter by location to find you</small>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="clinicianEmail" placeholder="doctor@clinic.com" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="clinicianPhone" placeholder="+1234567890" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianPassword" placeholder="Choose password (min 8 chars)" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianPassword', 'clinicianPasswordToggle')" id="clinicianPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianConfirmPassword" placeholder="Re-enter password" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianConfirmPassword', 'clinicianConfirmPasswordToggle')" id="clinicianConfirmPasswordToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN (4 digits) - 2FA *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianPin" placeholder="Choose 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianPin', 'clinicianPinToggle')" id="clinicianPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm PIN *</label>
                    <div style="position: relative;">
                        <input type="password" id="clinicianConfirmPin" placeholder="Re-enter 4-digit PIN" maxlength="4" required style="width: 100%; padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('clinicianConfirmPin', 'clinicianConfirmPinToggle')" id="clinicianConfirmPinToggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px;">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn" onclick="registerClinician()">Create Clinician Account</button>
                <button class="btn btn-secondary" onclick="showClinicianAuth()">Back to Login</button>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px;">Reset Password/PIN</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Enter your username and email. We'll send you a reset link.</p>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="forgotUsername" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your registered email">
                </div>
                <button class="btn" onclick="requestPasswordReset()">Send Reset Link</button>
                <button class="btn btn-secondary" onclick="showLanding()">Back</button>
            </div>
            
            <div id="authMessage" class="hidden"></div>
        </div>
    </div>
    
    <!-- Legal Disclaimer Modal -->
    <div id="disclaimerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 40px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);">
            <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">‚öñÔ∏è Important Legal Disclaimer</h2>
            
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                <strong style="color: #856404;">‚ö†Ô∏è Please Read Carefully</strong>
            </div>
            
            <div style="text-align: left; line-height: 1.8; color: #333; font-size: 14px;">
                <p><strong>1. NOT A SUBSTITUTE FOR PROFESSIONAL CARE</strong></p>
                <p>Healing Space is an AI-powered mental health support tool designed to complement, not replace, professional mental health services. This application does NOT provide medical advice, diagnosis, or treatment. The AI responses are generated by algorithms and should not be considered professional medical or therapeutic advice.</p>
                
                <p><strong>2. EMERGENCY SITUATIONS</strong></p>
                <p>If you are experiencing a mental health emergency, suicidal thoughts, or are in immediate danger, DO NOT rely on this application. Please:</p>
                <ul style="margin-left: 20px;">
                    <li>Call emergency services (999 in UK, 911 in US)</li>
                    <li>Contact the National Suicide Prevention Lifeline: 988 (US) or 116 123 (UK)</li>
                    <li>Go to your nearest emergency department</li>
                    <li>Call your mental health crisis team</li>
                </ul>
                
                <p><strong>3. CLINICAL RELATIONSHIPS</strong></p>
                <p>Any clinician-patient relationships formed through this platform do not constitute a formal therapeutic or medical relationship unless separately established through proper professional channels. Clinicians using this platform must adhere to all applicable professional standards, ethical guidelines, and legal requirements of their jurisdiction and licensing body.</p>
                
                <p><strong>4. DATA PRIVACY & CONFIDENTIALITY</strong></p>
                <p>While we implement security measures to protect your data, no electronic system can guarantee 100% security. Users acknowledge that:</p>
                <ul style="margin-left: 20px;">
                    <li>Data is stored electronically and transmitted over the internet</li>
                    <li>Absolute confidentiality cannot be guaranteed</li>
                    <li>You should not share information you wish to keep completely private</li>
                    <li>Data may be subject to legal disclosure requirements</li>
                </ul>
                
                <p><strong>5. AI LIMITATIONS</strong></p>
                <p>The AI system powering this application:</p>
                <ul style="margin-left: 20px;">
                    <li>Cannot fully understand complex emotional or psychological states</li>
                    <li>May produce errors, misunderstandings, or inappropriate responses</li>
                    <li>Does not have professional judgment or clinical training</li>
                    <li>Cannot assess medical conditions or prescribe treatments</li>
                </ul>
                
                <p><strong>6. USER RESPONSIBILITY</strong></p>
                <p>By using Healing Space, you acknowledge and agree that:</p>
                <ul style="margin-left: 20px;">
                    <li>You are responsible for seeking appropriate professional help when needed</li>
                    <li>You will not rely solely on this application for mental health treatment</li>
                    <li>You understand the limitations of AI-based support</li>
                    <li>You will use this tool as a supplement to, not replacement for, professional care</li>
                </ul>
                
                <p><strong>7. LIABILITY DISCLAIMER</strong></p>
                <p>The creators, developers, and operators of Healing Space expressly disclaim all liability for any harm, injury, or damages arising from use of this application. This includes but is not limited to:</p>
                <ul style="margin-left: 20px;">
                    <li>Reliance on AI-generated advice or suggestions</li>
                    <li>Data breaches or privacy violations</li>
                    <li>Technical failures or errors</li>
                    <li>Misdiagnosis or missed diagnoses</li>
                    <li>Delayed or inadequate treatment</li>
                </ul>
                
                <p><strong>8. AGE REQUIREMENT</strong></p>
                <p>Users must be 18 years or older, or have parental/guardian consent if under 18. This application is not designed for children under 13.</p>
                
                <p><strong>9. JURISDICTION & COMPLIANCE</strong></p>
                <p>Users are responsible for ensuring their use of this application complies with all applicable local, state, national, and international laws and regulations. Healthcare professionals must comply with all licensing requirements and professional standards of their jurisdiction.</p>
                
                <p><strong>10. CHANGES TO SERVICE</strong></p>
                <p>Healing Space reserves the right to modify, suspend, or terminate services at any time without notice. We are not liable for any modification or discontinuation of services.</p>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #e0e0e0;">
                
                <p style="text-align: center; font-weight: bold; color: #667eea; margin-top: 20px;">
                    By clicking "I Accept," you acknowledge that you have read, understood, and agree to this disclaimer.
                </p>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                <button class="btn" onclick="acceptDisclaimer()" style="min-width: 200px; padding: 15px;">
                    ‚úì I Accept
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <div class="app-header">
            <h2>üåø Healing Space</h2>
            <div class="user-info">
                <button onclick="showNotifications()" style="position: relative; background: transparent; border: 2px solid #667eea; color: #667eea; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-right: 15px; font-size: 18px;">
                    üîî
                    <span id="notificationBadge" style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none; justify-content: center; align-items: center;">0</span>
                </button>
                <span id="usernameDisplay"></span>
                <button class="btn" onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
            </div>
        </div>
        
        <!-- Notification Panel -->
        <div id="notificationPanel" style="display: none; position: fixed; top: 80px; right: 20px; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 400px; max-height: 500px; overflow-y: auto; z-index: 10000; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Notifications</h3>
                <button onclick="closeNotifications()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
            </div>
            <div id="notificationList"></div>
        </div>
        
        <div class="app-content">
            <div class="sidebar">
                <button class="tab-btn active" onclick="switchTab('therapy', this)">ü§ñ AI Therapy</button>
                <button class="tab-btn" onclick="switchTab('mood', this)">üìä Mood & Habits</button>
                <button class="tab-btn" onclick="switchTab('gratitude', this)">üôè Gratitude</button>
                <button class="tab-btn" onclick="switchTab('cbt', this)">üß† CBT Tools</button>
                <button class="tab-btn" onclick="switchTab('pet', this)">üê∂ My Pet</button>
                <button class="tab-btn" onclick="switchTab('clinical', this)">üìã Assessments</button>
                <button class="tab-btn" onclick="switchTab('community', this)">üë• Community</button>
                <button class="tab-btn" onclick="switchTab('safety', this)">üÜò Safety Plan</button>
                <button class="tab-btn" onclick="switchTab('insights', this)">üí° Insights</button>
                <button class="tab-btn" onclick="switchTab('appointments', this)">üìÖ Appointments</button>
                <button class="tab-btn" onclick="switchTab('aboutme', this)">üë§ About Me</button>
                <button class="tab-btn" onclick="switchTab('sleep', this)">üò¥ Sleep</button>
                <button class="tab-btn" onclick="switchTab('history', this)">üìà History</button>
                <button class="tab-btn" id="professionalTabBtn" onclick="switchTab('professional', this)" style="display:none;">üë®‚Äç‚öïÔ∏è Professional</button>
            </div>
            
            <div class="main-content">
            <!-- Therapy Chat Tab -->
            <div id="therapyTab" class="tab-content active">
                <h3>Talk to Your AI Therapist</h3>
                <p style="color: #666; margin-bottom: 20px;">Share your thoughts and feelings in a safe, confidential space.</p>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Mood Tracker Tab -->
            <div id="moodTab" class="tab-content">
                <h3>Mood, Sleep, Habits & Medications</h3>
                <p style="color: #666; margin-bottom: 20px;">Complete daily check-in to track your wellness journey.</p>
                
                <div class="mood-scale">
                    <div class="mood-option" data-mood="1" onclick="selectMood(1, this)">
                        <div class="emoji">üò¢</div>
                        <div>Very Low (1)</div>
                    </div>
                    <div class="mood-option" data-mood="3" onclick="selectMood(3, this)">
                        <div class="emoji">üòî</div>
                        <div>Low (3)</div>
                    </div>
                    <div class="mood-option" data-mood="5" onclick="selectMood(5, this)">
                        <div class="emoji">üòê</div>
                        <div>Neutral (5)</div>
                    </div>
                    <div class="mood-option" data-mood="7" onclick="selectMood(7, this)">
                        <div class="emoji">üôÇ</div>
                        <div>Good (7)</div>
                    </div>
                    <div class="mood-option" data-mood="10" onclick="selectMood(10, this)">
                        <div class="emoji">üòÑ</div>
                        <div>Great (10)</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Hours of Sleep</label>
                        <input type="number" id="sleepHours" min="0" max="24" step="0.5" placeholder="e.g., 7.5">
                    </div>
                    <div class="form-group">
                        <label>Water (Pints)</label>
                        <input type="number" id="waterPints" min="0" step="0.5" placeholder="e.g., 4">
                    </div>
                    <div class="form-group">
                        <label>Exercise (Minutes)</label>
                        <input type="number" id="exerciseMins" min="0" placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label>Outdoor Time (Minutes)</label>
                        <input type="number" id="outsideMins" min="0" placeholder="e.g., 20">
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Medications Taken Today</h4>
                <div class="inline-form">
                    <div class="form-group">
                        <label>Medication Name</label>
                        <input type="text" id="medName" placeholder="e.g., Sertraline">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>Strength (mg)</label>
                        <input type="number" id="medStrength" placeholder="50">
                    </div>
                    <div class="form-group" style="max-width: 80px;">
                        <label>Quantity</label>
                        <input type="number" id="medQty" placeholder="1" value="1">
                    </div>
                    <button class="btn" onclick="addMedication()" style="width: auto; padding: 12px 20px;">+ Add</button>
                </div>
                <div id="medList" class="med-list"></div>
                
                <div class="form-group">
                    <label>Journal Notes</label>
                    <textarea id="moodNotes" placeholder="How are you feeling? Any specific thoughts or events?"></textarea>
                </div>
                
                <button class="btn" onclick="logMood()">Save Full Check-In</button>
                <div id="moodMessage" class="hidden"></div>
            </div>
            
            <!-- Gratitude Journal Tab -->
            <div id="gratitudeTab" class="tab-content">
                <h3>Gratitude Journal</h3>
                <p style="color: #666; margin-bottom: 20px;">What are you grateful for today?</p>
                
                <div class="form-group">
                    <textarea id="gratitudeEntry" placeholder="Write about something you're grateful for today..."></textarea>
                </div>
                
                <button class="btn" onclick="logGratitude()">Save Entry</button>
                <div id="gratitudeMessage" class="hidden"></div>
            </div>
            
            <!-- CBT Tools Tab -->
            <div id="cbtTab" class="tab-content">
                <h3>Cognitive Behavioral Therapy Tools</h3>
                <p style="color: #666; margin-bottom: 20px;">Challenge negative thoughts and build healthier thinking patterns.</p>
                
                <div class="cbt-container">
                    <div class="form-group">
                        <label>What situation triggered this thought?</label>
                        <input type="text" id="cbtSituation" placeholder="e.g., Received critical feedback at work">
                    </div>
                    <div class="form-group">
                        <label>What automatic thought came to mind?</label>
                        <textarea id="cbtThought" placeholder="e.g., I'm terrible at my job and everyone thinks so"></textarea>
                    </div>
                    <div class="form-group">
                        <label>What evidence challenges this thought?</label>
                        <textarea id="cbtEvidence" placeholder="e.g., I received positive feedback last week, my manager praised my recent project"></textarea>
                    </div>
                    <button class="btn" onclick="saveCBT()">Save Thought Record</button>
                    <div id="cbtMessage" class="hidden"></div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h4>Breathing Exercise</h4>
                    <p style="color: #666; margin-bottom: 10px;">Follow the guided 4-7-8 breathing technique.</p>
                    <button class="btn" onclick="startBreathing()">Start Breathing Exercise</button>
                    <div id="breathingDisplay" class="hidden" style="text-align: center; padding: 40px; font-size: 24px; font-weight: bold;"></div>
                </div>
            </div>
            
            <!-- Pet Game Tab -->
            <div id="petTab" class="tab-content">
                <div id="petCreate" class="hidden">
                    <h3>üè° Adopt Your Companion</h3>
                    <p style="color: #666; margin-bottom: 20px;">Choose a virtual pet to care for as you care for yourself.</p>
                    
                    <div class="form-group">
                        <label>Pet Name</label>
                        <input type="text" id="petName" placeholder="e.g., Buddy">
                    </div>
                    <div class="form-group">
                        <label>Species</label>
                        <select id="petSpecies" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Dog">üê∂ Dog</option>
                            <option value="Cat">üê± Cat</option>
                            <option value="Rabbit">üê∞ Rabbit</option>
                            <option value="Fox">ü¶ä Fox</option>
                            <option value="Panda">üêº Panda</option>
                            <option value="Penguin">üêß Penguin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="petGender" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="Neutral">Neutral</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createPet()">Adopt Pet!</button>
                </div>
                
                <div id="petDisplay" class="hidden">
                    <div class="pet-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="petNameDisplay" style="margin: 0;"></h3>
                            <div>
                                <span style="font-size: 18px; font-weight: bold;">ü™ô <span id="petCoins">0</span></span>
                                <span style="font-size: 14px; margin-left: 15px;">‚≠ê <span id="petXP">0</span> (<span id="petStage">Baby</span>)</span>
                            </div>
                        </div>
                        
                        <div class="pet-display" id="petEmojiDisplay" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 16px; padding: 40px; text-align: center; font-size: 80px; margin-bottom: 20px; min-height: 150px; display: flex; align-items: center; justify-content: center; position: relative;">
                            <div id="petStatusMessage" style="position: absolute; top: 10px; left: 10px; right: 10px; font-size: 14px; color: #666; font-weight: 500;"></div>
                        </div>
                        
                        <div class="pet-stats">
                            <div class="stat-bar">
                                <label>üçî Hunger</label>
                                <div class="progress-bar"><div class="progress-fill" id="hungerBar" style="background: #e74c3c;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>üòä Happiness</label>
                                <div class="progress-bar"><div class="progress-fill" id="happinessBar" style="background: #2ecc71;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>‚ö° Energy</label>
                                <div class="progress-bar"><div class="progress-fill" id="energyBar" style="background: #f1c40f;"></div></div>
                            </div>
                            <div class="stat-bar">
                                <label>üßπ Hygiene</label>
                                <div class="progress-bar"><div class="progress-fill" id="hygieneBar" style="background: #3498db;"></div></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="openShop()" style="background: #e67e22; position: relative; z-index: 1;">üõçÔ∏è Shop</button>
                            <button class="btn" onclick="openDeclutter()" style="background: #9b59b6; position: relative; z-index: 1;">üßπ Declutter</button>
                            <button id="walkBtn" class="btn" onclick="startAdventure()" style="background: #27ae60; position: relative; z-index: 1;">üå≤ Walk (30m)</button>
                            <button class="btn" onclick="refreshPet()" style="background: #34495e; position: relative; z-index: 1;">üîÑ Refresh</button>
                        </div>
                        <div id="walkCountdown" style="text-align: center; margin-top: 10px; font-weight: bold; color: #27ae60; display: none;"></div>
                    </div>
                    <p style="color: #666; text-align: center; margin-top: 20px; font-size: 14px;">
                        üí° Earn coins and XP by completing self-care actions! Your pet grows as you grow.
                    </p>
                </div>
            </div>
            
            <!-- Shop Modal -->
            <div id="shopModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3>üõçÔ∏è Wellness Shop</h3>
                    <div style="text-align: center; margin-bottom: 20px; font-size: 18px; font-weight: bold;">
                        Your Coins: ü™ô <span id="shopCoins">0</span>
                    </div>
                    <div id="shopItems"></div>
                    <button class="btn btn-secondary" onclick="closeShop()" style="width: 100%; margin-top: 15px;">Close</button>
                </div>
            </div>
            
            <!-- Declutter Modal -->
            <div id="declutterModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%;">
                    <h3>üßπ Declutter The Mind</h3>
                    <p style="color: #666; margin-bottom: 20px;">Throw away 3 worries to clean the room:</p>
                    <div class="form-group">
                        <input type="text" id="worry1" placeholder="Worry 1...">
                    </div>
                    <div class="form-group">
                        <input type="text" id="worry2" placeholder="Worry 2...">
                    </div>
                    <div class="form-group">
                        <input type="text" id="worry3" placeholder="Worry 3...">
                    </div>
                    <button class="btn" onclick="submitDeclutter()" style="width: 100%; background: #e74c3c;">üóëÔ∏è Throw Away</button>
                    <button class="btn btn-secondary" onclick="closeDeclutter()" style="width: 100%; margin-top: 10px;">Cancel</button>
                </div>
            </div>
            
            <!-- Clinical Assessments Tab -->
            <div id="clinicalTab" class="tab-content">
                <h3>Clinical Assessments</h3>
                <p style="color: #666; margin-bottom: 20px;">Track your mental health with validated clinical scales.</p>
                
                <div class="grid-2">
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>PHQ-9 (Depression)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">9-question screening for depression severity.</p>
                        <button class="btn" onclick="startPHQ9()">Start PHQ-9</button>
                    </div>
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <h4>GAD-7 (Anxiety)</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">7-question screening for anxiety severity.</p>
                        <button class="btn" onclick="startGAD7()">Start GAD-7</button>
                    </div>
                </div>
                
                <div id="assessmentModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 id="assessmentTitle"></h3>
                        <div id="assessmentQuestions"></div>
                        <button class="btn" onclick="submitAssessment()">Submit</button>
                        <button class="btn btn-secondary" onclick="closeAssessment()">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h3>Your Progress</h3>
                <p style="color: #666; margin-bottom: 20px;">View your mood history and wellness patterns.</p>
                
                <button class="btn" onclick="loadHistory()" style="margin-bottom: 20px;">Load My History</button>
                
                <div id="historyContent">
                    <p style="text-align: center; color: #999; padding: 40px;">Click "Load My History" to view your mood logs</p>
                </div>
            </div>
            
            <!-- Community Support Tab -->
            <div id="communityTab" class="tab-content">
                <h3>Community Support Board</h3>
                <p style="color: #666; margin-bottom: 20px;">Connect with others on their mental health journey.</p>
                
                <div class="card">
                    <h4>Share Your Message</h4>
                    <textarea id="communityMessage" rows="4" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px;" placeholder="Share encouragement, hope, or ask for support..."></textarea>
                    <button class="btn" onclick="postCommunity()">Post Message</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Recent Posts</h4>
                    <button class="btn btn-secondary" onclick="loadCommunity()" style="margin-bottom: 15px;">Refresh Posts</button>
                    <div id="communityPosts">
                        <p style="text-align: center; color: #999;">Click "Refresh Posts" to load community messages</p>
                    </div>
                </div>
            </div>
            
            <!-- Safety Plan Tab -->
            <div id="safetyTab" class="tab-content">
                <h3>üÜò My Safety Plan</h3>
                <p style="color: #666; margin-bottom: 20px;">Create a plan for when you're feeling in crisis.</p>
                
                <div class="card">
                    <div class="form-group">
                        <label><strong>Warning Signs/Triggers:</strong></label>
                        <textarea id="safetyTriggers" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="What triggers distress for me..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Coping Strategies:</strong></label>
                        <textarea id="safetyCoping" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="What helps me calm down..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Support Contacts:</strong></label>
                        <textarea id="safetySupport" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="Friends/family I can call..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Professional Contacts:</strong></label>
                        <textarea id="safetyProfessional" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;" placeholder="Therapist, crisis hotline numbers..."></textarea>
                    </div>
                    
                    <button class="btn" onclick="saveSafetyPlan()">Save Safety Plan</button>
                    <button class="btn btn-secondary" onclick="loadSafetyPlan()">Load Saved Plan</button>
                </div>
                
                <div class="card" style="margin-top: 20px; background: #ffebee;">
                    <h4 style="color: #c62828;">üö® Crisis Resources (UK)</h4>
                    <p><strong>Samaritans:</strong> Call 116 123 (24/7 free hotline)</p>
                    <p><strong>Crisis Text Line UK:</strong> Text SHOUT to 85258</p>
                    <p><strong>NHS Mental Health Crisis:</strong> Call 111 (select option 2)</p>
                    <p><strong>Papyrus (Under 35):</strong> Call 0800 068 4141 or text 07860 039967</p>
                    <p><strong>Emergency:</strong> Call 999 or go to A&E</p>
                    <p><strong>International:</strong> <a href="https://findahelpline.com" target="_blank">findahelpline.com</a></p>
                </div>
            </div>
            
            <!-- Progress Insights Tab -->
            <div id="insightsTab" class="tab-content">
                <h3>üí° Progress Insights & Export</h3>
                <p style="color: #666; margin-bottom: 20px;">View AI-generated insights and export your data.</p>
                
                <div class="card" style="margin-bottom: 20px; background: #f8f9fa;">
                    <h4>üìÖ Date Range</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">From Date</label>
                            <input type="date" id="insightsFromDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">To Date</label>
                            <input type="date" id="insightsToDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="setInsightsRange(7)" style="padding: 10px 15px;">7 Days</button>
                            <button class="btn" onclick="setInsightsRange(30)" style="padding: 10px 15px;">30 Days</button>
                            <button class="btn" onclick="setInsightsRange(90)" style="padding: 10px 15px;">90 Days</button>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="loadInsights()">Generate Insights</button>
                    <button class="btn" onclick="exportCSV()" style="background: #34495e;">üì• Export CSV</button>
                    <button class="btn" onclick="exportPDF()" style="background: #e74c3c;">üìÑ Export PDF</button>
                </div>
                
                <div id="insightsContent">
                    <div class="card">
                        <h4>Your Stats</h4>
                        <div id="statsDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value" id="avgMood">-</div>
                                <div class="stat-label">Average Mood</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgSleep">-</div>
                                <div class="stat-label">Average Sleep</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="moodTrend">-</div>
                                <div class="stat-label">Trend</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>AI Insights</h4>
                        <div id="aiInsight" style="padding: 20px; background: #f5f5f5; border-radius: 12px; line-height: 1.6;">
                            <p style="color: #999;">Click "Generate Insights" to get personalized analysis of your progress.</p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>üìä Mood Trend</h4>
                        <canvas id="moodChart" width="600" height="200" style="max-width: 100%;"></canvas>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h4>üò¥ Sleep Hours Trend</h4>
                        <canvas id="sleepChart" width="600" height="200" style="max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Appointments Tab -->
            <div id="appointmentsTab" class="tab-content">
                <h3>üìÖ My Appointments</h3>
                <p style="color: #666; margin-bottom: 20px;">View and manage appointments scheduled by your clinician.</p>
                
                <div id="appointmentsList">
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading" style="margin: 0 auto;"></div>
                        <p style="color: #666; margin-top: 10px;">Loading appointments...</p>
                    </div>
                </div>
            </div>
            
            <!-- About Me Tab -->
            <div id="aboutmeTab" class="tab-content">
                <h3>üë§ About Me</h3>
                <p style="color: #666; margin-bottom: 20px;">Manage your personal information and view your activity statistics.</p>
                
                <div class="card">
                    <h4>Personal Information</h4>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileFullName" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="profileDOB">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="profilePhone" placeholder="+44 1234 567890">
                    </div>
                    <div class="form-group">
                        <label>Medical History / Conditions</label>
                        <textarea id="profileConditions" rows="4" placeholder="Any relevant medical history..."></textarea>
                    </div>
                    <button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
                    <button class="btn btn-secondary" onclick="loadProfile()">üîÑ Reload Profile</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>My Clinician</h4>
                    <div id="clinicianInfo" style="padding: 20px; background: #f5f5f5; border-radius: 12px;">
                        <p style="color: #999;">Loading clinician information...</p>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Activity Statistics</h4>
                    <div id="activityStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-card">
                            <div class="stat-value" id="statMoodLogs">-</div>
                            <div class="stat-label">Mood Logs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statGratitude">-</div>
                            <div class="stat-label">Gratitude Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCBT">-</div>
                            <div class="stat-label">CBT Exercises</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessions">-</div>
                            <div class="stat-label">Therapy Sessions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sleep Hygiene Tab -->
            <div id="sleepTab" class="tab-content">
                <h3>üò¥ Sleep Hygiene Checklist</h3>
                <p style="color: #666; margin-bottom: 20px;">Complete your bedtime routine for better sleep.</p>
                
                <div class="card">
                    <h4>Bedtime Routine</h4>
                    <p style="margin-bottom: 15px;">Check off each task as you complete it:</p>
                    
                    <div class="sleep-checklist">
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üí° Lights Dimmed (at least 1 hour before bed)</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üì± Phone on Do Not Disturb</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üì∫ No Screens for 30 mins</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üôè Gratitude Recorded</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üßò Deep Breathing Done</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üõèÔ∏è Bedroom Cool & Dark</span>
                        </label>
                        <label class="sleep-item">
                            <input type="checkbox" class="sleep-check">
                            <span>üìñ Reading Something Calming</span>
                        </label>
                    </div>
                    
                    <button class="btn" onclick="resetSleepChecklist()" style="margin-top: 20px;">Reset Checklist</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Sleep Tips</h4>
                    <ul style="line-height: 1.8; color: #555;">
                        <li>Maintain a consistent sleep schedule (same bedtime & wake time)</li>
                        <li>Avoid caffeine after 2 PM</li>
                        <li>Keep bedroom temperature between 60-67¬∞F (15-19¬∞C)</li>
                        <li>Use your bed only for sleep (not work or TV)</li>
                        <li>If you can't sleep after 20 minutes, get up and do a calm activity</li>
                    </ul>
                </div>
            </div>
            
            <!-- Professional Dashboard Tab -->
            <div id="professionalTab" class="tab-content">
                <h3>üë®‚Äç‚öïÔ∏è Clinical Dashboard</h3>
                <p style="color: #666; margin-bottom: 20px;">Monitor and manage your patients' mental health progress.</p>
                
                <!-- Pending Approvals Section -->
                <div class="card" style="margin-bottom: 20px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h4>‚è≥ Pending Patient Requests</h4>
                    <div id="pendingApprovals">
                        <p style="color: #999; text-align: center;">Loading...</p>
                    </div>
                </div>
                
                <!-- Patient List Section -->
                <div id="patientListSection">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üìã My Patients</h4>
                            <button class="btn" onclick="loadPatients()">üîÑ Refresh</button>
                        </div>
                        <div id="patientList">
                            <p style="text-align: center; color: #999; padding: 40px;">Loading patient list...</p>
                        </div>
                    </div>
                    
                    <!-- Appointments Calendar Section -->
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üìÖ Upcoming Appointments</h4>
                            <button class="btn" onclick="loadAppointments()">üîÑ Refresh</button>
                        </div>
                        <div id="appointmentsList">
                            <p style="text-align: center; color: #999; padding: 20px;">Loading appointments...</p>
                        </div>
                        <button class="btn" onclick="showNewAppointmentForm()" style="margin-top: 15px;">‚ûï Schedule New Appointment</button>
                    </div>
                    
                    <!-- New Appointment Form (hidden by default) -->
                    <div id="newAppointmentForm" class="card" style="margin-top: 20px; display: none; background: #f8f9fa;">
                        <h4>üìÖ Schedule New Appointment</h4>
                        <div class="form-group">
                            <label>Select Patient</label>
                            <select id="appointmentPatient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">Select a patient...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Appointment Date & Time</label>
                            <input type="datetime-local" id="appointmentDateTime" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="appointmentNotes" rows="3" placeholder="Appointment purpose, topics to discuss..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="createAppointment()">üìÖ Book Appointment</button>
                            <button class="btn btn-secondary" onclick="cancelNewAppointment()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Detail Section -->
                <div id="patientDetailSection" style="display: none;">
                    <button class="btn btn-secondary" onclick="closePatientDetail()" style="margin-bottom: 15px;">‚Üê Back to Patient List</button>
                    
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                        <h3 id="patientDetailName" style="color: white; margin: 0;"></h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">Patient Overview</p>
                    </div>
                    
                    <!-- AI Summary Card -->
                    <div class="card" style="margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <h4>ü§ñ AI Clinical Summary</h4>
                        <div id="aiSummary">
                            <div style="text-align: center; padding: 20px;">
                                <div class="loading" style="margin: 0 auto;"></div>
                                <p style="color: #666; margin-top: 10px;">Generating AI summary...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Range Selector for Charts -->
                    <div class="card" style="margin-bottom: 20px; background: #f8f9fa;">
                        <h4>üìÖ Chart Date Range</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">From Date</label>
                                <input type="date" id="patientChartFromDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">To Date</label>
                                <input type="date" id="patientChartToDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="setPatientChartRange(7)" style="padding: 10px 15px;">7 Days</button>
                                <button class="btn" onclick="setPatientChartRange(30)" style="padding: 10px 15px;">30 Days</button>
                                <button class="btn" onclick="setPatientChartRange(90)" style="padding: 10px 15px;">90 Days</button>
                                <button class="btn" onclick="loadPatientCharts()" style="padding: 10px 15px; background: #667eea;">Refresh</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4>üìä Mood Trend</h4>
                        <canvas id="moodChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <h4>üò¥ Sleep Hours Trend</h4>
                        <canvas id="sleepChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Patient Data Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="btn" onclick="showPatientTab('profile')" id="profileTabBtn" style="background: #667eea;">Profile</button>
                        <button class="btn btn-secondary" onclick="showPatientTab('moods')" id="moodsTabBtn">Mood Logs</button>
                        <button class="btn btn-secondary" onclick="showPatientTab('assessments')" id="assessmentsTabBtn">Assessments</button>
                        <button class="btn btn-secondary" onclick="showPatientTab('therapy')" id="therapyTabBtn">Therapy Notes</button>
                        <button class="btn btn-secondary" onclick="showPatientTab('alerts')" id="alertsTabBtn">Alerts</button>
                    </div>
                    
                    <div id="patientDetailContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div> <!-- End of app-content -->
    </div> <!-- End of app screen -->
    
    <script>
        console.log('Script loading - v2026.01.17.2');
        let currentUser = null;
        let currentUserRole = 'user';
        let selectedMoodValue = null;
        let medications = [];
        let currentAssessment = null;
        let assessmentScores = [];
        let tempLoginData = null; // Store login data for disclaimer flow
        
        const speciesEmojis = {Dog: 'üê∂', Cat: 'üê±', Rabbit: 'üê∞', Fox: 'ü¶ä', Panda: 'üêº', Penguin: 'üêß'};
        
        const PHQ9_QUESTIONS = [
            "Little interest or pleasure in doing things",
            "Feeling down, depressed, or hopeless",
            "Trouble falling/staying asleep, or sleeping too much",
            "Feeling tired or having little energy",
            "Poor appetite or overeating",
            "Feeling bad about yourself or that you are a failure",
            "Trouble concentrating on things",
            "Moving or speaking slowly, or being fidgety/restless",
            "Thoughts that you would be better off dead or hurting yourself"
        ];
        
        const GAD7_QUESTIONS = [
            "Feeling nervous, anxious or on edge",
            "Not being able to stop or control worrying",
            "Worrying too much about different things",
            "Trouble relaxing",
            "Being so restless that it is hard to sit still",
            "Becoming easily annoyed or irritable",
            "Feeling afraid as if something awful might happen"
        ];
        
        // Auth Functions
        // Auth Navigation Functions
        function showLanding() {
            hideAllAuthForms();
            document.getElementById('landingPage').classList.remove('hidden');
        }
        
        function showPatientAuth() {
            hideAllAuthForms();
            document.getElementById('patientLoginForm').classList.remove('hidden');
        }
        
        function showClinicianAuth() {
            hideAllAuthForms();
            document.getElementById('clinicianLoginForm').classList.remove('hidden');
        }
        
        console.log('Auth functions defined:', typeof showPatientAuth, typeof showClinicianAuth);
        
        function showPatientRegister() {
            hideAllAuthForms();
            document.getElementById('registerForm').classList.remove('hidden');
            // Set max date to today for DOB field
            document.getElementById('regDOB').max = new Date().toISOString().split('T')[0];
            loadCliniciansForRegistration();
            
            // Add event listeners to filter clinicians by location
            const countryInput = document.getElementById('regCountry');
            const areaInput = document.getElementById('regArea');
            
            if (countryInput && areaInput) {
                countryInput.addEventListener('blur', loadCliniciansForRegistration);
                areaInput.addEventListener('blur', loadCliniciansForRegistration);
            }
        }
        
        function showClinicianRegister() {
            hideAllAuthForms();
            document.getElementById('clinicianRegisterForm').classList.remove('hidden');
        }
        
        function showForgotPassword(userType) {
            hideAllAuthForms();
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
        }
        
        async function requestPasswordReset() {
            const username = document.getElementById('forgotUsername').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!username || !email) {
                showAuthMessage('Please enter your username and email', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Password reset link sent to your email!', 'success');
                    setTimeout(() => showLanding(), 3000);
                } else {
                    showAuthMessage(data.error || 'Failed to send reset link', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Password reset error:', error);
            }
        }
        
        function hideAllAuthForms() {
            // Hide only the direct children forms, not the entire auth screen
            const forms = document.querySelectorAll('#authScreen .auth-box > div');
            forms.forEach(form => {
                if (form.id) { // Only hide divs with an ID
                    form.classList.add('hidden');
                }
            });
            document.getElementById('authMessage').classList.add('hidden');
        }
        
        async function login(userType) {
            let username, password, pin, rememberMe;
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientLoginForm').classList.add('hidden');
            document.getElementById('clinicianLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('clinicianRegisterForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            
            if (userType === 'user') {
                username = document.getElementById('loginUsername').value.trim();
                password = document.getElementById('loginPassword').value;
                pin = document.getElementById('loginPin').value;
                rememberMe = document.getElementById('rememberMe').checked;
            } else {
                username = document.getElementById('clinicianLoginUsername').value.trim();
                password = document.getElementById('clinicianLoginPassword').value;
                pin = document.getElementById('clinicianLoginPin').value;
                rememberMe = document.getElementById('clinicianRememberMe').checked;
            }
            
            if (!username || !password) {
                showAuthMessage('Please enter username and password', 'error');
                return;
            }
            
            if (!pin) {
                showAuthMessage('Please enter your 4-digit PIN for 2FA', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, pin })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = username;
                    currentUserRole = data.role || 'user';
                    
                    // Save session data
                    const sessionData = {
                        username: username,
                        role: data.role || 'user',
                        approval_status: data.approval_status,
                        clinician_id: data.clinician_id,
                        disclaimer_accepted: data.disclaimer_accepted
                    };
                    
                    if (rememberMe) {
                        // Save to localStorage (persists across browser sessions)
                        localStorage.setItem('healingSpaceSession', JSON.stringify(sessionData));
                    } else {
                        // Save to sessionStorage (clears when tab closes)
                        sessionStorage.setItem('healingSpaceSession', JSON.stringify(sessionData));
                    }
                    
                    // Proceed with login (disclaimer already accepted during registration)
                    completeLogin(data);
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }
        
        function showDisclaimerModal() {
            document.getElementById('disclaimerModal').style.display = 'flex';
        }
        
        async function acceptDisclaimer() {
            try {
                document.getElementById('disclaimerModal').style.display = 'none';
                
                // Complete the registration with stored data
                if (tempLoginData) {
                    if (tempLoginData.type === 'patient') {
                        await completePatientRegistration(tempLoginData);
                    } else if (tempLoginData.type === 'clinician') {
                        await completeClinicianRegistration(tempLoginData);
                    }
                    tempLoginData = null; // Clear stored data
                }
            } catch (error) {
                console.error('Error accepting disclaimer:', error);
            }
        }
        
        function completeLogin(data) {
            document.getElementById('usernameDisplay').textContent = `Welcome, ${currentUser}!`;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            
            // Show professional tab only for clinicians
            if (currentUserRole === 'clinician') {
                document.getElementById('professionalTabBtn').style.display = 'block';
                
                // Hide all patient-facing tab buttons for clinicians
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id !== 'professionalTabBtn') {
                        btn.style.display = 'none';
                    }
                });
                
                // Hide all patient-facing tab content for clinicians
                const patientTabs = ['therapyTab', 'moodTab', 'gratitudeTab', 'cbtTab', 'petTab', 
                                     'clinicalTab', 'communityTab', 'safetyTab', 'insightsTab', 
                                     'sleepTab', 'historyTab'];
                patientTabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.style.display = 'none';
                    }
                });
                
                // Auto-switch to professional tab and show it
                document.getElementById('professionalTab').style.display = 'block';
                switchTab('professional', document.getElementById('professionalTabBtn'));
                loadPendingApprovals();
                loadPatients(); // Auto-load patients
            } else {
                // PATIENT: Hide professional tab, SHOW all patient tabs
                document.getElementById('professionalTabBtn').style.display = 'none';
                document.getElementById('professionalTab').style.display = 'none';
                
                // Ensure patient tab buttons are visible
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id !== 'professionalTabBtn') {
                        btn.style.display = 'inline-block';
                    }
                });
                
                // Ensure patient tab content exists (will be shown/hidden by switchTab)
                const patientTabs = ['therapyTab', 'moodTab', 'gratitudeTab', 'cbtTab', 'petTab', 
                                     'clinicalTab', 'communityTab', 'safetyTab', 'insightsTab', 
                                     'sleepTab', 'historyTab'];
                patientTabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        // Don't force display here - let switchTab handle it
                        tab.style.display = '';
                    }
                });
            }
            
            // Check approval status for patients
            if (data.approval_status === 'pending') {
                alert('Your clinician has not yet approved your account. Some features may be limited until approval.');
            }
            
            loadNotifications();
            
            // Only add system message for patients
            if (currentUserRole !== 'clinician') {
                // Load chat history first, then show greeting
                initializePatientSession();
                
                // Switch to therapy tab as default
                switchTab('therapy', document.querySelector('[onclick*="therapy"]'));
                
                loadPetStatus();
                checkMoodStatus(); // Check if mood logged today
            }
            
            // Refresh notifications every 30 seconds
            setInterval(loadNotifications, 30000);
        }
        
        // Initialize patient session with chat history and greeting
        async function initializePatientSession() {
            try {
                // First, check if chat needs initialization (first-time user)
                await initializeChatIfNeeded();
                
                // Load existing chat history
                await loadChatHistory();
                
                // Then show personalized greeting (only if not first time)
                const history = await fetch(`/api/therapy/history?username=${currentUser}`).then(r => r.json());
                if (history.history && history.history.length > 1) {
                    // Has chat history beyond welcome message
                    await showPersonalizedGreeting();
                }
            } catch (error) {
                console.error('Error initializing session:', error);
            }
        }
        
        // Initialize chat for first-time users
        async function initializeChatIfNeeded() {
            try {
                const response = await fetch('/api/therapy/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok && !data.already_exists) {
                    // First-time user - chat initialized with welcome message
                    console.log('Chat initialized for new user');
                }
            } catch (error) {
                console.error('Error initializing chat:', error);
            }
        }
        
        // Load chat history from previous sessions
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/therapy/history?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.history && data.history.length > 0) {
                    // Clear existing messages
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // Add history
                    data.history.forEach(msg => {
                        addMessage(msg.message, msg.sender);
                    });
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        // Show personalized greeting based on user context
        async function showPersonalizedGreeting() {
            try {
                const response = await fetch('/api/therapy/greeting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok && data.greeting) {
                    addMessage(data.greeting, 'ai');
                }
            } catch (error) {
                console.error('Error loading greeting:', error);
                // Fallback to simple greeting
                addMessage('Welcome back! How are you feeling today?', 'ai');
            }
        }
        
        // Check if user has logged mood today
        async function checkMoodStatus() {
            try {
                const response = await fetch(`/api/mood/check-today?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.logged_today) {
                    // Show status indicator that mood is already logged
                    const moodTab = document.querySelector('[onclick*="mood"]');
                    if (moodTab && !moodTab.textContent.includes('‚úì')) {
                        moodTab.innerHTML = '‚úì Mood & Habits';
                    }
                }
            } catch (error) {
                console.error('Error checking mood status:', error);
            }
        }
        
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrengthFill');
            const strengthText = document.getElementById('passwordStrengthText');
            
            let strength = 0;
            let feedback = 'Weak';
            let color = '#dc3545';
            
            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 25;
            
            if (strength <= 25) {
                feedback = 'Weak';
                color = '#dc3545';
            } else if (strength <= 50) {
                feedback = 'Fair';
                color = '#ffc107';
            } else if (strength <= 75) {
                feedback = 'Good';
                color = '#17a2b8';
            } else {
                feedback = 'Strong';
                color = '#28a745';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
            strengthText.textContent = `Password strength: ${feedback}`;
            strengthText.style.color = color;
        }
        
        async function register() {
            const fullName = document.getElementById('regFullName').value.trim();
            const dob = document.getElementById('regDOB').value;
            const conditions = document.getElementById('regConditions').value.trim();
            const country = document.getElementById('regCountry').value.trim();
            const area = document.getElementById('regArea').value.trim();
            const postcode = document.getElementById('regPostcode').value.trim();
            const nhs_number = document.getElementById('regNHS').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const pin = document.getElementById('regPin').value;
            const confirmPin = document.getElementById('regConfirmPin').value;
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const clinician_id = document.getElementById('regClinician').value;
            
            if (!fullName) {
                showAuthMessage('Please enter your full name', 'error');
                return;
            }
            
            if (!dob) {
                showAuthMessage('Please enter your date of birth', 'error');
                return;
            }
            
            if (!conditions) {
                showAuthMessage('Please describe your medical conditions or diagnosis', 'error');
                return;
            }
            
            if (!country || !area) {
                showAuthMessage('Please enter your country and area', 'error');
                return;
            }
            
            if (!username || !password || !pin || !email || !phone) {
                showAuthMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showAuthMessage('PINs do not match', 'error');
                return;
            }
            
            if (!clinician_id) {
                showAuthMessage('Please select your clinician', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            // Validate password requirements
            if (!/[a-z]/.test(password) || !/[A-Z]/.test(password)) {
                showAuthMessage('Password must contain both lowercase and uppercase letters', 'error');
                return;
            }
            
            if (!/[0-9]/.test(password)) {
                showAuthMessage('Password must contain at least one number', 'error');
                return;
            }
            
            if (!/[^a-zA-Z0-9]/.test(password)) {
                showAuthMessage('Password must contain at least one special character (!@#$%^&* etc.)', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showAuthMessage('PIN must be 4 digits', 'error');
                return;
            }
            
            // Store registration data and show disclaimer
            currentUser = username;
            tempLoginData = { 
                type: 'patient',
                username, 
                password, 
                pin,
                email,
                phone,
                full_name: fullName,
                dob: dob,
                conditions: conditions,
                clinician_id,
                country,
                area,
                postcode,
                nhs_number
            };
            showDisclaimerModal();
        }
        
        async function completePatientRegistration(data) {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: data.username, 
                        password: data.password, 
                        pin: data.pin,
                        email: data.email,
                        phone: data.phone,
                        full_name: data.full_name,
                        dob: data.dob,
                        conditions: data.conditions,
                        clinician_id: data.clinician_id,
                        country: data.country,
                        area: data.area,
                        postcode: data.postcode,
                        nhs_number: data.nhs_number,
                        disclaimer_accepted: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Account created! Awaiting clinician approval.', 'success');
                    setTimeout(() => {
                        showPatientAuth();
                        document.getElementById('loginUsername').value = data.username;
                    }, 3000);
                } else {
                    showAuthMessage(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Register error:', error);
            }
        }
        
        async function registerClinician() {
            const username = document.getElementById('clinicianUsername').value.trim();
            const password = document.getElementById('clinicianPassword').value;
            const confirmPassword = document.getElementById('clinicianConfirmPassword').value;
            const pin = document.getElementById('clinicianPin').value;
            const confirmPin = document.getElementById('clinicianConfirmPin').value;
            const full_name = document.getElementById('clinicianFullName').value.trim();
            const email = document.getElementById('clinicianEmail').value.trim();
            const phone = document.getElementById('clinicianPhone').value.trim();
            const professional_id = document.getElementById('clinicianProfessionalId').value.trim();
            const country = document.getElementById('clinicianCountry').value.trim();
            const area = document.getElementById('clinicianArea').value.trim();
            
            if (!username || !password || !pin || !email || !phone || !full_name) {
                showAuthMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (!professional_id) {
                showAuthMessage('Please enter your professional ID number', 'error');
                return;
            }
            
            if (!country || !area) {
                showAuthMessage('Please enter your country and area', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showAuthMessage('PINs do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showAuthMessage('Password must be at least 8 characters', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showAuthMessage('PIN must be exactly 4 digits', 'error');
                return;
            }
            
            // Store registration data and show disclaimer
            currentUser = username;
            tempLoginData = { 
                type: 'clinician',
                username, 
                password, 
                pin,
                full_name,
                email,
                phone,
                professional_id,
                country,
                area
            };
            showDisclaimerModal();
        }
        
        async function completeClinicianRegistration(data) {
            try {
                const response = await fetch('/api/auth/clinician/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: data.username, 
                        password: data.password, 
                        pin: data.pin, 
                        full_name: data.full_name,
                        email: data.email,
                        phone: data.phone,
                        professional_id: data.professional_id,
                        country: data.country,
                        area: data.area,
                        disclaimer_accepted: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAuthMessage('Clinician account created successfully! Please login.', 'success');
                    setTimeout(() => {
                        showClinicianAuth();
                        document.getElementById('clinicianLoginUsername').value = data.username;
                    }, 2000);
                } else {
                    showAuthMessage(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Connection error. Please try again.', 'error');
                console.error('Clinician register error:', error);
            }
        }
        
        async function loadCliniciansForRegistration() {
            try {
                // Get country and area filters if provided
                const country = document.getElementById('regCountry')?.value.trim() || '';
                const area = document.getElementById('regArea')?.value.trim() || '';
                
                let url = '/api/clinicians/list';
                const params = new URLSearchParams();
                if (country) params.append('country', country);
                if (area) params.append('area', area);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                const select = document.getElementById('regClinician');
                if (response.ok && data.clinicians && data.clinicians.length > 0) {
                    select.innerHTML = '<option value="">-- Select your clinician --</option>' +
                        data.clinicians.map(c => 
                            `<option value="${c.username}">${c.full_name || c.username}${c.area ? ' (' + c.area + ')' : ''}</option>`
                        ).join('');
                } else {
                    select.innerHTML = '<option value="">No clinicians found in your area</option>';
                }
            } catch (error) {
                console.error('Error loading clinicians:', error);
                document.getElementById('regClinician').innerHTML = '<option value="">Error loading clinicians</option>';
            }
        }
        
        function showAuthMessage(message, type) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.textContent = message;
            msgDiv.className = `alert alert-${type}`;
            msgDiv.classList.remove('hidden');
        }
        
        // Notification Functions
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/notifications?username=${currentUser}`);
                const data = await response.json();
                
                if (response.ok && data.notifications) {
                    const unreadCount = data.notifications.filter(n => !n.read).length;
                    const badge = document.getElementById('notificationBadge');
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                    
                    const list = document.getElementById('notificationList');
                    if (data.notifications.length === 0) {
                        list.innerHTML = '<div class="notification-item">No notifications</div>';
                    } else {
                        list.innerHTML = data.notifications.map(n => `
                            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
                                <strong>${n.notification_type}</strong>
                                <p>${n.message}</p>
                                <small>${new Date(n.created_at).toLocaleString()}</small>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function showNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeNotifications() {
            document.getElementById('notificationPanel').style.display = 'none';
        }
        
        async function markNotificationRead(id) {
            try {
                await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        // Patient Approval Functions
        async function loadPendingApprovals() {
            if (currentUserRole !== 'clinician') return;
            
            try {
                const response = await fetch(`/api/approvals/pending?clinician=${currentUser}`);
                const data = await response.json();
                
                const container = document.getElementById('pendingApprovals');
                if (response.ok && data.pending_approvals && data.pending_approvals.length > 0) {
                    container.innerHTML = data.pending_approvals.map(approval => `
                        <div class="approval-request">
                            <div>
                                <strong>${approval.patient_username}</strong>
                                <p>Requested: ${new Date(approval.request_date).toLocaleString()}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="approvePatient(${approval.id})">
                                    ‚úì Approve
                                </button>
                                <button class="btn btn-danger" onclick="rejectPatient(${approval.id})">
                                    ‚úó Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #666;">No pending approval requests</p>';
                }
            } catch (error) {
                console.error('Error loading pending approvals:', error);
            }
        }
        
        async function approvePatient(approvalId) {
            if (!confirm('Approve this patient?')) return;
            
            try {
                const response = await fetch(`/api/approvals/${approvalId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clinician_username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Patient approved successfully!');
                    loadPendingApprovals();
                    loadNotifications();
                } else {
                    alert(data.error || 'Failed to approve patient');
                }
            } catch (error) {
                console.error('Error approving patient:', error);
                alert('Error approving patient');
            }
        }
        
        async function rejectPatient(approvalId) {
            if (!confirm('Reject this patient request?')) return;
            
            try {
                const response = await fetch(`/api/approvals/${approvalId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clinician_username: currentUser })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Patient request rejected');
                    loadPendingApprovals();
                    loadNotifications();
                } else {
                    alert(data.error || 'Failed to reject patient');
                }
            } catch (error) {
                console.error('Error rejecting patient:', error);
                alert('Error rejecting patient');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all session data
                localStorage.removeItem('healingSpaceSession');
                sessionStorage.removeItem('healingSpaceSession');
                
                currentUser = null;
                currentUserRole = 'user';
                document.getElementById('professionalTabBtn').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('chatMessages').innerHTML = '';
                selectedMoodValue = null;
                medications = [];
                
                // Clear login forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPin').value = '';
                document.getElementById('clinicianLoginUsername').value = '';
                document.getElementById('clinicianLoginPassword').value = '';
                document.getElementById('clinicianLoginPin').value = '';
                
                // Return to landing page
                showLanding();
            }
        }
        
        // Tab Navigation
        function switchTab(tabName, buttonEl) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            buttonEl.classList.add('active');
            
            // Load pet when switching to pet tab
            if (tabName === 'pet') {
                loadPetStatus();
            }
            
            // Load profile when switching to About Me tab
            if (tabName === 'aboutme') {
                loadProfile();
            }
            
            // Load appointments when switching to appointments tab
            if (tabName === 'appointments' && currentUserRole !== 'clinician') {
                loadPatientAppointments();
            }
            
            // Load pending approvals when switching to professional tab
            if (tabName === 'professional' && currentUserRole === 'clinician') {
                loadPendingApprovals();
                loadAppointments();
            }
        }
        
        // Chat Functions
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading
            const loadingId = Date.now();
            addMessage('<div class="loading"></div>', 'ai', loadingId);
            
            try {
                const response = await fetch('/api/therapy/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, message })
                });
                
                const data = await response.json();
                
                // Remove loading
                const loadingEl = document.getElementById('msg-' + loadingId);
                if (loadingEl) loadingEl.remove();
                
                if (response.ok) {
                    addMessage(data.response, 'ai');
                    // Reward pet for therapy session
                    await rewardPet('therapy');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            } catch (error) {
                document.getElementById('msg-' + loadingId)?.remove();
                addMessage('Connection error. Please check your internet.', 'ai');
                console.error('Chat error:', error);
            }
        }
        
        function addMessage(text, sender, id) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            if (id) messageEl.id = 'msg-' + id;
            messageEl.innerHTML = text;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addSystemMessage(text) {
            addMessage(text, 'ai');
        }
        
        // Mood Tracking
        function selectMood(value, element) {
            selectedMoodValue = value;
            document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function addMedication() {
            const name = document.getElementById('medName').value.trim();
            const strength = document.getElementById('medStrength').value.trim();
            const qty = document.getElementById('medQty').value.trim() || '1';
            
            if (!name) {
                showMessage('moodMessage', 'Please enter medication name', 'error');
                return;
            }
            
            medications.push({name, strength, quantity: qty});
            updateMedList();
            
            // Clear inputs
            document.getElementById('medName').value = '';
            document.getElementById('medStrength').value = '';
            document.getElementById('medQty').value = '1';
        }
        
        function updateMedList() {
            const listEl = document.getElementById('medList');
            listEl.innerHTML = medications.map((med, idx) => `
                <div class="med-item">
                    <span>${med.name} ${med.strength}mg (x${med.quantity})</span>
                    <button onclick="removeMed(${idx})">Remove</button>
                </div>
            `).join('');
        }
        
        function removeMed(index) {
            medications.splice(index, 1);
            updateMedList();
        }
        
        async function logMood() {
            if (!selectedMoodValue) {
                showMessage('moodMessage', 'Please select a mood level', 'error');
                return;
            }
            
            const sleep = parseFloat(document.getElementById('sleepHours').value) || 0;
            const water = parseFloat(document.getElementById('waterPints').value) || 0;
            const exercise = parseInt(document.getElementById('exerciseMins').value) || 0;
            const outside = parseInt(document.getElementById('outsideMins').value) || 0;
            const notes = document.getElementById('moodNotes').value.trim();
            
            try {
                const response = await fetch('/api/mood/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        mood_val: selectedMoodValue,
                        sleep_val: sleep,
                        water_pints: water,
                        exercise_mins: exercise,
                        outside_mins: outside,
                        meds: medications,
                        notes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('moodMessage', 'Mood logged successfully! üéâ Keep tracking your progress! (+5 Coins)', 'success');
                    // Reward pet
                    await rewardPet('mood');
                    // Clear form
                    selectedMoodValue = null;
                    medications = [];
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    document.getElementById('sleepHours').value = '';
                    document.getElementById('waterPints').value = '';
                    document.getElementById('exerciseMins').value = '';
                    document.getElementById('outsideMins').value = '';
                    document.getElementById('moodNotes').value = '';
                    updateMedList();
                } else if (response.status === 409) {
                    // Already logged today - show friendly message
                    showMessage('moodMessage', '‚úì You\'ve already logged your mood today! See you tomorrow! üòä', 'success');
                } else {
                    showMessage('moodMessage', data.error || 'Failed to log mood', 'error');
                }
            } catch (error) {
                showMessage('moodMessage', 'Connection error. Please try again.', 'error');
                console.error('Mood log error:', error);
            }
        }
        
        // Gratitude Journal
        async function logGratitude() {
            const entry = document.getElementById('gratitudeEntry').value.trim();
            
            if (!entry) {
                showMessage('gratitudeMessage', 'Please write something you\'re grateful for', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/gratitude/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, entry })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('gratitudeMessage', 'Gratitude entry saved! üôè Practice makes perfect! (+5 Coins)', 'success');
                    await rewardPet('gratitude');
                    document.getElementById('gratitudeEntry').value = '';
                } else {
                    showMessage('gratitudeMessage', data.error || 'Failed to save entry', 'error');
                }
            } catch (error) {
                showMessage('gratitudeMessage', 'Connection error. Please try again.', 'error');
                console.error('Gratitude log error:', error);
            }
        }
        
        // CBT Tools
        async function saveCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const thought = document.getElementById('cbtThought').value.trim();
            const evidence = document.getElementById('cbtEvidence').value.trim();
            
            if (!situation || !thought) {
                showMessage('cbtMessage', 'Please fill in situation and thought fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/cbt/thought-record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, situation, thought, evidence })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('cbtMessage', 'Thought record saved! üß† Great work challenging your thoughts! (+15 Coins)', 'success');
                    await rewardPet('cbt', 'cbt');
                    document.getElementById('cbtSituation').value = '';
                    document.getElementById('cbtThought').value = '';
                    document.getElementById('cbtEvidence').value = '';
                } else {
                    showMessage('cbtMessage', data.error || 'Failed to save record', 'error');
                }
            } catch (error) {
                showMessage('cbtMessage', 'Connection error. Please try again.', 'error');
            }
        }
        
        async function startBreathing() {
            const display = document.getElementById('breathingDisplay');
            display.classList.remove('hidden');
            
            for (let cycle = 0; cycle < 3; cycle++) {
                display.textContent = 'Breathe IN for 4...';
                await sleep(4000);
                display.textContent = 'HOLD for 7...';
                await sleep(7000);
                display.textContent = 'Breathe OUT for 8...';
                await sleep(8000);
            }
            
            display.textContent = '‚úÖ Exercise Complete! Well done!';
            await rewardPet('breathing');
            setTimeout(() => display.classList.add('hidden'), 3000);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Pet Game
        async function loadPetStatus() {
            try {
                const response = await fetch(`/api/pet/status?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (data.exists) {
                    document.getElementById('petCreate').classList.add('hidden');
                    document.getElementById('petDisplay').classList.remove('hidden');
                    updatePetDisplay(data.pet);
                } else {
                    document.getElementById('petCreate').classList.remove('hidden');
                    document.getElementById('petDisplay').classList.add('hidden');
                }
            } catch (error) {
                console.error('Pet load error:', error);
            }
        }
        
        async function createPet() {
            const name = document.getElementById('petName').value.trim();
            const species = document.getElementById('petSpecies').value;
            const gender = document.getElementById('petGender').value;
            
            if (!name) {
                alert('Please enter a pet name');
                return;
            }
            
            try {
                const response = await fetch('/api/pet/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, species, gender })
                });
                
                if (response.ok) {
                    alert(`${name} adopted! üéâ Take good care of your companion!`);
                    loadPetStatus();
                }
            } catch (error) {
                console.error('Pet create error:', error);
            }
        }
        
        function updatePetDisplay(pet) {
            document.getElementById('petNameDisplay').textContent = pet.name;
            document.getElementById('petEmojiDisplay').textContent = speciesEmojis[pet.species] || 'üêæ';
            document.getElementById('petCoins').textContent = pet.coins;
            document.getElementById('petXP').textContent = pet.xp;
            document.getElementById('petStage').textContent = pet.stage;
            
            document.getElementById('hungerBar').style.width = pet.hunger + '%';
            document.getElementById('happinessBar').style.width = pet.happiness + '%';
            document.getElementById('energyBar').style.width = pet.energy + '%';
            document.getElementById('hygieneBar').style.width = pet.hygiene + '%';
            
            // Check if pet is on an adventure and resume countdown
            if (pet.adventure_end && pet.adventure_end > 0) {
                const now = Date.now() / 1000;
                if (pet.adventure_end > now) {
                    startWalkCountdown(pet.adventure_end);
                }
            }
        }
        
        async function rewardPet(action, activity_type = null) {
            try {
                const response = await fetch('/api/pet/reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, activity_type })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Show reward notification
                        if (data.evolved) {
                            alert(`üéâ Amazing! Your pet evolved to ${data.new_stage}!`);
                        }
                        // Refresh pet display if on pet tab
                        if (document.getElementById('petTab').classList.contains('active')) {
                            loadPetStatus();
                        }
                    }
                }
            } catch (error) {
                console.error('Pet reward error:', error);
            }
        }
        
        async function refreshPet() {
            await applyPetDecay();
            await loadPetStatus();
            await checkPetReturn();
        }
        
        async function applyPetDecay() {
            try {
                await fetch('/api/pet/apply-decay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.error('Pet decay error:', error);
            }
        }
        
        let walkCountdownInterval = null;
        
        async function checkPetReturn() {
            try {
                const response = await fetch('/api/pet/check-return', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.returned) {
                        alert('üéâ ' + data.message + ' Earned: ü™ô ' + data.coins_earned + ' coins!');
                        loadPetStatus();
                    }
                }
            } catch (error) {
                console.error('Pet return check error:', error);
            }
        }
        
        function openShop() {
            const shopModal = document.getElementById('shopModal');
            shopModal.classList.remove('hidden');
            loadShopItems();
        }
        
        function closeShop() {
            document.getElementById('shopModal').classList.add('hidden');
        }
        
        async function loadShopItems() {
            try {
                const response = await fetch('/api/pet/shop');
                const data = await response.json();
                
                const currentCoins = parseInt(document.getElementById('petCoins').textContent);
                document.getElementById('shopCoins').textContent = currentCoins;
                
                const container = document.getElementById('shopItems');
                container.innerHTML = data.items.map(item => `
                    <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px;">${item.name}</div>
                            <div style="font-size: 13px; color: #666;">${item.description}</div>
                        </div>
                        <button class="btn" onclick="buyItem('${item.id}')" style="padding: 8px 16px; ${currentCoins < item.cost ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ü™ô ${item.cost}
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Shop load error:', error);
            }
        }
        
        async function buyItem(itemId) {
            try {
                const response = await fetch('/api/pet/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('Item purchased! üéâ');
                    loadPetStatus();
                    loadShopItems();
                } else {
                    alert(data.error || 'Purchase failed');
                }
            } catch (error) {
                console.error('Buy error:', error);
                alert('Purchase failed');
            }
        }
        
        function openDeclutter() {
            document.getElementById('declutterModal').classList.remove('hidden');
            document.getElementById('worry1').value = '';
            document.getElementById('worry2').value = '';
            document.getElementById('worry3').value = '';
        }
        
        function closeDeclutter() {
            document.getElementById('declutterModal').classList.add('hidden');
        }
        
        async function submitDeclutter() {
            const worry1 = document.getElementById('worry1').value.trim();
            const worry2 = document.getElementById('worry2').value.trim();
            const worry3 = document.getElementById('worry3').value.trim();
            
            const worries = [worry1, worry2, worry3].filter(w => w);
            
            if (worries.length === 0) {
                alert('Please enter at least one worry to throw away');
                return;
            }
            
            try {
                const response = await fetch('/api/pet/declutter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ worries })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message);
                    closeDeclutter();
                    loadPetStatus();
                } else {
                    alert(data.error || 'Declutter failed');
                }
            } catch (error) {
                console.error('Declutter error:', error);
            }
        }
        
        async function startAdventure() {
            // Check current status first
            try {
                const statusResponse = await fetch(`/api/pet/status?username=${encodeURIComponent(currentUser)}`);
                const statusData = await statusResponse.json();
                
                if (statusData.exists && statusData.pet.adventure_end) {
                    const remaining = statusData.pet.adventure_end - (Date.now() / 1000);
                    if (remaining > 0) {
                        const minutes = Math.ceil(remaining / 60);
                        alert(`Your pet is still on a walk! Please wait ${minutes} more minute(s).`);
                        return;
                    }
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
            
            const confirm = window.confirm("Send your pet on a 30-minute walk? Your pet will earn rewards when they return!");
            
            if (!confirm) return;
            
            try {
                const response = await fetch('/api/pet/adventure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message + ' They will return with rewards in 30 minutes! üéÅ');
                    startWalkCountdown(data.return_time);
                    loadPetStatus();
                } else {
                    alert(data.error || 'Adventure failed');
                }
            } catch (error) {
                console.error('Adventure error:', error);
            }
        }
        
        function startWalkCountdown(returnTime) {
            const walkBtn = document.getElementById('walkBtn');
            const countdownDiv = document.getElementById('walkCountdown');
            
            walkBtn.disabled = true;
            walkBtn.style.opacity = '0.5';
            walkBtn.style.cursor = 'not-allowed';
            countdownDiv.style.display = 'block';
            
            if (walkCountdownInterval) clearInterval(walkCountdownInterval);
            
            walkCountdownInterval = setInterval(() => {
                const now = Date.now() / 1000;
                const remaining = returnTime - now;
                
                if (remaining <= 0) {
                    clearInterval(walkCountdownInterval);
                    walkBtn.disabled = false;
                    walkBtn.style.opacity = '1';
                    walkBtn.style.cursor = 'pointer';
                    countdownDiv.style.display = 'none';
                    checkPetReturn();
                } else {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = Math.floor(remaining % 60);
                    countdownDiv.textContent = `üå≤ Pet returns in: ${minutes}m ${seconds}s`;
                }
            }, 1000);
        }
        
        // Auto-refresh pet when tab is active
        setInterval(() => {
            if (document.getElementById('petTab').classList.contains('active')) {
                refreshPet();
            }
        }, 60000); // Every minute
        
        // Clinical Assessments
        function startPHQ9() {
            currentAssessment = 'PHQ-9';
            assessmentScores = [];
            showAssessmentModal('PHQ-9 Depression Screening', PHQ9_QUESTIONS);
        }
        
        function startGAD7() {
            currentAssessment = 'GAD-7';
            assessmentScores = [];
            showAssessmentModal('GAD-7 Anxiety Screening', GAD7_QUESTIONS);
        }
        
        function showAssessmentModal(title, questions) {
            document.getElementById('assessmentTitle').textContent = title;
            const container = document.getElementById('assessmentQuestions');
            container.innerHTML = questions.map((q, idx) => `
                <div style="margin: 20px 0; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="margin-bottom: 10px; font-weight: 600;">${idx + 1}. ${q}</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="0" onchange="setScore(${idx}, 0)"> Not at all
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="1" onchange="setScore(${idx}, 1)"> Several days
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="2" onchange="setScore(${idx}, 2)"> More than half
                        </label>
                        <label style="flex: 1; min-width: 120px;">
                            <input type="radio" name="q${idx}" value="3" onchange="setScore(${idx}, 3)"> Nearly every day
                        </label>
                    </div>
                </div>
            `).join('');
            document.getElementById('assessmentModal').classList.remove('hidden');
        }
        
        function setScore(index, value) {
            assessmentScores[index] = parseInt(value);
        }
        
        async function submitAssessment() {
            const expectedLength = currentAssessment === 'PHQ-9' ? 9 : 7;
            
            if (assessmentScores.length !== expectedLength || assessmentScores.includes(undefined)) {
                alert('Please answer all questions');
                return;
            }
            
            try {
                const endpoint = currentAssessment === 'PHQ-9' ? '/api/clinical/phq9' : '/api/clinical/gad7';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, scores: assessmentScores })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Assessment Complete!\n\nScore: ${data.score}\nSeverity: ${data.severity}\n\n+20 Coins for completing assessment!\n\nConsult with a mental health professional for personalized care.`);
                    await rewardPet('clinical', 'clinical');
                    closeAssessment();
                } else {
                    alert('Error submitting assessment');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Assessment error:', error);
            }
        }
        
        function closeAssessment() {
            document.getElementById('assessmentModal').classList.add('hidden');
            assessmentScores = [];
            currentAssessment = null;
        }
        
        // History
        async function loadHistory() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading your history...</p></div>';
            
            try {
                const response = await fetch(`/api/mood/history?username=${encodeURIComponent(currentUser)}&limit=30`);
                const data = await response.json();
                
                if (response.ok && data.logs && data.logs.length > 0) {
                    const moodEmojis = {1: 'üò¢', 2: 'üò¢', 3: 'üòî', 4: 'üòî', 5: 'üòê', 6: 'üòê', 7: 'üôÇ', 8: 'üôÇ', 9: 'üòÑ', 10: 'üòÑ'};
                    const html = '<div class="history-grid">' + 
                        data.logs.map(log => `
                            <div class="history-card">
                                <div class="date">${new Date(log.timestamp).toLocaleString()}</div>
                                <div style="font-size: 24px; margin: 10px 0;">${moodEmojis[log.mood_val]} <strong>${log.mood_val}/10</strong></div>
                                <div><strong>Sleep:</strong> ${log.sleep_val} hours</div>
                                ${log.water_pints ? `<div><strong>Water:</strong> ${log.water_pints} pints</div>` : ''}
                                ${log.exercise_mins ? `<div><strong>Exercise:</strong> ${log.exercise_mins} mins</div>` : ''}
                                ${log.outside_mins ? `<div><strong>Outdoors:</strong> ${log.outside_mins} mins</div>` : ''}
                                ${log.meds ? `<div><strong>Medications:</strong> ${log.meds}</div>` : ''}
                                ${log.notes ? `<div style="margin-top: 10px;"><strong>Notes:</strong><br>${log.notes}</div>` : ''}
                            </div>
                        `).join('') +
                        '</div>';
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = 
                        '<p style="text-align: center; color: #999; padding: 40px;">No mood logs yet. Start tracking in the Mood & Habits tab! üìä</p>';
                }
            } catch (error) {
                historyContent.innerHTML = 
                    '<p style="text-align: center; color: #dc3545; padding: 40px;">Error loading history. Please try again.</p>';
                console.error('History load error:', error);
            }
        }
        
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `alert alert-${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        // Community Functions
        async function loadCommunity() {
            const postsDiv = document.getElementById('communityPosts');
            postsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/community/posts?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok && data.posts && data.posts.length > 0) {
                    const html = data.posts.map(post => `
                        <div class="community-post" id="post-${post.id}">
                            <div class="post-header">
                                <strong>${post.username}</strong>
                                <span>${new Date(post.timestamp).toLocaleString()}</span>
                                ${post.username === currentUser ? `<button onclick="deletePost(${post.id})" style="background: #e74c3c; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;">Delete</button>` : ''}
                            </div>
                            <div class="post-message">${post.message}</div>
                            <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 14px;">
                                <button onclick="likePost(${post.id})" style="background: none; border: none; cursor: pointer; color: ${post.liked_by_user ? '#e74c3c' : '#666'}; font-size: 14px;">‚ù§Ô∏è ${post.likes} ${post.likes === 1 ? 'like' : 'likes'}</button>
                                <button onclick="toggleReplies(${post.id})" style="background: none; border: none; cursor: pointer; color: #667eea; font-size: 14px;">üí¨ Reply</button>
                            </div>
                            <div id="replies-${post.id}" style="display: none; margin-top: 15px; padding-left: 20px; border-left: 3px solid #e0e0e0;">
                                <textarea id="reply-input-${post.id}" rows="2" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #e0e0e0; margin-bottom: 8px;" placeholder="Write a reply..."></textarea>
                                <button onclick="postReply(${post.id})" class="btn" style="padding: 8px 16px; font-size: 13px;">Post Reply</button>
                                <div id="reply-list-${post.id}" style="margin-top: 15px;"></div>
                            </div>
                        </div>
                    `).join('');
                    postsDiv.innerHTML = html;
                } else {
                    postsDiv.innerHTML = '<p style="text-align: center; color: #999;">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                postsDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading posts</p>';
                console.error('Community load error:', error);
            }
        }
        
        async function postCommunity() {
            const message = document.getElementById('communityMessage').value.trim();
            
            if (!message) {
                alert('Please write a message before posting');
                return;
            }
            
            try {
                const response = await fetch('/api/community/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, message })
                });
                
                if (response.ok) {
                    document.getElementById('communityMessage').value = '';
                    alert('Message posted successfully!');
                    loadCommunity();
                } else {
                    alert('Error posting message');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Post error:', error);
            }
        }
        
        async function likePost(postId) {
            try {
                const response = await fetch(`/api/community/post/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                if (response.ok) {
                    loadCommunity(); // Refresh to show updated likes
                } else {
                    alert('Error liking post');
                }
            } catch (error) {
                console.error('Like error:', error);
            }
        }
        
        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/community/post/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });
                
                if (response.ok) {
                    alert('Post deleted successfully');
                    loadCommunity(); // Refresh posts
                } else {
                    alert('Error deleting post. You can only delete your own posts.');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Delete error:', error);
            }
        }
        
        function toggleReplies(postId) {
            const repliesDiv = document.getElementById(`replies-${postId}`);
            if (repliesDiv.style.display === 'none') {
                repliesDiv.style.display = 'block';
                loadReplies(postId);
            } else {
                repliesDiv.style.display = 'none';
            }
        }
        
        async function loadReplies(postId) {
            const replyList = document.getElementById(`reply-list-${postId}`);
            replyList.innerHTML = '<div style="text-align: center; color: #999;">Loading replies...</div>';
            
            try {
                const response = await fetch(`/api/community/post/${postId}/replies`);
                const data = await response.json();
                
                if (response.ok && data.replies && data.replies.length > 0) {
                    const html = data.replies.map(reply => `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                <strong>${reply.username}</strong> ‚Ä¢ ${new Date(reply.timestamp).toLocaleString()}
                            </div>
                            <div style="font-size: 14px;">${reply.message}</div>
                        </div>
                    `).join('');
                    replyList.innerHTML = html;
                } else {
                    replyList.innerHTML = '<div style="text-align: center; color: #999; font-size: 13px;">No replies yet</div>';
                }
            } catch (error) {
                replyList.innerHTML = '<div style="text-align: center; color: #dc3545; font-size: 13px;">Error loading replies</div>';
                console.error('Replies load error:', error);
            }
        }
        
        async function postReply(postId) {
            const replyInput = document.getElementById(`reply-input-${postId}`);
            const message = replyInput.value.trim();
            
            if (!message) {
                alert('Please write a reply before posting');
                return;
            }
            
            try {
                const response = await fetch(`/api/community/post/${postId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, message })
                });
                
                if (response.ok) {
                    replyInput.value = '';
                    loadReplies(postId); // Refresh replies
                } else {
                    alert('Error posting reply');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Reply error:', error);
            }
        }
        
        // Safety Plan Functions
        async function loadSafetyPlan() {
            try {
                const response = await fetch(`/api/safety-plan?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('safetyTriggers').value = data.triggers || '';
                    document.getElementById('safetyCoping').value = data.coping_strategies || '';
                    document.getElementById('safetySupport').value = data.support_contacts || '';
                    document.getElementById('safetyProfessional').value = data.professional_contacts || '';
                    alert('Safety plan loaded successfully');
                } else {
                    alert('Error loading safety plan');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Safety plan load error:', error);
            }
        }
        
        async function saveSafetyPlan() {
            const triggers = document.getElementById('safetyTriggers').value;
            const coping = document.getElementById('safetyCoping').value;
            const support = document.getElementById('safetySupport').value;
            const professional = document.getElementById('safetyProfessional').value;
            
            try {
                const response = await fetch('/api/safety-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        triggers,
                        coping_strategies: coping,
                        support_contacts: support,
                        professional_contacts: professional
                    })
                });
                
                if (response.ok) {
                    alert('Safety plan saved successfully!');
                } else {
                    alert('Error saving safety plan');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Safety plan save error:', error);
            }
        }
        
        // Appointments Functions
        async function loadPatientAppointments() {
            try {
                const response = await fetch(`/api/appointments?patient=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                const listDiv = document.getElementById('appointmentsList');
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    listDiv.innerHTML = data.appointments.map(apt => {
                        const date = new Date(apt.appointment_date);
                        const dateStr = date.toLocaleDateString('en-GB', { 
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                        });
                        const timeStr = date.toLocaleTimeString('en-GB', { 
                            hour: '2-digit', minute: '2-digit' 
                        });
                        
                        const isPast = date < new Date();
                        const statusColor = apt.patient_response === 'accepted' ? '#28a745' : 
                                           apt.patient_response === 'declined' ? '#dc3545' : '#ffc107';
                        const statusText = apt.patient_response === 'accepted' ? '‚úì Accepted' :
                                          apt.patient_response === 'declined' ? '‚úó Declined' : 
                                          '‚è≥ Awaiting Response';
                        
                        return `
                            <div class="card" style="margin-bottom: 20px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #667eea;">üìÖ ${apt.appointment_type || 'Consultation'}</h4>
                                        <p style="margin: 0; color: #666; font-size: 14px;">With ${apt.clinician_username}</p>
                                    </div>
                                    <span style="background: ${statusColor}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                        ${statusText}
                                    </span>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <p style="margin: 0 0 5px 0;"><strong>üìÜ Date:</strong> ${dateStr}</p>
                                    <p style="margin: 0 0 5px 0;"><strong>üïê Time:</strong> ${timeStr}</p>
                                    ${apt.notes ? `<p style="margin: 10px 0 0 0; padding-top: 10px; border-top: 1px solid #e0e0e0;"><strong>Notes:</strong> ${apt.notes}</p>` : ''}
                                </div>
                                
                                ${!apt.patient_acknowledged && !isPast ? `
                                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                        <p style="margin: 0 0 10px 0; color: #856404;">
                                            <strong>‚ö†Ô∏è Please acknowledge this appointment</strong>
                                        </p>
                                        <label style="display: flex; align-items: center; cursor: pointer; color: #333;">
                                            <input type="checkbox" id="ack-${apt.id}" style="width: 20px; height: 20px; margin-right: 10px;">
                                            <span>I have read and understood this appointment</span>
                                        </label>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="respondToAppointment(${apt.id}, 'accepted')" style="flex: 1; background: #28a745;">
                                            ‚úì Accept Appointment
                                        </button>
                                        <button class="btn" onclick="respondToAppointment(${apt.id}, 'declined')" style="flex: 1; background: #dc3545;">
                                            ‚úó Decline Appointment
                                        </button>
                                    </div>
                                ` : apt.patient_response_date ? `
                                    <p style="margin: 0; color: #666; font-size: 13px; text-align: center;">
                                        Response sent: ${new Date(apt.patient_response_date).toLocaleString('en-GB')}
                                    </p>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    listDiv.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <p style="font-size: 48px; margin: 0 0 15px 0;">üìÖ</p>
                            <h4 style="margin: 0 0 10px 0;">No Appointments</h4>
                            <p style="color: #666; margin: 0;">You don't have any upcoming appointments scheduled.</p>
                            <p style="color: #999; margin-top: 10px; font-size: 14px;">Your clinician will schedule appointments as needed.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsList').innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545;">Failed to load appointments. Please try again.</p>
                    </div>
                `;
            }
        }
        
        async function respondToAppointment(appointmentId, response) {
            const checkbox = document.getElementById(`ack-${appointmentId}`);
            
            if (!checkbox || !checkbox.checked) {
                alert('‚ö†Ô∏è You must tick the box to confirm you have read the appointment details before responding.');
                return;
            }
            
            const action = response === 'accepted' ? 'accept' : 'decline';
            if (!confirm(`Are you sure you want to ${action} this appointment?`)) {
                return;
            }
            
            try {
                const apiResponse = await fetch(`/api/appointments/${appointmentId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_username: currentUser,
                        acknowledged: true,
                        response: response
                    })
                });
                
                const data = await apiResponse.json();
                
                if (apiResponse.ok) {
                    alert(`‚úì Appointment ${response}! Your clinician has been notified.`);
                    loadPatientAppointments(); // Reload to show updated status
                } else {
                    alert('Error: ' + (data.error || 'Failed to respond to appointment'));
                }
            } catch (error) {
                console.error('Error responding to appointment:', error);
                alert('Failed to respond to appointment. Please try again.');
            }
        }
        
        // Insights Functions
        function setInsightsRange(days) {
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - days);
            
            document.getElementById('insightsToDate').valueAsDate = toDate;
            document.getElementById('insightsFromDate').valueAsDate = fromDate;
            loadInsights();
        }
        
        async function loadInsights() {
            try {
                let url = `/api/insights?username=${encodeURIComponent(currentUser)}`;
                
                // Add date range if specified
                const fromDate = document.getElementById('insightsFromDate')?.value;
                const toDate = document.getElementById('insightsToDate')?.value;
                if (fromDate) url += `&from_date=${fromDate}`;
                if (toDate) url += `&to_date=${toDate}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('avgMood').textContent = data.avg_mood.toFixed(1);
                    document.getElementById('avgSleep').textContent = data.avg_sleep.toFixed(1) + 'h';
                    document.getElementById('moodTrend').textContent = data.trend;
                    document.getElementById('aiInsight').innerHTML = `<p>${data.insight}</p>`;
                    
                    // Draw mood chart
                    if (data.mood_data && data.mood_data.length > 0) {
                        drawMoodChart(data.mood_data);
                    }
                    
                    // Draw sleep chart
                    if (data.sleep_data && data.sleep_data.length > 0) {
                        drawSleepChart(data.sleep_data);
                    }
                } else {
                    alert('Error loading insights');
                }
            } catch (error) {
                alert('Connection error');
                console.error('Insights load error:', error);
            }
        }
        
        function drawMoodChart(moodData) {
            const canvas = document.getElementById('moodChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = height - padding - (i * (height - 2 * padding) / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i, padding - 10, y + 4);
            }
            
            // Draw line
            if (moodData.length > 1) {
                const stepX = (width - 2 * padding) / (moodData.length - 1);
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moodData.forEach((point, index) => {
                    const x = padding + index * stepX;
                    const y = height - padding - (point.value * (height - 2 * padding) / 10);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            moodData.forEach((point, index) => {
                const x = padding + index * ((width - 2 * padding) / (moodData.length - 1));
                const date = new Date(point.timestamp);
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                ctx.fillText(label, x, height - padding + 20);
            });
        }
        
        function drawSleepChart(sleepData) {
            const canvas = document.getElementById('sleepChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const maxHours = 12; // Maximum sleep hours for scale
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= maxHours; i++) {
                const y = height - padding - (i * (height - 2 * padding) / maxHours);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i + 'h', padding - 10, y + 4);
            }
            
            // Draw line
            if (sleepData.length > 1) {
                const stepX = (width - 2 * padding) / (sleepData.length - 1);
                
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                sleepData.forEach((point, index) => {
                    const x = padding + index * stepX;
                    const y = height - padding - (point.value * (height - 2 * padding) / maxHours);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            sleepData.forEach((point, index) => {
                const x = padding + index * ((width - 2 * padding) / (sleepData.length - 1));
                const date = new Date(point.timestamp);
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                ctx.fillText(label, x, height - padding + 20);
            });
        }
        
        async function exportCSV() {
            window.location.href = `/api/export/csv?username=${encodeURIComponent(currentUser)}`;
        }
        
        async function exportPDF() {
            window.location.href = `/api/export/pdf?username=${encodeURIComponent(currentUser)}`;
        }
        
        // About Me Functions
        async function loadProfile() {
            try {
                const response = await fetch(`/api/patient/profile?username=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Fill in profile fields
                    document.getElementById('profileFullName').value = data.profile.full_name || '';
                    document.getElementById('profileDOB').value = data.profile.dob || '';
                    document.getElementById('profileEmail').value = data.profile.email || '';
                    document.getElementById('profilePhone').value = data.profile.phone || '';
                    document.getElementById('profileConditions').value = data.profile.conditions || '';
                    
                    // Display clinician info
                    const clinicianDiv = document.getElementById('clinicianInfo');
                    if (data.profile.assigned_clinician) {
                        clinicianDiv.innerHTML = `
                            <p><strong>Assigned Clinician:</strong> ${data.profile.assigned_clinician}</p>
                            <p><strong>Email:</strong> ${data.profile.clinician_email || 'Not provided'}</p>
                            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                                Your clinician can view your progress and provide professional support.
                            </p>
                        `;
                    } else {
                        clinicianDiv.innerHTML = '<p style="color: #999;">No clinician assigned yet.</p>';
                    }
                    
                    // Display activity stats
                    document.getElementById('statMoodLogs').textContent = data.stats.mood_logs || 0;
                    document.getElementById('statGratitude').textContent = data.stats.gratitude_entries || 0;
                    document.getElementById('statCBT').textContent = data.stats.cbt_entries || 0;
                    document.getElementById('statSessions').textContent = data.stats.therapy_sessions || 0;
                } else {
                    alert('Error loading profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile');
            }
        }
        
        async function saveProfile() {
            const profileData = {
                username: currentUser,
                full_name: document.getElementById('profileFullName').value,
                dob: document.getElementById('profileDOB').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                conditions: document.getElementById('profileConditions').value
            };
            
            try {
                const response = await fetch('/api/patient/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Profile saved successfully!');
                } else {
                    alert('Error saving profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile');
            }
        }
        
        // Sleep Hygiene Functions
        function resetSleepChecklist() {
            document.querySelectorAll('.sleep-check').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Professional Dashboard Functions
        let currentPatientData = null;
        let currentPatientTab = 'profile';
        
        async function loadPatients() {
            if (currentUserRole !== 'clinician') {
                alert('Access denied. Professional dashboard is only for clinicians.');
                return;
            }
            
            const listDiv = document.getElementById('patientList');
            listDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/professional/patients?clinician=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    const html = data.patients.map(patient => `
                        <div class="patient-card" onclick="viewPatientDetail('${patient.username}')" style="cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s; hover: {border-color: #667eea;}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <strong style="font-size: 20px; color: #333;">${patient.username}</strong>
                                    <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Last active: ${new Date(patient.last_login || Date.now()).toLocaleDateString()}</p>
                                </div>
                                ${patient.alert_count_7d > 0 ? `<span style="background: #e74c3c; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold;">üö® ${patient.alert_count_7d} alerts</span>` : `<span style="background: #28a745; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px;">‚úì No alerts</span>`}
                            </div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 28px; font-weight: bold; color: #667eea;">${patient.avg_mood_7d || 'N/A'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">Avg Mood (7d)</div>
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 28px; font-weight: bold; color: ${getSeverityColor(patient.latest_assessment?.severity)}">${patient.latest_assessment?.score || 'N/A'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">${patient.latest_assessment ? patient.latest_assessment.name : 'No Assessment'}</div>
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="font-size: 20px; font-weight: bold; color: ${getSeverityColor(patient.latest_assessment?.severity)}">${patient.latest_assessment?.severity || '-'}</div>
                                    <div style="font-size: 12px; color: #999; text-transform: uppercase;">Severity</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No patients found. Patients will appear here after you approve their requests.</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading patients</p>';
                console.error('Patient load error:', error);
            }
        }
        
        async function viewPatientDetail(username) {
            document.getElementById('patientListSection').style.display = 'none';
            document.getElementById('patientDetailSection').style.display = 'block';
            document.getElementById('patientDetailName').textContent = username;
            currentPatientTab = 'profile';
            
            // Initialize date range to last 30 days
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - 30);
            document.getElementById('patientChartToDate').valueAsDate = toDate;
            document.getElementById('patientChartFromDate').valueAsDate = fromDate;
            
            // Show loading
            document.getElementById('patientDetailContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/professional/patient/${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (response.ok) {
                    currentPatientData = data;
                    
                    // Generate AI summary
                    generateAISummary(username, data);
                    
                    // Load charts with current date range
                    loadPatientCharts();
                    
                    // Show profile tab by default
                    showPatientTab('profile');
                } else {
                    document.getElementById('patientDetailContent').innerHTML = '<p style="color: #dc3545;">Error loading patient data</p>';
                }
            } catch (error) {
                document.getElementById('patientDetailContent').innerHTML = '<p style="color: #dc3545;">Connection error</p>';
                console.error('Patient detail error:', error);
            }
        }
        
        function setPatientChartRange(days) {
            const toDate = new Date();
            const fromDate = new Date();
            fromDate.setDate(toDate.getDate() - days);
            
            document.getElementById('patientChartToDate').valueAsDate = toDate;
            document.getElementById('patientChartFromDate').valueAsDate = fromDate;
            loadPatientCharts();
        }
        
        async function loadPatientCharts() {
            if (!currentPatientData) return;
            
            const fromDate = document.getElementById('patientChartFromDate')?.value;
            const toDate = document.getElementById('patientChartToDate')?.value;
            
            try {
                let url = `/api/insights?username=${encodeURIComponent(currentPatientData.username)}`;
                if (fromDate) url += `&from_date=${fromDate}`;
                if (toDate) url += `&to_date=${toDate}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    // Draw mood chart
                    if (data.mood_data && data.mood_data.length > 0) {
                        drawPatientMoodChart(data.mood_data);
                    }
                    
                    // Draw sleep chart
                    if (data.sleep_data && data.sleep_data.length > 0) {
                        drawPatientSleepChart(data.sleep_data);
                    }
                }
            } catch (error) {
                console.error('Chart loading error:', error);
            }
        }
        
        function drawPatientMoodChart(moods) {
            const canvas = document.getElementById('moodChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            if (!moods || moods.length === 0) {
                ctx.clearRect(0, 0, width, height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No mood data available', width / 2, height / 2);
                return;
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = height - padding - (i * (height - 2 * padding) / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i, padding - 10, y + 4);
            }
            
            // Draw line
            if (moods.length > 1) {
                const stepX = (width - 2 * padding) / (moods.length - 1);
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moods.forEach((point, index) => {
                    const moodValue = point.value !== undefined ? point.value : point.mood;
                    const x = padding + index * stepX;
                    const y = height - padding - (moodValue * (height - 2 * padding) / 10);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelStep = Math.max(1, Math.floor(moods.length / 10));
            moods.forEach((point, index) => {
                if (index % labelStep === 0 || index === moods.length - 1) {
                    const x = padding + index * ((width - 2 * padding) / (moods.length - 1));
                    const date = new Date(point.timestamp);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, x, height - padding + 20);
                }
            });
        }
        
        function drawPatientSleepChart(sleepData) {
            const canvas = document.getElementById('sleepChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const maxHours = 12;
            
            if (!sleepData || sleepData.length === 0) {
                ctx.clearRect(0, 0, width, height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No sleep data available', width / 2, height / 2);
                return;
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= maxHours; i++) {
                const y = height - padding - (i * (height - 2 * padding) / maxHours);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(i + 'h', padding - 10, y + 4);
            }
            
            // Draw line
            if (sleepData.length > 1) {
                const stepX = (width - 2 * padding) / (sleepData.length - 1);
                
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                sleepData.forEach((point, index) => {
                    const sleepValue = point.value !== undefined ? point.value : point.sleep;
                    const x = padding + index * stepX;
                    const y = height - padding - (sleepValue * (height - 2 * padding) / maxHours);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelStep = Math.max(1, Math.floor(sleepData.length / 10));
            sleepData.forEach((point, index) => {
                if (index % labelStep === 0 || index === sleepData.length - 1) {
                    const x = padding + index * ((width - 2 * padding) / (sleepData.length - 1));
                    const date = new Date(point.timestamp);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, x, height - padding + 20);
                }
            });
        }
        
        async function generateAISummary(username, data) {
            const summaryDiv = document.getElementById('aiSummary');
            
            try {
                // Call API to get AI summary
                const response = await fetch('/api/professional/ai-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (response.ok && result.summary) {
                    summaryDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.8;">
                            <p style="white-space: pre-wrap;">${result.summary}</p>
                        </div>
                    `;
                } else {
                    // Fallback to basic summary
                    const avgMood = data.recent_moods.reduce((acc, m) => acc + m.mood, 0) / (data.recent_moods.length || 1);
                    const latestAssessment = data.clinical_scales[0];
                    const alertCount = data.recent_alerts.length;
                    
                    summaryDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p><strong>Clinical Overview:</strong></p>
                            <ul style="line-height: 1.8; margin-top: 10px;">
                                <li>Average mood over last 30 days: <strong>${avgMood.toFixed(1)}/10</strong></li>
                                <li>Latest assessment: <strong>${latestAssessment ? `${latestAssessment.name} - ${latestAssessment.severity} (Score: ${latestAssessment.score})` : 'No assessments recorded'}</strong></li>
                                <li>Recent alerts: <strong style="color: ${alertCount > 0 ? '#e74c3c' : '#28a745'}">${alertCount} ${alertCount === 1 ? 'alert' : 'alerts'}</strong></li>
                                <li>Therapy sessions: <strong>${data.recent_moods.length} mood entries recorded</strong></li>
                            </ul>
                            ${alertCount > 0 ? '<p style="color: #e74c3c; margin-top: 15px; font-weight: bold;">‚ö†Ô∏è Requires immediate attention</p>' : '<p style="color: #28a745; margin-top: 15px;">‚úì Patient appears stable</p>'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI summary error:', error);
                summaryDiv.innerHTML = '<p style="color: #999;">AI summary unavailable</p>';
            }
        }
        
        function showPatientTab(tabName) {
            // Update button styles
            ['profile', 'moods', 'assessments', 'therapy', 'alerts'].forEach(tab => {
                const btn = document.getElementById(tab + 'TabBtn');
                if (btn) {
                    if (tab === tabName) {
                        btn.style.background = '#667eea';
                        btn.style.color = 'white';
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn');
                    } else {
                        btn.style.background = '';
                        btn.style.color = '';
                        btn.classList.remove('btn');
                        btn.classList.add('btn-secondary');
                    }
                }
            });
            
            currentPatientTab = tabName;
            const data = currentPatientData;
            const contentDiv = document.getElementById('patientDetailContent');
            
            if (!data) {
                contentDiv.innerHTML = '<p>No data available</p>';
                return;
            }
            
            let html = '';
            
            switch (tabName) {
                case 'profile':
                    html = `
                        <div class="card">
                            <h4>Patient Profile</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold; width: 30%;">Username</td>
                                    <td style="padding: 12px 0;">${data.profile.username || 'N/A'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Full Name</td>
                                    <td style="padding: 12px 0;">${data.profile.name || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Email</td>
                                    <td style="padding: 12px 0;">${data.profile.email || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Phone</td>
                                    <td style="padding: 12px 0;">${data.profile.phone || 'Not provided'}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px 0; font-weight: bold;">Date of Birth</td>
                                    <td style="padding: 12px 0;">${data.profile.dob || 'Not provided'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 0; font-weight: bold; vertical-align: top;">Conditions</td>
                                    <td style="padding: 12px 0;">${data.profile.conditions || 'Not provided'}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                    break;
                    
                case 'moods':
                    html = `
                        <div class="card">
                            <h4>Mood Logs (Last 30 Days)</h4>
                            ${data.recent_moods.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left;">Date</th>
                                            <th style="padding: 12px; text-align: center;">Mood</th>
                                            <th style="padding: 12px; text-align: center;">Sleep</th>
                                            <th style="padding: 12px; text-align: center;">Exercise</th>
                                            <th style="padding: 12px; text-align: left;">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.recent_moods.map(m => `
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="padding: 12px;">${new Date(m.timestamp).toLocaleDateString()}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: bold; color: ${m.mood >= 7 ? '#28a745' : m.mood >= 4 ? '#ffc107' : '#dc3545'};">${m.mood}/10</td>
                                                <td style="padding: 12px; text-align: center;">${m.sleep || 0}h</td>
                                                <td style="padding: 12px; text-align: center;">${m.exercise || 0}min</td>
                                                <td style="padding: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${m.notes || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: #999; padding: 20px; text-align: center;">No mood logs recorded yet</p>'}
                        </div>
                    `;
                    break;
                    
                case 'assessments':
                    html = `
                        <div class="card">
                            <h4>Clinical Assessments</h4>
                            ${data.clinical_scales.length > 0 ? data.clinical_scales.map(s => `
                                <div style="padding: 20px; border-bottom: 1px solid #eee; margin-bottom: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="font-size: 18px;">${s.name}</strong>
                                        <span style="background: ${getSeverityColor(s.severity)}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">${s.severity}</span>
                                    </div>
                                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                                        <div>
                                            <div style="font-size: 32px; font-weight: bold; color: ${getSeverityColor(s.severity)};">${s.score}</div>
                                            <div style="font-size: 12px; color: #666;">Score</div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="color: #666; font-size: 14px;">Completed: ${new Date(s.timestamp).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #999; padding: 20px; text-align: center;">No clinical assessments completed yet</p>'}
                        </div>
                    `;
                    break;
                    
                case 'therapy':
                    html = `
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>üìù Add Therapy / Appointment Note</h4>
                            <textarea id="newClinicianNote" placeholder="Enter therapy session notes, appointment summaries, or clinical observations..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 120px; font-family: inherit; margin-bottom: 10px;"></textarea>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="highlightNote" style="cursor: pointer;">
                                    <span>‚≠ê Highlight as important</span>
                                </label>
                                <button class="btn" onclick="saveClinicianNote()" style="margin-left: auto;">üíæ Save Note</button>
                            </div>
                        </div>
                        <div class="card">
                            <h4>Previous Therapy Notes & Appointments</h4>
                            <div id="clinicianNotesContainer">
                                ${data.clinician_notes && data.clinician_notes.length > 0 ? 
                                    data.clinician_notes.map(note => `
                                        <div class="note-item" style="padding: 15px; border-left: 4px solid ${note.highlighted ? '#ffc107' : '#e0e0e0'}; background: ${note.highlighted ? '#fff3cd' : '#f8f9fa'}; border-radius: 8px; margin-bottom: 15px; position: relative;">
                                            ${note.highlighted ? '<span style="position: absolute; top: 10px; right: 10px; font-size: 20px;">‚≠ê</span>' : ''}
                                            <div style="color: #666; font-size: 13px; margin-bottom: 8px;">üìÖ ${new Date(note.timestamp).toLocaleString()}</div>
                                            <div style="white-space: pre-wrap; line-height: 1.6;">${note.note}</div>
                                            <button class="btn btn-secondary" onclick="deleteNote(${note.id})" style="margin-top: 10px; padding: 6px 12px; font-size: 13px;">üóëÔ∏è Delete</button>
                                        </div>
                                    `).join('') 
                                    : '<p style="color: #999; padding: 20px; text-align: center;">No therapy notes yet. Add your first note above.</p>'
                                }
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'alerts':
                    html = `
                        <div class="card">
                            <h4>Safety Alerts & Warnings</h4>
                            ${data.recent_alerts.length > 0 ? data.recent_alerts.map(a => `
                                <div style="padding: 20px; margin-bottom: 15px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="font-size: 16px; color: #c62828;">üö® ${a.type}</strong>
                                        <span style="font-size: 13px; color: #666;">${new Date(a.timestamp).toLocaleString()}</span>
                                    </div>
                                    <p style="margin: 0; color: #666;">${a.message}</p>
                                </div>
                            `).join('') : '<p style="color: #28a745; padding: 20px; text-align: center; font-weight: bold;">‚úì No recent safety alerts - patient appears stable</p>'}
                        </div>
                    `;
                    break;
            }
            
            contentDiv.innerHTML = html;
        }
        
        function closePatientDetail() {
            document.getElementById('patientListSection').style.display = 'block';
            document.getElementById('patientDetailSection').style.display = 'none';
            currentPatientData = null;
        }
        
        function getSeverityColor(severity) {
            if (!severity) return '#999';
            const colors = {
                'Minimal': '#28a745',
                'Mild': '#ffc107',
                'Moderate': '#fd7e14',
                'Moderately Severe': '#dc3545',
                'Severe': '#dc3545'
            };
            return colors[severity] || '#999';
        }
        
        async function saveClinicianNote() {
            const noteText = document.getElementById('newClinicianNote').value.trim();
            const isHighlighted = document.getElementById('highlightNote').checked;
            
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            
            if (!currentPatientData || !currentPatientData.username) {
                alert('No patient selected');
                return;
            }
            
            try {
                const response = await fetch('/api/professional/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clinician_username: currentUser,
                        patient_username: currentPatientData.username,
                        note_text: noteText,
                        is_highlighted: isHighlighted ? 1 : 0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Note saved successfully! AI will reference this in patient conversations.');
                    document.getElementById('newClinicianNote').value = '';
                    document.getElementById('highlightNote').checked = false;
                    // Reload patient data to show new note
                    viewPatient(currentPatientData.username);
                } else {
                    alert('Error saving note: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note');
            }
        }
        
        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            try {
                const response = await fetch(`/api/professional/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Note deleted');
                    viewPatient(currentPatientData.username);
                } else {
                    alert('Error deleting note: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note');
            }
        }
        
        // Appointment Management Functions
        async function loadAppointments() {
            if (currentUserRole !== 'clinician') {
                return;
            }
            
            const listDiv = document.getElementById('appointmentsList');
            listDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading" style="margin: 0 auto;"></div></div>';
            
            try {
                const response = await fetch(`/api/appointments?clinician=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (response.ok && data.appointments) {
                    if (data.appointments.length === 0) {
                        listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No upcoming appointments scheduled.</p>';
                        return;
                    }
                    
                    const html = data.appointments.map(apt => {
                        const date = new Date(apt.appointment_date);
                        const dateStr = date.toLocaleDateString();
                        const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        const daysUntil = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
                        
                        // Patient response status
                        const responseColor = apt.patient_response === 'accepted' ? '#28a745' : 
                                             apt.patient_response === 'declined' ? '#dc3545' : '#ffc107';
                        const responseIcon = apt.patient_response === 'accepted' ? '‚úì' : 
                                            apt.patient_response === 'declined' ? '‚úó' : '‚è≥';
                        const responseText = apt.patient_response === 'accepted' ? 'Accepted' :
                                            apt.patient_response === 'declined' ? 'Declined' : 'Pending';
                        const ackStatus = apt.patient_acknowledged ? '‚úì Read' : '‚óã Unread';
                        
                        return `
                            <div style="border: 2px solid ${daysUntil <= 2 ? '#ffc107' : '#e0e0e0'}; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: ${daysUntil <= 2 ? '#fff3cd' : 'white'};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 18px; font-weight: bold; color: #333;">${apt.patient_username}</div>
                                        <div style="color: #667eea; margin-top: 5px;">üìÖ ${dateStr} at ${timeStr}</div>
                                        ${apt.notes ? `<div style="color: #666; margin-top: 8px; font-size: 14px;">${apt.notes}</div>` : ''}
                                        ${daysUntil <= 2 ? `<div style="color: #dc7e14; font-weight: bold; margin-top: 8px;">‚ö†Ô∏è ${daysUntil === 0 ? 'Today!' : daysUntil === 1 ? 'Tomorrow' : `In ${daysUntil} days`}</div>` : ''}
                                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                                            <span style="background: ${responseColor}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                                ${responseIcon} Patient: ${responseText}
                                            </span>
                                            <span style="background: ${apt.patient_acknowledged ? '#28a745' : '#999'}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">
                                                ${ackStatus}
                                            </span>
                                        </div>
                                        ${apt.patient_response_date ? `<div style="color: #999; font-size: 12px; margin-top: 5px;">Response: ${new Date(apt.patient_response_date).toLocaleString()}</div>` : ''}
                                    </div>
                                    <button onclick="cancelAppointment(${apt.id})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading appointments</p>';
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                listDiv.innerHTML = '<p style="color: #dc3545; text-align: center;">Connection error</p>';
            }
        }
        
        function showNewAppointmentForm() {
            document.getElementById('newAppointmentForm').style.display = 'block';
            
            // Populate patient dropdown
            const select = document.getElementById('appointmentPatient');
            const patientList = document.getElementById('patientList');
            const patientCards = patientList.querySelectorAll('.patient-card');
            
            select.innerHTML = '<option value="">Select a patient...</option>';
            patientCards.forEach(card => {
                const username = card.querySelector('strong').textContent;
                select.innerHTML += `<option value="${username}">${username}</option>`;
            });
            
            // Set minimum date to today
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('appointmentDateTime').min = now.toISOString().slice(0, 16);
        }
        
        function cancelNewAppointment() {
            document.getElementById('newAppointmentForm').style.display = 'none';
            document.getElementById('appointmentPatient').value = '';
            document.getElementById('appointmentDateTime').value = '';
            document.getElementById('appointmentNotes').value = '';
        }
        
        async function createAppointment() {
            const patientUsername = document.getElementById('appointmentPatient').value;
            const dateTime = document.getElementById('appointmentDateTime').value;
            const notes = document.getElementById('appointmentNotes').value;
            
            if (!patientUsername || !dateTime) {
                alert('Please select a patient and appointment date/time');
                return;
            }
            
            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clinician_username: currentUser,
                        patient_username: patientUsername,
                        appointment_date: dateTime,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Appointment scheduled successfully!');
                    cancelNewAppointment();
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to create appointment'));
                }
            } catch (error) {
                console.error('Error creating appointment:', error);
                alert('Connection error. Please try again.');
            }
        }
        
        async function cancelAppointment(appointmentId) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Appointment cancelled');
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel'));
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('Connection error');
            }
        }
        
        // Restore session on page load
        async function restoreSession() {
            // Check localStorage first (Remember Me), then sessionStorage
            let sessionData = localStorage.getItem('healingSpaceSession');
            let storage = 'localStorage';
            
            if (!sessionData) {
                sessionData = sessionStorage.getItem('healingSpaceSession');
                storage = 'sessionStorage';
            }
            
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    
                    // Validate session with server before restoring
                    const response = await fetch('/api/validate-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: data.username,
                            role: data.role || 'user'
                        })
                    });
                    
                    if (response.ok) {
                        currentUser = data.username;
                        currentUserRole = data.role || 'user';
                        
                        console.log('Session restored from ' + storage + ' for user:', currentUser);
                        
                        // Restore the app state
                        completeLogin(data);
                    } else {
                        // Session invalid, clear it
                        console.log('Session validation failed, clearing session data');
                        localStorage.removeItem('healingSpaceSession');
                        sessionStorage.removeItem('healingSpaceSession');
                        showLanding();
                    }
                } catch (error) {
                    console.error('Error restoring session:', error);
                    // Clear corrupted session data
                    localStorage.removeItem('healingSpaceSession');
                    sessionStorage.removeItem('healingSpaceSession');
                    showLanding();
                }
            } else {
                // No session data, show landing page
                showLanding();
            }
        }
        
        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
                button.title = 'Hide password';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
                button.title = 'Show password';
            }
        }
        
        // Initialize and restore session on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Healing Space Complete Edition initialized');
            
            // Ensure authScreen is visible by default
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            
            // Try to restore session (will handle visibility if successful)
            await await restoreSession();
        });
        
        // Debug helper: Call this from browser console to clear all session data
        window.clearAllSessions = function() {
            localStorage.removeItem('healingSpaceSession');
            sessionStorage.removeItem('healingSpaceSession');
            console.log('All session data cleared. Reloading page...');
            location.reload();
        };
    </script>
</body>
</html>