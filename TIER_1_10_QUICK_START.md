# Quick Start: TIER 1.10 - Anonymization Salt
**Estimated Time**: 1-2 hours  
**Difficulty**: ‚≠ê Easy  
**Why First**: Zero dependencies, fast win, builds momentum

---

## üéØ The Goal
Remove hardcoded salt from `training_data_manager.py` and make it environment-based.

**Current Problem**:
```python
ANONYMIZATION_SALT = "default_salt_12345"  # ‚ùå Hardcoded!
```

**After Fix**:
```python
ANONYMIZATION_SALT = get_anonymization_salt()  # ‚úÖ Generated on startup
```

---

## üìã Step-by-Step Implementation

### Step 1: Examine Current Code (5 min)
```bash
# Find the hardcoded salt
grep -n "ANONYMIZATION_SALT" training_data_manager.py

# Expected output (around line ~20-30):
# 20: ANONYMIZATION_SALT = "default_salt_12345"
```

Open `training_data_manager.py` and locate the line.

### Step 2: Create Feature Branch (1 min)
```bash
git checkout -b security/tier1-1.10
```

### Step 3: Update `.env.example` (2 min)
Find section about encryption/security keys:

```bash
# In .env.example, find this section (around line 30):
# SECURITY: ENCRYPTION KEYS

# Add below ENCRYPTION_KEY:
# ANONYMIZATION SALT (auto-generated on first run if not set)
ANONYMIZATION_SALT=<auto-generated-on-startup>
```

### Step 4: Modify `training_data_manager.py` (15 min)

**At the top of the file** (after imports), add:

```python
import os
import secrets

# Generate random anonymization salt on startup if not set
def get_anonymization_salt():
    """Get or generate anonymization salt from environment
    
    In DEBUG mode: Auto-generates random salt if not set
    In PRODUCTION: Fails if ANONYMIZATION_SALT not explicitly provided
    
    Returns:
        str: 64-character hex string (32 bytes)
    """
    salt = os.getenv('ANONYMIZATION_SALT')
    if not salt:
        # Generate 32-byte random salt (64 hex chars)
        salt = secrets.token_hex(32)
        print(f"‚ö†Ô∏è  ANONYMIZATION_SALT not set. Generated random salt:")
        print(f"    {salt}")
        print(f"    Set this in .env or Railway dashboard: export ANONYMIZATION_SALT={salt}")
        
        if not os.getenv('DEBUG'):
            # In production, fail-closed if salt not explicitly set
            raise RuntimeError(
                "ANONYMIZATION_SALT must be set in production. "
                "Generate with: python3 -c \"import secrets; print(secrets.token_hex(32))\" "
                "Set via environment variable or Railway dashboard."
            )
    return salt
```

**Find the line**:
```python
ANONYMIZATION_SALT = "default_salt_12345"
```

**Replace with**:
```python
ANONYMIZATION_SALT = get_anonymization_salt()
```

### Step 5: Find All Uses of ANONYMIZATION_SALT (10 min)
```bash
grep -n "ANONYMIZATION_SALT" training_data_manager.py
```

Check each line to ensure they work with the new approach (they should - it's just a string value now).

Typical uses:
```python
# These should all still work:
hashlib.sha256((value + ANONYMIZATION_SALT).encode()).hexdigest()
# or
cipher = Fernet(base64.urlsafe_b64encode(ANONYMIZATION_SALT.encode()))
```

If any code tries to call it as a function `ANONYMIZATION_SALT()`, those need fixing (shouldn't be any).

### Step 6: Test Locally (10 min)

**Test 1: Development mode (auto-generates)**
```bash
# Should print the generated salt
DEBUG=1 python3 -c "from training_data_manager import get_anonymization_salt; print('Generated:', get_anonymization_salt())"
```
‚úÖ Expected: Prints a 64-character hex string

**Test 2: Production mode without env var (should fail safely)**
```bash
# Should raise RuntimeError
DEBUG=0 python3 -c "from training_data_manager import get_anonymization_salt; print(get_anonymization_salt())" 2>&1 | grep "must be set"
```
‚úÖ Expected: RuntimeError with helpful message

**Test 3: With env var set (should use it)**
```bash
# Should use the provided salt
ANONYMIZATION_SALT="abc123def456..." DEBUG=0 python3 -c "from training_data_manager import get_anonymization_salt; print(get_anonymization_salt())"
```
‚úÖ Expected: Returns `abc123def456...`

### Step 7: Run Tests (5 min)
```bash
pytest tests/ -v
```
‚úÖ All original 13 tests should still pass (no changes to logic, just where salt comes from)

### Step 8: Verify Syntax (2 min)
```bash
python3 -m py_compile training_data_manager.py
echo "‚úÖ Syntax valid"
```

### Step 9: Commit & Push (3 min)
```bash
# Stage changes
git add training_data_manager.py .env.example

# Commit with clear message
git commit -m "security(1.10): remove hardcoded anonymization salt - use environment variable"

# Push feature branch
git push origin security/tier1-1.10
```

---

## ‚úÖ Verification Checklist

Before marking as DONE:

- [ ] `.env.example` updated with ANONYMIZATION_SALT
- [ ] `get_anonymization_salt()` function added
- [ ] Line `ANONYMIZATION_SALT = "default_salt_12345"` replaced
- [ ] All uses of ANONYMIZATION_SALT still work (not called as function)
- [ ] Local tests pass (3 scenarios above)
- [ ] `pytest tests/ -v` passes
- [ ] Syntax valid: `python3 -m py_compile training_data_manager.py`
- [ ] Committed with message: `security(1.10): ...`
- [ ] Pushed to `security/tier1-1.10`
- [ ] GitHub shows "All checks passed" (if CI enabled)

---

## üö® Troubleshooting

**Issue**: `ImportError: cannot import secrets`
- **Solution**: Should be in stdlib. Try: `python3 -c "import secrets; print(secrets.token_hex(32))"`

**Issue**: Tests fail with "ANONYMIZATION_SALT not set"
- **Solution**: In conftest.py, set: `os.environ['ANONYMIZATION_SALT'] = 'test_salt_123...'`

**Issue**: Production deployment fails with RuntimeError
- **Solution**: Set ANONYMIZATION_SALT in Railway dashboard or `.env` file with: `python3 -c "import secrets; print(secrets.token_hex(32))"`

**Issue**: Code using ANONYMIZATION_SALT fails
- **Solution**: Verify it's used as string value only (not called). Should be: `hash_value = (data + ANONYMIZATION_SALT).encode()`  NOT `ANONYMIZATION_SALT()`

---

## üìö Related Files

After completing 1.10, update tracker:
```bash
# Update TIER_1_5_TO_1_10_TRACKER.md
# Mark 1.10 as DONE
# Fill in commit SHA
# Move to 1.7 (next priority)
```

---

## üé¨ Next After 1.10

Once this is committed and passing:
1. ‚úÖ Merge `security/tier1-1.10` to main (or keep in feature branch)
2. üìã Switch to **1.7 Access Control** (4 hours)
3. ‚è±Ô∏è Estimated completion: Feb 9 evening + Feb 10 morning

---

**Total Time Estimate**: 1-2 hours  
**Difficulty**: Easy ‚≠ê  
**Start Time**: ________  
**Completion Time**: ________  
**Notes**: _______________
