name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        env:
          DEBUG: 1
          PIN_SALT: test_salt_for_ci
          ENCRYPTION_KEY: ${{ secrets.TEST_ENCRYPTION_KEY }}
        run: |
          if [ -z "$ENCRYPTION_KEY" ]; then
            export ENCRYPTION_KEY=$(python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
          fi
          # Prevent system-level pytest plugins from interfering
          PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q

      - name: Optional browser smoke tests
        if: env.RUN_BROWSER_TESTS == '1'
        run: |
          pip install playwright pytest-playwright
          playwright install chromium
          PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q tests/browser_smoke_test.py -p pytest_playwright

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install linting tools
        run: pip install pylint
      - name: Run pylint
        run: pylint *.py --exit-zero --output-format=text || true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run security scan
        run: |
          pip install safety bandit
          safety check --file requirements.txt || echo "Security vulnerabilities found"
          bandit -r . -f json -o bandit-report.json || true
      - name: Upload security report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: bandit-report.json
